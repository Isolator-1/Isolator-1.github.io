---
title: Heap 基础知识
tags: [ctf-pwn]
date: 2022-11-18 12:19:00
categories: [ctf-pwn]
excerpt: basic knowledge in heap exploitation
---

### malloc

```c++
#include <stdlib.h>
void *malloc(size_t size);
```

size = 0时，返回系统允许的最小内存块

32位系统下malloc(0)分配8Bytes，64位分配16Bytes



### brk

堆段的起点和终点标识符：start_brk、brk（program brk)

不开ASLR，初始时都指向bss段末尾（end_data)

开启ASLR，会随机向后偏移一段距离

`brk()`函数作用为抬高brk指针，获取一段heap

程序开始时heap大小为0，第一次申请堆的时候，通过brk()向系统申请一段内存  **main_arena**，后面malloc都会从main_arena中申请内存





### chunk

```C
struct malloc chunk{
    INTERNAL_SIZE_T mchunk_prev_size; /* Size of previous chunk (if free).*/
    INTERNAL_SIZE_T mchunk_size;      /* Size in bytes，including overhead.*/
    struct malloc chunk* fd;          /* double links -- used only if free.*/
    struct malloc chunk* bk;          /* Only used for large blocks: pointer to next larger size. */
    struct malloc_chunk* fd_nextsize; /* double links -- used only if free.*/
    struct malloc chunk* bk_nextsize;
}
typedef struct malloc_chunk* mchunkptr;
```



#### allocated chunk

`prevsize `：如果前一个chunk是free的***（这里指的是内存中的前一个，而不是freelist中的前一个）***，它代表前一个chunk的大小；如果不是free的，存储前一个的user data 。32位中是4字节，64位中是8字节

`size`：此chunk大小。最低3位用来存储N（chunk 在 non_main_arena里为1）、M（chunk是mmap得到的为1）、P（前一个chunk已被分配为1 对应prevsize），因此size是8字节对齐的

`userdata`：数据

（下一个chunk的prevsize也会存储userdata）

```C
#define request2size(req) ...   //可以计算申请字节需要实际分配多少字节
```

chunk是在prevsize开始，但是malloc返回的指针指向userdata



#### free chunk 

`prevsize`：上一个chunk的userdata，因为上一个如果也是free，则会被合并（fast bin中可能会例外，后面会提及）

`size`：同上

`fd bk`：（在freelist中的）前一个/后一个chunk



#### top chunk

位于arena顶部。在所有bin都没有满足需求的chunk时，从top chunk切割

top chunk 不够，在main_arena中会用brk扩张top chunk，non_main_arena中，用mmap分配新的堆



### Bin

<div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2022-11-17T04:09:19.532Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36\&quot; etag=\&quot;ojfzveORWWdzC3RN6ooc\&quot; version=\&quot;20.5.3\&quot; type=\&quot;device\&quot;&gt;&lt;diagram id=\&quot;FyZdLwTWtfESSsWo7Yml\&quot; name=\&quot;第 1 页\&quot;&gt;7ZlNc5swEIZ/jY/JgASCHOPEaQ7pNDNups0poxoF6GCJCvmrv74rIwyCEieeSUybnMyupEV6tK9YwwhfzNefJM2TzyJi2Qg50XqEL0cIuTg8gx/t2RiPEzilJ5ZpVPoajmn6m1UdjXeRRqwwvtKlhMhUmtvOmeCczZTlo1KKld3tUWSR5chpzKxpaMd0RjPW6fYtjVRSekMU1P5rlsZJdWeXmBXPadXZBC4SGolVw4UnI3whhVDl1Xx9wTJNz+Zy1dO6m5hkXD1nwPVEnE/c5bn/8JD9ouvwhn+5OzFRljRbmAV/FYrqYeOUFyNEMog9/iHhKtZXLiZmNWpTIZJiwSOm7+JAj1WSKjbN6Uy3riArwJeoeQaWC5ePgiuzyy4B29yfScXWvQtzd7gg0ZiYMyU30MUMQBVyk2MnQVjaq3rDXGJ2IWlsVmh81ORIvAtdY4QLQ/IFVHGH6hUtVD9UZ3BMXddCivzgyEi9DtI7XghYYdSPdXBUEQkGhtXvYL2hEk7EPqYEDw6qj52BQSUdqNM5zfoPVYIGBzVonanHhxp0oPaoHg3vCdVO0QAdGeZZB2aHGYugDjImFxx+xnDcJiIWnGY3QuQG10+m1MbwogslbJg2+SZawDVmPDrXNRrYImccPIWictfFK7s0zUIs5IzdMpkCCCb1LqY8htYQGpU+ulRP42whl9uJ6Gmxdaq+60mdIt+Y942my7WZ8NbYVAYH9OUovzLvm231sK1VjSvRap5Ppw/g365uf7lWLnRfAdJNx2a+eSa3JMuoSpf23P6WcCbcrUi5qlMbO61KISR2CLNj5ahmedoK5Hl7ApndbQeCBKKbRrdcdyg6CtlROFw0VZn2flVzoAAqtbkNqUGIwH9abmDsZnU8KQUfUnoFKXX/d74zKf2jD6Dgmarx3kw17drKdfCBqsF2yYvdVqDjqwZ9qEY18v9/E43/ZqJBDrJyvXov8VLNuO33REEr0PE1030X9141ExwkGo80VXPinML5uqfc09YrVm7PlRN5MzkR1HoGVW90Xqongj1bT21hvqKewKw/RpTd6286ePIH&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
#### fast bin

在free一个chunk到fast bin时，它下一个chunk的P位（PREV_INUSE)是不会变的，还是为1，为了加快free的效率。**因此地址连续的两个chunk 被free到fast bin，他们不会被合并**。

大小范围：0x10-0x40 （64位中0x20-0x80）每一个链表中存放的chunk大小相同，相邻bin存放的大小差0x8（0x10）字节

新的chunk加入bin时，**fd**指向原来的栈顶

#### unsorted bin

大于global_max_fast（fast bin最大大小）的chunk都会放进来

#### small bin

存放小于0x200（0x400）的，也就是0x10-0x1f0（0x20-0x3f0）chunk，和fast bin相同，每个bin大小递增，因此有62个small bin

#### large bin

大于0x200（0x400），每一个bin中chunk大小不是相同的，按照大小降序排列



### 内存分配流程

 ![](/img/heapexploitation/1.jpg)

### 内存释放流程

 ![](/img/heapexploitation/2.jpg)







[Heap Exploitation](https://heap-exploitation.dhavalkapil.com/)

[Understanding glibc malloc](https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/)

[Syscalls used by malloc](https://sploitfun.wordpress.com/2015/02/11/syscalls-used-by-malloc/)

[glibc 内存管理 ptmalloc 源代码分析](https://paper.seebug.org/papers/Archive/refs/heap/glibc内存管理ptmalloc源代码分析.pdf)

[Painless intro to the Linux userland heap](https://sensepost.com/blog/2017/painless-intro-to-the-linux-userland-heap/)